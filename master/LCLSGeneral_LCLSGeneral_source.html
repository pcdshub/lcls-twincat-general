<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DUTs &mdash; pcdshub/lcls-twincat-general  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script src="_static/doctr-versions-menu.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Data Types" href="LCLSGeneral_LCLSGeneral_epics.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> pcdshub/lcls-twincat-general
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">LCLSGeneral</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="LCLSGeneral_pragmas.html">Pragmas</a></li>
<li class="toctree-l1"><a class="reference internal" href="LCLSGeneral_nc.html">NC Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="LCLSGeneral_boxes.html">Boxes</a></li>
<li class="toctree-l1"><a class="reference internal" href="LCLSGeneral_links.html">Links</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">LCLSGeneral</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="LCLSGeneral_LCLSGeneral_summary.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="LCLSGeneral_LCLSGeneral_summary.html#pragmas">Pragmas</a></li>
<li class="toctree-l1"><a class="reference internal" href="LCLSGeneral_LCLSGeneral_summary.html#libraries">Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="LCLSGeneral_LCLSGeneral_summary.html#symbols">Symbols</a></li>
<li class="toctree-l1"><a class="reference internal" href="LCLSGeneral_LCLSGeneral_epics.html">Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="LCLSGeneral_LCLSGeneral_epics.html#database-records">Database Records</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">DUTs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#e-ecatdiagstate">E_EcatDiagState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-eccommstate">E_EcCommState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-logeventtype-wc">E_LogEventType_WC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-subsystem">E_Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-ecdevice">ST_EcDevice</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-ecmasterdevstate">ST_EcMasterDevState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-epicsmotormsta">ST_EpicsMotorMSTA</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-fbdiagnostics">ST_FbDiagnostics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-loggingeventinfo-wc">ST_LoggingEventInfo_WC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-pendingevent">ST_PendingEvent</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-portaddr">ST_PortAddr</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-slavestate">ST_SlaveState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-slavestateinfo">ST_SlaveStateInfo</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-slavestateinfoscanned">ST_SlaveStateInfoScanned</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-system">ST_System</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-topologydata">ST_TopologyData</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#gvls">GVLs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#defaultglobals">DefaultGlobals</a></li>
<li class="toctree-l2"><a class="reference internal" href="#generalconstants">GeneralConstants</a></li>
<li class="toctree-l2"><a class="reference internal" href="#global-variables-ethercat">Global_Variables_EtherCAT</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-logger">GVL_Logger</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#pous">POUs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#f-converttickstounixtimestamp">F_ConvertTicksToUnixTimestamp</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-sendudpmessage">F_SendUDPMessage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-analoginput">FB_AnalogInput</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-analogoutput">FB_AnalogOutput</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-basicstats">FB_BasicStats</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-circuitbreaker-test">FB_CircuitBreaker_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-coe-fastread">FB_CoE_FastRead</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-databuffer">FB_DataBuffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ecatdiag">FB_EcatDiag</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ecatdiagwrapper">FB_EcatDiagWrapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-el6-com">FB_EL6_Com</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-epicscentroidmonitor">FB_EpicsCentroidMonitor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-epicsmotormonitor">FB_EpicsMotorMonitor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ethercatdiag">FB_EtherCATDiag</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ethercatframediag">FB_EtherCATFrameDiag</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-getplchostname">FB_GetPLCHostname</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-getplcipaddress">FB_GetPLCIPAddress</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-index">FB_Index</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-led">FB_LED</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-listener">FB_Listener</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-loghandler">FB_LogHandler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-logmessage">FB_LogMessage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-lrealbuffer">FB_LREALBuffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-lrealfromepics">FB_LREALFromEPICS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-stringfromepics">FB_STRINGFromEPICS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-tempsensor">FB_TempSensor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-test-epicscentroidmonitor">FB_Test_EpicsCentroidMonitor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-test-epicsmotormonitor">FB_Test_EpicsMotorMonitor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-thermocouple">FB_ThermoCouple</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-timestampbuffer">FB_TimeStampBuffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-timestampbufferglobal">FB_TimeStampBufferGlobal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-unixtimestamp">FB_UnixTimeStamp</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-unixtimestampglobal">FB_UnixTimeStampGlobal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-xkoyoplcmodbus">FB_XKoyoPLCModbus</a></li>
<li class="toctree-l2"><a class="reference internal" href="#resetcircuitbreakerglobals">ResetCircuitBreakerGlobals</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-tests">RUN_TESTS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#system-time-to-rfc3339">SYSTEM_TIME_TO_RFC3339</a></li>
<li class="toctree-l2"><a class="reference internal" href="#time-to-100ns">TIME_TO_100NS</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pcdshub/lcls-twincat-general</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">DUTs</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/LCLSGeneral_LCLSGeneral_source.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="duts">
<h1>DUTs<a class="headerlink" href="#duts" title="Permalink to this heading"></a></h1>
<section id="e-ecatdiagstate">
<h2>E_EcatDiagState<a class="headerlink" href="#e-ecatdiagstate" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">E_EcatDiagState</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">Idle</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">GetSlaveAddresses</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">GetSlaveStates</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">GetTopoDataLen</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">GetTopoData</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">ScanSlaves</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">GetSlaveIdentity</span> <span class="o">:=</span> <span class="mi">6</span><span class="p">,</span>
    <span class="n">GetSlaveName</span> <span class="o">:=</span> <span class="mi">7</span><span class="p">,</span>
    <span class="n">GetScannedSlaveName</span> <span class="o">:=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">LogDiagnostics</span> <span class="o">:=</span> <span class="mi">9</span><span class="p">,</span>
    <span class="n">Done</span> <span class="o">:=</span> <span class="mi">8000</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-ecatdiagstate">E_EcatDiagState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="e-eccommstate">
<h2>E_EcCommState<a class="headerlink" href="#e-eccommstate" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">E_EcCommState</span> <span class="p">:</span> <span class="p">(</span>
    <span class="n">eEcState_UNDEFINED</span>      <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">eEcState_INIT</span>           <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">eEcState_PREOP</span>          <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">eEcState_BOOT</span>           <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">eEcState_SAFEOP</span>         <span class="o">:=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">eEcState_OP</span>             <span class="o">:=</span> <span class="mi">8</span>
<span class="p">)</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-logeventtype-wc">
<h2>E_LogEventType_WC<a class="headerlink" href="#e-logeventtype-wc" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_LogEventType_WC</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">AlarmCleared</span>    <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">AlarmConfirmed</span>  <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">AlarmRaised</span>     <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">MessageSent</span>     <span class="o">:=</span> <span class="mi">3</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Note</span><span class="p">:</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">working</span> <span class="n">copy</span> <span class="n">version</span> <span class="n">that</span> <span class="ow">is</span> <span class="n">automatically</span> <span class="n">made</span> <span class="n">a</span>
   <span class="k">global</span> <span class="nb">type</span> <span class="n">when</span> <span class="n">pinning</span> <span class="n">ST_LoggingEventInfo</span> <span class="o">*</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="e-subsystem">
<h2>E_Subsystem<a class="headerlink" href="#e-subsystem" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">LCLS</span> <span class="n">Defined</span> <span class="n">subsystems</span><span class="p">,</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">these</span> <span class="n">correspond</span> <span class="k">with</span> <span class="n">casSubsystems</span> <span class="ow">in</span> <span class="n">FB_LogMessage</span>
<span class="n">TYPE</span> <span class="n">E_Subsystem</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">NILVALUE</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">//</span><span class="n">Undefined</span> <span class="n">system</span>
    <span class="n">VACUUM</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">//</span><span class="n">Vacuum</span> <span class="n">control</span> <span class="n">system</span>
    <span class="n">MPS</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span> <span class="o">//</span><span class="n">Machine</span> <span class="n">protection</span> <span class="n">system</span>
    <span class="n">MOTION</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span> <span class="o">//</span><span class="n">Motion</span> <span class="n">control</span> <span class="n">systems</span>
    <span class="n">FIELDBUS</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">,</span> <span class="o">//</span><span class="n">EtherCAT</span> <span class="n">networks</span>
    <span class="n">SDS</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">,</span> <span class="o">//</span><span class="n">Sample</span> <span class="n">delivery</span> <span class="n">system</span>
    <span class="n">OPTICS</span> <span class="o">:=</span> <span class="mi">6</span> <span class="o">//</span><span class="n">Optics</span> <span class="n">control</span> <span class="n">system</span>
<span class="p">)</span><span class="n">WORD</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-logmessage">FB_LogMessage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-ecdevice">
<h2>ST_EcDevice<a class="headerlink" href="#st-ecdevice" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">EtherCAT</span> <span class="n">Device</span> <span class="n">struct</span> <span class="k">for</span> <span class="n">EtherCAT</span> <span class="n">diagnostics</span>
<span class="n">TYPE</span> <span class="n">ST_EcDevice</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">nDeviceState</span><span class="p">:</span> <span class="n">BYTE</span><span class="p">;</span> <span class="o">//</span><span class="n">EtherCAT</span> <span class="n">state</span> <span class="n">machine</span> <span class="n">state</span> <span class="n">number</span><span class="p">,</span> <span class="mi">8</span> <span class="ow">is</span> <span class="n">OP</span> <span class="ow">is</span> <span class="n">good</span>
    <span class="n">sDeviceState</span> <span class="p">:</span><span class="n">STRING</span><span class="p">;</span> <span class="o">//</span><span class="n">EtherCAT</span> <span class="n">state</span> <span class="n">machine</span> <span class="n">state</span><span class="p">,</span> <span class="n">OP</span> <span class="ow">is</span> <span class="n">good</span>
    <span class="n">nLinkState</span><span class="p">:</span> <span class="n">BYTE</span><span class="p">;</span> <span class="o">//</span><span class="n">EtherCAT</span> <span class="n">link</span> <span class="n">state</span><span class="p">,</span> <span class="mi">8</span> <span class="ow">is</span> <span class="n">good</span>
    <span class="n">nAddrr</span><span class="p">:</span> <span class="n">WORD</span><span class="p">;</span> <span class="o">//</span><span class="n">EtherCAT</span> <span class="n">slave</span> <span class="n">address</span>
    <span class="n">sType</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span> <span class="o">//</span><span class="n">EtherCAT</span> <span class="n">slave</span> <span class="nb">type</span>
    <span class="n">sName</span><span class="p">:</span><span class="n">STRING</span><span class="p">;</span> <span class="o">//</span><span class="n">EtherCAT</span> <span class="n">slave</span> <span class="n">name</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-ecmasterdevstate">
<h2>ST_EcMasterDevState<a class="headerlink" href="#st-ecmasterdevstate" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_EcMasterDevState</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">eEcState</span>                        <span class="p">:</span> <span class="n">E_EcCommState</span><span class="p">;</span>
    <span class="n">nReserved</span>                       <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0..2</span><span class="p">]</span> <span class="n">OF</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="n">bLinkError</span>                      <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bResetRequired</span>          <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMissFrmRedMode</span>         <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bWatchdogTriggerd</span>       <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDriverNotFound</span>         <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bResetActive</span>            <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bAtLeastOneNotInOp</span>      <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDcNotInSync</span>            <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-eccommstate">E_EcCommState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-epicsmotormsta">
<h2>ST_EpicsMotorMSTA<a class="headerlink" href="#st-epicsmotormsta" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_EpicsMotorMSTA</span> <span class="p">:</span>
<span class="n">STRUCT</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">DIRECTION</span><span class="p">:</span> <span class="n">last</span> <span class="n">raw</span> <span class="n">direction</span><span class="p">;</span> <span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">Negative</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">Positive</span><span class="p">)</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bPositiveDirection</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">DONE</span><span class="p">:</span> <span class="n">motion</span> <span class="ow">is</span> <span class="n">complete</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bDone</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">PLUS_LS</span><span class="p">:</span> <span class="n">plus</span> <span class="n">limit</span> <span class="n">switch</span> <span class="n">has</span> <span class="n">been</span> <span class="n">hit</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bPlusLimitSwitch</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">HOMELS</span><span class="p">:</span> <span class="n">state</span> <span class="n">of</span> <span class="n">the</span> <span class="n">home</span> <span class="n">limit</span> <span class="n">switch</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bHomeLimitSwitch</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Unused</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bUnused0</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">POSITION</span><span class="p">:</span> <span class="n">closed</span><span class="o">-</span><span class="n">loop</span> <span class="n">position</span> <span class="n">control</span> <span class="ow">is</span> <span class="n">enabled</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bClosedLoop</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">SLIP_STALL</span><span class="p">:</span> <span class="n">Slip</span><span class="o">/</span><span class="n">Stall</span> <span class="n">detected</span> <span class="p">(</span><span class="n">eg</span><span class="o">.</span> <span class="n">fatal</span> <span class="n">following</span> <span class="n">error</span><span class="p">)</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bSlipStall</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">HOME</span><span class="p">:</span> <span class="k">if</span> <span class="n">at</span> <span class="n">home</span> <span class="n">position</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bHome</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">PRESENT</span><span class="p">:</span> <span class="n">encoder</span> <span class="ow">is</span> <span class="n">present</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bEncoderPresent</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">PROBLEM</span><span class="p">:</span> <span class="n">driver</span> <span class="n">stopped</span> <span class="n">polling</span><span class="p">,</span> <span class="ow">or</span> <span class="n">hardware</span> <span class="n">problem</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bHardwareProblem</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">MOVING</span><span class="p">:</span> <span class="n">non</span><span class="o">-</span><span class="n">zero</span> <span class="n">velocity</span> <span class="n">present</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bMoving</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">GAIN_SUPPORT</span><span class="p">:</span> <span class="n">motor</span> <span class="n">supports</span> <span class="n">closed</span><span class="o">-</span><span class="n">loop</span> <span class="n">position</span> <span class="n">control</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bGainSupport</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">COMM_ERR</span><span class="p">:</span> <span class="n">Controller</span> <span class="n">communication</span> <span class="n">error</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bCommError</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">MINUS_LS</span><span class="p">:</span> <span class="n">minus</span> <span class="n">limit</span> <span class="n">switch</span> <span class="n">has</span> <span class="n">been</span> <span class="n">hit</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bMinusLimitSwitch</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">HOMED</span><span class="p">:</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">has</span> <span class="n">been</span> <span class="n">homed</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bHomed</span> <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-fbdiagnostics">
<h2>ST_FbDiagnostics<a class="headerlink" href="#st-fbdiagnostics" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">Stuff</span> <span class="n">to</span> <span class="n">log</span> <span class="n">messages</span> <span class="n">within</span> <span class="n">function</span> <span class="n">blocks</span>
<span class="n">TYPE</span> <span class="n">ST_FbDiagnostics</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">asResults</span>       <span class="p">:</span>       <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1..20</span><span class="p">]</span> <span class="n">OF</span> <span class="n">T_MaxString</span><span class="p">;</span> <span class="o">//</span><span class="n">Diagnostic</span> <span class="n">messages</span><span class="p">,</span> <span class="n">use</span> <span class="n">to</span> <span class="n">record</span> <span class="n">state</span> <span class="n">changes</span> <span class="ow">or</span> <span class="n">other</span> <span class="n">important</span> <span class="n">events</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;naming&#39;</span> <span class="o">:=</span> <span class="s1">&#39;omit&#39;</span><span class="p">}</span>
    <span class="o">//</span><span class="n">Incrementer</span><span class="p">,</span> <span class="n">included</span> <span class="n">here</span> <span class="n">to</span> <span class="n">facilitate</span> <span class="n">using</span> <span class="n">asResults</span>
    <span class="n">resultIdx</span>       <span class="p">:</span>       <span class="n">FB_Index</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">LowerLimit</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">UpperLimit</span> <span class="o">:=</span> <span class="mi">20</span>
    <span class="p">);</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;naming&#39;</span> <span class="o">:=</span> <span class="s1">&#39;omit&#39;</span><span class="p">}</span>
    <span class="n">fString</span> <span class="p">:</span>       <span class="n">FB_FormatString</span><span class="p">;</span> <span class="o">//</span><span class="n">Use</span> <span class="n">to</span> <span class="n">create</span> <span class="n">good</span> <span class="n">log</span> <span class="n">messages</span><span class="p">,</span> <span class="n">similar</span> <span class="n">to</span> <span class="n">C</span><span class="o">++</span> <span class="n">fstring</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-index">FB_Index</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-loggingeventinfo-wc">
<h2>ST_LoggingEventInfo_WC<a class="headerlink" href="#st-loggingeventinfo-wc" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>TYPE ST_LoggingEventInfo_WC :
STRUCT
    (*
        Message or Alarm{Cleared,Confirmed,Raised} event information

        ** Working copy - to be used for the pinned ST_LoggingEventInfo **
        * The process for updating this type is as follows:
            1. Copy this structure and rename to ST_LoggingEventInfo
            2. Remove the working copy notes section
            3. Pin the global data type
        ** End of working copy information **

        Note that elements here do not follow the usual Hungarian notation /
        variable-type-prefixing naming convention due to the member names being
        used directly in the generation of the JSON document.
    *)

    {attribute &#39;pytmc&#39; := &#39;
        pv: Schema
        io: i
        field: DESC Schema string
    &#39;}
    schema          :       STRING := &#39;twincat-event-0&#39;;

    {attribute &#39;pytmc&#39; := &#39;
        pv: Timestamp
        io: i
        field: DESC Unix timestamp
    &#39;}
      ts                    :       LREAL;

      {attribute &#39;pytmc&#39; := &#39;
        pv: Hostname
        io: i
        field: DESC PLC Hostname
    &#39;}
      plc                   :       STRING;

    {attribute &#39;pytmc&#39; := &#39;
        pv: Severity
        io: i
        field: DESC TcEventSeverity
        field: ZRST Verbose
        field: ONST Info
        field: TWST Warning
        field: THST Error
    &#39;}
    severity        :       TcEventSeverity;

    {attribute &#39;pytmc&#39; := &#39;
        pv: MessageID
        io: i
        field: DESC TwinCAT Message ID
    &#39;}
    id                      :       UDINT;

    {attribute &#39;pytmc&#39; := &#39;
        pv: EventClass
        io: i
        field: DESC TwinCAT Event class
    &#39;}
    event_class             :       STRING;

    {attribute &#39;pytmc&#39; := &#39;
        pv: Message
        io: i
    &#39;}
    msg                             : STRING(255);
    // This is actually: T_MaxString
    // which has been expanded due to requirements for pinning global data types.

    {attribute &#39;pytmc&#39; := &#39;
        pv: Source
        io: i
    &#39;}
    source                  : STRING(255);
    // This is actually: STRING(Tc3_EventLogger.ParameterList.cSourceNameSize - 1)
    // which has been expanded due to requirements for pinning global data types.

    {attribute &#39;pytmc&#39; := &#39;
        pv: EventType
        io: i
        field: DESC The event type
    &#39;}
    event_type      :        E_LogEventType;

    {attribute &#39;pytmc&#39; := &#39;
        pv: MessageJSON
        io: i
        field: DESC Metadata with the message
    &#39;}
    json            :       STRING(10000);
    (*
    NOTE: this JSON gets inserted as an escaped string in the &quot;json&quot; key.
    TODO: it may be possible to use `fbJson.AddRawObject`, but this would
          require us to switch back to creating the JSON in a more manual
          way with AddKey/AddInt (and such).
    *)

END_STRUCT
END_TYPE
</pre></div>
</div>
</section>
<section id="st-pendingevent">
<h2>ST_PendingEvent<a class="headerlink" href="#st-pendingevent" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_PendingEvent</span> <span class="p">:</span>
<span class="n">STRUCT</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">stEventInfo</span>                     <span class="p">:</span>       <span class="n">ST_LoggingEventInfo</span><span class="p">;</span>
    <span class="n">bInUse</span>                          <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fbRequestEventText</span>      <span class="p">:</span>       <span class="n">FB_RequestEventText</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-portaddr">
<h2>ST_PortAddr<a class="headerlink" href="#st-portaddr" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_PortAddr</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">portA</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">portB</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">portC</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">portD</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-slavestate">
<h2>ST_SlaveState<a class="headerlink" href="#st-slavestate" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_SlaveState</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">slave</span> <span class="n">state</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">eEcState</span>                <span class="p">:</span> <span class="n">E_EcCommState</span><span class="p">;</span>
    <span class="n">nReserved</span>               <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bError</span>                  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bInvalidVPRS</span>    <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nReserved2</span>              <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">link</span> <span class="n">state</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bNoCommToSlave</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLinkError</span>              <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMissingLink</span>    <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bUnexpectedLink</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bPortA</span>                  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bPortB</span>                  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bPortC</span>                  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bPortD</span>                  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-eccommstate">E_EcCommState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-slavestateinfo">
<h2>ST_SlaveStateInfo<a class="headerlink" href="#st-slavestateinfo" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_SlaveStateInfo</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">nIndex</span>                  <span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">sName</span>                   <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>               <span class="p">(</span><span class="o">*</span> <span class="n">name</span> <span class="n">of</span> <span class="n">slave</span> <span class="n">given</span> <span class="ow">in</span> <span class="n">System</span> <span class="n">Manager</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">sType</span>                   <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>               <span class="p">(</span><span class="o">*</span> <span class="nb">type</span> <span class="n">of</span> <span class="n">slave</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">EK1100</span><span class="o">*</span><span class="p">)</span>
    <span class="n">nECAddr</span>                 <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>                 <span class="p">(</span><span class="o">*</span> <span class="n">EtherCAT</span> <span class="n">Slave</span> <span class="n">Addr</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bDiagData</span>               <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                 <span class="p">(</span><span class="o">*</span> <span class="n">DiagData</span> <span class="ow">in</span> <span class="n">Slave</span> <span class="n">State</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">stPortCRCErrors</span> <span class="p">:</span> <span class="n">ST_EcCrcErrorEx</span><span class="p">;(</span><span class="o">*</span> <span class="n">Slave</span> <span class="n">CRC</span><span class="o">-</span><span class="n">Errors</span><span class="p">,</span> <span class="n">separate</span> <span class="k">for</span> <span class="n">each</span> <span class="n">Port</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">nSumCRCErrors</span>   <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>                <span class="p">(</span><span class="o">*</span> <span class="n">Slave</span> <span class="n">CRC</span><span class="o">-</span><span class="n">Errors</span><span class="p">,</span> <span class="nb">sum</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">Ports</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">stState</span>                 <span class="p">:</span> <span class="n">ST_SlaveState</span><span class="p">;(</span><span class="o">*</span> <span class="n">EtherCAT</span> <span class="n">State</span> <span class="ow">and</span> <span class="n">Link</span> <span class="n">state</span><span class="o">*</span><span class="p">)</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-slavestate">ST_SlaveState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-slavestateinfoscanned">
<h2>ST_SlaveStateInfoScanned<a class="headerlink" href="#st-slavestateinfoscanned" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_SlaveStateInfoScanned</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">nIndex</span>                  <span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">sName</span>                   <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>               <span class="p">(</span><span class="o">*</span> <span class="n">name</span> <span class="n">of</span> <span class="n">slave</span> <span class="n">given</span> <span class="ow">in</span> <span class="n">System</span> <span class="n">Manager</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">sType</span>                   <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>               <span class="p">(</span><span class="o">*</span> <span class="nb">type</span> <span class="n">of</span> <span class="n">slave</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">EK1100</span><span class="o">*</span><span class="p">)</span>
    <span class="n">nECAddr</span>                 <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>                 <span class="p">(</span><span class="o">*</span> <span class="n">EtherCAT</span> <span class="n">Slave</span> <span class="n">Addr</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bDifferentName</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                 <span class="p">(</span><span class="o">*</span> <span class="n">Name</span> <span class="n">of</span> <span class="n">Scanned</span> <span class="n">configuration</span> <span class="n">differs</span> <span class="kn">from</span> <span class="nn">Configured</span> <span class="n">configuration</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bDifferentType</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                 <span class="p">(</span><span class="o">*</span> <span class="n">Type</span> <span class="n">Of</span> <span class="n">Scanned</span> <span class="n">configuration</span> <span class="n">differs</span> <span class="kn">from</span> <span class="nn">Configured</span> <span class="n">configuration</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">bDifferentAddr</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                 <span class="p">(</span><span class="o">*</span> <span class="n">EcAddress</span> <span class="n">of</span> <span class="n">Scanned</span> <span class="n">configuration</span> <span class="n">differs</span> <span class="kn">from</span> <span class="nn">Configured</span> <span class="n">configuration</span> <span class="o">*</span><span class="p">)</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-system">
<h2>ST_System<a class="headerlink" href="#st-system" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">Defacto</span> <span class="n">system</span> <span class="n">structure</span><span class="p">,</span> <span class="n">must</span> <span class="n">be</span> <span class="n">included</span> <span class="ow">in</span> <span class="nb">all</span> <span class="n">projects</span>
<span class="n">TYPE</span> <span class="n">ST_System</span> <span class="p">:</span>
<span class="n">STRUCT</span>

    <span class="n">xSwAlmRst</span>               <span class="p">:</span> <span class="n">BOOL</span><span class="p">;(</span><span class="o">*</span> <span class="n">Global</span> <span class="n">Alarm</span> <span class="n">Reset</span> <span class="o">-</span> <span class="n">EPICS</span> <span class="n">Command</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">xAtVacuum</span>           <span class="p">:</span> <span class="n">BOOL</span><span class="p">;(</span><span class="o">*</span> <span class="n">System</span> <span class="n">At</span> <span class="n">Vacuum</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">xFirstScan</span>          <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">boolean</span> <span class="ow">is</span> <span class="n">true</span> <span class="k">for</span> <span class="n">the</span> <span class="n">first</span> <span class="n">scan</span><span class="p">,</span> <span class="ow">and</span> <span class="ow">is</span> <span class="n">false</span> <span class="n">thereafter</span><span class="p">,</span> <span class="n">use</span> <span class="k">for</span> <span class="n">initialization</span> <span class="n">of</span> <span class="n">stuff</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">xOverrideMode</span>   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">This</span> <span class="n">bit</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">when</span> <span class="n">using</span> <span class="n">the</span> <span class="n">override</span> <span class="n">features</span> <span class="n">of</span> <span class="n">the</span> <span class="n">system</span>
    <span class="n">xIOState</span>        <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">ECat</span> <span class="n">Bus</span> <span class="n">Health</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;naming&#39;</span> <span class="o">:=</span> <span class="s1">&#39;omit&#39;</span><span class="p">}</span>
    <span class="n">I_EcatMaster1</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">AMSNETID</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">AMS</span> <span class="n">Net</span> <span class="n">ID</span> <span class="n">used</span> <span class="k">for</span> <span class="n">FB_EcatDiag</span><span class="p">,</span> <span class="n">among</span> <span class="n">others</span> <span class="o">*</span><span class="p">)</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-ecatdiag">FB_EcatDiag</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-topologydata">
<h2>ST_TopologyData<a class="headerlink" href="#st-topologydata" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_TopologyData</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">iOwnPhysicalAddr</span>        <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">iOwnAutoIncAddr</span>         <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">stPhysicalAddr</span>          <span class="p">:</span> <span class="n">ST_PortAddr</span><span class="p">;</span>
    <span class="n">stAutoIncAddr</span>           <span class="p">:</span> <span class="n">ST_PortAddr</span><span class="p">;</span>
    <span class="n">iPortDelay</span>                      <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0..2</span><span class="p">]</span> <span class="n">OF</span> <span class="n">UDINT</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">EC_AD</span><span class="p">,</span> <span class="n">EC_DB</span><span class="p">,</span> <span class="n">EC_BC</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">iReserved</span>                       <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0..7</span><span class="p">]</span> <span class="n">OF</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-portaddr">ST_PortAddr</a></p></li>
</ul>
</dd>
</dl>
</section>
</section>
<section id="gvls">
<h1>GVLs<a class="headerlink" href="#gvls" title="Permalink to this heading"></a></h1>
<section id="defaultglobals">
<h2>DefaultGlobals<a class="headerlink" href="#defaultglobals" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">These</span> <span class="n">are</span> <span class="n">variables</span> <span class="n">every</span> <span class="n">PLC</span> <span class="n">project</span> <span class="n">should</span> <span class="n">have</span>
<span class="n">VAR_GLOBAL</span>

    <span class="n">stSys</span>   <span class="p">:</span>       <span class="n">ST_System</span><span class="p">;</span> <span class="o">//</span><span class="n">Included</span> <span class="k">for</span> <span class="n">you</span>
    <span class="n">fTimeStamp</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-system">ST_System</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="generalconstants">
<h2>GeneralConstants<a class="headerlink" href="#generalconstants" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">VAR_GLOBAL</span> <span class="n">CONSTANT</span>
    <span class="o">//</span> <span class="mi">16</span> <span class="n">including</span> <span class="s2">&quot;Unknown&quot;</span> <span class="ow">is</span> <span class="n">the</span> <span class="nb">max</span> <span class="k">for</span> <span class="n">an</span> <span class="n">EPICS</span> <span class="n">MBBI</span>
    <span class="o">//</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">the</span> <span class="nb">max</span> <span class="n">number</span> <span class="n">of</span> <span class="n">user</span><span class="o">-</span><span class="n">defined</span> <span class="n">states</span> <span class="p">(</span><span class="n">OUT</span><span class="p">,</span> <span class="n">TARGET1</span><span class="p">,</span> <span class="n">YAG</span><span class="o">...</span><span class="p">)</span>
    <span class="n">MAX_STATES</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">15</span><span class="p">;</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="global-variables-ethercat">
<h2>Global_Variables_EtherCAT<a class="headerlink" href="#global-variables-ethercat" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">VAR_GLOBAL</span> <span class="n">CONSTANT</span>
    <span class="n">iSLAVEADDR_ARR_SIZE</span>     <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">256</span><span class="p">;</span>
    <span class="n">ESC_MAX_PORTS</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span> <span class="o">//</span> <span class="n">Maximum</span> <span class="n">number</span> <span class="n">of</span> <span class="n">ports</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="n">on</span> <span class="n">ESC</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl-logger">
<h2>GVL_Logger<a class="headerlink" href="#gvl-logger" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>{attribute &#39;qualified only&#39;}
//Global variables for logging to syslog
VAR_GLOBAL CONSTANT
    (*
    Using the IP address directly avoids DNS configuration issues.
    While we may want to address this in the future, for now the static IP
    will suffice:

    $ nslookup ctl-logsrv01
    Name:   ctl-logsrv01.pcdsn
    Address: 172.21.32.36
    *)
    {attribute &#39;pytmc&#39; := &#39;
        pv: @(PREFIX)LCLSGeneral:LogHost
        io: io
        field: DESC The log host IP address
    &#39;}
    cLogHost                :       STRING(15)      := &#39;172.21.32.36&#39;;

    {attribute &#39;pytmc&#39; := &#39;
        pv: @(PREFIX)LCLSGeneral:LogPort
        io: io
        field: DESC The log host UDP port
    &#39;}
    iLogPort                :       UINT            := 54321;

    sIpTidbit : STRING(6) := &#39;172.21&#39;;

    // Log message circuit breaker configuration

    // Initialization constants for circuit breakers
    nLocalTripThreshold : TIME := T#1ms; // Minimum time between log messages
    nMinTimeViolationAcceptable : INT := 5; // Trip if `nLocalTripThreshold` exceeded `nMinTimeViolationAcceptable` times
    nLocalTrickleTripThreshold : TIME := T#100ms; // Default trickle trip, activated by global threshold
    nTrickleTripTime : TIME := T#10s; // Default time for log-handler to recognize a trickle overload condition, many log-message FB occasionally creating a message
    // such that every PLC cycle is emitting a message (this is considered to be too much).
    nTripResetPeriod : TIME := T#10m; // Default time for CB auto-reset
END_VAR

VAR_GLOBAL
    sPlcHostname    :       STRING          := &#39;unknown&#39;;

    (* Ref: https://infosys.beckhoff.com/english.php?content=../content/1033/tcpipserver/html/TcPlcLibTcpIp_FB_SocketUdpSendTo.htm
        TODO: Activate the &quot;Replace constants&quot; option in the
        TwinCAT PLC Control-&gt;&quot;Project-&gt;Options...-&gt;Build&quot; dialog window.
    *)
    TCPADS_MAXUDP_BUFFSIZE : UDINT :=10000;

    {analysis -33}
    fbRootLogger : FB_LogMessage; //Instantiated here to be used everywhere
    {analysis +33}

    {attribute &#39;pytmc&#39; := &#39;
        pv: @(PREFIX)LCLSGeneral:GlobalLogTrickleTrip
        io: i
        field: DESC Tripped by overall log count
    &#39;}
    bTrickleTripped :   BOOL; // Global trickle trip flag

    {attribute &#39;pytmc&#39; := &#39;
        pv: @(PREFIX)LCLSGeneral:LogMessageCount
        io: i
        field: DESC Total log messages on the last cycle
    &#39;}
    nGlobAccEvents : UDINT; // Global log message count
    nTrickleThreshold : UDINT := 2; // If GlobAccEvents goes over this level for longer than the
END_VAR
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-logmessage">FB_LogMessage</a></p></li>
</ul>
</dd>
</dl>
</section>
</section>
<section id="pous">
<h1>POUs<a class="headerlink" href="#pous" title="Permalink to this heading"></a></h1>
<section id="f-converttickstounixtimestamp">
<h2>F_ConvertTicksToUnixTimestamp<a class="headerlink" href="#f-converttickstounixtimestamp" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_ConvertTicksToUnixTimestamp</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTimestamp</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="o">//</span> <span class="n">Timer</span> <span class="n">ticks</span> <span class="ow">in</span> <span class="n">Windows</span> <span class="n">are</span> <span class="mi">100</span><span class="n">ns</span> <span class="p">(</span><span class="mf">1e-7</span> <span class="n">sec</span><span class="p">)</span>
    <span class="n">nTicksToSeconds</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">10_000_000</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Epoch</span> <span class="n">offset</span> <span class="mi">1601</span> <span class="n">to</span> <span class="mi">1970</span>
    <span class="n">nEpochOffset</span>    <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">11_644_473_600</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">F_ConvertTicksToUnixTimestamp</span> <span class="o">:=</span> <span class="n">ULINT_TO_LREAL</span><span class="p">(</span><span class="n">nTimestamp</span><span class="p">)</span> <span class="o">/</span> <span class="n">nTicksToSeconds</span> <span class="o">-</span> <span class="n">nEpochOffset</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="f-sendudpmessage">
<h2>F_SendUDPMessage<a class="headerlink" href="#f-sendudpmessage" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_SendUDPMessage</span> <span class="p">:</span> <span class="n">HRESULT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">sMessage</span>                        <span class="p">:</span>       <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">fbSocket</span>                        <span class="p">:</span>       <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">FB_ConnectionlessSocket</span><span class="p">;</span>
    <span class="n">sHost</span>                           <span class="p">:</span>       <span class="n">STRING</span><span class="p">;</span>
    <span class="n">iPort</span>                           <span class="p">:</span>       <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">fbSend</span>                          <span class="p">:</span>       <span class="n">FB_SocketUdpSendTo</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">sMessage</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">AND</span> <span class="n">__ISVALIDREF</span><span class="p">(</span><span class="n">fbSocket</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">fbSend</span><span class="o">.</span><span class="n">hSocket</span>          <span class="o">:=</span> <span class="n">fbSocket</span><span class="o">.</span><span class="n">hSocket</span><span class="p">;</span>
    <span class="n">fbSend</span><span class="o">.</span><span class="n">sRemoteHost</span>      <span class="o">:=</span> <span class="n">sHost</span><span class="p">;</span>
    <span class="n">fbSend</span><span class="o">.</span><span class="n">nRemotePort</span>      <span class="o">:=</span> <span class="n">iPort</span><span class="p">;</span>
    <span class="n">fbSend</span><span class="o">.</span><span class="n">pSrc</span>             <span class="o">:=</span> <span class="n">sMessage</span><span class="p">;</span>
    <span class="n">fbSend</span><span class="o">.</span><span class="n">cbLen</span>            <span class="o">:=</span> <span class="n">LEN2</span><span class="p">(</span><span class="n">sMessage</span><span class="p">);</span>
    <span class="n">fbSend</span><span class="o">.</span><span class="n">bExecute</span>         <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fbSend</span><span class="p">();</span>

    <span class="n">fbSend</span><span class="o">.</span><span class="n">bExecute</span>         <span class="n">R</span><span class="o">=</span> <span class="n">fbSend</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="fb-analoginput">
<h2>FB_AnalogInput<a class="headerlink" href="#fb-analoginput" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_AnalogInput</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Converts</span> <span class="n">the</span> <span class="n">integer</span> <span class="kn">from</span> <span class="nn">an</span> <span class="n">analog</span> <span class="nb">input</span> <span class="n">terminal</span> <span class="n">to</span> <span class="n">a</span> <span class="n">real</span> <span class="n">unit</span> <span class="n">value</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="p">,</span> <span class="n">volts</span><span class="p">)</span>
    <span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">09</span> <span class="n">Zachary</span> <span class="n">Lentz</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Connect</span> <span class="n">this</span> <span class="nb">input</span> <span class="n">to</span> <span class="n">the</span> <span class="n">terminal</span>
    <span class="n">iRaw</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">number</span> <span class="n">of</span> <span class="n">bits</span> <span class="n">correlated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">terminal</span><span class="s1">&#39;s max value. This is not necessarily the resolution parameter.</span>
    <span class="n">iTermBits</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fReal</span> <span class="n">value</span> <span class="n">correlated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">terminal</span><span class="s1">&#39;s max value</span>
    <span class="n">fTermMax</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fReal</span> <span class="n">value</span> <span class="n">correlated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">terminal</span><span class="s1">&#39;s min value</span>
    <span class="n">fTermMin</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">real</span> <span class="n">value</span> <span class="n">read</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">output</span>
    <span class="n">fReal</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fScale</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">fScale</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">AND</span> <span class="n">fTermMax</span> <span class="o">&gt;</span> <span class="n">fTermMin</span> <span class="n">THEN</span>
    <span class="n">fScale</span> <span class="o">:=</span> <span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">iTermBits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fTermMax</span> <span class="o">-</span> <span class="n">fTermMin</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">fScale</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">fReal</span> <span class="o">:=</span> <span class="n">iRaw</span> <span class="o">/</span> <span class="n">fScale</span> <span class="o">+</span> <span class="n">fTermMin</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-analogoutput">
<h2>FB_AnalogOutput<a class="headerlink" href="#fb-analogoutput" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_AnalogOutput</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Converts</span> <span class="n">a</span> <span class="n">real</span> <span class="n">unit</span> <span class="n">value</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="p">,</span> <span class="n">volts</span><span class="p">)</span> <span class="n">to</span> <span class="n">the</span> <span class="n">integer</span> <span class="n">needed</span> <span class="k">for</span> <span class="n">an</span> <span class="n">analog</span> <span class="n">output</span> <span class="n">terminal</span><span class="o">.</span>
    <span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">09</span> <span class="n">Zachary</span> <span class="n">Lentz</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">real</span> <span class="n">value</span> <span class="n">to</span> <span class="n">send</span> <span class="n">to</span> <span class="n">the</span> <span class="n">output</span>
    <span class="n">fReal</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">maximum</span> <span class="n">allowed</span> <span class="n">real</span> <span class="n">value</span> <span class="k">for</span> <span class="n">the</span> <span class="n">connected</span> <span class="n">hardware</span>
    <span class="n">fSafeMax</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">minimum</span> <span class="n">allowed</span> <span class="n">real</span> <span class="n">value</span> <span class="k">for</span> <span class="n">the</span> <span class="n">connected</span> <span class="n">hardware</span>
    <span class="n">fSafeMin</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">number</span> <span class="n">of</span> <span class="n">bits</span> <span class="n">correlated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">terminal</span><span class="s1">&#39;s max output. This is not necessarily the resolution parameter.</span>
    <span class="n">iTermBits</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fReal</span> <span class="n">value</span> <span class="n">correlated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">terminal</span><span class="s1">&#39;s max output</span>
    <span class="n">fTermMax</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fReal</span> <span class="n">value</span> <span class="n">correlated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">terminal</span><span class="s1">&#39;s min output</span>
    <span class="n">fTermMin</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Connect</span> <span class="n">this</span> <span class="n">output</span> <span class="n">to</span> <span class="n">the</span> <span class="n">terminal</span>
    <span class="n">iRaw</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fScale</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">scaling</span> <span class="kn">from</span> <span class="nn">real</span> <span class="n">to</span> <span class="n">raw</span>
<span class="n">IF</span> <span class="n">fScale</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">AND</span> <span class="n">fTermMax</span> <span class="o">&gt;</span> <span class="n">fTermMin</span> <span class="n">THEN</span>
    <span class="n">fScale</span> <span class="o">:=</span> <span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">iTermBits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fTermMax</span> <span class="o">-</span> <span class="n">fTermMin</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Adjust</span> <span class="n">real</span> <span class="n">value</span> <span class="n">to</span> <span class="n">be</span> <span class="n">within</span> <span class="n">the</span> <span class="n">limits</span>
<span class="n">fReal</span> <span class="o">:=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">fReal</span><span class="p">,</span> <span class="n">fSafeMax</span><span class="p">,</span> <span class="n">fTermMax</span><span class="p">);</span>
<span class="n">fReal</span> <span class="o">:=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">fReal</span><span class="p">,</span> <span class="n">fSafeMin</span><span class="p">,</span> <span class="n">fTermMin</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Scale</span> <span class="n">the</span> <span class="n">output</span> <span class="n">accordingly</span>
<span class="n">iRaw</span> <span class="o">:=</span> <span class="n">LREAL_TO_INT</span><span class="p">((</span><span class="n">fReal</span> <span class="o">-</span> <span class="n">fTermMin</span><span class="p">)</span> <span class="o">*</span> <span class="n">fScale</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-basicstats">
<h2>FB_BasicStats<a class="headerlink" href="#fb-basicstats" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_BasicStats</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Minimalist</span> <span class="n">Array</span> <span class="n">Stats</span> <span class="k">for</span> <span class="n">LREALs</span>
    <span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">10</span> <span class="n">Zachary</span> <span class="n">Lentz</span>

    <span class="n">Calculates</span> <span class="n">the</span> <span class="n">most</span> <span class="n">basic</span> <span class="n">stats</span> <span class="k">for</span> <span class="n">an</span> <span class="n">array</span> <span class="ow">and</span> <span class="n">provides</span> <span class="n">pytmc</span> <span class="n">control</span> <span class="n">points</span><span class="o">.</span>
    <span class="n">This</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">alternative</span> <span class="n">to</span> <span class="n">the</span> <span class="n">TC3</span> <span class="n">Condition</span> <span class="n">Monitoring</span> <span class="n">library</span> <span class="n">which</span> <span class="n">requires</span> <span class="n">an</span>
    <span class="n">additional</span> <span class="n">license</span> <span class="ow">and</span> <span class="n">had</span> <span class="n">a</span> <span class="n">more</span> <span class="n">complicated</span> <span class="n">interface</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Input</span> <span class="n">array</span> <span class="n">of</span> <span class="n">floats</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATS</span><span class="p">:</span><span class="n">DATA</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">aSignal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">OF</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">will</span> <span class="n">update</span> <span class="n">the</span> <span class="n">results</span> <span class="n">every</span> <span class="n">cycle</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATS:ALWAYS_CALC&#39;</span><span class="p">}</span>
    <span class="n">bAlwaysCalc</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">On</span> <span class="n">rising</span> <span class="n">edge</span><span class="p">,</span> <span class="n">do</span> <span class="n">one</span> <span class="n">calculation</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATS:EXECUTE&#39;</span><span class="p">}</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">reset</span> <span class="n">outputs</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATS:RESET&#39;</span><span class="p">}</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">nonzero</span><span class="p">,</span> <span class="n">we</span> <span class="n">will</span> <span class="n">only</span> <span class="n">pay</span> <span class="n">attention</span> <span class="n">to</span> <span class="n">the</span> <span class="n">first</span> <span class="n">nElems</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">aSignal</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATS</span><span class="p">:</span><span class="n">NELM</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nElems</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Average</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">array</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATS</span><span class="p">:</span><span class="n">MEAN</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fMean</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Standard</span> <span class="n">deviation</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">array</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATS</span><span class="p">:</span><span class="n">STDEV</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fStDev</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Largest</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">array</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATS</span><span class="p">:</span><span class="n">MAX</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fMax</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Smallest</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">array</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATS</span><span class="p">:</span><span class="n">MIN</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fMin</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Largest</span> <span class="n">array</span> <span class="n">element</span> <span class="n">subtracted</span> <span class="n">by</span> <span class="n">the</span> <span class="n">smallest</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATS</span><span class="p">:</span><span class="n">RANGE</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fRange</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">the</span> <span class="n">other</span> <span class="n">outputs</span> <span class="n">are</span> <span class="n">valid</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATS</span><span class="p">:</span><span class="n">VALID</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">bValid</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rTrig</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">nIndex</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">nElemsSeen</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">fSum</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVarianceSum</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVarianceMean</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">rTrig</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">fMean</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">fStDev</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">fMax</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">fMin</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">fRange</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">bExecute</span> <span class="n">OR</span> <span class="n">bAlwaysCalc</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">bAlwaysCalc</span> <span class="n">OR</span> <span class="n">rTrig</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">First</span> <span class="k">pass</span> <span class="n">through</span> <span class="n">aSignal</span><span class="p">:</span> <span class="n">get</span> <span class="nb">sum</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="nb">min</span>
    <span class="n">nElemsSeen</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">fSum</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">fMax</span> <span class="o">:=</span> <span class="n">aSignal</span><span class="p">[</span><span class="n">LOWER_BOUND</span><span class="p">(</span><span class="n">aSignal</span><span class="p">,</span> <span class="mi">1</span><span class="p">)];</span>
    <span class="n">fMin</span> <span class="o">:=</span> <span class="n">fMax</span><span class="p">;</span>
    <span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="n">LOWER_BOUND</span><span class="p">(</span><span class="n">aSignal</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="n">TO</span> <span class="n">UPPER_BOUND</span><span class="p">(</span><span class="n">aSignal</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="n">DO</span>
        <span class="n">nElemsSeen</span> <span class="o">:=</span> <span class="n">nElemsSeen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">fSum</span> <span class="o">:=</span> <span class="n">fSum</span> <span class="o">+</span> <span class="n">aSignal</span><span class="p">[</span><span class="n">nIndex</span><span class="p">];</span>
        <span class="n">IF</span> <span class="n">aSignal</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">fMax</span> <span class="n">THEN</span>
            <span class="n">fMax</span> <span class="o">:=</span> <span class="n">aSignal</span><span class="p">[</span><span class="n">nIndex</span><span class="p">];</span>
        <span class="n">ELSIF</span> <span class="n">aSignal</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">fMin</span> <span class="n">tHEN</span>
            <span class="n">fMin</span> <span class="o">:=</span> <span class="n">aSignal</span><span class="p">[</span><span class="n">nIndex</span><span class="p">];</span>
        <span class="n">END_IF</span>
        <span class="n">IF</span> <span class="n">nElems</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">AND</span> <span class="n">nElemsSeen</span> <span class="o">&gt;=</span> <span class="n">nElems</span> <span class="n">THEN</span>
            <span class="n">EXIT</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_FOR</span>
    <span class="n">IF</span> <span class="n">nElemsSeen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">fMean</span> <span class="o">:=</span> <span class="n">fSum</span> <span class="o">/</span> <span class="n">nElemsSeen</span><span class="p">;</span>
        <span class="n">fRange</span> <span class="o">:=</span> <span class="n">fMax</span> <span class="o">-</span> <span class="n">fMin</span><span class="p">;</span>

        <span class="o">//</span> <span class="n">Second</span> <span class="k">pass</span> <span class="n">through</span> <span class="n">aSignal</span><span class="p">:</span> <span class="n">get</span> <span class="n">the</span> <span class="nb">sum</span> <span class="n">of</span> <span class="n">the</span> <span class="n">variances</span> <span class="ow">and</span> <span class="n">then</span> <span class="n">the</span> <span class="n">stdev</span>
        <span class="n">nElemsSeen</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">fVarianceSum</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="n">LOWER_BOUND</span><span class="p">(</span><span class="n">aSignal</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="n">TO</span> <span class="n">UPPER_BOUND</span><span class="p">(</span><span class="n">aSignal</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="n">DO</span>
            <span class="n">nElemsSeen</span> <span class="o">:=</span> <span class="n">nElemsSeen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">fVarianceSum</span> <span class="o">:=</span> <span class="n">fVarianceSum</span> <span class="o">+</span> <span class="p">(</span><span class="n">aSignal</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span> <span class="o">-</span> <span class="n">fMean</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">aSignal</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span> <span class="o">-</span> <span class="n">fMean</span><span class="p">);</span>
            <span class="n">IF</span> <span class="n">nElems</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">AND</span> <span class="n">nElemsSeen</span> <span class="o">&gt;=</span> <span class="n">nElems</span> <span class="n">THEN</span>
                <span class="n">EXIT</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">END_FOR</span>
        <span class="n">IF</span> <span class="n">nElemsSeen</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="n">THEN</span>
            <span class="n">fVarianceMean</span> <span class="o">:=</span> <span class="n">fVarianceSum</span> <span class="o">/</span> <span class="p">(</span><span class="n">nElemsSeen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
            <span class="n">fStDev</span> <span class="o">:=</span> <span class="n">SQRT</span><span class="p">(</span><span class="n">fVarianceMean</span><span class="p">);</span>
            <span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-circuitbreaker-test">
<h2>FB_CircuitBreaker_Test<a class="headerlink" href="#fb-circuitbreaker-test" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_CircuitBreaker_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">AutoReset</span><span class="p">();</span>
<span class="n">SingleBadLogger</span><span class="p">();</span>
<span class="n">DeathByManySmall</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">AutoReset</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbLog</span> <span class="p">:</span> <span class="n">FB_LogMessage</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">bEnableAutoReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">nTripResetPeriod</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#5s);</span>

    <span class="o">//</span><span class="n">Auto</span> <span class="n">reset</span> <span class="n">test</span>
    <span class="n">tonAutoResetTest</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>

    <span class="n">Init</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Test</span> <span class="n">that</span> <span class="n">the</span> <span class="n">CB</span> <span class="n">resets</span> <span class="n">itself</span> <span class="n">after</span> <span class="n">a</span> <span class="n">cooldown</span> <span class="n">period</span> <span class="o">*</span><span class="p">)</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;AutoReset&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">Init</span> <span class="n">THEN</span>
    <span class="n">fbLog</span><span class="o">.</span><span class="n">CircuitBreaker</span><span class="p">();</span>
    <span class="n">WRITE_PROTECTED_BOOL</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbLog</span><span class="o">.</span><span class="n">bTripped</span><span class="p">),</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">WRITE_PROTECTED_BOOL</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbLog</span><span class="o">.</span><span class="n">bLocalTripped</span><span class="p">),</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbLog</span><span class="o">.</span><span class="n">CircuitBreaker</span><span class="p">();</span>
    <span class="n">fbLog</span><span class="o">.</span><span class="n">CircuitBreaker</span><span class="p">();</span>
    <span class="n">Init</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">tonAutoResetTest</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">Init</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#6s);</span>

<span class="n">IF</span> <span class="n">tonAutoResetTest</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>

    <span class="n">fbLog</span><span class="o">.</span><span class="n">CircuitBreaker</span><span class="p">();</span>

    <span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbLog</span><span class="o">.</span><span class="n">bTripped</span><span class="p">,</span>
        <span class="s1">&#39;Circuit breaker should be reset automatically&#39;</span><span class="p">);</span>

    <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;AutoReset&#39;</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">DeathByManySmall</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbLogNoisy</span> <span class="p">:</span> <span class="n">FB_LogMessage</span><span class="p">;</span>
    <span class="n">tNoisy</span> <span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#50ms); //50ms is &gt; the local trip threshold default of 1ms</span>
    <span class="n">fbLogNice</span> <span class="p">:</span> <span class="n">FB_LogMessage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nTrickleTripThreshold</span><span class="o">:=</span><span class="n">T</span><span class="c1">#2s);</span>
    <span class="n">tNice</span> <span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s);</span>
    <span class="n">tTrickle</span> <span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span> <span class="n">GVL_Logger</span><span class="o">.</span><span class="n">nTrickleTripTime</span> <span class="o">+</span> <span class="n">T</span><span class="c1">#1s);</span>
    <span class="n">fbLogHandler</span> <span class="p">:</span> <span class="n">FB_LogHandler</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;ManySmall&#39;</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">condition</span> <span class="n">where</span>
<span class="o">//</span> <span class="n">a</span> <span class="n">few</span> <span class="n">loggers</span> <span class="n">did</span> <span class="n">their</span> <span class="n">thing</span><span class="p">,</span> <span class="k">while</span> <span class="n">keeping</span> <span class="n">under</span> <span class="n">the</span>
<span class="o">//</span> <span class="n">local</span> <span class="n">logging</span> <span class="n">rate</span> <span class="n">limit</span> <span class="n">until</span> <span class="n">the</span> <span class="k">global</span> <span class="n">trickle</span> <span class="n">trip</span>
<span class="o">//</span> <span class="n">was</span> <span class="n">triggered</span><span class="o">.</span> <span class="n">Then</span> <span class="n">verify</span> <span class="n">only</span> <span class="n">those</span> <span class="n">loggers</span> <span class="n">that</span>
<span class="o">//</span> <span class="n">were</span> <span class="n">just</span> <span class="n">a</span> <span class="n">little</span> <span class="n">too</span> <span class="n">noisy</span><span class="p">,</span> <span class="n">would</span> <span class="n">trip</span> <span class="n">off</span><span class="p">,</span> <span class="k">while</span> <span class="n">others</span> <span class="n">stayed</span> <span class="n">up</span><span class="o">.</span>

<span class="n">fbLogHandler</span><span class="o">.</span><span class="n">CircuitBreaker</span><span class="p">();</span>

<span class="o">//</span> <span class="n">Call</span> <span class="n">this</span> <span class="n">guy</span> <span class="n">every</span> <span class="mi">50</span><span class="n">ms</span> <span class="ow">or</span> <span class="n">so</span><span class="o">.</span>
<span class="n">tNoisy</span><span class="p">(</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">tNoisy</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tNoisy</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">fbLogNoisy</span><span class="o">.</span><span class="n">CircuitBreaker</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Call</span> <span class="n">this</span> <span class="n">guy</span> <span class="n">every</span> <span class="mi">5</span><span class="n">s</span> <span class="ow">or</span> <span class="n">so</span>
<span class="n">tNice</span><span class="p">(</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">tNoisy</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tNice</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">fbLogNice</span><span class="o">.</span><span class="n">CircuitBreaker</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="n">tTrickle</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">tTrickle</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbLogNoisy</span><span class="o">.</span><span class="n">bLocalTrickleTripped</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbLogNice</span><span class="o">.</span><span class="n">bLocalTrickleTripped</span><span class="p">,</span>
            <span class="s1">&#39;Only Noisy should be tripped.&#39;</span><span class="p">);</span>
    <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;ManySmall&#39;</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">SingleBadLogger</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">idx</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbLog</span> <span class="p">:</span> <span class="n">FB_LogMessage</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">bEnableAutoReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">nTripResetPeriod</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#5s);</span>
<span class="n">END_VAR</span>
<span class="n">ResetCircuitBreakerGlobals</span><span class="p">();</span>

<span class="p">(</span><span class="o">*</span> <span class="n">In</span> <span class="n">this</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">a</span> <span class="n">logger</span> <span class="n">trips</span> <span class="n">off</span> <span class="n">because</span> <span class="n">it</span> <span class="n">has</span> <span class="n">been</span> <span class="n">called</span> <span class="n">too</span> <span class="n">many</span> <span class="n">times</span>
<span class="ow">in</span> <span class="n">one</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">leading</span> <span class="n">to</span> <span class="n">a</span> <span class="n">large</span> <span class="n">excess</span> <span class="n">of</span> <span class="n">messages</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;LocalFastTrip&#39;</span><span class="p">);</span>
    <span class="n">FOR</span> <span class="n">idx</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GVL_LOGGER</span><span class="o">.</span><span class="n">nMinTimeViolationAcceptable</span> <span class="o">+</span> <span class="mi">1</span> <span class="n">DO</span>
        <span class="n">fbLog</span><span class="o">.</span><span class="n">CircuitBreaker</span><span class="p">();</span>
    <span class="n">END_FOR</span>

    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbLog</span><span class="o">.</span><span class="n">bLocalTripped</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbLog</span><span class="o">.</span><span class="n">bLocalTrickleTripped</span><span class="p">,</span>
        <span class="s1">&#39;Only local trip should occur in these conditions&#39;</span><span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-loghandler">FB_LogHandler</a></p></li>
<li><p><a class="reference internal" href="#fb-logmessage">FB_LogMessage</a></p></li>
<li><p><a class="reference internal" href="#gvl-logger">GVL_Logger</a></p></li>
<li><p><a class="reference internal" href="#resetcircuitbreakerglobals">ResetCircuitBreakerGlobals</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-coe-fastread">
<h2>FB_CoE_FastRead<a class="headerlink" href="#fb-coe-fastread" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_CoE_FastRead</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Utility</span> <span class="n">to</span> <span class="n">repeatedly</span> <span class="n">read</span> <span class="n">a</span> <span class="n">CoE</span> <span class="n">parameter</span>
    <span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">09</span> <span class="n">Zachary</span> <span class="n">Lentz</span>

    <span class="n">In</span> <span class="n">practice</span><span class="p">,</span> <span class="n">it</span><span class="s1">&#39;s impossible to read most CoE parameters every cycle,</span>
    <span class="n">but</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">best</span> <span class="n">effort</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">work</span> <span class="k">if</span> <span class="n">the</span> <span class="n">data</span> <span class="ow">is</span> <span class="n">available</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span> <span class="n">we</span><span class="s1">&#39;ll attempt a CoE read this cycle.</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Link</span> <span class="n">this</span> <span class="n">to</span> <span class="n">your</span> <span class="n">terminal</span><span class="s1">&#39;s drive reference variables under InfoData.</span>
    <span class="n">stPlcDriveRef</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">ST_PlcDriveRef</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Hexadecimal</span> <span class="n">index</span> <span class="n">of</span> <span class="n">CoE</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">the</span> <span class="mi">8010</span> <span class="ow">in</span> <span class="mi">8010</span><span class="p">:</span><span class="mi">12</span>
    <span class="n">nIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Hexadecimal</span> <span class="n">subindex</span> <span class="n">of</span> <span class="n">CoE</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">the</span> <span class="mi">12</span> <span class="ow">in</span> <span class="mi">8010</span><span class="p">:</span><span class="mi">12</span>
    <span class="n">nSubIndex</span><span class="p">:</span> <span class="n">BYTE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Pointer</span> <span class="n">to</span> <span class="n">a</span> <span class="n">value</span> <span class="n">to</span> <span class="n">fill</span> <span class="k">with</span> <span class="n">the</span> <span class="n">result</span> <span class="n">of</span> <span class="n">the</span> <span class="n">read</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">ADR</span><span class="p">(</span><span class="n">MyValue</span><span class="p">)</span>
    <span class="n">pDstBuf</span><span class="p">:</span> <span class="n">PVOID</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Data</span> <span class="n">size</span> <span class="n">of</span> <span class="n">pDstBuf</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">MyValue</span><span class="p">)</span>
    <span class="n">cbBufLen</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">the</span> <span class="n">value</span> <span class="n">was</span> <span class="n">updated</span> <span class="n">on</span> <span class="n">this</span> <span class="n">cycle</span><span class="o">.</span>
    <span class="n">bNewValue</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbRead</span><span class="p">:</span> <span class="n">FB_CoERead_ByDriveRef</span><span class="p">;</span>
    <span class="n">stDriveRef</span><span class="p">:</span> <span class="n">ST_DriveRef</span><span class="p">;</span>
    <span class="n">iLoop</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bInnerExec</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">stDriveRef</span><span class="o">.</span><span class="n">sNetId</span> <span class="o">:=</span> <span class="n">F_CreateAmsNetId</span><span class="p">(</span><span class="n">stPlcDriveRef</span><span class="o">.</span><span class="n">aNetId</span><span class="p">);</span>
<span class="n">stDriveRef</span><span class="o">.</span><span class="n">nSlaveAddr</span> <span class="o">:=</span> <span class="n">stPlcDriveRef</span><span class="o">.</span><span class="n">nSlaveAddr</span><span class="p">;</span>
<span class="n">stDriveRef</span><span class="o">.</span><span class="n">nDriveNo</span> <span class="o">:=</span> <span class="n">stPlcDriveRef</span><span class="o">.</span><span class="n">nDriveNo</span><span class="p">;</span>
<span class="n">stDriveRef</span><span class="o">.</span><span class="n">nDriveType</span> <span class="o">:=</span> <span class="n">stPlcDriveRef</span><span class="o">.</span><span class="n">nDriveType</span><span class="p">;</span>

<span class="n">bNewValue</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bExecute</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">You</span> <span class="n">need</span> <span class="n">to</span> <span class="n">do</span> <span class="n">this</span> <span class="n">block</span> <span class="mi">3</span> <span class="n">times</span> <span class="n">per</span> <span class="n">cycle</span> <span class="n">to</span> <span class="n">have</span> <span class="n">a</span> <span class="n">chance</span> <span class="n">at</span> <span class="n">always</span> <span class="n">getting</span> <span class="n">a</span> <span class="n">read</span>
    <span class="n">FOR</span> <span class="n">iLoop</span><span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">3</span> <span class="n">DO</span>
        <span class="n">fbRead</span><span class="p">(</span>
            <span class="n">stDriveRef</span> <span class="o">:=</span> <span class="n">stDriveRef</span><span class="p">,</span>
            <span class="n">nIndex</span> <span class="o">:=</span> <span class="n">nIndex</span><span class="p">,</span>
            <span class="n">nSubIndex</span> <span class="o">:=</span> <span class="n">nSubIndex</span><span class="p">,</span>
            <span class="n">pDstBuf</span> <span class="o">:=</span> <span class="n">pDstBuf</span><span class="p">,</span>
            <span class="n">cbBufLen</span> <span class="o">:=</span> <span class="n">cbBufLen</span><span class="p">,</span>
            <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bInnerExec</span><span class="p">,</span>
            <span class="n">tTimeout</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#1s);</span>

        <span class="n">IF</span> <span class="n">bInnerExec</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbRead</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbRead</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bNewValue</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_FOR</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-databuffer">
<h2>FB_DataBuffer<a class="headerlink" href="#fb-databuffer" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_DataBuffer</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Function</span> <span class="n">Block</span> <span class="n">to</span> <span class="n">accumulate</span> <span class="n">data</span> <span class="n">into</span> <span class="n">an</span> <span class="n">array</span><span class="o">.</span>
    <span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">09</span> <span class="n">Zachary</span> <span class="n">Lentz</span>

    <span class="n">Requires</span> <span class="n">the</span> <span class="n">user</span> <span class="n">to</span> <span class="n">supply</span> <span class="n">pointers</span> <span class="n">to</span> <span class="n">the</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">to</span> <span class="mi">2</span> <span class="n">arrays</span><span class="p">:</span>
    <span class="mf">1.</span> <span class="n">A</span> <span class="n">partial</span> <span class="n">buffer</span> <span class="n">that</span> <span class="n">we</span> <span class="n">will</span> <span class="n">slowly</span> <span class="n">fill</span> <span class="n">one</span> <span class="n">value</span> <span class="n">at</span> <span class="n">a</span> <span class="n">time</span>
    <span class="mf">2.</span> <span class="n">An</span> <span class="n">output</span> <span class="n">buffer</span> <span class="n">that</span> <span class="n">will</span> <span class="n">only</span> <span class="n">update</span> <span class="n">when</span> <span class="n">the</span> <span class="n">partial</span> <span class="n">buffer</span> <span class="ow">is</span> <span class="n">full</span>

    <span class="n">Take</span> <span class="n">great</span> <span class="n">care</span> <span class="n">of</span> <span class="n">the</span> <span class="n">following</span><span class="p">,</span> <span class="ow">or</span> <span class="k">else</span> <span class="n">your</span> <span class="n">program</span> <span class="n">will</span> <span class="n">likely</span> <span class="n">crash</span><span class="p">,</span>
    <span class="ow">or</span> <span class="n">at</span> <span class="n">least</span> <span class="n">have</span> <span class="n">corrupt</span> <span class="n">data</span><span class="p">:</span>
    <span class="mf">1.</span> <span class="n">The</span> <span class="nb">input</span> <span class="nb">type</span> <span class="ow">and</span> <span class="n">array</span> <span class="n">types</span> <span class="n">must</span> <span class="n">match</span>
    <span class="mf">2.</span> <span class="n">The</span> <span class="n">provided</span> <span class="n">element</span> <span class="n">count</span> <span class="n">must</span> <span class="n">be</span> <span class="n">accurate</span> <span class="ow">and</span> <span class="n">match</span> <span class="n">both</span> <span class="n">arrays</span>
    <span class="mf">3.</span> <span class="n">The</span> <span class="n">provided</span> <span class="n">element</span> <span class="n">size</span> <span class="ow">is</span> <span class="n">correct</span>

    <span class="n">As</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="k">as</span> <span class="n">no</span> <span class="n">way</span> <span class="n">of</span> <span class="n">checking</span> <span class="n">that</span> <span class="n">you</span> <span class="n">did</span> <span class="n">this</span> <span class="n">correctly</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Whether</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">to</span> <span class="n">accumulate</span> <span class="n">on</span> <span class="n">this</span> <span class="n">cycle</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Address</span> <span class="n">of</span> <span class="n">the</span> <span class="n">value</span> <span class="n">to</span> <span class="n">accumulate</span>
    <span class="n">pInputAdr</span><span class="p">:</span> <span class="n">PVOID</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Size</span> <span class="n">of</span> <span class="n">the</span> <span class="n">accumulated</span> <span class="n">value</span>
    <span class="n">iInputSize</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">output</span> <span class="n">array</span>
    <span class="n">iElemCount</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Address</span> <span class="n">of</span> <span class="n">the</span> <span class="n">rolling</span> <span class="n">buffer</span> <span class="n">to</span> <span class="n">be</span> <span class="n">filled</span> <span class="n">every</span> <span class="n">cycle</span>
    <span class="n">pPartialAdr</span><span class="p">:</span> <span class="n">PVOID</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Address</span> <span class="n">of</span> <span class="n">the</span> <span class="n">output</span> <span class="n">buffer</span> <span class="n">to</span> <span class="n">be</span> <span class="n">filled</span> <span class="n">when</span> <span class="n">the</span> <span class="n">rolling</span> <span class="n">buffer</span> <span class="ow">is</span> <span class="n">full</span>
    <span class="n">pOutputAdr</span><span class="p">:</span> <span class="n">PVOID</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">on</span> <span class="n">the</span> <span class="n">cycle</span> <span class="n">that</span> <span class="n">we</span> <span class="n">copy</span> <span class="n">the</span> <span class="n">output</span> <span class="n">array</span>
    <span class="n">bNewArray</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">iArrayIndex</span><span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">bNewArray</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bExecute</span> <span class="n">THEN</span>
    <span class="n">MEMCPY</span><span class="p">(</span>
        <span class="n">destAddr</span> <span class="o">:=</span> <span class="n">pPartialAdr</span> <span class="o">+</span> <span class="n">iArrayIndex</span><span class="o">*</span><span class="n">iInputSize</span><span class="p">,</span>
        <span class="n">srcAddr</span> <span class="o">:=</span> <span class="n">pInputAdr</span><span class="p">,</span>
        <span class="n">n</span> <span class="o">:=</span> <span class="n">iInputSize</span><span class="p">);</span>
    <span class="n">iArrayIndex</span> <span class="o">:=</span> <span class="n">iArrayIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">iArrayIndex</span> <span class="o">&gt;=</span> <span class="n">iElemCount</span> <span class="n">THEN</span>
        <span class="n">MEMCPY</span><span class="p">(</span>
            <span class="n">destAddr</span> <span class="o">:=</span> <span class="n">pOutputAdr</span><span class="p">,</span>
            <span class="n">srcAddr</span> <span class="o">:=</span> <span class="n">pPartialAdr</span><span class="p">,</span>
            <span class="n">n</span> <span class="o">:=</span> <span class="n">iElemCount</span><span class="o">*</span><span class="n">iInputSize</span><span class="p">);</span>
        <span class="n">iArrayIndex</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">bNewArray</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-ecatdiag">
<h2>FB_EcatDiag<a class="headerlink" href="#fb-ecatdiag" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span>
<span class="n">Ecat</span> <span class="n">bus</span> <span class="n">diagnostic</span> <span class="n">tool</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">4</span> <span class="n">Alex</span> <span class="n">Wallace</span>
<span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">checks</span> <span class="n">the</span> <span class="n">states</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">slaves</span> <span class="n">on</span> <span class="n">the</span> <span class="n">ecat</span> <span class="n">bus</span> <span class="n">network</span><span class="p">,</span>
<span class="n">it</span> <span class="n">could</span> <span class="n">be</span> <span class="n">modified</span> <span class="n">to</span> <span class="n">export</span> <span class="n">the</span> <span class="n">states</span> <span class="n">of</span> <span class="n">the</span> <span class="n">slaves</span> <span class="n">on</span> <span class="n">an</span> <span class="n">individual</span> <span class="n">basis</span><span class="p">,</span>
<span class="n">but</span> <span class="k">for</span> <span class="n">now</span> <span class="n">it</span> <span class="n">sets</span> <span class="n">the</span> <span class="n">output</span> <span class="n">boolean</span> <span class="n">true</span> <span class="k">if</span> <span class="nb">all</span> <span class="n">slaves</span> <span class="n">are</span> <span class="n">OP</span> <span class="ow">and</span> <span class="n">false</span> <span class="n">otherwise</span><span class="o">.</span>
<span class="n">To</span> <span class="n">start</span> <span class="n">the</span> <span class="n">block</span> <span class="n">provide</span> <span class="n">a</span> <span class="n">falling</span> <span class="n">edge</span> <span class="n">on</span> <span class="n">the</span> <span class="n">first</span> <span class="k">pass</span> <span class="n">boolean</span> <span class="nb">input</span><span class="o">.</span>

<span class="mi">2018</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span> <span class="n">Margaret</span> <span class="n">Ghaly</span>
<span class="n">Function</span> <span class="n">block</span> <span class="n">has</span> <span class="n">been</span> <span class="n">modified</span> <span class="n">to</span> <span class="n">retrieve</span> <span class="n">the</span> <span class="n">Device</span> <span class="n">State</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Ethercat</span> <span class="n">Master</span><span class="o">.</span>
<span class="n">It</span> <span class="n">also</span> <span class="n">exports</span> <span class="n">the</span> <span class="n">states</span> <span class="ow">and</span> <span class="n">information</span> <span class="n">of</span> <span class="n">each</span> <span class="n">individual</span> <span class="n">configured</span> <span class="n">Slave</span><span class="o">.</span>
<span class="n">And</span> <span class="n">saves</span> <span class="n">them</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">array</span> <span class="n">q_aEcConfSlaveInfo</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_EcatDiag</span>
<span class="n">VAR_INPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;naming&#39;</span> <span class="o">:=</span> <span class="s1">&#39;omit&#39;</span><span class="p">}</span>
    <span class="n">I_AMSNetId</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">AMSNETID</span><span class="p">;</span> <span class="o">//</span><span class="n">Link</span> <span class="n">to</span> <span class="n">the</span> <span class="n">AMSNETID</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">ethercat</span> <span class="n">master</span> <span class="n">info</span><span class="o">.</span>
    <span class="n">i_xFirstPass</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Hook</span> <span class="n">to</span> <span class="n">system</span> <span class="n">first</span> <span class="k">pass</span> <span class="n">boolean</span> <span class="k">for</span> <span class="n">proper</span> <span class="n">intialization</span> <span class="p">(</span><span class="n">must</span> <span class="n">be</span> <span class="n">true</span> <span class="k">for</span> <span class="n">the</span> <span class="n">first</span> <span class="n">cycle</span> <span class="n">of</span> <span class="n">the</span> <span class="n">PLC</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">q_xAllSlaveStatesGood</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">all</span> <span class="n">Slaves</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">OP</span> <span class="n">State</span>
    <span class="n">q_anTermStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..256</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BYTE</span><span class="p">;</span> <span class="o">//</span><span class="n">ECAT</span> <span class="n">State</span> <span class="n">of</span> <span class="n">terminals</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">bus</span>
    <span class="n">q_xMasterStateGood</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">the</span> <span class="n">Master</span> <span class="n">Device</span> <span class="n">State</span> <span class="ow">is</span> <span class="n">OP</span>
    <span class="n">q_nMasterState</span><span class="p">:</span> <span class="n">WORD</span><span class="p">;</span> <span class="o">//</span> <span class="n">The</span> <span class="n">Device</span> <span class="n">State</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Master</span>
    <span class="n">q_sMasterState</span><span class="p">:</span><span class="n">STRING</span><span class="p">;</span> <span class="o">//</span><span class="n">State</span> <span class="n">of</span> <span class="n">the</span> <span class="n">ECAT</span> <span class="n">master</span>
    <span class="n">q_astEcConfSlaveInfo</span> <span class="p">:</span>  <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..256</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_EcDevice</span><span class="p">;</span> <span class="o">//</span><span class="n">State</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">ECAT</span> <span class="n">slaves</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">bus</span>
    <span class="n">q_nSlaves</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">the</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">the</span> <span class="n">connected</span> <span class="n">Slaves</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">sNetId</span><span class="p">:</span> <span class="n">T_AmsNetId</span><span class="p">;</span> <span class="o">//</span><span class="n">NetId</span> <span class="n">string</span>
    <span class="n">astTermStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..256</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_EcSlaveState</span><span class="p">;</span> <span class="o">//</span><span class="n">ECAT</span> <span class="n">Slave</span> <span class="n">States</span> <span class="n">Buffer</span>
    <span class="n">astEcConfSlaveInfo</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..256</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_EcSlaveConfigData</span><span class="p">;</span> <span class="o">//</span><span class="n">ECAT</span> <span class="n">Slave</span> <span class="n">Configs</span> <span class="n">Buffer</span>
    <span class="n">fbGetAllSlaveStates</span><span class="p">:</span> <span class="n">FB_EcGetAllSlaveStates</span><span class="p">;</span> <span class="o">//</span><span class="n">Acquires</span> <span class="n">the</span> <span class="n">ECAT</span> <span class="n">Slave</span> <span class="n">States</span> <span class="n">puts</span> <span class="n">them</span> <span class="n">into</span> <span class="n">astTermStates</span>

    <span class="n">fbGetMasterState</span><span class="p">:</span> <span class="n">FB_EcGetMasterState</span><span class="p">;</span> <span class="o">//</span><span class="n">Acquires</span> <span class="n">ECAT</span> <span class="n">Master</span> <span class="n">State</span>
    <span class="n">fbGetConfSlaves</span><span class="p">:</span> <span class="n">FB_EcGetConfSlaves</span><span class="p">;</span> <span class="o">//</span><span class="n">Acquires</span> <span class="n">the</span> <span class="n">ECAT</span> <span class="n">slave</span> <span class="n">configuration</span> <span class="n">of</span> <span class="n">the</span> <span class="n">bus</span> <span class="p">(</span><span class="n">how</span> <span class="n">many</span><span class="p">,</span> <span class="n">what</span> <span class="n">kind</span><span class="p">,</span> <span class="n">etc</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;naming&#39;</span> <span class="o">:=</span> <span class="s1">&#39;omit&#39;</span><span class="p">}</span>
    <span class="n">ftReset</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span> <span class="o">//</span><span class="n">Reset</span> <span class="n">trigger</span> <span class="n">sensor</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;naming&#39;</span> <span class="o">:=</span> <span class="s1">&#39;omit&#39;</span><span class="p">}</span>
    <span class="n">ftMasterReset</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span> <span class="o">//</span><span class="n">Retrigger</span> <span class="n">sensor</span> <span class="k">for</span> <span class="n">GetMasterState</span>
    <span class="n">nIterator</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span> <span class="o">//</span><span class="n">Generic</span> <span class="n">iterator</span> <span class="n">placeholder</span>
<span class="n">END_VAR</span>
<span class="o">//</span><span class="n">Create</span> <span class="n">the</span> <span class="n">net</span> <span class="n">ID</span> <span class="n">string</span>
<span class="n">sNetId</span> <span class="o">:=</span> <span class="n">F_CreateAmsNetId</span><span class="p">(</span><span class="n">I_AMSNetId</span><span class="p">);</span>

<span class="o">//</span><span class="n">Query</span> <span class="n">the</span> <span class="n">state</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">terminals</span><span class="p">,</span> <span class="n">collect</span> <span class="ow">in</span> <span class="n">astTermStates</span>
<span class="n">ftReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">fbGetAllSlaveStates</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">i_xFirstPass</span><span class="p">);</span>
<span class="n">fbGetAllSlaveStates</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">ftReset</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">fbGetAllSlaveStates</span><span class="p">(</span><span class="n">sNetId</span><span class="o">:=</span><span class="n">sNetId</span><span class="p">,</span> <span class="n">pStateBuf</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">astTermStates</span><span class="p">),</span> <span class="n">cbBufLen</span><span class="o">:=</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">astTermStates</span><span class="p">));</span>
<span class="o">//</span><span class="n">Keep</span> <span class="n">checking</span><span class="o">...</span>



<span class="o">//</span><span class="n">Cycle</span> <span class="n">through</span> <span class="n">each</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">array</span> <span class="ow">and</span> <span class="n">check</span> <span class="k">if</span> <span class="n">we</span> <span class="n">have</span> <span class="n">anyone</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">OP</span> <span class="ow">and</span> <span class="n">that</span> <span class="n">the</span> <span class="n">link</span> <span class="n">state</span> <span class="ow">is</span> <span class="n">good</span><span class="o">.</span>
<span class="o">//</span> <span class="n">If</span> <span class="n">so</span><span class="p">,</span> <span class="n">then</span> <span class="nb">set</span> <span class="n">our</span> <span class="k">global</span> <span class="n">IO</span> <span class="n">bad</span> <span class="n">boolean</span><span class="o">.</span>
<span class="n">IF</span> <span class="n">fbGetAllSlaveStates</span><span class="o">.</span><span class="n">nSlaves</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">q_xAllSlaveStatesGood</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIterator</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="p">(</span><span class="n">UINT_TO_INT</span><span class="p">(</span><span class="n">fbGetAllSlaveStates</span><span class="o">.</span><span class="n">nSlaves</span><span class="p">)</span> <span class="p">)</span> <span class="n">BY</span> <span class="mi">1</span>
    <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">NOT</span><span class="p">(</span> <span class="p">(</span><span class="n">astTermStates</span><span class="p">[</span><span class="n">nIterator</span><span class="p">]</span><span class="o">.</span><span class="n">deviceState</span> <span class="o">=</span> <span class="n">EC_DEVICE_STATE_OP</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">astTermStates</span><span class="p">[</span><span class="n">nIterator</span><span class="p">]</span><span class="o">.</span><span class="n">linkState</span> <span class="o">=</span> <span class="n">EC_LINK_STATE_OK</span><span class="p">))</span> <span class="n">THEN</span>
        <span class="n">q_xAllSlaveStatesGood</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">q_anTermStates</span><span class="p">[</span><span class="n">nIterator</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astTermStates</span><span class="p">[</span><span class="n">nIterator</span><span class="p">]</span><span class="o">.</span><span class="n">deviceState</span><span class="p">;</span>
    <span class="n">q_astEcConfSlaveInfo</span><span class="p">[</span><span class="n">nIterator</span><span class="p">]</span><span class="o">.</span><span class="n">nDeviceState</span> <span class="o">:=</span><span class="n">astTermStates</span><span class="p">[</span><span class="n">nIterator</span><span class="p">]</span><span class="o">.</span><span class="n">deviceState</span><span class="p">;</span><span class="o">//</span>
    <span class="n">q_astEcConfSlaveInfo</span><span class="p">[</span><span class="n">nIterator</span><span class="p">]</span><span class="o">.</span><span class="n">nLinkState</span> <span class="o">:=</span><span class="n">astTermStates</span><span class="p">[</span><span class="n">nIterator</span><span class="p">]</span><span class="o">.</span><span class="n">linkState</span><span class="p">;</span><span class="o">//</span>
    <span class="n">q_astEcConfSlaveInfo</span><span class="p">[</span><span class="n">nIterator</span><span class="p">]</span><span class="o">.</span><span class="n">sDeviceState</span><span class="o">:=</span> <span class="n">F_ConvSlaveStateToString</span><span class="p">(</span><span class="n">state</span><span class="o">:=</span><span class="n">astTermStates</span><span class="p">[</span><span class="n">nIterator</span><span class="p">]);</span><span class="o">//</span>

<span class="n">END_FOR</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Read</span> <span class="n">the</span> <span class="n">EtherCAT</span> <span class="n">state</span> <span class="n">of</span> <span class="n">the</span> <span class="n">master</span><span class="o">.</span> <span class="n">If</span> <span class="n">the</span> <span class="n">call</span> <span class="ow">is</span> <span class="n">successful</span><span class="p">,</span>
<span class="o">//</span><span class="n">the</span> <span class="n">State</span> <span class="n">output</span> <span class="n">variable</span> <span class="n">of</span> <span class="nb">type</span> <span class="n">WORD</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">requested</span> <span class="n">status</span> <span class="n">information</span><span class="o">.</span>
<span class="n">ftMasterReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">fbGetMasterState</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">i_xFirstPass</span><span class="p">);</span>
<span class="n">fbGetMasterState</span><span class="p">(</span><span class="n">sNetId</span><span class="o">:=</span> <span class="n">sNetId</span><span class="p">,</span> <span class="n">bExecute</span><span class="o">:=</span><span class="n">ftMasterReset</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
                <span class="n">state</span> <span class="o">=&gt;</span> <span class="n">q_nMasterState</span><span class="p">,</span><span class="n">bError</span><span class="o">=&gt;</span><span class="p">,</span>
                <span class="n">nErrId</span><span class="o">=&gt;</span><span class="p">);</span>
<span class="n">q_xMasterStateGood</span><span class="o">:=</span> <span class="p">(</span><span class="n">fbGetMasterState</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">BYTE_TO_UINT</span><span class="p">(</span><span class="n">EC_DEVICE_STATE_OP</span><span class="p">));</span>
<span class="n">q_sMasterState</span> <span class="o">:=</span> <span class="n">F_ConvMasterDevStateToString</span><span class="p">(</span><span class="n">fbGetMasterState</span><span class="o">.</span><span class="n">state</span><span class="p">);</span>

<span class="o">//</span><span class="n">This</span> <span class="n">function</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">to</span> <span class="n">read</span> <span class="n">a</span> <span class="nb">list</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">configured</span> <span class="n">slaves</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">EtherCat</span> <span class="n">master</span> <span class="nb">object</span> <span class="n">Directory</span>
<span class="o">//</span><span class="n">needs</span> <span class="n">to</span> <span class="n">run</span> <span class="n">only</span> <span class="n">once</span>
<span class="n">fbGetConfSlaves</span><span class="p">(</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">i_xFirstPass</span><span class="p">,</span> <span class="n">sNetId</span> <span class="o">:=</span><span class="n">sNetId</span><span class="p">,</span> <span class="n">pArrEcConfSlaveInfo</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">astEcConfSlaveInfo</span><span class="p">),</span><span class="n">cbBufLen</span> <span class="o">:=</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">astEcConfSlaveInfo</span><span class="p">));</span>
<span class="n">q_nSlaves</span><span class="o">:=</span><span class="n">fbGetConfSlaves</span><span class="o">.</span><span class="n">nSlaves</span><span class="p">;</span>

<span class="n">IF</span>  <span class="n">NOT</span> <span class="p">(</span><span class="n">fbGetConfSlaves</span><span class="o">.</span><span class="n">bBusy</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">FOR</span> <span class="n">nIterator</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="p">(</span><span class="n">UINT_TO_INT</span><span class="p">(</span><span class="n">fbGetConfSlaves</span><span class="o">.</span><span class="n">nSlaves</span><span class="p">)</span> <span class="p">)</span> <span class="n">BY</span> <span class="mi">1</span>
    <span class="n">DO</span>
    <span class="n">q_astEcConfSlaveInfo</span><span class="p">[</span><span class="n">nIterator</span><span class="p">]</span><span class="o">.</span><span class="n">nAddrr</span> <span class="o">:=</span><span class="n">astEcConfSlaveInfo</span><span class="p">[</span><span class="n">nIterator</span><span class="p">]</span><span class="o">.</span><span class="n">nAddr</span><span class="p">;</span>
    <span class="n">q_astEcConfSlaveInfo</span><span class="p">[</span><span class="n">nIterator</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span><span class="n">astEcConfSlaveInfo</span><span class="p">[</span><span class="n">nIterator</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span><span class="p">;</span>
    <span class="n">q_astEcConfSlaveInfo</span><span class="p">[</span><span class="n">nIterator</span><span class="p">]</span><span class="o">.</span><span class="n">sType</span> <span class="o">:=</span><span class="n">astEcConfSlaveInfo</span><span class="p">[</span><span class="n">nIterator</span><span class="p">]</span><span class="o">.</span><span class="n">sType</span><span class="p">;</span>
<span class="n">END_FOR</span>
    <span class="n">fbGetConfSlaves</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-ecdevice">ST_EcDevice</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-ecatdiagwrapper">
<h2>FB_EcatDiagWrapper<a class="headerlink" href="#fb-ecatdiagwrapper" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_EcatDiagWrapper</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bAllFrameWcStatesOK</span>             <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                         <span class="o">//</span> <span class="nb">all</span> <span class="n">frames</span> <span class="n">are</span> <span class="n">OK</span>
    <span class="n">bEtherCATOK</span>                             <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                         <span class="o">//</span> <span class="n">no</span> <span class="n">problem</span> <span class="n">on</span> <span class="n">EtherCAT</span>
    <span class="n">bFrameWcStateError</span>              <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                         <span class="o">//</span> <span class="n">at</span> <span class="n">least</span> <span class="n">one</span> <span class="n">fram</span> <span class="k">with</span> <span class="n">error</span>
    <span class="n">bSlaveCountError</span>                <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                         <span class="o">//</span> <span class="n">EtherCAT</span> <span class="n">slave</span> <span class="n">count</span> <span class="n">mismatch</span> <span class="p">(</span><span class="c1"># of cfg slaves &lt;&gt; # of found slaves)</span>
    <span class="n">bMasterDevStateError</span>    <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                         <span class="o">//</span> <span class="n">EtherCAT</span> <span class="n">master</span> <span class="n">device</span> <span class="n">state</span> <span class="n">signals</span> <span class="n">error</span>
    <span class="n">stMasterDevState</span>                <span class="p">:</span> <span class="n">ST_EcMasterDevState</span><span class="p">;</span> <span class="o">//</span> <span class="n">device</span> <span class="n">state</span> <span class="n">split</span> <span class="n">to</span> <span class="n">a</span> <span class="n">structure</span>
    <span class="n">bBusy</span>                                   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                         <span class="o">//</span> <span class="n">diagnostic</span> <span class="n">FB</span> <span class="ow">is</span> <span class="n">busy</span>
    <span class="n">bError</span>                                  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                         <span class="o">//</span> <span class="n">diagnostic</span> <span class="n">FB</span> <span class="n">has</span> <span class="n">an</span> <span class="n">error</span>
    <span class="n">iErrorID</span>                                <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>                        <span class="o">//</span> <span class="n">error</span> <span class="n">ID</span> <span class="n">of</span> <span class="n">diagnostic</span> <span class="n">FB</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

    <span class="p">(</span><span class="o">*</span> <span class="o">*******************</span> <span class="n">EtherCAT</span> <span class="n">Frame</span> <span class="o">*****************************</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fbEtherCATFrameDiag</span>             <span class="p">:</span> <span class="n">FB_EtherCATFrameDiag</span><span class="p">;</span> <span class="o">//</span> <span class="n">frame</span> <span class="n">diagnostic</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;TIID^Device 1 (EtherCAT)^Inputs^Frm1WcState&#39;</span><span class="p">}</span>
    <span class="n">wFrmXWcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>             <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>                         <span class="o">//</span> <span class="n">link</span> <span class="n">to</span> <span class="n">task</span> <span class="n">related</span> <span class="n">ethercat</span> <span class="n">frame</span> <span class="n">state</span> <span class="p">(</span><span class="n">Frm1WcState</span><span class="p">)</span>
    <span class="n">wReqZeroMask</span>                    <span class="p">:</span> <span class="n">WORD</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#FFFF;      // clear bit to ignore datagram error of Frm1WcState</span>
    <span class="n">bFrameWcStateOK</span>                 <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                         <span class="o">//</span> <span class="n">this</span> <span class="n">frame</span> <span class="ow">is</span> <span class="n">OK</span>

    <span class="p">(</span><span class="o">*</span> <span class="o">*******************</span> <span class="n">EtherCAT</span> <span class="n">Diag</span> <span class="o">*****************************</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fbEtherCATDiag</span>                  <span class="p">:</span> <span class="n">FB_EtherCATDiag</span><span class="p">;</span>      <span class="o">//</span> <span class="n">deep</span> <span class="n">EtherCAT</span> <span class="n">diagnostic</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">cyclic</span> <span class="n">variables</span> <span class="kn">from</span> <span class="nn">EtherCAT</span> <span class="n">Master</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;TIID^Device 1 (EtherCAT)^Inputs^SlaveCount&#39;</span><span class="p">}</span>
    <span class="n">nEcMasterSlaveCount</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>      <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>                 <span class="o">//</span> <span class="n">link</span> <span class="n">to</span> <span class="n">SlaveCount</span> <span class="n">of</span> <span class="n">EtherCAT</span> <span class="n">Master</span> <span class="p">(</span><span class="n">Inputs</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;TIID^Device 1 (EtherCAT)^Inputs^DevState&#39;</span><span class="p">}</span>
    <span class="n">nEcMasterDevState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>        <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>                 <span class="o">//</span> <span class="n">link</span> <span class="n">to</span> <span class="n">DevState</span> <span class="n">of</span> <span class="n">EtherCAT</span> <span class="n">Master</span> <span class="p">(</span><span class="n">Inputs</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;TIID^Device 1 (EtherCAT)^InfoData^DevId&#39;</span><span class="p">}</span>
    <span class="n">nEcMasterDeviceId</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>        <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>                 <span class="o">//</span> <span class="n">link</span> <span class="n">to</span> <span class="n">DevID</span> <span class="n">of</span> <span class="n">EtherCAT</span> <span class="n">Master</span> <span class="p">(</span><span class="n">InfoData</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;TIID^Device 1 (EtherCAT)^InfoData^AmsNetId&#39;</span><span class="p">}</span>
    <span class="n">arrEcMasterNetId</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>         <span class="p">:</span> <span class="n">T_AmsNetIdArr</span><span class="p">;</span><span class="o">//</span> <span class="n">link</span> <span class="n">to</span> <span class="n">NetID</span> <span class="n">of</span> <span class="n">EtherCAT</span> <span class="n">Master</span> <span class="p">(</span><span class="n">InfoData</span><span class="p">)</span>
    <span class="n">sEcMasterNetId</span>                          <span class="p">:</span> <span class="n">T_AmsNetId</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;TIID^Device 1 (EtherCAT)^InfoData^CfgSlaveCount&#39;</span><span class="p">}</span>
    <span class="n">nEcMasterSlaveCountCfg</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>   <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>         <span class="o">//</span> <span class="n">link</span> <span class="n">to</span> <span class="n">CfgSlaveCount</span> <span class="n">of</span> <span class="n">EtherCAT</span> <span class="n">Master</span> <span class="p">(</span><span class="n">InfoData</span><span class="p">)</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">general</span> <span class="n">variables</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">arrDiagSlaveInfo</span>                        <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">ESC_MAX_PORTS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_SlaveStateInfo</span><span class="p">;</span>                <span class="o">//</span> <span class="n">read</span> <span class="ow">in</span> <span class="n">info</span> <span class="n">of</span> <span class="n">configured</span> <span class="n">EtherCAT</span> <span class="n">slaves</span>
    <span class="n">arrDiagSlaveInfoScanned</span>         <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">ESC_MAX_PORTS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_SlaveStateInfoScanned</span><span class="p">;</span> <span class="o">//</span> <span class="n">read</span> <span class="ow">in</span> <span class="n">info</span> <span class="n">of</span> <span class="n">scanned</span> <span class="n">EtherCAT</span> <span class="n">slaves</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">***************************************</span> <span class="n">Frame</span> <span class="n">Diag</span> <span class="o">*********************************************</span><span class="p">)</span>
<span class="n">fbEtherCATFrameDiag</span><span class="p">(</span>
    <span class="n">wFrmXWcState</span>    <span class="o">:=</span> <span class="n">wFrmXWcState</span><span class="p">,</span>
    <span class="n">wReqZeroMask</span>    <span class="o">:=</span> <span class="n">wReqZeroMask</span><span class="p">,</span>
    <span class="n">bFrameWcStateOK</span> <span class="o">=&gt;</span> <span class="n">bFrameWcStateOK</span>
<span class="p">);</span>
<span class="n">bAllFrameWcStatesOK</span> <span class="o">:=</span> <span class="n">bFrameWcStateOK</span><span class="p">;</span>

<span class="p">(</span><span class="o">***************************************</span> <span class="n">EtherCAT</span> <span class="n">Diag</span> <span class="o">*********************************************</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">generate</span> <span class="n">Net</span> <span class="n">Id</span> <span class="o">*</span><span class="p">)</span>
<span class="n">sEcMasterNetId</span> <span class="o">:=</span> <span class="n">F_CreateAmsNetId</span><span class="p">(</span><span class="n">nIds</span> <span class="o">:=</span> <span class="n">arrEcMasterNetId</span><span class="p">);</span>
<span class="n">fbEtherCATDiag</span><span class="p">(</span>
    <span class="n">sIPCNetID</span>                       <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">sMasterNetID</span>            <span class="o">:=</span> <span class="n">sEcMasterNetId</span><span class="p">,</span>
    <span class="n">nMasterDevID</span>            <span class="o">:=</span> <span class="n">nEcMasterDeviceId</span><span class="p">,</span>
    <span class="n">nSlaveCount</span>                     <span class="o">:=</span> <span class="n">nEcMasterSlaveCount</span><span class="p">,</span>
    <span class="n">nSlaveCountCfg</span>          <span class="o">:=</span> <span class="n">nEcMasterSlaveCountCfg</span><span class="p">,</span>
    <span class="n">nMasterDevState</span>         <span class="o">:=</span> <span class="n">nEcMasterDevState</span><span class="p">,</span>
    <span class="n">bAllFrameWcStatesOK</span>     <span class="o">:=</span> <span class="n">bAllFrameWcStatesOK</span><span class="p">,</span>
    <span class="n">tTimeout</span>                        <span class="o">:=</span> <span class="n">T</span><span class="c1">#5s,</span>
    <span class="n">arrDiagSlaveInfo</span>        <span class="o">:=</span> <span class="n">arrDiagSlaveInfo</span><span class="p">,</span>
    <span class="n">arrDiagSlaveInfoScanned</span> <span class="o">:=</span> <span class="n">arrDiagSlaveInfoScanned</span><span class="p">,</span>
    <span class="n">bEtherCATOK</span>                     <span class="o">=&gt;</span> <span class="n">bEtherCATOK</span><span class="p">,</span>
    <span class="n">bFrameWcStateError</span>      <span class="o">=&gt;</span> <span class="n">bFrameWcStateError</span><span class="p">,</span>
    <span class="n">bSlaveCountError</span>        <span class="o">=&gt;</span> <span class="n">bSlaveCountError</span><span class="p">,</span>
    <span class="n">bMasterDevStateError</span><span class="o">=&gt;</span> <span class="n">bMasterDevStateError</span><span class="p">,</span>
    <span class="n">stMasterDevState</span>        <span class="o">=&gt;</span> <span class="n">stMasterDevState</span><span class="p">,</span>
    <span class="n">bBusy</span>                           <span class="o">=&gt;</span> <span class="n">bBusy</span><span class="p">,</span>
    <span class="n">bError</span>                          <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
    <span class="n">iErrorID</span>                        <span class="o">=&gt;</span> <span class="n">iErrorID</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-ethercatdiag">FB_EtherCATDiag</a></p></li>
<li><p><a class="reference internal" href="#fb-ethercatframediag">FB_EtherCATFrameDiag</a></p></li>
<li><p><a class="reference internal" href="#st-ecmasterdevstate">ST_EcMasterDevState</a></p></li>
<li><p><a class="reference internal" href="#st-slavestateinfo">ST_SlaveStateInfo</a></p></li>
<li><p><a class="reference internal" href="#st-slavestateinfoscanned">ST_SlaveStateInfoScanned</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-el6-com">
<h2>FB_EL6_Com<a class="headerlink" href="#fb-el6-com" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_EL6_Com</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Communicate</span> <span class="k">with</span> <span class="n">a</span> <span class="n">serial</span> <span class="n">device</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">an</span> <span class="n">EL6XXX</span>
    <span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">09</span> <span class="n">Zachary</span> <span class="n">Lentz</span> <span class="ow">and</span> <span class="n">Jackson</span> <span class="n">Sheppard</span>

    <span class="n">May</span> <span class="n">contain</span> <span class="n">assumptions</span> <span class="n">about</span> <span class="n">the</span> <span class="n">device</span> <span class="n">we</span> <span class="n">wrote</span> <span class="n">it</span> <span class="k">for</span><span class="p">,</span> <span class="n">potentially</span> <span class="n">will</span> <span class="n">need</span> <span class="n">to</span> <span class="n">be</span> <span class="n">adjusted</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Command</span> <span class="n">to</span> <span class="n">send</span> <span class="n">to</span> <span class="n">the</span> <span class="n">serial</span> <span class="n">device</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">CMD</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">sCmd</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Pulse</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="ow">and</span> <span class="n">back</span> <span class="n">to</span> <span class="n">FALSE</span> <span class="n">when</span> <span class="n">it</span><span class="s1">&#39;s time to send</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SEND</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">bSend</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Any</span> <span class="n">static</span> <span class="n">prefix</span> <span class="n">to</span> <span class="n">add</span> <span class="n">before</span> <span class="n">every</span> <span class="n">sent</span> <span class="n">message</span>
    <span class="n">sSendPrefix</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Any</span> <span class="n">static</span> <span class="n">suffix</span> <span class="n">to</span> <span class="n">add</span> <span class="n">after</span> <span class="n">every</span> <span class="n">sent</span> <span class="n">message</span>
    <span class="n">sSendSuffix</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Any</span> <span class="n">static</span> <span class="n">prefix</span> <span class="n">to</span> <span class="n">strip</span> <span class="n">off</span> <span class="n">of</span> <span class="n">every</span> <span class="n">recieved</span> <span class="n">message</span>
    <span class="n">sRecvPrefix</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Any</span> <span class="n">static</span> <span class="n">suffic</span> <span class="n">to</span> <span class="n">strip</span> <span class="n">off</span> <span class="n">of</span> <span class="n">every</span> <span class="n">recieved</span> <span class="n">message</span>
    <span class="n">sRecvSuffix</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">tTimeout</span><span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#1S;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stIn_EL6</span><span class="p">:</span> <span class="n">EL6inData22B</span><span class="p">;</span>
    <span class="n">stOut_EL6</span><span class="p">:</span> <span class="n">EL6outData22B</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">response</span> <span class="n">recieved</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">serial</span> <span class="n">device</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">RESP</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
    <span class="s1">&#39;}</span>
    <span class="n">sResponse</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">This</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">after</span> <span class="n">recieving</span> <span class="n">a</span> <span class="n">response</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">DONE</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
    <span class="s1">&#39;}</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERR</span><span class="p">:</span><span class="n">SER</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
    <span class="s1">&#39;}</span>
    <span class="n">eSerialLineErrorID</span><span class="p">:</span> <span class="n">ComError_t</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERR</span><span class="p">:</span><span class="n">SEND</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
    <span class="s1">&#39;}</span>
    <span class="n">eSendErrorID</span><span class="p">:</span> <span class="n">ComError_t</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERR</span><span class="p">:</span><span class="n">RECV</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
    <span class="s1">&#39;}</span>
    <span class="n">eRecvErrorID</span><span class="p">:</span> <span class="n">ComError_t</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">Communication</span> <span class="n">Buffers</span>
    <span class="n">TxBuffer</span><span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
    <span class="n">RxBuffer</span><span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
    <span class="n">fbClearComBuffer</span><span class="p">:</span> <span class="n">ClearComBuffer</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Parameters</span> <span class="k">for</span> <span class="n">PLC</span> <span class="o">-&gt;</span> <span class="n">EL6</span>
    <span class="n">fbEL6Ctrl</span><span class="p">:</span> <span class="n">SerialLineControl</span><span class="p">;</span>
    <span class="n">bEL6CtrlError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">eEL6CtrlErrorID</span><span class="p">:</span> <span class="n">ComError_t</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Parameters</span> <span class="k">for</span> <span class="n">EL6</span> <span class="o">-&gt;</span> <span class="n">Serial</span> <span class="n">Device</span>
    <span class="n">fbSend</span><span class="p">:</span> <span class="n">SendString</span><span class="p">;</span>
    <span class="n">bSendBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">eLastSendErrorID</span><span class="p">:</span> <span class="n">ComError_t</span><span class="p">;</span>
    <span class="n">fbReceive</span><span class="p">:</span> <span class="n">ReceiveString</span><span class="p">;</span>
    <span class="n">sReceivedString</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">sLastReceivedString</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">bStringReceived</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReceiveBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReceiveError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">eReceiveErrorID</span><span class="p">:</span> <span class="n">ComError_t</span><span class="p">;</span>
    <span class="n">bReceiveTimeout</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nReceiveCounter</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nSendCounter</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">sStringToSend</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">fbFormatString</span><span class="p">:</span> <span class="n">FB_FormatString</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Parameters</span> <span class="k">for</span> <span class="n">state</span><span class="o">-</span><span class="n">machine</span> <span class="n">implementation</span>
    <span class="n">nStep</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbEL6Ctrl</span><span class="p">(</span>
    <span class="n">Mode</span><span class="o">:=</span> <span class="n">SERIALLINEMODE_EL6_22B</span><span class="p">,</span>
    <span class="n">pComIn</span><span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">stIn_EL6</span><span class="p">),</span>
    <span class="n">pComOut</span><span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">stOut_EL6</span><span class="p">),</span>
    <span class="n">SizeComIn</span><span class="o">:=</span> <span class="n">UINT_TO_INT</span><span class="p">(</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">stIn_EL6</span><span class="p">)),</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="n">eSerialLineErrorID</span><span class="p">,</span>
    <span class="n">TxBuffer</span><span class="o">:=</span> <span class="n">TxBuffer</span><span class="p">,</span>
    <span class="n">RxBuffer</span><span class="o">:=</span> <span class="n">RxBuffer</span> <span class="p">);</span>
<span class="n">IF</span> <span class="n">fbEL6Ctrl</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
    <span class="n">bEL6CtrlError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">eEL6CtrlErrorID</span> <span class="o">:=</span> <span class="n">fbEL6Ctrl</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">bSend</span> <span class="n">THEN</span>
    <span class="n">nStep</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">bSend</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Attempt</span> <span class="n">at</span> <span class="n">solution</span> <span class="n">that</span> <span class="n">sends</span> <span class="n">one</span> <span class="n">command</span> <span class="n">at</span> <span class="n">a</span> <span class="n">time</span><span class="p">,</span> <span class="ow">not</span> <span class="n">on</span> <span class="n">constant</span> <span class="n">loop</span>
<span class="n">CASE</span> <span class="n">nStep</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span>
        <span class="p">;</span> <span class="o">//</span> <span class="n">idle</span>
    <span class="mi">10</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">Clear</span> <span class="n">buffers</span> <span class="ow">in</span> <span class="n">case</span> <span class="nb">any</span> <span class="n">lingering</span> <span class="n">data</span>
        <span class="n">fbClearComBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="o">:=</span><span class="n">TxBuffer</span><span class="p">);</span>
        <span class="n">fbClearComBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="o">:=</span><span class="n">RxBuffer</span><span class="p">);</span>
        <span class="o">//</span> <span class="n">Prepare</span> <span class="n">string</span> <span class="n">to</span> <span class="n">send</span>
        <span class="n">sStringToSend</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sSendPrefix</span><span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sCmd</span><span class="p">,</span> <span class="n">sSendSuffix</span><span class="p">));</span>
        <span class="o">//</span> <span class="n">Send</span> <span class="n">string</span>
        <span class="n">fbSend</span><span class="p">(</span>     <span class="n">SendString</span><span class="o">:=</span> <span class="n">sStringToSend</span><span class="p">,</span>
                <span class="n">TXbuffer</span><span class="o">:=</span> <span class="n">TxBuffer</span><span class="p">,</span>
                <span class="n">Busy</span><span class="o">=&gt;</span> <span class="n">bSendBusy</span><span class="p">,</span>
                <span class="n">Error</span><span class="o">=&gt;</span> <span class="n">eSendErrorID</span><span class="p">);</span>
        <span class="n">IF</span> <span class="n">fbSend</span><span class="o">.</span><span class="n">Error</span> <span class="o">&lt;&gt;</span> <span class="n">COMERROR_NOERROR</span> <span class="n">THEN</span>
            <span class="n">eLastSendErrorID</span> <span class="o">:=</span> <span class="n">fbSend</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">nSendCounter</span> <span class="o">:=</span> <span class="n">nSendCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">END_IF</span>
        <span class="n">nStep</span> <span class="o">:=</span> <span class="n">nStep</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
    <span class="mi">20</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">Finish</span> <span class="n">sending</span> <span class="n">String</span>
        <span class="n">IF</span> <span class="n">fbSend</span><span class="o">.</span><span class="n">Busy</span> <span class="n">THEN</span>
            <span class="n">fbSend</span><span class="p">(</span> <span class="n">SendString</span><span class="o">:=</span> <span class="n">sStringToSend</span><span class="p">,</span>
                    <span class="n">TXbuffer</span><span class="o">:=</span> <span class="n">TxBuffer</span><span class="p">,</span>
                    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="n">bSendBusy</span><span class="p">,</span>
                    <span class="n">Error</span><span class="o">=&gt;</span> <span class="n">eSendErrorID</span><span class="p">);</span>
            <span class="n">IF</span> <span class="n">fbSend</span><span class="o">.</span><span class="n">Error</span> <span class="o">&lt;&gt;</span> <span class="n">COMERROR_NOERROR</span> <span class="n">THEN</span>
                <span class="n">eLastSendErrorID</span> <span class="o">:=</span> <span class="n">fbSend</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
            <span class="n">ELSE</span>
                <span class="n">nSendCounter</span> <span class="o">:=</span> <span class="n">nSendCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">ELSE</span>
            <span class="n">nStep</span> <span class="o">:=</span> <span class="n">nStep</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="mi">30</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">Get</span> <span class="n">Reply</span>
        <span class="n">fbReceive</span><span class="p">(</span>
            <span class="n">Prefix</span><span class="o">:=</span> <span class="n">sRecvPrefix</span><span class="p">,</span>
            <span class="n">Suffix</span><span class="o">:=</span> <span class="n">sRecvSuffix</span><span class="p">,</span>
            <span class="n">Timeout</span><span class="o">:=</span> <span class="n">tTimeout</span><span class="p">,</span>
            <span class="n">ReceivedString</span><span class="o">:=</span> <span class="n">sReceivedString</span><span class="p">,</span>
            <span class="n">RXbuffer</span><span class="o">:=</span> <span class="n">RxBuffer</span><span class="p">,</span>
            <span class="n">StringReceived</span><span class="o">=&gt;</span> <span class="n">bStringReceived</span><span class="p">,</span>
            <span class="n">Busy</span><span class="o">=&gt;</span> <span class="n">bReceiveBusy</span><span class="p">,</span>
            <span class="n">Error</span><span class="o">=&gt;</span> <span class="n">eRecvErrorID</span><span class="p">,</span>
            <span class="n">RxTimeout</span><span class="o">=&gt;</span> <span class="n">bReceiveTimeout</span> <span class="p">);</span>
        <span class="n">IF</span> <span class="n">fbReceive</span><span class="o">.</span><span class="n">Error</span> <span class="o">&lt;&gt;</span> <span class="n">COMERROR_NOERROR</span> <span class="n">THEN</span>
            <span class="n">eReceiveErrorID</span> <span class="o">:=</span> <span class="n">fbReceive</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
        <span class="n">END_IF</span>
        <span class="n">IF</span> <span class="n">bStringReceived</span> <span class="n">THEN</span>
            <span class="n">nReceiveCounter</span> <span class="o">:=</span> <span class="n">nReceiveCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="o">//</span> <span class="n">Check</span> <span class="k">for</span> <span class="n">response</span>
            <span class="n">IF</span> <span class="n">FIND</span><span class="p">(</span><span class="n">sReceivedString</span><span class="p">,</span> <span class="n">sStringToSend</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span> <span class="n">THEN</span>
                <span class="n">sResponse</span> <span class="o">:=</span> <span class="n">sReceivedString</span><span class="p">;</span>
                <span class="n">bDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="n">nStep</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">END_IF</span>
<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-epicscentroidmonitor">
<h2>FB_EpicsCentroidMonitor<a class="headerlink" href="#fb-epicscentroidmonitor" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(*
    EPICS AreaDetector Stats Plugin Centroid Monitor

    Requirements:

    * Requires an existing IOC with an EPICS AreaDetector.
    * Requires an AreaDetector plugin chain that includes a stats plugin.
    * Requires a pytmc &quot;link&quot; pragma to specify the plugin PV prefix.

    What information is included?

    * Centroid X position
    * Centroid Y position
    * Array count index
    * The validity of the data, as determined by:
        - The ArrayCounter_RBV PV changing
        - Alarm severity of the PVs
        - The centroid value changing, even minimally

    Example:

        {attribute &#39;pytmc&#39; := &#39;
            pv: @(PREFIX):Chk:Centroid1
            link: AREA:DETECTOR:CAM:01:Stats2:
        &#39;}
        fbCentroid : FB_EpicsCentroidMonitor;

        fbCentroid(bEnable:=TRUE, fMinimumValidChange:=1E-6, fNewFrameMinimumChange:=1E-6);
        IF fbCentroid.bValid AND fbCentroid.bIsUpdating THEN
            fbCentroid.fCentroidX;
            fbCentroid.fCentroidY;
            fbCentroid.nArrayCount;
            fbCentroid.fFrameTime;
        END_IF

    Above, ``AREA:DETECTOR:CAM:01:Stats2`` should refer to the PV prefix of a
    stats plugin.
    That is, ``caget AREA:DETECTOR:CAM:01:Stats2:ArrayCounter_RBV`` should not
    fail.

    How does this work?

    pytmc offers the ability to push EPICS process variable data into PLCs by
    way of link pragmas.  These link pragmas create additional supporting EPICS
    records that monitor PVs from any IOC on the controls network. In this case,
    the PLC IOC will monitor vital AreaDetector plugin record data and let your
    PLC project know of its status.

    Why are there multiple thresholds I have to specify?

    ``fNewFrameMinimumChange`` is the minimum change in pixels to say that
    when the array counter changes, these are the new values for X and Y.
    While this seems a bit confusing (or perhaps unnecessary), we do not
    know when the array counters or centroid values will be updated.  These
    do not get written in a single, atomic write to the PLC. We may see an
    updated array count and then a centroid X change and then a Y change.
    This threshold is a way of working around that complexity and saying
    the new data is here only when it&#39;s changed at least a bit and we have
    a new frame number.

    ``fMinimumValidChange``, which by default is set to the same as the above
    threshold, says that if the centroid value doesn&#39;t change by at least this
    on a frame-to-frame basis, consider this a result of a faulty AreaDetector
    implementation.  The monitor would report values below this threshold as
    &quot;not updating&quot; - ``bIsUpdating`` as ``FALSE``.

    What needs to happen to get new centroid values?

    - An updated array count
    - An updated X centroid value (above fNewFrameMinimumChange)
    - An updated Y centroid value (above fNewFrameMinimumChange)
    - NO_ALARM severities for all values

    This will result in an updated:

    - fFrameTime (seconds between valid frames)

    What needs to happen for ``bIsUpdating`` to be TRUE?

    - All items from the above &quot;new centroid values&quot;
    - Frame time below fMaximumFrameTime
    - Centroid X and Y values above fMinimumValidChange

*)
FUNCTION_BLOCK FB_EpicsCentroidMonitor
VAR_INPUT
    fMaximumFrameTime : LREAL := 0.2;
    (* Minimum change to be considered updating correctly - buggy detectors may need this. *)
    fMinimumValidChange : LREAL := 1E-6;
    (* Minimum change in pixels to be considered a new value for X, Y *)
    fNewFrameMinimumChange : LREAL := 1E-6;
    bEnable : BOOL := TRUE;
END_VAR
VAR_OUTPUT
    {attribute &#39;pytmc&#39; := &#39;
        pv: IsUpdating
        io: input
    &#39;}
    bIsUpdating : BOOL;
    {attribute &#39;pytmc&#39; := &#39;
        pv: CentroidX
        io: input
    &#39;}
    fCentroidX : LREAL;
    {attribute &#39;pytmc&#39; := &#39;
        pv: CentroidY
        io: input
    &#39;}
    fCentroidY : LREAL;
    {attribute &#39;pytmc&#39; := &#39;
        pv: ArrayCount
        io: input
    &#39;}
    nArrayCount : UDINT;
    bValid : BOOL;
    {attribute &#39;pytmc&#39; := &#39;
        pv: FrameTime
        io: input
        field: DESC Time between frame updates
        field: EGU sec
    &#39;}
    fFrameTime : LREAL;
END_VAR
VAR
    {attribute &#39;pytmc&#39; := &#39;
        pv: CX_
        link: CentroidX_RBV
    &#39;}
    fbCentroidX : FB_LREALFromEPICS;

    {attribute &#39;pytmc&#39; := &#39;
        pv: CY_
        link: CentroidY_RBV
    &#39;}
    fbCentroidY : FB_LREALFromEPICS;

    fLastCentroidX : LREAL;
    fLastCentroidY : LREAL;

    {attribute &#39;pytmc&#39; := &#39;
        pv: Cnt_
        link: ArrayCounter_RBV
    &#39;}
    fbArrayCounter : FB_LREALFromEPICS;

    // Last array count value
    nLastArrayCount : UDINT;
    // Time of the last frame update
    tLastUpdate: TIME;

    bInit : BOOL;
    // Did we see a frame update yet? (FALSE at startup; TRUE after first frame.)
    bSawFrame : BOOL;
    // Do we have a new frame? Has the array count updated, and position change above fNewFrameMinimumChange?
    bHaveNewFrame : BOOL;
    // For this new frame, is it above the threshold fMinimumValidChange?
    bAboveThreshold : BOOL;

END_VAR
IF NOT bEnable THEN
    bValid := FALSE;
    RETURN;
END_IF

IF NOT bInit THEN
    tLastUpdate := TIME();
    fFrameTime := 1000.0;
    bSawFrame := FALSE;
    bInit := TRUE;
END_IF

fbCentroidX();
fbCentroidY();
fbArrayCounter();

bValid := (
    fbCentroidX.bValid AND
    fbCentroidY.bValid AND
    fbArrayCounter.bValid
);

fCentroidX := fbCentroidX.fValue;
fCentroidY := fbCentroidY.fValue;
nArrayCount := LREAL_TO_UDINT(fbArrayCounter.fValue);

(*
    Only consider that we have a new frame if:
    1. The array count has been updated
    2. X and Y values have changed even minimally
        a. With background noise, this should not be a problem.
        b. With an invalid black/white/stale image, this will indicate
           &#39;no new frame&#39; despite an increasing array count.
*)
bHaveNewFrame := (
    nArrayCount &lt;&gt; nLastArrayCount AND
    ABS(fLastCentroidX - fCentroidX) &gt;= fNewFrameMinimumChange AND
    ABS(fLastCentroidY - fCentroidY) &gt;= fNewFrameMinimumChange AND
    TRUE
);

IF bHaveNewFrame THEN
    bAboveThreshold := (
        ABS(fLastCentroidX - fCentroidX) &gt;= fMinimumValidChange AND
        ABS(fLastCentroidY - fCentroidY) &gt;= fMinimumValidChange
    );

    fFrameTime := TIME_TO_LREAL(TIME() - tLastUpdate) * 0.001; // Milliseconds -&gt; seconds
    tLastUpdate := TIME();
    nLastArrayCount := nArrayCount;
    bSawFrame := TRUE;

    fLastCentroidX := fCentroidX;
    fLastCentroidY := fCentroidY;
END_IF

bIsUpdating := bSawFrame AND (fFrameTime &lt;= fMaximumFrameTime) AND bAboveThreshold;

END_FUNCTION_BLOCK
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-lrealfromepics">FB_LREALFromEPICS</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-epicsmotormonitor">
<h2>FB_EpicsMotorMonitor<a class="headerlink" href="#fb-epicsmotormonitor" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(*
    EPICS Motor Record Monitoring tool

    Requirements:

    * Requires an existing IOC with an EPICS motor record.
    * Requires a pytmc &quot;link&quot; pragma to specify the motor record prefix.

    What information is included?

    * The validity of the source data (as determined by alarm severity)
    * Readback value (scaled encoder position in ``fPosition``)
    * Motion status (moving or not, ``bIsMoving``)
    * Homed status, limit status, and others (via ``stMSTA``, see
      ``ST_EpicsMotorMSTA``).

    Example:

        {attribute &#39;pytmc&#39; := &#39;
            pv: @(PREFIX):Internal:Mon
            link: MOTOR:PV:NAME
        &#39;}
        fbMotorMonitor : FB_EpicsMotorMonitor;

        fbMotorMonitor(bEnable:=TRUE);
        IF fbMotorMonitor.bValid THEN
            fbMotorMonitor.fPosition;
            fbMotorMonitor.bIsMoving;
            fbMotorMonitor.stMSTA.bHomed;
        END_IF

    Above, ``MOTOR:PV:NAME`` should refer to an EPICS motor record.
    That is, ``caget MOTOR:PV:NAME.RTYP`` should return &quot;motor&quot;.

    How does this work?

    pytmc offers the ability to push EPICS process variable data into PLCs by
    way of link pragmas.  These link pragmas create additional supporting EPICS
    records that monitor PVs from any IOC on the controls network. In this case,
    the PLC IOC will monitor vital motor record information and let your PLC
    project know of its status.

    Note that not all motor records may be created equally.  Some of the status
    fields may not be consistent.  Be sure to check how your motor works and
    what fields are worth paying attention to when using this.

*)
FUNCTION_BLOCK FB_EpicsMotorMonitor
VAR_INPUT
    bEnable : BOOL := TRUE;
END_VAR
VAR_OUTPUT
    bIsMoving : BOOL;
    fPosition : LREAL;
    nMSTA_Raw : UINT;
    stMSTA : ST_EpicsMotorMSTA;
    bValid : BOOL;
END_VAR
VAR
    {attribute &#39;pytmc&#39; := &#39;
        pv: RBV_
        link: .RBV
    &#39;}
    fbRBVCheck : FB_LREALFromEPICS;

    {attribute &#39;pytmc&#39; := &#39;
        pv: Dmov_
        link: .DMOV
    &#39;}
    fbMovingCheck : FB_LREALFromEPICS;

    {attribute &#39;pytmc&#39; := &#39;
        pv: Msta_
        link: .MSTA
    &#39;}
    fbMotorStatusCheck : FB_LREALFromEPICS;
END_VAR
IF NOT bEnable THEN
    bValid := FALSE;
    RETURN;
END_IF

fbRBVCheck();
fbMovingCheck();
fbMotorStatusCheck();
bValid := (
    fbRBVCheck.bValid AND
    fbMovingCheck.bValid AND
    fbMotorStatusCheck.bValid
);

(* Moving status is DMOV; this comes in as a floating point value
     DMOV = 0 -&gt; moving
     DMOV = 1 -&gt; done moving, or not moving
*)
bIsMoving := ABS(fbMovingCheck.fValue) &lt; 1e-5;
fPosition := fbRBVCheck.fValue;

nMSTA_Raw := LREAL_TO_UINT(fbMotorStatusCheck.fValue);
stMSTA.bPositiveDirection := nMSTA_Raw.0;
stMSTA.bDone := nMSTA_Raw.1;
stMSTA.bPlusLimitSwitch := nMSTA_Raw.2;
stMSTA.bHomeLimitSwitch := nMSTA_Raw.3;
stMSTA.bUnused0 := nMSTA_Raw.4;
stMSTA.bClosedLoop := nMSTA_Raw.5;
stMSTA.bSlipStall := nMSTA_Raw.6;
stMSTA.bHome := nMSTA_Raw.7;
stMSTA.bEncoderPresent := nMSTA_Raw.8;
stMSTA.bHardwareProblem := nMSTA_Raw.9;
stMSTA.bMoving := nMSTA_Raw.10;
stMSTA.bGainSupport := nMSTA_Raw.11;
stMSTA.bCommError := nMSTA_Raw.12;
stMSTA.bMinusLimitSwitch := nMSTA_Raw.13;
stMSTA.bHomed := nMSTA_Raw.14;

END_FUNCTION_BLOCK
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-lrealfromepics">FB_LREALFromEPICS</a></p></li>
<li><p><a class="reference internal" href="#st-epicsmotormsta">ST_EpicsMotorMSTA</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-ethercatdiag">
<h2>FB_EtherCATDiag<a class="headerlink" href="#fb-ethercatdiag" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_EtherCATDiag
VAR_INPUT
    sIPCNetID                                       : T_AmsNetId;   // AmsNetId of the IPC
    sMasterNetID                            : T_AmsNetId;   // AmsNetId of the EtherCAT master device
    nMasterDevID                            : UINT;                 // Device ID of EtherCAT master
    nSlaveCount                             : UINT;                 // current slave count
    nSlaveCountCfg                          : UINT;                 // configured slave count
    nMasterDevState                         : WORD;                 // device state of EtherCAT Master
    bAllFrameWcStatesOK                     : BOOL;                 // all FrameWcState OK?
    tTimeout                                        : TIME := T#5S; // ads timeout
    eSubSystem : E_Subsystem := E_Subsystem.FIELDBUS; // Subsystem, change to (MPS, VACUUM, MOTION, etc)
END_VAR
VAR_OUTPUT
    bEtherCATOK                                     : BOOL;                 // no problem on EtherCAT
    bFrameWcStateError                      : BOOL;                 // error in at least one frame
    bSlaveCountError                        : BOOL;                 // EtherCAT slave count mismatch (# of cfg slaves &lt;&gt; # of found slaves)
    bMasterDevStateError            : BOOL;                 // error in master device state
    stMasterDevState                        : ST_EcMasterDevState; // splitted master device state
    bBusy                                           : BOOL;                 // FB busy
    bError                                          : BOOL;                 // FB with error
    iErrorID                                        : UDINT;                // FB error ID
END_VAR
VAR_IN_OUT
    arrDiagSlaveInfo                        : ARRAY [0..ESC_MAX_PORTS] OF ST_SlaveStateInfo;                // read in info from configured slaves
    arrDiagSlaveInfoScanned         : ARRAY [0..ESC_MAX_PORTS] OF ST_SlaveStateInfoScanned; // read in info from scanned slaves
END_VAR
VAR
    iState                                          : E_EcatDiagState;
    nMasterDevStatePrev                     : WORD;
    bSlaveCountErrorPrev            : BOOL;
    bAllFrameWcStatesOKPrev         : BOOL;
    bDiagReq                                        : BOOL := TRUE;
    I                                                       : UDINT;
    P                                                       : UDINT;

    arrSlaveInfo                            : ARRAY [0..iSLAVEADDR_ARR_SIZE] OF ST_SlaveStateInfo;
    rSlaveInfo  :   REFERENCE TO ST_SlaveStateInfo;

    (* -- Get Slave Addresses *)
    fbGetSlaveAddresses             : FB_EcGetAllSlaveAddr;
    arrSlaveAddresses                       : ARRAY[0..iSLAVEADDR_ARR_SIZE] OF UINT;
    iNumOfSlavesRead                        : UINT;

    (* -- Get Slave States *)
    fbGetAllSlaveStates                     : FB_EcGetAllSlaveStates;
    arrSlaveStates                          : ARRAY[0..iSLAVEADDR_ARR_SIZE] OF ST_EcSlaveState;

    (* -- Get Topology Data *)
    iTopologyData                           : UDINT;
    fbGetTopologyData                       : ADSREAD;
    arrTopologyData                         : ARRAY[0..iSLAVEADDR_ARR_SIZE] OF ST_TopologyData;

    (* -- Check Topology *)
    aiDiagIndex                                     : ARRAY [0..ESC_MAX_PORTS] OF UINT;
    iDiagIndex : UINT;
    aiDiagPort                                      : ARRAY [0..ESC_MAX_PORTS] OF UINT;
    iDiagPort : UINT;
    iIdx                                            : DINT;

    (* -- Scan Slaves *)
    fbEcGetScannedSlaves            : FB_EcGetScannedSlaves;
    arrScannedSlaveInfo                     : ARRAY [0..iSLAVEADDR_ARR_SIZE] OF ST_EcSlaveScannedData; // what...
    rScannedSlaveInfo   :   REFERENCE TO ST_EcSlaveScannedData;
    nScannedSlaves                          : UINT;

    (* -- Get Slave Identities *)
    fbGetSlaveIdentity                      : FB_EcGetSlaveIdentity;
    stIdentity                                      : ST_EcSlaveIdentity;

    (* -- Get Slave Names *)
    fbGetSlaveName                          : IOF_GetBoxNameByAddr;
    arrSlaveInfoScanned                     : ARRAY [0..iSLAVEADDR_ARR_SIZE] OF ST_SlaveStateInfoScanned; // the F
    rSlaveInfoScanned   :   REFERENCE TO ST_SlaveStateInfoScanned;
    strName                                         : STRING;



    // Logging components
    fbLogger : FB_LogMessage := (eSubsystem := eSubsystem);

    fbJson : FB_JsonSaxWriter;
    fbJsonDataType : FB_JsonReadWriteDataType;
    rDiagSlaveInfo : REFERENCE TO ST_SlaveStateInfo;
    tEtherCATOK : F_TRIG;
    tFrameWcStateError : R_TRIG;
    tMasterError : R_TRIG;
    jsonIdx : UINT;
    test : T_MaxString;
END_VAR
(* cyclic diag *)
bFrameWcStateError := NOT bAllFrameWcStatesOK;

bSlaveCountError := (nSlaveCount &lt;&gt; nSlaveCountCfg) OR (nSlaveCount = 0);
IF (bSlaveCountError AND NOT bSlaveCountErrorPrev) OR (NOT bSlaveCountError AND bSlaveCountErrorPrev) THEN
    bSlaveCountErrorPrev := bSlaveCountError;
    bDiagReq := TRUE; // slave count error change detected --&gt; diag required
END_IF

IF (bAllFrameWcStatesOK AND NOT bAllFrameWcStatesOKPrev) OR (NOT bAllFrameWcStatesOK AND bAllFrameWcStatesOKPrev) THEN
    bAllFrameWcStatesOKPrev := bAllFrameWcStatesOK;
    bDiagReq := TRUE; // frame error change detected --&gt; diag required
END_IF

IF (nMasterDevState &lt;&gt; nMasterDevStatePrev) THEN
    M_CheckMasterDevState();
    bDiagReq := TRUE; // devstate change detected --&gt; diag required
END_IF

(* acyclic diag *)
CASE iState OF
E_EcatDiagState.Idle: (* IDLE *)
    IF bDiagReq THEN                                // diag requested
        bDiagReq := FALSE;

        IF sMasterNetID &lt;&gt; &#39;&#39; AND sMasterNetID &lt;&gt; &#39;0.0.0.0.0.0&#39; THEN
            iState := E_EcatDiagState.GetSlaveAddresses;    // execute diag
            bBusy := TRUE;
        ELSE
            bError := TRUE;
            iErrorID := 7;
        END_IF

        bEtherCATOK := FALSE;
    ELSE
        // check for changes in idle
        IF (bSlaveCountError OR bMasterDevStateError OR NOT bAllFrameWcStatesOK) AND NOT (arrSlaveInfo[aiDiagIndex[0]].bDiagData) THEN
            bEtherCATOK := FALSE;
            bDiagReq := TRUE;//new error --&gt; diag requested
        ELSIF (bSlaveCountError AND NOT bSlaveCountErrorPrev) OR (NOT bSlaveCountError AND bSlaveCountErrorPrev) THEN
            bSlaveCountErrorPrev := bSlaveCountError;
            bEtherCATOK := FALSE;
            bDiagReq := TRUE;// slave count error change detected --&gt; diag required
        ELSIF (nMasterDevState &lt;&gt; nMasterDevStatePrev) THEN
            bEtherCATOK := FALSE;
            bDiagReq := TRUE;// devstate change detected --&gt; diag required
        ELSIF (bAllFrameWcStatesOK AND NOT bAllFrameWcStatesOKPrev) OR (NOT bAllFrameWcStatesOK AND bAllFrameWcStatesOKPrev) THEN
            bAllFrameWcStatesOKPrev := bAllFrameWcStatesOK;
            bEtherCATOK := FALSE;
            bDiagReq := TRUE;// frame error change detected --&gt; diag required
        ELSIF (bSlaveCountError OR bMasterDevStateError OR NOT bAllFrameWcStatesOK OR arrSlaveInfo[aiDiagIndex[0]].bDiagData) THEN
            bEtherCATOK := FALSE;
        ELSE
            bEtherCATOK := TRUE;
        END_IF
    END_IF

E_EcatDiagState.GetSlaveAddresses: (* get adresses *)
    M_GetSlaveAdresses();

E_EcatDiagState.GetSlaveStates: (* get states *)
    M_GetSlaveStates();

E_EcatDiagState.GetTopoDataLen:     (* get topology data length *)
    M_GetTopoDataLen();

E_EcatDiagState.GetTopoData:        (* get topology data *)
    M_GetTopoData();

E_EcatDiagState.ScanSlaves: (* scan slaves *)
    M_ScanSlaves();

E_EcatDiagState.GetSlaveIdentity:   (* get identity *)
    M_GetSlaveIdentity();

E_EcatDiagState.GetSlaveName:       (* get name *)
    M_GetSlaveName();

E_EcatDiagState.GetScannedSlaveName:        (* get scanned name *)
    M_GetScannedSlaveName();

E_EcatDiagState.LogDiagnostics: (* Log diagnostics *)
    (* I can&#39;t get the fbJsonDataType to actually convert the slave info
    structures. I just get nulls. Either I am doing this wrong, or when
    the symbol parser encounters datatypes it can&#39;t deal with it nulls
    the whole thing. I&#39;ll keep this code commented out until someone figures
    out how to deal with parsing the slave structs into the json payload *)
    IF jsonIdx &lt; iNumOfSlavesRead THEN // the last entry is always blank
        jsonIdx := MIN(iSLAVEADDR_ARR_SIZE, jsonIdx);
        rDiagSlaveInfo REF= arrSlaveInfo[jsonIdx];
        DiagnosticJson();
        fbLogger(sMsg:=CONCAT(&#39;Diag Results: &#39;, rDiagSlaveInfo.sName),
                eSevr:=TcEventSeverity.Info);
        jsonIdx := jsonIdx + 1;
    ELSE
        jsonIdx := 0;
        iState := E_EcatDiagState.Done;
    END_IF

E_EcatDiagState.Done:       (* DONE *)
    bBusy := FALSE;
    iState := 0;

END_CASE

// Log messages
tEtherCATOK(CLK:=bEtherCATOK);
IF tEtherCATOK.Q THEN
    fbLogger(sMsg:=&#39;EtherCAT failure, starting diagnostic&#39;, eSevr:=TcEventSeverity.Critical, sJson:=&#39;&#39;);
END_IF

tFrameWcStateError(CLK:=bFrameWcStateError);
IF tFrameWcStateError.Q THEN
    fbLogger(sMsg:=&#39;Working Counter Frame Error: error in at least one frame&#39;, eSevr:=TcEventSeverity.Error, sJson:=&#39;&#39;);
END_IF

tMasterError(CLK:=bMasterDevStateError);
IF tMasterError.Q THEN
    fbJson.StartObject();
        fbJson.AddKey(&#39;ecat_master_diag&#39;);
        fbJson.StartObject();
            fbJson.AddKey(&#39;bAtLeastOneNotInOp&#39;);
            fbJson.AddBool(stMasterDevState.bAtLeastOneNotInOp);
            fbJson.AddKey(&#39;bDcNotInSync&#39;);
            fbJson.AddBool(stMasterDevState.bDcNotInSync);
            fbJson.AddKey(&#39;bDriverNotFound&#39;);
            fbJson.AddBool(stMasterDevState.bDriverNotFound);
            fbJson.AddKey(&#39;bLinkError&#39;);
            fbJson.AddBool(stMasterDevState.bLinkError);
            fbJson.AddKey(&#39;bMissFrmRedMode&#39;);
            fbJson.AddBool(stMasterDevState.bMissFrmRedMode);
            fbJson.AddKey(&#39;bResetActive&#39;);
            fbJson.AddBool(stMasterDevState.bResetActive);
            fbJson.AddKey(&#39;bResetRequired&#39;);
            fbJson.AddBool(stMasterDevState.bResetRequired);
            fbJson.AddKey(&#39;bWatchdogTriggerd&#39;);
            fbJson.AddBool(stMasterDevState.bWatchdogTriggerd);
            fbJson.AddKey(&#39;eEcState&#39;);
            fbJson.AddUdint(stMasterDevState.eEcState);
        fbJson.EndObject();
    fbJson.EndObject();
    fbJson.CopyDocument(fbLogger.sJson, SIZEOF(fbLogger.sJson));
    fbLogger(sMsg:=&#39;Master error: error in master device state&#39;, eSevr:=TcEventSeverity.Critical);
    fbJson.ResetDocument();
END_IF

END_FUNCTION_BLOCK

ACTION DiagnosticJson:
fbJson.StartObject();
    fbJson.AddKey(&#39;ecat_diag&#39;);
    fbJson.StartObject();

        fbJson.AddKey(&#39;nECAddr&#39;);
        fbJson.AddUdint(rDiagSlaveInfo.nECAddr);

        fbJson.AddKey(&#39;nIndex&#39;);
        fbJson.AddDint(rDiagSlaveInfo.nIndex);

        fbJson.AddKey(&#39;sName&#39;);
        fbJson.AddString(rDiagSlaveInfo.sName);

        fbJson.AddKey(&#39;sType&#39;);
        fbJson.AddString(rDiagSlaveInfo.sType);

        fbJson.AddKey(&#39;bDiagData&#39;);
        fbJson.AddBool(rDiagSlaveInfo.bDiagData);

        fbJson.AddKey(&#39;stPortCRCErrors&#39;);
        fbjson.StartObject();

            fbJson.AddKey(&#39;portA&#39;);
            fbJson.AddUdint(rDiagSlaveInfo.stPortCRCErrors.portA);
            fbJson.AddKey(&#39;portB&#39;);
            fbJson.AddUdint(rDiagSlaveInfo.stPortCRCErrors.portB);
            fbJson.AddKey(&#39;portC&#39;);
            fbJson.AddUdint(rDiagSlaveInfo.stPortCRCErrors.portC);
            fbJson.AddKey(&#39;portD&#39;);
            fbJson.AddUdint(rDiagSlaveInfo.stPortCRCErrors.portD);

        fbJson.EndObject();

        fbJson.AddKey(&#39;nSumCRCErrors&#39;);
        fbjson.AddUdint(rDiagSlaveInfo.nSumCRCErrors);

        fbJson.AddKey(&#39;stState&#39;);
        fbJson.StartObject();

            fbJson.AddKey(&#39;eEcState &#39;);
            fbJson.AddUdint(rDiagSlaveInfo.stState.eEcState);
            fbJson.AddKey(&#39;nReserved&#39;);
            fbJson.AddUdint(rDiagSlaveInfo.stState.nReserved);
            fbJson.AddKey(&#39;bError&#39;);
            fbJson.AddBool(rDiagSlaveInfo.stState.bError);
            fbJson.AddKey(&#39;bInvalidVPRS&#39;);
            fbJson.AddBool(rDiagSlaveInfo.stState.bInvalidVPRS);
            fbJson.AddKey(&#39;nReserved2&#39;);
            fbJson.AddUdint(rDiagSlaveInfo.stState.nReserved2);
            fbJson.AddKey(&#39;bNoCommToSlave&#39;);
            fbJson.AddBool(rDiagSlaveInfo.stState.bNoCommToSlave);
            fbJson.AddKey(&#39;bLinkError&#39;);
            fbJson.AddBool(rDiagSlaveInfo.stState.bLinkError);
            fbJson.AddKey(&#39;bMissingLink&#39;);
            fbJson.AddBool(rDiagSlaveInfo.stState.bMissingLink);
            fbJson.AddKey(&#39;bUnexpectedLink&#39;);
            fbJson.AddBool(rDiagSlaveInfo.stState.bUnexpectedLink);
            fbJson.AddKey(&#39;bPortA&#39;);
            fbJson.AddBool(rDiagSlaveInfo.stState.bPortA);
            fbJson.AddKey(&#39;bPortB&#39;);
            fbJson.AddBool(rDiagSlaveInfo.stState.bPortB);
            fbJson.AddKey(&#39;bPortC&#39;);
            fbJson.AddBool(rDiagSlaveInfo.stState.bPortC);
            fbJson.AddKey(&#39;bPortD&#39;);
            fbJson.AddBool(rDiagSlaveInfo.stState.bPortD);

        fbJson.EndObject();

    fbJson.EndObject();

fbJson.EndObject();

fbJson.CopyDocument(fbLogger.sJson, SIZEOF(fbLogger.sJson));
fbJson.ResetDocument();
END_ACTION

ACTION M_CheckMasterDevState:
(* check master errors based on devstate *)
bMasterDevStateError                                := nMasterDevState &lt;&gt; 0;
stMasterDevState.bLinkError                 := ((nMasterDevState AND 16#000F) = 1) OR ((nMasterDevState AND 16#000F) = 4);
stMasterDevState.bResetRequired     := ((nMasterDevState AND 16#000F) = 2) OR ((nMasterDevState AND 16#FFF0) = 16#10);
stMasterDevState.bMissFrmRedMode    := (nMasterDevState AND 16#000F) = 8;
stMasterDevState.bWatchdogTriggerd  := (nMasterDevState AND 16#20) = 16#20;
stMasterDevState.bDriverNotFound    := (nMasterDevState AND 16#40) = 16#40;
stMasterDevState.bResetActive               := (nMasterDevState AND 16#80) = 16#80;
stMasterDevState.bAtLeastOneNotInOp := ((nMasterDevState AND 16#100) = 16#100) OR ((nMasterDevState AND 16#200) = 16#200) OR
                                        ((nMasterDevState AND 16#400) = 16#400) OR ((nMasterDevState AND 16#800) = 16#800);
stMasterDevState.bDcNotInSync               := (nMasterDevState AND 16#1000) = 16#1000;
nMasterDevStatePrev                                 := nMasterDevState;
END_ACTION

ACTION M_GetScannedSlaveName:
rSlaveInfoScanned REF= arrSlaveInfoScanned[aiDiagIndex[iIdx]];
rScannedSlaveInfo REF= arrScannedSlaveInfo[aiDiagIndex[iIdx]];

fbGetSlaveName(
    NETID           := sIPCNetId,
    DEVICEID        := nMasterDevID,
    BOXADDR         := rScannedSlaveInfo.nAddr,
    START           := TRUE,
    TMOUT           := tTimeout,
    BOXNAME         =&gt; strName
);

IF NOT fbGetSlaveName.BUSY THEN
    fbGetSlaveName(START:= FALSE);

    (* add scanned info *)
    rSlaveInfoScanned.nIndex        := iDiagIndex + 1;
    IF rScannedSlaveInfo.nAddr &lt;&gt; 0 THEN
        IF NOT fbGetSlaveName.ERR THEN
            rSlaveInfoScanned.sName := strName;
        END_IF
    ELSE
        rSlaveInfoScanned.sType             := &#39;&#39;;
    END_IF

    IF (iDiagIndex &lt; nScannedSlaves) THEN
        rSlaveInfoScanned.sType             := F_ConvProductCodeToString(rScannedSlaveInfo.stSlaveIdentity);
    ELSE
        rSlaveInfoScanned.sType             := &#39;&#39;;
    END_IF

    rSlaveInfoScanned.nECAddr       := rScannedSlaveInfo.nAddr;

    IF rSlaveInfoScanned.sName &lt;&gt; rSlaveInfo.sName THEN
        rSlaveInfoScanned.bDifferentName := TRUE;
    ELSE
        rSlaveInfoScanned.bDifferentName := FALSE;
    END_IF

    IF rSlaveInfoScanned.nECAddr &lt;&gt; rSlaveInfo.nECAddr THEN
        rSlaveInfoScanned.bDifferentAddr := TRUE;
    ELSE
        rSlaveInfoScanned.bDifferentAddr := FALSE;
    END_IF

    IF rSlaveInfoScanned.sType &lt;&gt; rSlaveInfo.sType THEN
        rSlaveInfoScanned.bDifferentType := TRUE;
    ELSE
        rSlaveInfoScanned.bDifferentType := FALSE;
    END_IF

    IF iIdx &lt; ESC_MAX_PORTS THEN
        iIdx := iIdx + 1;
        iState := E_EcatDiagState.GetSlaveIdentity; // loop back
    ELSE
        iIdx := 0;
        iState := E_EcatDiagState.LogDiagnostics;

        FOR I := 0 TO ESC_MAX_PORTS DO
            IF aiDiagPort[I] &lt;&gt; 0 THEN
                arrDiagSlaveInfo[I] := arrSlaveInfo[aiDiagIndex[I]];
                arrDiagSlaveInfoScanned[I] := arrSlaveInfoScanned[aiDiagIndex[I]];
            ELSE
                MEMSET(ADR(arrDiagSlaveInfo[I]), 0, SIZEOF(arrDiagSlaveInfo[I]));
                MEMSET(ADR(arrDiagSlaveInfoScanned[I]), 0, SIZEOF(arrDiagSlaveInfoScanned[I]));
            END_IF
        END_FOR
    END_IF
END_IF
END_ACTION

ACTION M_GetSlaveAdresses:
fbGetSlaveAddresses(
    sNetId          := sMasterNetID,
    pAddrBuf        := ADR(arrSlaveAddresses),
    cbBufLen        := SIZEOF(arrSlaveAddresses),
    bExecute        := TRUE,
    tTimeout        := tTimeout,
    nSlaves         =&gt; iNumOfSlavesRead
);

IF NOT fbGetSlaveAddresses.bBusy THEN
    fbGetSlaveAddresses(bExecute:= FALSE);
    IF NOT fbGetSlaveAddresses.bError THEN
        FOR I := 0 TO MIN(iNumOfSlavesRead, iSLAVEADDR_ARR_SIZE) DO
            arrSlaveInfo[I].nECAddr := arrSlaveAddresses[I];
        END_FOR
    END_IF
    iState := GetSlaveStates;
END_IF
END_ACTION

ACTION M_GetSlaveIdentity:
iDiagIndex := aiDiagIndex[iIdx];
iDiagPort := aiDiagPort[iIdx];

rSlaveInfo REF= arrSlaveInfo[iDiagIndex];

fbGetSlaveIdentity(
    sNetId          := sMasterNetID,
    nSlaveAddr      := rSlaveInfo.nECAddr,
    bExecute        := TRUE,
    tTimeout        := tTimeout,
    identity        =&gt; stIdentity
);

IF NOT fbGetSlaveIdentity.bBusy THEN
    fbGetSlaveIdentity(bExecute:= FALSE);

    IF NOT fbGetSlaveIdentity.bError THEN
        IF aiDiagPort[iIdx] &lt;&gt; 0 THEN
            rSlaveInfo.nIndex       := aiDiagIndex[iIdx] + 1;
            rSlaveInfo.sType        := F_ConvProductCodeToString(stSlaveIdentity := stIdentity);
        END_IF
    END_IF
    iState := E_EcatDiagState.GetSlaveName;
END_IF
END_ACTION

ACTION M_GetSlaveName:
fbGetSlaveName(
    NETID           := sIPCNetId,
    DEVICEID        := nMasterDevID,
    BOXADDR         := rSlaveInfo.nECAddr,
    START           := TRUE,
    TMOUT           := tTimeout,
    BOXNAME         =&gt; strName
);

IF NOT fbGetSlaveName.BUSY THEN
    fbGetSlaveName(START:= FALSE);

    IF NOT fbGetSlaveName.ERR THEN
        IF iDiagPort &lt;&gt; 0 THEN
            rSlaveInfo.sName        := strName;
        END_IF
    END_IF

    iState := E_EcatDiagState.GetScannedSlaveName;
END_IF
END_ACTION

ACTION M_GetSlaveStates:
fbGetAllSlaveStates(
    sNetId          := sMasterNetID,
    pStateBuf       := ADR(arrSlaveStates),
    cbBufLen        := SIZEOF(arrSlaveStates),
    bExecute        := TRUE,
    tTimeout        := tTimeout,
    nSlaves         =&gt; iNumOfSlavesRead
);

IF NOT fbGetAllSlaveStates.bBusy THEN
    fbGetAllSlaveStates(bExecute:= FALSE);

    IF NOT fbGetAllSlaveStates.bError THEN
        IF iNumOfSlavesRead = nSlaveCountCfg THEN
            FOR I := 0 TO ESC_MAX_PORTS DO
                aiDiagIndex[I] := 0;
            END_FOR

            (* split slave state and link state *)
            FOR I := 0 TO MIN(iNumOfSlavesRead, iSLAVEADDR_ARR_SIZE) DO
                (* slave state*)
                arrSlaveInfo[I].stState.eEcState            := arrSlaveStates[I].deviceState AND 16#0F;
                arrSlaveInfo[I].stState.bError                      := arrSlaveStates[I].deviceState.4;
                arrSlaveInfo[I].stState.bInvalidVPRS        := arrSlaveStates[I].deviceState.5;
                (* link state *)
                arrSlaveInfo[I].stState.bNoCommToSlave      := arrSlaveStates[I].linkState.0;
                arrSlaveInfo[I].stState.bLinkError          := arrSlaveStates[I].linkState.1;
                arrSlaveInfo[I].stState.bMissingLink        := arrSlaveStates[I].linkState.2;
                arrSlaveInfo[I].stState.bUnexpectedLink := arrSlaveStates[I].linkState.3;
                arrSlaveInfo[I].stState.bPortA                      := arrSlaveStates[I].linkState.4;
                arrSlaveInfo[I].stState.bPortB                      := arrSlaveStates[I].linkState.5;
                arrSlaveInfo[I].stState.bPortC                      := arrSlaveStates[I].linkState.6;
                arrSlaveInfo[I].stState.bPortD                      := arrSlaveStates[I].linkState.7;
                (* DiagData *)
                arrSlaveInfo[I].bDiagData   := ((arrSlaveStates[I].deviceState AND 16#F0) &lt;&gt; 0) OR
                    (((arrSlaveStates[I].deviceState AND 16#0F) &gt; 0) AND ((arrSlaveStates[I].deviceState AND 16#0F) &lt; 8)) OR
                    (arrSlaveStates[I].linkState &lt;&gt; 0);

                IF arrSlaveInfo[I].bDiagData THEN
                    IF (I=0) THEN
                        aiDiagIndex[0] := 0;
                    ELSE
                        IF (aiDiagIndex[0] = 0) AND NOT arrSlaveInfo[0].bDiagData THEN
                            aiDiagIndex[0] :=  UDINT_TO_UINT(I);
                        END_IF
                    END_IF
                END_IF
            END_FOR
        END_IF
    END_IF

    IF arrSlaveInfo[aiDiagIndex[0]].bDiagData THEN
        iState := E_EcatDiagState.GetTopoDataLen;
    ELSE
        FOR I := 0 TO ESC_MAX_PORTS DO
            MEMSET(ADR(arrDiagSlaveInfo[I]), 0, SIZEOF(arrDiagSlaveInfo[I]));
            MEMSET(ADR(arrDiagSlaveInfoScanned[I]), 0, SIZEOF(arrDiagSlaveInfoScanned[I]));
        END_FOR
        iState := E_EcatDiagState.Done;
    END_IF
END_IF
END_ACTION

ACTION M_GetTopoData:
fbGetTopologyData(
    NETID   := sMasterNetID,
    PORT    := 16#FFFF,
    IDXGRP  := 16#22,
    IDXOFFS := 0,
    LEN             := iTopologyData*SIZEOF(arrTopologyData[0]),
    DESTADDR:= ADR(arrTopologyData),
    READ    := TRUE,
    TMOUT   := tTimeout,
);

IF NOT fbGetTopologyData.BUSY THEN
    fbGetTopologyData(READ := FALSE);

    IF NOT fbGetTopologyData.ERR THEN
        aiDiagPort[0] := arrTopologyData[aiDiagIndex[0]].iOwnPhysicalAddr;
        aiDiagPort[1] := arrTopologyData[aiDiagIndex[0]].stPhysicalAddr.portB;
        aiDiagPort[2] := arrTopologyData[aiDiagIndex[0]].stPhysicalAddr.portC;
        aiDiagPort[ESC_MAX_PORTS] := arrTopologyData[aiDiagIndex[0]].stPhysicalAddr.portD;

        (* clear diag index  *)
        aiDiagIndex[1] := 0;
        aiDiagIndex[2] := 0;
        aiDiagIndex[ESC_MAX_PORTS] := 0;

        (* find slaves on PortB-D of first slave with diag *)
        FOR P := 0 TO ESC_MAX_PORTS DO
            IF aiDiagPort[P] &lt;&gt; 0 THEN
            FOR I := 0 TO MIN(iTopologyData-1,iSLAVEADDR_ARR_SIZE) DO
                IF arrTopologyData[I].iOwnPhysicalAddr = aiDiagPort[P] THEN
                    aiDiagIndex[P] := UDINT_TO_UINT(I);
                    EXIT;
                END_IF
            END_FOR
        END_IF
        END_FOR
    END_IF

    iIdx := 0;
    iState := E_EcatDiagState.ScanSlaves;
END_IF
END_ACTION

ACTION M_GetTopoDataLen:
fbGetTopologyData(
    NETID   := sMasterNetID,
    PORT    := 16#FFFF,
    IDXGRP  := EC_ADS_IGRP_MASTER_COUNT_SLAVE,
    IDXOFFS := EC_ADS_IOFFS_MASTER_COUNT_SLAVE,
    LEN             := SIZEOF(iTopologyData),
    DESTADDR:= ADR(iTopologyData),
    READ    := TRUE,
    TMOUT   := tTimeout,
);

IF NOT fbGetTopologyData.BUSY THEN
    fbGetTopologyData(READ := FALSE);

    iState := E_EcatDiagState.GetTopoData;
END_IF
END_ACTION

ACTION M_ScanSlaves:
fbEcGetScannedSlaves(
    bExecute                                := TRUE,
    sNetId                                  := sMasterNetID,
    pArrEcScannedSlaveInfo  := ADR(arrScannedSlaveInfo),
    cbBufLen                                := SIZEOF(arrScannedSlaveInfo),
    tTimeout                                := tTimeout
);

IF NOT fbEcGetScannedSlaves.bBusy THEN
    fbEcGetScannedSlaves(bExecute := FALSE);

    IF fbEcGetScannedSlaves.bError THEN
        nScannedSlaves := 0;
    ELSE
        nScannedSlaves := fbEcGetScannedSlaves.nSlaves;
    END_IF

    iState := E_EcatDiagState.GetSlaveIdentity;

END_IF
END_ACTION
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-ecatdiagstate">E_EcatDiagState</a></p></li>
<li><p><a class="reference internal" href="#e-subsystem">E_Subsystem</a></p></li>
<li><p><a class="reference internal" href="#fb-logmessage">FB_LogMessage</a></p></li>
<li><p><a class="reference internal" href="#st-ecmasterdevstate">ST_EcMasterDevState</a></p></li>
<li><p><a class="reference internal" href="#st-slavestateinfo">ST_SlaveStateInfo</a></p></li>
<li><p><a class="reference internal" href="#st-slavestateinfoscanned">ST_SlaveStateInfoScanned</a></p></li>
<li><p><a class="reference internal" href="#st-topologydata">ST_TopologyData</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-ethercatframediag">
<h2>FB_EtherCATFrameDiag<a class="headerlink" href="#fb-ethercatframediag" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_EtherCATFrameDiag</span>
<span class="n">VAR_INPUT</span>
    <span class="n">wFrmXWcState</span>            <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>                         <span class="o">//</span> <span class="n">FrmXWcState</span>
    <span class="n">wReqZeroMask</span>            <span class="p">:</span> <span class="n">WORD</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#FFFF;      // mask, bit TRUE: require wFrmXWcState.bit = FALSE, bit FALSE: ignore wFrmXWcState.bit *)</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bFrameWcStateOK</span>         <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                         <span class="o">//</span> <span class="n">result</span> <span class="n">of</span> <span class="n">fram</span> <span class="n">state</span> <span class="n">check</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">mask</span> <span class="n">out</span> <span class="n">ignored</span> <span class="n">error</span> <span class="n">bits</span> <span class="ow">and</span> <span class="n">compare</span> <span class="n">result</span> <span class="n">against</span> <span class="mi">0</span> <span class="o">*</span><span class="p">)</span>
<span class="n">bFrameWcStateOK</span> <span class="o">:=</span> <span class="p">((</span><span class="n">wFrmXWcState</span> <span class="n">AND</span> <span class="n">wReqZeroMask</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-getplchostname">
<h2>FB_GetPLCHostname<a class="headerlink" href="#fb-getplchostname" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_GetPLCHostname</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bEnable</span>                 <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tRetryDelay</span>             <span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#10s;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">sHostname</span>               <span class="p">:</span> <span class="n">T_MaxString</span><span class="p">;</span>
    <span class="n">bDone</span>                   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span>                  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbGetHostName</span>   <span class="p">:</span> <span class="n">FB_GetHostName</span><span class="p">;</span>

    <span class="n">tRetry</span>                  <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">bReset</span>                  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bInitialized</span>    <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">bEnable</span> <span class="n">THEN</span>
    <span class="n">fbGetHostName</span><span class="o">.</span><span class="n">sNetID</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInitialized</span> <span class="n">OR</span> <span class="p">(</span><span class="n">tRetry</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bDone</span><span class="p">)</span> <span class="n">THEN</span>
        <span class="n">bReset</span>                      <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">bInitialized</span>        <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">fbGetHostName</span><span class="p">(</span><span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">END_IF</span>

    <span class="n">tRetry</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">tRetryDelay</span><span class="p">);</span>

    <span class="n">bReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bDone</span> <span class="n">THEN</span>
        <span class="n">fbGetHostName</span><span class="p">(</span><span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">bError</span><span class="o">=&gt;</span><span class="n">bError</span><span class="p">);</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">fbGetHostName</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">bError</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">sHostname</span>       <span class="o">:=</span> <span class="n">fbGetHostName</span><span class="o">.</span><span class="n">sHostName</span><span class="p">;</span>
            <span class="n">bDone</span>           <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-getplcipaddress">
<h2>FB_GetPLCIPAddress<a class="headerlink" href="#fb-getplcipaddress" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_GetPLCIPAddress</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bEnable</span>                 <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tRetryDelay</span>             <span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#10s;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">sIPAddress</span>              <span class="p">:</span> <span class="n">STRING</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>

    <span class="n">bDone</span>                   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span>                  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbGetAdapterIP</span>  <span class="p">:</span> <span class="n">FB_GetAdaptersInfo</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">sNetID</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">);</span> <span class="o">//</span> <span class="n">Acquire</span> <span class="n">IP</span> <span class="n">of</span> <span class="n">the</span> <span class="n">correct</span> <span class="n">adapter</span>

    <span class="n">iIndex</span>                  <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>

    <span class="n">tRetry</span>                  <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">bReset</span>                  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bInitialized</span>    <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">bEnable</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInitialized</span> <span class="n">OR</span> <span class="p">(</span><span class="n">tRetry</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bDone</span><span class="p">)</span> <span class="n">THEN</span>
        <span class="n">bReset</span>                      <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">bInitialized</span>        <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">fbGetAdapterIP</span><span class="p">(</span><span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">END_IF</span>

    <span class="n">tRetry</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">tRetryDelay</span><span class="p">);</span>
    <span class="n">bReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bDone</span> <span class="n">THEN</span>
        <span class="n">fbGetAdapterIP</span><span class="p">(</span><span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">bError</span><span class="o">=&gt;</span><span class="n">bError</span><span class="p">);</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">fbGetAdapterIP</span><span class="o">.</span><span class="n">bBusy</span> <span class="ow">or</span> <span class="n">fbGetAdapterIP</span><span class="o">.</span><span class="n">bError</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">FOR</span> <span class="n">iIndex</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">MAX_LOCAL_ADAPTERS</span> <span class="n">DO</span>
                <span class="n">IF</span> <span class="n">FIND</span><span class="p">(</span><span class="n">fbGetAdapterIP</span><span class="o">.</span><span class="n">arrAdapters</span><span class="p">[</span><span class="n">iIndex</span><span class="p">]</span><span class="o">.</span><span class="n">sIpAddr</span><span class="p">,</span> <span class="n">GVL_Logger</span><span class="o">.</span><span class="n">sIpTidbit</span><span class="p">)</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
                    <span class="n">sIPAddress</span> <span class="o">:=</span> <span class="n">fbGetAdapterIP</span><span class="o">.</span><span class="n">arrAdapters</span><span class="p">[</span><span class="n">iIndex</span><span class="p">]</span><span class="o">.</span><span class="n">sIpAddr</span><span class="p">;</span>
                    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
                    <span class="n">EXIT</span><span class="p">;</span>
                <span class="n">END_IF</span>
            <span class="n">END_FOR</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>

<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#gvl-logger">GVL_Logger</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-index">
<h2>FB_Index<a class="headerlink" href="#fb-index" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">Index</span> <span class="n">FB</span>
<span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span> <span class="mi">2016</span><span class="o">-</span><span class="mi">9</span><span class="o">-</span><span class="mi">3</span>

<span class="n">Why</span> <span class="n">doesn</span><span class="s1">&#39;t beckhoff have this as a builtin type?</span>

<span class="n">Use</span> <span class="n">this</span> <span class="n">thing</span> <span class="n">to</span> <span class="n">have</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">indexer</span> <span class="k">with</span> <span class="n">rollover</span><span class="o">.</span>

<span class="o">*</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_Index</span>
<span class="n">VAR_INPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;naming&#39;</span> <span class="o">:=</span> <span class="s1">&#39;off&#39;</span><span class="p">}</span>
    <span class="n">LowerLimit</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">//</span><span class="n">Incrementer</span> <span class="n">will</span> <span class="n">rollver</span> <span class="n">over</span> <span class="n">to</span> <span class="n">this</span> <span class="n">value</span> <span class="p">(</span><span class="ow">and</span> <span class="n">initialize</span> <span class="n">to</span> <span class="n">this</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">ValInc</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">//</span><span class="n">Incrementer</span> <span class="n">increments</span> <span class="n">by</span> <span class="n">this</span> <span class="n">value</span>
    <span class="n">UpperLimit</span>      <span class="p">:</span>       <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">//</span><span class="n">Incrementer</span> <span class="n">will</span> <span class="n">rollover</span> <span class="n">at</span> <span class="n">this</span> <span class="n">value</span> <span class="n">to</span> <span class="n">lower</span> <span class="n">limit</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;naming&#39;</span> <span class="o">:=</span> <span class="s1">&#39;off&#39;</span><span class="p">}</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nVal</span>    <span class="p">:</span>       <span class="n">INT</span> <span class="o">:=</span> <span class="n">LowerLimit</span><span class="p">;</span> <span class="o">//</span><span class="n">Internal</span> <span class="n">incrementer</span> <span class="n">value</span><span class="p">,</span> <span class="n">initialized</span> <span class="n">to</span> <span class="n">LowerLimit</span>
<span class="n">END_VAR</span>
<span class="p">{</span><span class="n">analysis</span> <span class="o">-</span><span class="mi">2</span><span class="p">}</span> <span class="o">//</span><span class="n">Only</span> <span class="n">the</span> <span class="n">methods</span> <span class="ow">and</span> <span class="n">actions</span> <span class="n">are</span> <span class="n">needed</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">Dec</span><span class="p">:</span>
<span class="n">nVal</span> <span class="o">:=</span> <span class="n">nVal</span> <span class="o">-</span> <span class="n">ValInc</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">nVal</span> <span class="o">&lt;</span> <span class="n">LowerLimit</span> <span class="n">THEN</span> <span class="n">nVal</span> <span class="o">:=</span> <span class="n">UpperLimit</span><span class="p">;</span> <span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">Inc</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Dont</span> <span class="n">use</span> <span class="n">this</span><span class="p">,</span> <span class="n">use</span> <span class="n">ValInc</span>
<span class="n">nVal</span> <span class="o">:=</span> <span class="n">nVal</span> <span class="o">+</span> <span class="n">ValInc</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">nVal</span> <span class="o">&gt;</span>  <span class="n">UpperLimit</span> <span class="n">THEN</span> <span class="n">nVal</span> <span class="o">:=</span> <span class="n">LowerLimit</span><span class="p">;</span> <span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="o">//</span><span class="n">Decrement</span> <span class="n">the</span> <span class="n">counter</span> <span class="ow">and</span> <span class="k">return</span> <span class="n">new</span> <span class="n">value</span>
<span class="n">METHOD</span> <span class="n">DecVal</span> <span class="p">:</span> <span class="n">INT</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">Dec</span><span class="p">();</span>
<span class="n">DecVal</span> <span class="o">:=</span> <span class="n">nVal</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="o">//</span><span class="n">Increment</span> <span class="n">the</span> <span class="n">counter</span> <span class="ow">and</span> <span class="k">return</span> <span class="n">new</span> <span class="n">value</span>
<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">IncVal</span> <span class="p">:</span> <span class="n">INT</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">Inc</span><span class="p">();</span>
<span class="n">IncVal</span> <span class="o">:=</span> <span class="n">nVal</span><span class="p">;</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
</section>
<section id="fb-led">
<h2>FB_LED<a class="headerlink" href="#fb-led" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_LED</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Reads</span> <span class="n">a</span> <span class="n">percentage</span> <span class="n">of</span> <span class="n">illumination</span> <span class="n">determined</span> <span class="n">by</span> <span class="n">the</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">converts</span> <span class="n">it</span> <span class="n">to</span> <span class="n">a</span> <span class="n">raw</span> <span class="n">value</span>
    <span class="n">to</span> <span class="n">send</span> <span class="n">to</span> <span class="n">the</span> <span class="n">terminal</span> <span class="n">output</span> <span class="n">via</span> <span class="n">the</span> <span class="n">FB_AnalogOutput</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">determination</span> <span class="n">of</span> <span class="n">the</span> <span class="n">full</span> <span class="n">scale</span> <span class="n">raw</span> <span class="n">value</span> <span class="p">(</span><span class="n">FSV</span><span class="p">)</span> <span class="ow">is</span> <span class="n">calculated</span> <span class="n">via</span> <span class="n">the</span> <span class="n">iTermBits</span><span class="p">,</span>
    <span class="n">which</span> <span class="ow">is</span> <span class="n">setup</span> <span class="k">as</span> <span class="n">an</span> <span class="nb">input</span> <span class="n">variable</span> <span class="n">to</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">according</span> <span class="n">to</span> <span class="n">the</span> <span class="n">situation</span><span class="o">.</span> <span class="n">This</span> <span class="n">value</span>
    <span class="ow">is</span> <span class="n">bounded</span> <span class="n">by</span> <span class="n">the</span> <span class="n">FSV</span> <span class="n">of</span> <span class="n">the</span> <span class="n">terminal</span> <span class="nb">set</span> <span class="n">by</span> <span class="n">the</span> <span class="n">Beckhoff</span> <span class="n">architecture</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="mi">15</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">32767.</span>

    <span class="n">Through</span> <span class="n">the</span> <span class="n">configurable</span> <span class="nb">max</span> <span class="n">raw</span> <span class="n">value</span> <span class="n">sent</span> <span class="n">to</span> <span class="n">the</span> <span class="n">terminal</span> <span class="n">output</span><span class="p">,</span> <span class="n">this</span> <span class="n">LED</span> <span class="n">function</span> <span class="n">block</span>
    <span class="ow">is</span> <span class="n">applicable</span> <span class="n">to</span> <span class="n">a</span> <span class="n">wider</span> <span class="n">variety</span> <span class="n">of</span> <span class="n">hardware</span><span class="p">:</span> <span class="n">whether</span> <span class="n">it</span> <span class="n">be</span> <span class="n">simple</span> <span class="n">Analog</span> <span class="n">Voltage</span> <span class="n">control</span><span class="p">,</span>
    <span class="n">PWM</span> <span class="n">voltage</span> <span class="n">output</span><span class="p">,</span> <span class="ow">or</span> <span class="n">current</span> <span class="n">controlled</span> <span class="n">output</span><span class="o">.</span>

    <span class="n">As</span> <span class="n">an</span> <span class="n">initial</span> <span class="n">application</span><span class="p">,</span> <span class="n">this</span> <span class="n">FB</span> <span class="n">will</span> <span class="n">be</span> <span class="n">instituted</span> <span class="k">for</span> <span class="n">systems</span> <span class="n">of</span> <span class="n">vaccum</span> <span class="n">chamber</span> <span class="n">LED</span>
    <span class="n">illuminators</span> <span class="n">on</span> <span class="n">TMO</span> <span class="n">endstations</span><span class="p">,</span> <span class="n">which</span> <span class="n">are</span> <span class="n">rated</span> <span class="k">for</span> <span class="mi">12</span> <span class="n">V</span> <span class="nb">max</span><span class="o">.</span> <span class="n">They</span> <span class="n">will</span> <span class="n">be</span> <span class="n">dimmed</span> <span class="n">via</span> <span class="n">the</span>
    <span class="n">EL2502</span> <span class="n">terminal</span> <span class="mi">24</span> <span class="n">V</span> <span class="n">PWM</span> <span class="n">output</span> <span class="n">voltage</span> <span class="n">control</span> <span class="kn">from</span> <span class="mi">0</span><span class="o">-</span><span class="mi">50</span><span class="o">%</span> <span class="n">duty</span> <span class="n">cycle</span><span class="o">.</span>

    <span class="mi">2022</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">03</span> <span class="n">Maarten</span> <span class="n">Thomas</span><span class="o">-</span><span class="n">Bosum</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">NAME</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Descriptive</span> <span class="n">name</span> <span class="k">for</span> <span class="n">the</span> <span class="n">LED</span>
        <span class="n">autosave_pass0</span><span class="p">:</span> <span class="n">VAL</span> <span class="n">DESC</span>
    <span class="s1">&#39;}</span>
    <span class="n">ledName</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>

    <span class="n">iTermBits</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ILL</span><span class="p">:</span><span class="n">PCT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="o">%</span>
    <span class="s1">&#39;}</span>
    <span class="n">fIlluminatorPercent</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PWR</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">OFF</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">ON</span>
    <span class="s1">&#39;}</span>
    <span class="n">bLedPower</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">iIlluminatorINT</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">fbSetIllPercent</span><span class="p">:</span> <span class="n">FB_AnalogOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Illuminator</span> <span class="n">conversion</span> <span class="n">to</span> <span class="n">percentage</span>
<span class="n">fbSetIllPercent</span><span class="p">(</span>
    <span class="n">fReal</span><span class="o">:=</span><span class="n">fIlluminatorPercent</span><span class="p">,</span>
    <span class="n">fSafeMax</span><span class="o">:=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">fSafeMin</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">iTermBits</span><span class="o">:=</span><span class="n">iTermBits</span><span class="p">,</span>
    <span class="n">fTermMax</span><span class="o">:=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">fTermMin</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">iRaw</span><span class="o">=&gt;</span><span class="n">iIlluminatorINT</span><span class="p">);</span>

<span class="n">IF</span>  <span class="n">fIlluminatorPercent</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">bLedPower</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bLEDPower</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-analogoutput">FB_AnalogOutput</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-listener">
<h2>FB_Listener<a class="headerlink" href="#fb-listener" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_Listener EXTENDS FB_ListenerBase
VAR_INPUT
END_VAR

VAR_OUTPUT
END_VAR

VAR
    nEventIdx                       :       UINT := 0;
    nPendingEvents          :       UINT := 0;

    {attribute &#39;pytmc&#39; := &#39;
        pv: LogToVisualStudio
        io: io
    &#39;}
    bLogToVisualStudio      :       BOOL := FALSE;

    {attribute &#39;pytmc&#39; := &#39;
        pv: MessagesSent
        io: i
    &#39;}
    nCntMessagesSent        : UDINT := 0;

    {attribute &#39;pytmc&#39; := &#39;
        pv: AlarmsRaised
        io: i
    &#39;}
    nCntAlarmsRaised        : UDINT := 0;

    {attribute &#39;pytmc&#39; := &#39;
        pv: AlarmsConfirmed
        io: i
    &#39;}
    nCntAlarmsConfirmed : UDINT := 0;

    {attribute &#39;pytmc&#39; := &#39;
        pv: AlarmsCleared
        io: i
    &#39;}
    nCntAlarmsCleared       : UDINT := 0;

    {attribute &#39;pytmc&#39; := &#39;
        pv: MinSeverity
        io: io
    &#39;}
    eMinSeverity            : TcEventSeverity;

    {attribute &#39;pytmc&#39; := &#39;
        pv: Log
    &#39;}
    stEventInfo             :       REFERENCE TO ST_LoggingEventInfo;

    stPendingEvents         :       ARRAY [0..nMaxEvents - 1] OF ST_PendingEvent;
    ipMessageConfig         :       ITcEventFilterConfig;
    fbSocket                        :       POINTER TO FB_ConnectionlessSocket;
    bConfigured                     :       BOOL    := FALSE;


END_VAR

VAR_IN_OUT

END_VAR

VAR CONSTANT
    // The maximum number of events allowed *per-cycle*
    nMaxEvents                      :       UINT := 10;
END_VAR


END_FUNCTION_BLOCK

(*
    Configure an event class + severity
*)
METHOD Configure : HRESULT
VAR_INPUT
    i_EventClass    :       GUID;
    i_MinSeverity   :       TcEventSeverity := TcEventSeverity.Verbose;
    i_fbSocket              :       POINTER TO FB_ConnectionlessSocket;
END_VAR

VAR_INST
    bSubscribed             :       BOOL := FALSE;
END_VAR
IF bSubscribed THEN
    Unsubscribe();
END_IF

THIS^.Subscribe(ADR(ipMessageConfig), 0);
bSubscribed         := TRUE;
eMinSeverity        := i_MinSeverity;
fbSocket            := i_fbSocket;

IF (ipMessageConfig = 0) THEN
    Configure       := 1;
    bConfigured := FALSE;
ELSE
    ipMessageConfig.AddEventClass(i_EventClass, i_MinSeverity);
    Configure       := 0;
    bConfigured := TRUE;
END_IF
END_METHOD

METHOD OnAlarmCleared
VAR_INPUT
    fbEvent : REFERENCE TO FB_TcEvent;
END_VAR
(* Callback run from THIS^.Execute() *)
nCntAlarmsCleared := nCntAlarmsCleared + 1;
StoreEvent(fbEvent, eEventType:=E_LogEventType.AlarmCleared);
END_METHOD

METHOD OnAlarmConfirmed
VAR_INPUT
    fbEvent : REFERENCE TO FB_TcEvent;
END_VAR
(* Callback run from THIS^.Execute() *)
nCntAlarmsConfirmed := nCntAlarmsConfirmed + 1;
StoreEvent(fbEvent, eEventType:=E_LogEventType.AlarmConfirmed);
END_METHOD

METHOD OnAlarmRaised
VAR_INPUT
    fbEvent : REFERENCE TO FB_TcEvent;
END_VAR
(* Callback run from THIS^.Execute() *)
nCntAlarmsRaised := nCntAlarmsRaised + 1;
StoreEvent(fbEvent, eEventType:=E_LogEventType.AlarmRaised);
END_METHOD

METHOD OnMessageSent
VAR_INPUT
    fbEvent : REFERENCE TO FB_TcEvent;
END_VAR
(* Callback run from THIS^.Execute() *)
nCntMessagesSent := nCntMessagesSent + 1;
StoreEvent(fbEvent, eEventType:=E_LogEventType.MessageSent);
END_METHOD

METHOD PublishEvents : HRESULT
VAR
    nEvent                          :       UINT;
    stPendingEvent          :       REFERENCE TO ST_PendingEvent;
    stEventInfo                     :       REFERENCE TO ST_LoggingEventInfo;
    fbRequestEventText      :       REFERENCE TO FB_RequestEventText;
END_VAR

VAR_INST
    fbJson                          :       FB_JsonSaxWriter;
    fbJsonDataType          :       FB_JsonReadWriteDataType;
    sJsonDoc                        :       STRING(10000);

END_VAR
IF nPendingEvents = 0 THEN
    RETURN;
END_IF

FOR nEvent := 0 TO nMaxEvents - 1 DO
    stPendingEvent REF= stPendingEvents[nEvent];
    IF NOT stPendingEvent.bInUse THEN
        CONTINUE;
    END_IF

    fbRequestEventText REF= stPendingEvent.fbRequestEventText;
    stEventInfo        REF= stPendingEvent.stEventInfo;

    IF fbRequestEventText.bError THEN
        stEventInfo.Msg := &#39;(Unable to retrieve message)&#39;;
    ELSIF NOT fbRequestEventText.bBusy THEN
        fbRequestEventText.GetString(stEventInfo.msg, SIZEOF(stEventInfo.msg));
    ELSE
        CONTINUE;
    END_IF

    IF bConfigured THEN
        stEventInfo.plc := GVL_Logger.sPlcHostname;

        // Generate the JSON message
        fbJson.ResetDocument();
        fbJsonDataType.AddJsonValueFromSymbol(fbJson, &#39;ST_LoggingEventInfo&#39;, SIZEOF(stEventInfo), ADR(stEventInfo));
        fbJson.CopyDocument(sJsonDoc, SIZEOF(sJsonDoc));

        SendMessage(sMessage:=ADR(sJsonDoc));
    END_IF

    // Mark as not in use, and fill in this event in the next StoreEvent call
    nPendingEvents                  := nPendingEvents - 1;
    stPendingEvent.bInUse   := FALSE;
    nEventIdx                               := nEvent;

END_FOR
END_METHOD

METHOD SendMessage : HRESULT
VAR_INPUT
    sMessage                :       POINTER TO STRING;
END_VAR

VAR
    sLogStr                 :       T_MaxString;
END_VAR
(* For subclasses to override, if necessary *)
IF sMessage = 0 THEN
    RETURN;
END_IF

// Optionally log it to Visual Studio&#39;s message list
IF bLogToVisualStudio THEN
     // Keep the message length under 255 (extended string function for LEFT/MID do not exist)
    STRNCPY(ADR(sLogStr), sMessage, MIN(220, SIZEOF(sLogStr)));
    ADSLOGSTR(
        msgCtrlMask := ADSLOG_MSGTYPE_HINT,
        msgFmtStr   := &#39;[Logger JSON Debug] %s&#39;,
        strArg      := sLogStr
    );
END_IF

IF fbSocket &lt;&gt; 0 THEN
    // And send it along to logstash
    F_SendUDPMessage(sMessage:=sMessage, fbSocket:=fbSocket^,
                     sHost:=GVL_Logger.cLogHost, iPort:=GVL_Logger.iLogPort);
END_IF
END_METHOD

METHOD PRIVATE StoreEvent : HRESULT
VAR_INPUT
    fbEvent         :       REFERENCE TO FB_TcEvent;
    eEventType      :       E_LogEventType;
END_VAR

VAR
    stPendingEvent  :       REFERENCE TO ST_PendingEvent;
    stEventInfo             :       REFERENCE TO ST_LoggingEventInfo;
    nFailures               :       UINT := 0;
END_VAR
IF fbEvent.eSeverity &lt; eMinSeverity THEN
    // Ignore all messages below the minimum severity
    RETURN;
ELSIF NOT __ISVALIDREF(fbEvent) THEN
    RETURN;
END_IF

// Find the next slot to use in stPendingEvents
WHILE stPendingEvents[nEventIdx].bInUse AND nFailures &lt; nMaxEvents DO
    nFailures := nFailures + 1;
    IF ((nEventIdx := (nEventIdx + 1)) = nMaxEvents) THEN
        nEventIdx := 0;
    END_IF
END_WHILE

IF (nFailures = nMaxEvents) THEN
    ADSLOGSTR(
        msgCtrlMask := ADSLOG_MSGTYPE_ERROR,
        msgFmtStr   := &#39;Logging message buffer full (%s)&#39;,
        strArg              := UINT_TO_STRING(nMaxEvents),
    );
    RETURN;
END_IF

nPendingEvents                      :=      nPendingEvents + 1;
nCntMessagesSent            :=      nCntMessagesSent + 1;

stPendingEvent                      REF= stPendingEvents[nEventIdx];
stEventInfo                         REF= stPendingEvent.stEventInfo;
stPendingEvent.bInUse       := TRUE;

stEventInfo.id                      := fbEvent.nEventId;
stEventInfo.event_class     := GUID_TO_STRING(fbEvent.EventClass);
stEventInfo.severity        := fbEvent.eSeverity;
stEventInfo.ts                      := F_ConvertTicksToUnixTimestamp(fbEvent.nTimestamp);
stEventInfo.source          := fbEvent.ipSourceInfo.sName;
stEventInfo.event_type      := eEventType;

fbEvent.GetJsonAttribute(stEventInfo.json, SIZEOF(stEventInfo.json));
stPendingEvent.fbRequestEventText.Request(eventClass:=fbEvent.EventClass, nEventId:=fbEvent.nEventId, nLangId:=1033, ipArgs:=fbEvent.ipArguments);
END_METHOD

PROPERTY PUBLIC LogToVisualStudio : BOOL
VAR
END_VAR
LogToVisualStudio := bLogToVisualStudio;
END_PROPERTY

PROPERTY PUBLIC LogToVisualStudio : BOOL
VAR
    bValue : BOOL;
END_VAR
THIS^.bLogToVisualStudio := bValue;
END_PROPERTY
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#f-converttickstounixtimestamp">F_ConvertTicksToUnixTimestamp</a></p></li>
<li><p><a class="reference internal" href="#f-sendudpmessage">F_SendUDPMessage</a></p></li>
<li><p><a class="reference internal" href="#gvl-logger">GVL_Logger</a></p></li>
<li><p><a class="reference internal" href="#st-pendingevent">ST_PendingEvent</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-loghandler">
<h2>FB_LogHandler<a class="headerlink" href="#fb-loghandler" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_LogHandler</span>
<span class="n">VAR_INPUT</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ADS</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbTcAdsListener</span> <span class="p">:</span> <span class="n">FB_Listener</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Router</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbTcRouterListener</span> <span class="p">:</span> <span class="n">FB_Listener</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">RTime</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbTcRTimeListener</span> <span class="p">:</span> <span class="n">FB_Listener</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">System</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbTcSystemListener</span> <span class="p">:</span> <span class="n">FB_Listener</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Windows</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbWindowsListener</span> <span class="p">:</span> <span class="n">FB_Listener</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">LCLS</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbLCLSListener</span>  <span class="p">:</span> <span class="n">FB_Listener</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>

    <span class="n">bInitialized</span>    <span class="p">:</span>       <span class="n">BOOL</span>    <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bReadyToLog</span>             <span class="p">:</span>       <span class="n">BOOL</span>    <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">rtFirstLog</span>              <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>

    <span class="n">fbGetHostName</span>   <span class="p">:</span> <span class="n">FB_GetPLCHostname</span><span class="p">;</span>
    <span class="n">fbGetIP</span>                 <span class="p">:</span> <span class="n">FB_GetPLCIPAddress</span><span class="p">;</span>

    <span class="n">fbListener</span>              <span class="p">:</span>       <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">FB_Listener</span><span class="p">;</span>
    <span class="n">fbListeners</span>             <span class="p">:</span>       <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">nNumListeners</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="n">OF</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">FB_Listener</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Default</span> <span class="n">minimum</span> <span class="n">severity</span> <span class="k">for</span> <span class="n">subscriptions</span>
    <span class="n">eMinSeverity</span>    <span class="p">:</span>       <span class="n">TcEventSeverity</span> <span class="o">:=</span> <span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Verbose</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;naming&#39;</span> <span class="o">:=</span> <span class="s1">&#39;omit&#39;</span><span class="p">}</span>
    <span class="n">rtReset</span>                         <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span> <span class="o">//</span><span class="n">Reset</span> <span class="n">trigger</span>
    <span class="n">bReset</span>                          <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">fbSocket</span>                        <span class="p">:</span>       <span class="n">FB_ConnectionlessSocket</span><span class="p">;</span>

    <span class="n">nI</span>                                      <span class="p">:</span>       <span class="n">UINT</span><span class="p">;</span>

    <span class="n">SocketEnable</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">ctuSocketError</span> <span class="p">:</span> <span class="n">CTU</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PV</span><span class="o">:=</span><span class="mi">3</span><span class="p">);</span> <span class="o">//</span> <span class="n">Circuit</span> <span class="n">breaker</span> <span class="k">for</span> <span class="n">socket</span> <span class="n">errors</span><span class="o">.</span> <span class="mi">3</span> <span class="n">errors</span> <span class="n">before</span> <span class="n">it</span> <span class="n">stops</span><span class="o">.</span>

    <span class="n">tRetryConnection</span> <span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#1h); // Retry after an hour</span>

    <span class="n">tofTrickleBreakerPre</span> <span class="p">:</span> <span class="n">TOF</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#1s);</span>
    <span class="n">tonTrickleBreaker</span> <span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span> <span class="o">:=</span> <span class="n">GVL_Logger</span><span class="o">.</span><span class="n">nTrickleTripTime</span><span class="p">);</span>
    <span class="n">bTripCon</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">nNumListeners</span>           <span class="p">:</span>       <span class="n">UINT</span>    <span class="o">:=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="n">DisarmCountDefault</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span><span class="mi">5</span><span class="p">;</span> <span class="o">//</span> <span class="c1"># number of cycles to permit below threshold condition</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInitialized</span> <span class="n">THEN</span>
    <span class="n">bInitialized</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fbTcAdsListener</span><span class="o">.</span><span class="n">Configure</span><span class="p">(</span><span class="n">i_EventClass</span><span class="o">:=</span><span class="n">TC_EVENT_CLASSES</span><span class="o">.</span><span class="n">TcGeneralAdsEventClass</span><span class="p">,</span> <span class="n">i_MinSeverity</span><span class="o">:=</span><span class="n">eMinSeverity</span><span class="p">,</span> <span class="n">i_fbSocket</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbSocket</span><span class="p">));</span>
    <span class="n">fbTcRouterListener</span><span class="o">.</span><span class="n">Configure</span><span class="p">(</span><span class="n">i_EventClass</span><span class="o">:=</span><span class="n">TC_EVENT_CLASSES</span><span class="o">.</span><span class="n">TcRouterEventClass</span><span class="p">,</span> <span class="n">i_MinSeverity</span><span class="o">:=</span><span class="n">eMinSeverity</span><span class="p">,</span> <span class="n">i_fbSocket</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbSocket</span><span class="p">));</span>
    <span class="n">fbTcRTimeListener</span><span class="o">.</span><span class="n">Configure</span><span class="p">(</span><span class="n">i_EventClass</span><span class="o">:=</span><span class="n">TC_EVENT_CLASSES</span><span class="o">.</span><span class="n">TcRTimeEventClass</span><span class="p">,</span> <span class="n">i_MinSeverity</span><span class="o">:=</span><span class="n">eMinSeverity</span><span class="p">,</span> <span class="n">i_fbSocket</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbSocket</span><span class="p">));</span>
    <span class="n">fbTcSystemListener</span><span class="o">.</span><span class="n">Configure</span><span class="p">(</span><span class="n">i_EventClass</span><span class="o">:=</span><span class="n">TC_EVENT_CLASSES</span><span class="o">.</span><span class="n">TcSystemEventClass</span><span class="p">,</span> <span class="n">i_MinSeverity</span><span class="o">:=</span><span class="n">eMinSeverity</span><span class="p">,</span> <span class="n">i_fbSocket</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbSocket</span><span class="p">));</span>
    <span class="n">fbWindowsListener</span><span class="o">.</span><span class="n">Configure</span><span class="p">(</span><span class="n">i_EventClass</span><span class="o">:=</span><span class="n">TC_EVENT_CLASSES</span><span class="o">.</span><span class="n">Win32EventClass</span><span class="p">,</span> <span class="n">i_MinSeverity</span><span class="o">:=</span><span class="n">eMinSeverity</span><span class="p">,</span> <span class="n">i_fbSocket</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbSocket</span><span class="p">));</span>
    <span class="n">fbLCLSListener</span><span class="o">.</span><span class="n">Configure</span><span class="p">(</span><span class="n">i_EventClass</span><span class="o">:=</span><span class="n">TC_EVENT_CLASSES</span><span class="o">.</span><span class="n">LCLSGeneralEventClass</span><span class="p">,</span> <span class="n">i_MinSeverity</span><span class="o">:=</span><span class="n">eMinSeverity</span><span class="p">,</span> <span class="n">i_fbSocket</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbSocket</span><span class="p">));</span>

    <span class="n">fbListeners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbTcAdsListener</span><span class="p">);</span>
    <span class="n">fbListeners</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbTcRouterListener</span><span class="p">);</span>
    <span class="n">fbListeners</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbTcRTimeListener</span><span class="p">);</span>
    <span class="n">fbListeners</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbTcSystemListener</span><span class="p">);</span>
    <span class="n">fbListeners</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbWindowsListener</span><span class="p">);</span>
    <span class="n">fbListeners</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbLCLSListener</span><span class="p">);</span>

<span class="n">END_IF</span>

<span class="n">fbGetHostName</span><span class="p">(</span>
    <span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">sHostname</span> <span class="o">=&gt;</span> <span class="n">GVL_Logger</span><span class="o">.</span><span class="n">sPlcHostname</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbGetIP</span><span class="p">(</span>
    <span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">sIPAddress</span> <span class="o">=&gt;</span> <span class="n">fbSocket</span><span class="o">.</span><span class="n">sLocalHost</span>
<span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Ensure</span> <span class="n">the</span> <span class="n">socket</span> <span class="ow">is</span> <span class="n">ready</span> <span class="k">for</span> <span class="n">when</span> <span class="n">JSON</span> <span class="n">documents</span> <span class="n">are</span> <span class="n">emitted</span> <span class="o">*</span><span class="p">)</span>
<span class="n">rtReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bReset</span><span class="p">);</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">rtReset</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">fbSocket</span><span class="o">.</span><span class="n">bEnable</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">fbSocket</span><span class="p">(</span><span class="n">bEnable</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Disable</span> <span class="n">fbSocket</span> <span class="k">if</span> <span class="n">too</span> <span class="n">many</span> <span class="n">errors</span> <span class="n">occur</span>
<span class="n">ctuSocketError</span><span class="p">(</span><span class="n">CU</span><span class="o">:=</span><span class="n">fbSocket</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span> <span class="n">RESET</span><span class="o">:=</span><span class="n">tRetryConnection</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">rtReset</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">SocketEnable</span> <span class="n">R</span><span class="o">=</span> <span class="n">ctuSocketError</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Retry</span> <span class="n">an</span> <span class="n">hour</span> <span class="n">later</span>
<span class="n">tRetryConnection</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">ctuSocketError</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">SocketEnable</span> <span class="n">S</span><span class="o">=</span> <span class="n">tRetryConnection</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">rtReset</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="n">fbSocket</span><span class="p">(</span>
    <span class="n">nLocalPort</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">fbGetIP</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
    <span class="n">nMode</span><span class="o">:=</span><span class="n">CONNECT_MODE_ENABLEDBG</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">bReadyToLog</span> <span class="o">:=</span> <span class="p">(</span>
    <span class="n">fbGetHostName</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span>
    <span class="n">fbGetIP</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span>
    <span class="n">bInitialized</span> <span class="n">AND</span>
    <span class="n">fbSocket</span><span class="o">.</span><span class="n">bEnable</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">fbSocket</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span>
    <span class="n">fbSocket</span><span class="o">.</span><span class="n">eState</span> <span class="o">=</span> <span class="n">E_SocketConnectionlessState</span><span class="o">.</span><span class="n">eSOCKET_CREATED</span>
<span class="p">);</span>
<span class="n">rtFirstLog</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bReadyToLog</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">rtFirstLog</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">fbRootLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Logging system online&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">,</span>
                 <span class="n">eSubsystem</span><span class="o">:=</span><span class="n">E_Subsystem</span><span class="o">.</span><span class="n">NILVALUE</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">CircuitBreaker</span><span class="p">();</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Poke</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">listeners</span> <span class="o">*</span><span class="p">)</span>
<span class="n">FOR</span> <span class="n">nI</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">nNumListeners</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">DO</span>
    <span class="n">fbListener</span> <span class="n">REF</span><span class="o">=</span> <span class="n">fbListeners</span><span class="p">[</span><span class="n">nI</span><span class="p">]</span><span class="o">^</span><span class="p">;</span>
    <span class="n">fbListener</span><span class="o">.</span><span class="n">Execute</span><span class="p">();</span>
    <span class="n">fbListener</span><span class="o">.</span><span class="n">PublishEvents</span><span class="p">();</span>
<span class="n">END_FOR</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">CircuitBreaker</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Global</span> <span class="n">log</span> <span class="n">circuit</span> <span class="n">breaker</span>
<span class="p">(</span><span class="o">*</span>
<span class="n">Logic</span> <span class="n">explanation</span>
<span class="n">We</span> <span class="n">want</span> <span class="n">to</span> <span class="n">trip</span> <span class="k">if</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">constant</span> <span class="n">stream</span> <span class="n">of</span> <span class="n">messages</span> <span class="n">being</span> <span class="n">emitted</span> <span class="n">by</span> <span class="n">this</span> <span class="n">PLC</span><span class="o">.</span> <span class="n">We</span> <span class="n">also</span>
<span class="n">only</span> <span class="n">want</span> <span class="n">the</span> <span class="n">noisy</span> <span class="n">offenders</span> <span class="n">to</span> <span class="n">trip</span><span class="o">.</span> <span class="n">To</span> <span class="n">target</span> <span class="n">them</span> <span class="n">we</span> <span class="nb">set</span> <span class="n">a</span> <span class="k">global</span> <span class="n">trickle</span> <span class="n">tripped</span> <span class="n">flag</span>
<span class="n">using</span> <span class="n">this</span> <span class="n">logic</span> <span class="n">here</span><span class="o">.</span> <span class="n">Then</span> <span class="n">each</span> <span class="n">individual</span> <span class="n">FB_LogMessage</span> <span class="n">evaluates</span> <span class="n">itself</span> <span class="n">to</span> <span class="n">see</span> <span class="k">if</span> <span class="n">it</span><span class="s1">&#39;s</span>
<span class="n">sending</span> <span class="n">a</span> <span class="n">message</span> <span class="n">too</span> <span class="n">frequently</span> <span class="p">(</span><span class="n">ie</span><span class="o">.</span> <span class="n">it</span><span class="s1">&#39;s being called to often).</span>

<span class="n">This</span> <span class="n">logic</span> <span class="ow">is</span> <span class="n">attempting</span> <span class="n">to</span> <span class="n">implement</span> <span class="n">the</span> <span class="n">following</span><span class="p">:</span>
<span class="mf">1.</span> <span class="n">Trip</span> <span class="k">if</span> <span class="n">the</span> <span class="n">total</span> <span class="n">events</span> <span class="n">exceeds</span> <span class="n">the</span> <span class="n">nTrickleThreshold</span> <span class="k">for</span> <span class="o">&gt;</span><span class="mi">10</span><span class="n">s</span>
<span class="mf">2.</span> <span class="n">Sustain</span> <span class="n">the</span> <span class="n">timer</span> <span class="k">if</span> <span class="n">the</span> <span class="n">event</span> <span class="n">count</span> <span class="n">drops</span> <span class="k">for</span> <span class="n">a</span> <span class="n">handful</span> <span class="n">of</span> <span class="n">cycles</span> <span class="n">since</span> <span class="n">usually</span> <span class="n">a</span> <span class="n">cycle</span> <span class="n">amounts</span> <span class="n">to</span> <span class="mi">10</span><span class="n">ms</span><span class="p">,</span> <span class="n">losing</span> <span class="n">a</span> <span class="n">few</span>
<span class="n">should</span> <span class="ow">not</span> <span class="n">stop</span> <span class="n">the</span> <span class="n">trickle</span> <span class="n">timer</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">bTripCon</span> <span class="o">:=</span> <span class="n">GVL_Logger</span><span class="o">.</span><span class="n">nGlobAccEvents</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">;</span>

<span class="n">tofTrickleBreakerPre</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">bTripCon</span><span class="p">);</span>
<span class="n">tonTrickleBreaker</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">tofTrickleBreakerPre</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>

<span class="n">GVL_Logger</span><span class="o">.</span><span class="n">bTrickleTripped</span> <span class="n">S</span><span class="o">=</span> <span class="n">tonTrickleBreaker</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">bTripCon</span><span class="p">;</span>

<span class="n">GVL_Logger</span><span class="o">.</span><span class="n">nGlobAccEvents</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">//</span> <span class="n">reset</span> <span class="n">the</span> <span class="n">count</span> <span class="k">for</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">cycle</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-subsystem">E_Subsystem</a></p></li>
<li><p><a class="reference internal" href="#fb-getplchostname">FB_GetPLCHostname</a></p></li>
<li><p><a class="reference internal" href="#fb-getplcipaddress">FB_GetPLCIPAddress</a></p></li>
<li><p><a class="reference internal" href="#fb-listener">FB_Listener</a></p></li>
<li><p><a class="reference internal" href="#fb-logmessage">FB_LogMessage</a></p></li>
<li><p><a class="reference internal" href="#gvl-logger">GVL_Logger</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-logmessage">
<h2>FB_LogMessage<a class="headerlink" href="#fb-logmessage" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;reflection&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_LogMessage</span>
<span class="n">VAR_INPUT</span>
    <span class="n">sMsg</span>                    <span class="p">:</span> <span class="n">T_MaxString</span><span class="p">;</span>                                  <span class="o">//</span> <span class="n">Message</span> <span class="n">to</span> <span class="n">send</span>
    <span class="n">eSevr</span>                   <span class="p">:</span> <span class="n">TcEventSeverity</span>       <span class="o">:=</span> <span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Verbose</span><span class="p">;</span>
    <span class="n">eSubsystem</span>              <span class="p">:</span> <span class="n">E_Subsystem</span><span class="p">;</span>                                  <span class="o">//</span> <span class="n">Subsystem</span>
    <span class="n">sJson</span>                   <span class="p">:</span> <span class="n">STRING</span><span class="p">(</span><span class="mi">7000</span><span class="p">)</span>  <span class="o">:=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">;</span>                <span class="o">//</span> <span class="n">JSON</span> <span class="n">to</span> <span class="n">add</span> <span class="n">to</span> <span class="n">the</span> <span class="n">message</span>

    <span class="o">//</span><span class="n">Circuit</span> <span class="n">breaker</span> <span class="n">settings</span>
    <span class="n">nMinTimeViolationAcceptable</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="n">GVL_Logger</span><span class="o">.</span><span class="n">nMinTimeViolationAcceptable</span><span class="p">;</span> <span class="o">//</span> <span class="n">How</span> <span class="n">many</span> <span class="n">times</span> <span class="n">the</span> <span class="nb">min</span><span class="o">.</span> <span class="n">time</span> <span class="n">can</span> <span class="n">be</span> <span class="n">violated</span> <span class="n">before</span> <span class="n">the</span> <span class="n">CB</span> <span class="n">trips</span>
    <span class="n">nLocalTripThreshold</span> <span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">GVL_Logger</span><span class="o">.</span><span class="n">nLocalTripThreshold</span><span class="p">;</span> <span class="o">//</span> <span class="n">Minimum</span> <span class="n">time</span> <span class="n">between</span> <span class="n">calls</span> <span class="n">allowed</span><span class="p">,</span> <span class="n">pairs</span> <span class="k">with</span> <span class="n">nMinTimeViolationAcceptable</span>
    <span class="n">nTrickleTripThreshold</span> <span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">GVL_Logger</span><span class="o">.</span><span class="n">nLocalTrickleTripThreshold</span><span class="p">;</span> <span class="o">//</span> <span class="n">Trickle</span> <span class="n">trip</span><span class="p">,</span> <span class="n">activated</span> <span class="n">by</span> <span class="k">global</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">should</span> <span class="n">be</span> <span class="o">&gt;&gt;</span> <span class="n">LocalTripThreshold</span>
    <span class="n">nTripResetPeriod</span> <span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">GVL_Logger</span><span class="o">.</span><span class="n">nTripResetPeriod</span><span class="p">;</span> <span class="o">//</span> <span class="n">Time</span> <span class="k">for</span> <span class="n">auto</span><span class="o">-</span><span class="n">reset</span>
    <span class="n">bEnableAutoReset</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="o">//</span><span class="n">Enable</span> <span class="n">circuit</span> <span class="n">breaker</span> <span class="n">auto</span><span class="o">-</span><span class="n">reset</span> <span class="p">(</span><span class="n">true</span> <span class="n">by</span> <span class="n">default</span><span class="p">)</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">bInitialized</span>            <span class="p">:</span>       <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bInitFailed</span>                     <span class="p">:</span>       <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">sSubsystemSource</span>        <span class="p">:</span>       <span class="n">STRING</span><span class="p">;</span>
    <span class="n">fbMessage</span>                       <span class="p">:</span>       <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">FB_TcMessage</span><span class="p">;</span>
    <span class="n">fbMessages</span>                      <span class="p">:</span>       <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0..4</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_TcMessage</span><span class="p">;</span>
    <span class="n">fbSource</span>                        <span class="p">:</span>       <span class="n">FB_TcSourceInfo</span><span class="p">;</span>
    <span class="n">ipResultMessage</span>         <span class="p">:</span>       <span class="n">I_TcMessage</span><span class="p">;</span>
    <span class="n">hr</span>                                      <span class="p">:</span>       <span class="n">HRESULT</span><span class="p">;</span>
    <span class="n">hrLastInternalError</span> <span class="p">:</span>   <span class="n">HRESULT</span><span class="p">;</span>
    <span class="n">eTraceLevel</span>             <span class="p">:</span>       <span class="n">TcEventSeverity</span> <span class="o">:=</span> <span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Verbose</span><span class="p">;</span>
    <span class="n">bFirstCall</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;instance-path&#39;</span><span class="p">}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;noinit&#39;</span><span class="p">}</span>
    <span class="n">sPath</span>                           <span class="p">:</span>       <span class="n">T_MaxString</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Circuit</span> <span class="n">breaker</span>
    <span class="o">///////////////////////////////</span>
        <span class="n">nTotalEvents</span>       <span class="p">:</span>   <span class="n">UINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">events</span> <span class="n">accumulated</span> <span class="n">over</span> <span class="n">the</span> <span class="n">last</span> <span class="n">nAccWidth</span><span class="o">*</span><span class="n">nEventTripPeriod</span>
        <span class="n">nTimesViolated</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>

        <span class="n">LastCallTime</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>
        <span class="n">CurrentCallTime</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>
        <span class="n">DeltaSinceLastCall</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>

        <span class="n">WhenTripsCleared</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>
        <span class="n">ftTrippedReleased</span> <span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>

        <span class="n">bLocalTrickleTripped</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
        <span class="n">bLocalTripped</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
            <span class="n">pv</span><span class="p">:</span> <span class="n">Tripped</span>
            <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Log</span> <span class="n">message</span> <span class="n">FB</span> <span class="n">tripped</span>
        <span class="s1">&#39;}</span>
        <span class="n">bTripped</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Won</span><span class="s1">&#39;t emit messages if true</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
            <span class="n">pv</span><span class="p">:</span> <span class="n">Reset</span>
            <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
            <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Rising</span><span class="o">-</span><span class="n">edge</span> <span class="n">reset</span> <span class="n">of</span> <span class="n">trip</span>
        <span class="s1">&#39;}</span>
        <span class="n">bResetBreaker</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
        <span class="n">rtResetBreaker</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>

        <span class="n">rtTripped</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="o">////////////////////////////////////////////</span>

<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInitialized</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bInitFailed</span> <span class="n">THEN</span>

    <span class="n">hr</span> <span class="o">:=</span> <span class="n">fbMessages</span><span class="p">[</span><span class="n">TC_EVENTS</span><span class="o">.</span><span class="n">LCLSGeneralEventClass</span><span class="o">.</span><span class="n">Verbose</span><span class="o">.</span><span class="n">nEventId</span><span class="p">]</span><span class="o">.</span><span class="n">CreateEx</span><span class="p">(</span><span class="n">TC_EVENTS</span><span class="o">.</span><span class="n">LCLSGeneralEventClass</span><span class="o">.</span><span class="n">Verbose</span><span class="p">,</span> <span class="mi">0</span> <span class="p">(</span><span class="o">*</span><span class="n">fbSource</span><span class="o">*</span><span class="p">)</span> <span class="p">);</span>
    <span class="n">IF</span> <span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">)</span> <span class="n">THEN</span>
        <span class="n">bInitFailed</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">hrLastInternalError</span> <span class="o">:=</span> <span class="n">hr</span><span class="p">;</span>
    <span class="n">END_IF</span>

    <span class="n">hr</span> <span class="o">:=</span> <span class="n">fbMessages</span><span class="p">[</span><span class="n">TC_EVENTS</span><span class="o">.</span><span class="n">LCLSGeneralEventClass</span><span class="o">.</span><span class="n">Warning</span><span class="o">.</span><span class="n">nEventId</span><span class="p">]</span><span class="o">.</span><span class="n">CreateEx</span><span class="p">(</span><span class="n">TC_EVENTS</span><span class="o">.</span><span class="n">LCLSGeneralEventClass</span><span class="o">.</span><span class="n">Warning</span><span class="p">,</span> <span class="mi">0</span> <span class="p">(</span><span class="o">*</span><span class="n">fbSource</span><span class="o">*</span><span class="p">)</span> <span class="p">);</span>
    <span class="n">IF</span> <span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">)</span> <span class="n">THEN</span>
        <span class="n">bInitFailed</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">hrLastInternalError</span> <span class="o">:=</span> <span class="n">hr</span><span class="p">;</span>
    <span class="n">END_IF</span>

    <span class="n">hr</span> <span class="o">:=</span> <span class="n">fbMessages</span><span class="p">[</span><span class="n">TC_EVENTS</span><span class="o">.</span><span class="n">LCLSGeneralEventClass</span><span class="o">.</span><span class="n">Info</span><span class="o">.</span><span class="n">nEventId</span><span class="p">]</span><span class="o">.</span><span class="n">CreateEx</span><span class="p">(</span><span class="n">TC_EVENTS</span><span class="o">.</span><span class="n">LCLSGeneralEventClass</span><span class="o">.</span><span class="n">Info</span><span class="p">,</span> <span class="mi">0</span> <span class="p">(</span><span class="o">*</span><span class="n">fbSource</span><span class="o">*</span><span class="p">)</span> <span class="p">);</span>
    <span class="n">IF</span> <span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">)</span> <span class="n">THEN</span>
        <span class="n">bInitFailed</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">hrLastInternalError</span> <span class="o">:=</span> <span class="n">hr</span><span class="p">;</span>
    <span class="n">END_IF</span>

    <span class="n">hr</span> <span class="o">:=</span> <span class="n">fbMessages</span><span class="p">[</span><span class="n">TC_EVENTS</span><span class="o">.</span><span class="n">LCLSGeneralEventClass</span><span class="o">.</span><span class="n">Error</span><span class="o">.</span><span class="n">nEventId</span><span class="p">]</span><span class="o">.</span><span class="n">CreateEx</span><span class="p">(</span><span class="n">TC_EVENTS</span><span class="o">.</span><span class="n">LCLSGeneralEventClass</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span> <span class="mi">0</span> <span class="p">(</span><span class="o">*</span><span class="n">fbSource</span><span class="o">*</span><span class="p">)</span> <span class="p">);</span>
    <span class="n">IF</span> <span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">)</span> <span class="n">THEN</span>
        <span class="n">bInitFailed</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">hrLastInternalError</span> <span class="o">:=</span> <span class="n">hr</span><span class="p">;</span>
    <span class="n">END_IF</span>

    <span class="n">hr</span> <span class="o">:=</span> <span class="n">fbMessages</span><span class="p">[</span><span class="n">TC_EVENTS</span><span class="o">.</span><span class="n">LCLSGeneralEventClass</span><span class="o">.</span><span class="n">Critical</span><span class="o">.</span><span class="n">nEventId</span><span class="p">]</span><span class="o">.</span><span class="n">CreateEx</span><span class="p">(</span><span class="n">TC_EVENTS</span><span class="o">.</span><span class="n">LCLSGeneralEventClass</span><span class="o">.</span><span class="n">Critical</span><span class="p">,</span> <span class="mi">0</span> <span class="p">(</span><span class="o">*</span><span class="n">fbSource</span><span class="o">*</span><span class="p">)</span> <span class="p">);</span>
    <span class="n">IF</span> <span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">)</span> <span class="n">THEN</span>
        <span class="n">bInitFailed</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">hrLastInternalError</span> <span class="o">:=</span> <span class="n">hr</span><span class="p">;</span>
    <span class="n">END_IF</span>

    <span class="n">IF</span> <span class="n">bInitFailed</span> <span class="n">THEN</span>
        <span class="n">ADSLOGSTR</span><span class="p">(</span>
            <span class="n">msgCtrlMask</span> <span class="o">:=</span> <span class="n">ADSLOG_MSGTYPE_ERROR</span><span class="p">,</span>
            <span class="n">msgFmtStr</span>   <span class="o">:=</span> <span class="s1">&#39;[LOGGER] Initialization failed in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">strArg</span>      <span class="o">:=</span> <span class="n">sPath</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">bInitialized</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bInitFailed</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="o">///////////////////////////////////////</span>
<span class="o">//</span> <span class="n">Log</span> <span class="n">message</span> <span class="n">circuit</span> <span class="n">breaker</span>

<span class="n">CircuitBreaker</span><span class="p">();</span>
<span class="n">IF</span> <span class="n">bTripped</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">rtTripped</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">RETURN</span><span class="p">;</span> <span class="n">END_IF</span> <span class="o">//</span> <span class="n">Pass</span> <span class="n">on</span> <span class="n">the</span> <span class="n">first</span> <span class="n">one</span> <span class="n">to</span> <span class="n">deliver</span> <span class="n">the</span> <span class="n">message</span> <span class="n">we</span><span class="s1">&#39;re going silent</span>

<span class="o">///////////////////////////////////////////////////////////</span>



<span class="o">//</span> <span class="n">Map</span> <span class="n">the</span> <span class="n">message</span> <span class="n">severity</span> <span class="n">to</span> <span class="n">the</span> <span class="n">LCLSGeneralEventClass</span><span class="p">:</span>
<span class="n">CASE</span> <span class="n">eSevr</span> <span class="n">OF</span>
    <span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Verbose</span><span class="p">:</span>        <span class="n">fbMessage</span> <span class="n">REF</span><span class="o">=</span> <span class="n">fbMessages</span><span class="p">[</span><span class="n">TC_EVENTS</span><span class="o">.</span><span class="n">LCLSGeneralEventClass</span><span class="o">.</span><span class="n">Verbose</span><span class="o">.</span><span class="n">nEventId</span><span class="p">];</span>
    <span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">:</span>        <span class="n">fbMessage</span> <span class="n">REF</span><span class="o">=</span> <span class="n">fbMessages</span><span class="p">[</span><span class="n">TC_EVENTS</span><span class="o">.</span><span class="n">LCLSGeneralEventClass</span><span class="o">.</span><span class="n">Warning</span><span class="o">.</span><span class="n">nEventId</span><span class="p">];</span>
    <span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Info</span><span class="p">:</span>           <span class="n">fbMessage</span> <span class="n">REF</span><span class="o">=</span> <span class="n">fbMessages</span><span class="p">[</span><span class="n">TC_EVENTS</span><span class="o">.</span><span class="n">LCLSGeneralEventClass</span><span class="o">.</span><span class="n">Info</span><span class="o">.</span><span class="n">nEventId</span><span class="p">];</span>
    <span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>          <span class="n">fbMessage</span> <span class="n">REF</span><span class="o">=</span> <span class="n">fbMessages</span><span class="p">[</span><span class="n">TC_EVENTS</span><span class="o">.</span><span class="n">LCLSGeneralEventClass</span><span class="o">.</span><span class="n">Error</span><span class="o">.</span><span class="n">nEventId</span><span class="p">];</span>
    <span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Critical</span><span class="p">:</span>       <span class="n">fbMessage</span> <span class="n">REF</span><span class="o">=</span> <span class="n">fbMessages</span><span class="p">[</span><span class="n">TC_EVENTS</span><span class="o">.</span><span class="n">LCLSGeneralEventClass</span><span class="o">.</span><span class="n">Critical</span><span class="o">.</span><span class="n">nEventId</span><span class="p">];</span>
    <span class="n">ELSE</span>
        <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_CASE</span>

<span class="n">CASE</span> <span class="n">eSubsystem</span> <span class="n">OF</span>
    <span class="n">E_Subsystem</span><span class="o">.</span><span class="n">FIELDBUS</span><span class="p">:</span>   <span class="n">sSubsystemSource</span> <span class="o">:=</span> <span class="s1">&#39;/Fieldbus&#39;</span><span class="p">;</span>
    <span class="n">E_Subsystem</span><span class="o">.</span><span class="n">MOTION</span><span class="p">:</span>     <span class="n">sSubsystemSource</span> <span class="o">:=</span> <span class="s1">&#39;/Motion&#39;</span><span class="p">;</span>
    <span class="n">E_Subsystem</span><span class="o">.</span><span class="n">MPS</span><span class="p">:</span>                <span class="n">sSubsystemSource</span> <span class="o">:=</span> <span class="s1">&#39;/MPS&#39;</span><span class="p">;</span>
    <span class="n">E_Subsystem</span><span class="o">.</span><span class="n">SDS</span><span class="p">:</span>                <span class="n">sSubsystemSource</span> <span class="o">:=</span> <span class="s1">&#39;/SDS&#39;</span><span class="p">;</span>
    <span class="n">E_Subsystem</span><span class="o">.</span><span class="n">VACUUM</span><span class="p">:</span>             <span class="n">sSubsystemSource</span> <span class="o">:=</span> <span class="s1">&#39;/Vacuum&#39;</span><span class="p">;</span>
    <span class="n">E_Subsystem</span><span class="o">.</span><span class="n">OPTICS</span><span class="p">:</span>     <span class="n">sSubsystemSource</span> <span class="o">:=</span> <span class="s1">&#39;/Optics&#39;</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">sSubsystemSource</span> <span class="o">:=</span> <span class="s1">&#39;/Unknown&#39;</span><span class="p">;</span>
<span class="n">END_CASE</span>

<span class="o">//</span> <span class="n">Clearing</span> <span class="n">the</span> <span class="n">source</span> <span class="n">here</span> <span class="n">will</span> <span class="n">clear</span> <span class="n">the</span> <span class="n">event</span> <span class="n">GUID</span><span class="p">,</span> <span class="n">causing</span> <span class="n">the</span> <span class="n">message</span> <span class="n">to</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">resolved</span><span class="o">.</span>
<span class="o">//</span> <span class="n">However</span><span class="p">,</span> <span class="n">we</span> <span class="n">can</span> <span class="n">change</span> <span class="n">the</span> <span class="n">name</span> <span class="k">as</span> <span class="n">desired</span><span class="p">:</span>
<span class="o">//</span><span class="n">fbSource</span><span class="o">.</span><span class="n">Clear</span><span class="p">();</span>
<span class="n">fbSource</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sPath</span><span class="p">,</span> <span class="n">sSubsystemSource</span><span class="p">);</span>

<span class="n">ipResultMessage</span> <span class="o">:=</span> <span class="n">fbMessage</span><span class="p">;</span>
<span class="n">hr</span> <span class="o">:=</span> <span class="n">fbMessage</span><span class="o">.</span><span class="n">CreateEx</span><span class="p">(</span><span class="n">stEventEntry</span><span class="o">:=</span><span class="n">ipResultMessage</span><span class="o">.</span><span class="n">stEventEntry</span><span class="p">,</span> <span class="n">ipSourceInfo</span><span class="o">:=</span><span class="n">fbSource</span><span class="p">);</span>

<span class="o">//</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">where</span> <span class="n">the</span> <span class="n">message</span> <span class="n">text</span> <span class="n">gets</span> <span class="n">appended</span><span class="p">:</span>
<span class="n">fbMessage</span><span class="o">.</span><span class="n">ipArguments</span><span class="o">.</span><span class="n">Clear</span><span class="p">();</span>

<span class="n">IF</span> <span class="n">rtTripped</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
   <span class="n">fbMessage</span><span class="o">.</span><span class="n">ipArguments</span><span class="o">.</span><span class="n">AddString</span><span class="p">(</span><span class="s1">&#39;Logging circuit breaker tripped, this will be the last message from this element for a while...&#39;</span><span class="p">);</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">bTripped</span> <span class="n">THEN</span>
    <span class="n">fbMessage</span><span class="o">.</span><span class="n">ipArguments</span><span class="o">.</span><span class="n">AddString</span><span class="p">(</span><span class="n">sMsg</span><span class="p">);</span>
<span class="n">END_IF</span>


<span class="n">IF</span> <span class="n">LEN</span><span class="p">(</span><span class="n">sJson</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Ensure</span> <span class="n">there</span><span class="s1">&#39;s a valid JSON string here</span>
    <span class="n">sJson</span> <span class="o">:=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbMessage</span><span class="o">.</span><span class="n">SetJsonAttribute</span><span class="p">(</span><span class="n">sJson</span><span class="p">);</span>

<span class="o">//</span> <span class="n">For</span> <span class="n">a</span> <span class="n">final</span> <span class="nb">format</span> <span class="n">of</span><span class="p">:</span>
<span class="o">//</span> <span class="s1">&#39;Path.to.FB_LogMessage/Subsystem&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">Unknown</span><span class="p">,</span><span class="n">Error</span><span class="p">,</span><span class="ne">Warning</span><span class="p">,</span><span class="n">Verbose</span><span class="p">}</span> <span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="o">//</span> <span class="n">We</span> <span class="n">want</span> <span class="n">to</span> <span class="n">send</span> <span class="mi">1</span> <span class="n">more</span> <span class="n">message</span> <span class="n">when</span> <span class="n">we</span> <span class="n">trip</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">)</span> <span class="n">AND</span> <span class="n">fbMessage</span><span class="o">.</span><span class="n">eSeverity</span> <span class="o">&gt;=</span> <span class="n">eTraceLevel</span> <span class="n">AND</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">bTripped</span> <span class="n">OR</span> <span class="n">rtTripped</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">hr</span> <span class="o">:=</span> <span class="n">fbMessage</span><span class="o">.</span><span class="n">Send</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">hrLastInternalError</span> <span class="o">:=</span> <span class="n">hr</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">CircuitBreaker</span><span class="p">:</span>
<span class="n">GVL_Logger</span><span class="o">.</span><span class="n">nGlobAccEvents</span> <span class="o">:=</span> <span class="n">GVL_Logger</span><span class="o">.</span><span class="n">nGlobAccEvents</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">CurrentCallTime</span> <span class="o">:=</span> <span class="n">F_GetTaskTime</span><span class="p">();</span>
<span class="n">IF</span> <span class="n">bFirstCall</span> <span class="n">THEN</span>
    <span class="n">DeltaSinceLastCall</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#FFFF_FFFF;</span>
    <span class="n">bFirstCall</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSE</span>
   <span class="n">DeltaSinceLastCall</span> <span class="o">:=</span> <span class="n">CurrentCallTime</span> <span class="o">-</span> <span class="n">LastCallTime</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">LastCallTime</span> <span class="o">:=</span> <span class="n">CurrentCallTime</span><span class="p">;</span>

<span class="n">ftTrippedReleased</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bLocalTripped</span> <span class="n">OR</span> <span class="n">bLocalTrickleTripped</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">ftTrippedReleased</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">WhenTripsCleared</span> <span class="o">:=</span> <span class="n">CurrentCallTime</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">rtResetBreaker</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bResetBreaker</span> <span class="n">OR</span>
                <span class="n">bEnableAutoReset</span> <span class="n">AND</span> <span class="p">(</span><span class="n">CurrentCallTime</span> <span class="o">-</span> <span class="n">WhenTripsCleared</span> <span class="o">&gt;</span> <span class="n">TIME_TO_100NS</span><span class="p">(</span><span class="n">nTripResetPeriod</span><span class="p">))</span> <span class="p">);</span>

<span class="n">IF</span> <span class="n">rtResetBreaker</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
   <span class="o">//</span> <span class="n">bLocalTrickleTripped</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//</span><span class="n">bLocalTripped</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bTripped</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//</span><span class="n">nTimesViolated</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">bResetBreaker</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">DeltaSinceLastCall</span> <span class="o">&lt;</span> <span class="n">TIME_TO_100NS</span><span class="p">(</span><span class="n">nLocalTripThreshold</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">nTimesViolated</span> <span class="o">:=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">nTimesViolated</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nMinTimeViolationAcceptable</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="n">ELSE</span>
    <span class="n">nTimesViolated</span> <span class="o">:=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">nTimesViolated</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">bLocalTripped</span> <span class="o">:=</span> <span class="n">nTimesViolated</span> <span class="o">&gt;</span> <span class="n">nMinTimeViolationAcceptable</span><span class="p">;</span>

<span class="n">bLocalTrickleTripped</span> <span class="o">:=</span> <span class="n">DeltaSinceLastCall</span> <span class="o">&lt;</span> <span class="n">TIME_TO_100NS</span><span class="p">(</span><span class="n">nTrickleTripThreshold</span><span class="p">)</span> <span class="n">AND</span> <span class="n">GVL_LOGGER</span><span class="o">.</span><span class="n">bTrickleTripped</span><span class="p">;</span>

<span class="n">bTripped</span> <span class="n">S</span><span class="o">=</span> <span class="n">bLocalTrickleTripped</span> <span class="n">OR</span> <span class="n">bLocalTripped</span><span class="p">;</span>
<span class="n">rtTripped</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bTripped</span><span class="p">);</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-subsystem">E_Subsystem</a></p></li>
<li><p><a class="reference internal" href="#gvl-logger">GVL_Logger</a></p></li>
<li><p><a class="reference internal" href="#time-to-100ns">TIME_TO_100NS</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-lrealbuffer">
<h2>FB_LREALBuffer<a class="headerlink" href="#fb-lrealbuffer" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_LREALBuffer</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">An</span> <span class="n">example</span> <span class="n">use</span> <span class="n">of</span> <span class="n">FB_DataBuffer</span> <span class="k">for</span> <span class="n">the</span> <span class="n">likely</span> <span class="n">most</span><span class="o">-</span><span class="n">common</span> <span class="n">use</span> <span class="n">case</span><span class="o">.</span>
    <span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">09</span> <span class="n">Zachary</span> <span class="n">Lentz</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span><span class="s1">&#39;ll accumulate a value on this cycle.</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">value</span> <span class="n">to</span> <span class="n">accumulate</span><span class="o">.</span>
    <span class="n">fInput</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">arrOutput</span><span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1..1000</span><span class="p">]</span> <span class="n">OF</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bNewArray</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">arrPartial</span><span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1..1000</span><span class="p">]</span> <span class="n">OF</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fbDataBuffer</span><span class="p">:</span> <span class="n">FB_DataBuffer</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbDataBuffer</span><span class="p">(</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bExecute</span><span class="p">,</span>
    <span class="n">pInputAdr</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fInput</span><span class="p">),</span>
    <span class="n">iInputSize</span> <span class="o">:=</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">fInput</span><span class="p">),</span>
    <span class="n">iElemCount</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">pPartialAdr</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">arrPartial</span><span class="p">),</span>
    <span class="n">pOutputAdr</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">arrOutput</span><span class="p">),</span>
    <span class="n">bNewArray</span> <span class="o">=&gt;</span> <span class="n">bNewArray</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-databuffer">FB_DataBuffer</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-lrealfromepics">
<h2>FB_LREALFromEPICS<a class="headerlink" href="#fb-lrealfromepics" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(*
Function block to link an analog value from EPICS to an LREAL on the PLC

Usage:

    {attribute &#39;pytmc&#39; := &#39;
        pv: INTERNAL:RECORD
        link: PV:NAME:TO:LINK:TO
    &#39;}
    fbLinkedValue1 : FB_LREALFromEPICS;

Such that when PV:NAME:TO:LINK:TO changes in EPICS, the INTERNAL:RECORD will be used to
push a value through to the PLC with this function block.

As this block takes care of IOC heartbeat signals and monitors the link and value severity,
the end-user should then only have to look at `.bValid` and `.fValue`. These are guaranteed to
be up-to-date and valid within `tTimeout` seconds.
*)

FUNCTION_BLOCK FB_LREALFromEPICS

VAR_INPUT
    iMaximumValidSeverity           : INT := 1;
END_VAR

VAR_OUTPUT
    bValid                          : BOOL;
    fValue                          : LREAL;
END_VAR

VAR
    iValueInvalidate        : POINTER TO ULINT;
    tonValueTimeout         : TON;
    tonSeverityTimeout      : TON;

    fLastValidValue         : LREAL;
    iLastValidSeverity      : INT;

    {attribute &#39;pytmc&#39; := &#39;
        pv: EPICSLink
        link:
        field: DESC Internal variable used to monitor EPICS PV in PLC
    &#39;}
    fPLCInternalValue : LREAL;

    // Use special link syntax for now to get EPICSLink.SEVR here:
    {attribute &#39;pytmc&#39; := &#39;
        pv: EPICSLink:LinkSeverity
        link: *EPICSLink.SEVR
        field: DESC Internal variable used to monitor EPICS PV severity in PLC
    &#39;}
    iPLCInternalSeverity : INT;

END_VAR
VAR CONSTANT
    // The timeout will trip after `tTimeout` if EPICS doesn&#39;t write in that time period:
    tTimeout                        : TIME := T#2S;
    NAN_VALUE               : ULINT := 16#7f_ff_ff_ff__ff_ff_ff_ff;
END_VAR
iValueInvalidate := ADR(fPLCInternalValue);

IF iPLCInternalSeverity &lt;&gt; -1 THEN
    // New severity value
    iLastValidSeverity := iPLCInternalSeverity;
    iPLCInternalSeverity := -1;

     // Reset the timer
    tonSeverityTimeout(IN:=FALSE);
    tonSeverityTimeout(IN:=TRUE, PT:=tTimeout);
END_IF

IF iValueInvalidate^ &lt;&gt; NAN_VALUE THEN
    // New value from EPICS
    fLastValidValue         := fPLCInternalValue;
    iValueInvalidate^       := NAN_VALUE;

    // Reset the timer
    tonValueTimeout(IN:=FALSE);
    tonValueTimeout(IN:=TRUE, PT:=tTimeout);
END_IF

tonValueTimeout();
tonSeverityTimeout();
bValid := (NOT tonValueTimeout.Q) AND
          (NOT tonSeverityTimeout.Q) AND
          (iLastValidSeverity &lt;= iMaximumValidSeverity);
fValue := fLastValidValue;

END_FUNCTION_BLOCK
</pre></div>
</div>
</section>
<section id="fb-stringfromepics">
<h2>FB_STRINGFromEPICS<a class="headerlink" href="#fb-stringfromepics" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(*
Function block to link an analog value from EPICS to a STRING on the PLC

Usage:

    {attribute &#39;pytmc&#39; := &#39;
        pv: INTERNAL:RECORD
        link: PV:NAME:TO:LINK:TO.VAL@
    &#39;}
    fbLinkedValue1 : FB_STRINGFromEPICS;

Such that when PV:NAME:TO:LINK:TO.VAL$ changes in EPICS, the INTERNAL:RECORD will be used to
push a value through to the PLC with this function block.

The usage of &quot;@&quot; above has several layers of complexity, which are not strictly necessary to
understand in order to use this function block. The reasons are as follows:

    1. TwinCAT does not allow the &quot;$&quot; symbol to be used in pragmas.  pytmc uses &quot;@&quot; as an
       alternate character for &quot;$&quot; as the latter is more frequently useful.
    2. The &quot;$&quot; is used as a suffix for EPICS string PVs where accessing strings over
       the standard 40 character length is desirable.
    3. Combining the above, using &quot;PV.VAL@&quot; we can direct EPICS to use long string
       handling over the Channel Access link to the link PV (&quot;PV.VAL$&quot;).

As this block takes care of IOC heartbeat signals and monitors the link and value severity,
the end-user should then only have to look at `.bValid` and `.sValue`. These are guaranteed to
be up-to-date and valid within `tTimeout` seconds.
*)

FUNCTION_BLOCK FB_STRINGFromEPICS

VAR_INPUT
    iMaximumValidSeverity           : INT := 1;
END_VAR

VAR_OUTPUT
    bValid                          : BOOL;
    sValue                          : STRING;
END_VAR

VAR
    tonValueTimeout         : TON;
    tonSeverityTimeout      : TON;

    sLastValidValue         : STRING;
    iLastValidSeverity      : INT;

    {attribute &#39;pytmc&#39; := &#39;
        pv: EPICSLink
        link:
        field: DESC Internal variable used to monitor EPICS PV in PLC
    &#39;}
    sPLCInternalValue : STRING;

    // Use special link syntax for now to get EPICSLink.SEVR here:
    {attribute &#39;pytmc&#39; := &#39;
        pv: EPICSLink:Sevr
        link: *EPICSLink.SEVR
        field: DESC Internal variable used to monitor EPICS PV severity in PLC
    &#39;}
    iPLCInternalSeverity : INT;

END_VAR
VAR CONSTANT
    // The timeout will trip after `tTimeout` if EPICS doesn&#39;t write in that time period:
    tTimeout                        : TIME := T#2S;
    // This is an arbitrary extended UUID.  If you want to store this value in your IOC
    // and use it with this function block - well, too bad.
    sUnsetString            : STRING := &#39;857be58e-5b82-4731-935f-e0e9cdfe005d-50b69a17-1499-49bc-af7b-084a8b6f63dd&#39;;
END_VAR
IF iPLCInternalSeverity &lt;&gt; -1 THEN
    // New severity value
    iLastValidSeverity := iPLCInternalSeverity;
    iPLCInternalSeverity := -1;

     // Reset the timer
    tonSeverityTimeout(IN:=FALSE);
    tonSeverityTimeout(IN:=TRUE, PT:=tTimeout);
END_IF

IF sPLCInternalValue &lt;&gt; sUnsetString THEN
    // New value from EPICS
    sLastValidValue         := sPLCInternalValue;
    sPLCInternalValue       := sUnsetString;

    // Reset the timer
    tonValueTimeout(IN:=FALSE);
    tonValueTimeout(IN:=TRUE, PT:=tTimeout);
END_IF

tonValueTimeout();
tonSeverityTimeout();
bValid := (NOT tonValueTimeout.Q) AND
          (NOT tonSeverityTimeout.Q) AND
          (iLastValidSeverity &lt;= iMaximumValidSeverity);
sValue := sLastValidValue;

END_FUNCTION_BLOCK
</pre></div>
</div>
</section>
<section id="fb-tempsensor">
<h2>FB_TempSensor<a class="headerlink" href="#fb-tempsensor" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TempSensor</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Handles</span> <span class="n">scaling</span> <span class="ow">and</span> <span class="n">default</span> <span class="n">diagnostics</span> <span class="k">for</span> <span class="n">temperature</span> <span class="n">sensors</span><span class="p">,</span>
    <span class="n">such</span> <span class="k">as</span> <span class="n">thermocouples</span><span class="p">,</span> <span class="n">RTDs</span><span class="p">,</span> <span class="ow">and</span> <span class="n">others</span><span class="o">.</span>
    <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">02</span> <span class="n">Zachary</span> <span class="n">Lentz</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Resolution</span> <span class="n">parameter</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">Beckhoff</span> <span class="n">docs</span><span class="o">.</span> <span class="n">Default</span> <span class="ow">is</span> <span class="mf">0.1</span> <span class="k">for</span> <span class="mf">0.1</span> <span class="n">degree</span> <span class="n">resolution</span>
    <span class="n">fResolution</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">TEMP</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">C</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">PREC</span> <span class="mi">2</span>
    <span class="s1">&#39;}</span>
    <span class="n">fTemp</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">CONN</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">Connected</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">Disconnected</span>
    <span class="s1">&#39;}</span>
    <span class="n">bConnected</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERR</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
    <span class="s1">&#39;}</span>
    <span class="n">bError</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">bUnderrange</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bOverrange</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">iRaw</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">The</span> <span class="n">manual</span> <span class="n">states</span> <span class="n">that</span> <span class="n">we</span> <span class="n">are</span> <span class="n">disconnected</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="n">both</span> <span class="n">overrange</span> <span class="ow">and</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">error</span> <span class="n">state</span>
<span class="n">bConnected</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">bOverrange</span> <span class="n">AND</span> <span class="n">bError</span><span class="p">);</span>
<span class="n">fTemp</span> <span class="o">:=</span> <span class="n">INT_TO_LREAL</span><span class="p">(</span><span class="n">iRaw</span><span class="p">)</span> <span class="o">*</span> <span class="n">fResolution</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-test-epicscentroidmonitor">
<h2>FB_Test_EpicsCentroidMonitor<a class="headerlink" href="#fb-test-epicscentroidmonitor" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_Test_EpicsCentroidMonitor</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">TestBasics</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">TestBasics</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbMonitor</span> <span class="p">:</span> <span class="n">FB_EpicsCentroidMonitor</span><span class="p">;</span>
    <span class="n">nCount</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Basic&#39;</span><span class="p">);</span>

<span class="n">nCount</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">nCount</span> <span class="o">:=</span> <span class="n">nCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">WriteCentroidValue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fX</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fY</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nCount</span><span class="o">:=</span><span class="n">nCount</span><span class="p">,</span> <span class="n">nX_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nY_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nCount_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tLastUpdate</span><span class="o">:=</span><span class="n">T</span><span class="c1">#0S);</span>
<span class="n">fbMonitor</span><span class="p">();</span>

<span class="n">nCount</span> <span class="o">:=</span> <span class="n">nCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">WriteCentroidValue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fX</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">fY</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">nCount</span><span class="o">:=</span><span class="n">nCount</span><span class="p">,</span> <span class="n">nX_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nY_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nCount_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tLastUpdate</span><span class="o">:=</span><span class="n">T</span><span class="c1">#0S);</span>
<span class="n">fbMonitor</span><span class="p">(</span><span class="n">fMinimumValidChange</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">);</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">bIsUpdating</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Centroid not reporting updating&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Min change&#39;</span><span class="p">);</span>

<span class="n">nCount</span> <span class="o">:=</span> <span class="n">nCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">WriteCentroidValue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fX</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fY</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nCount</span><span class="o">:=</span><span class="n">nCount</span><span class="p">,</span> <span class="n">nX_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nY_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nCount_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tLastUpdate</span><span class="o">:=</span><span class="n">T</span><span class="c1">#0S);</span>
<span class="n">fbMonitor</span><span class="p">(</span><span class="n">fMinimumValidChange</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">fMaximumFrameTime</span><span class="o">:=</span><span class="mf">0.2</span><span class="p">);</span>

<span class="n">nCount</span> <span class="o">:=</span> <span class="n">nCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">WriteCentroidValue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fX</span><span class="o">:=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">fY</span><span class="o">:=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">nCount</span><span class="o">:=</span><span class="n">nCount</span><span class="p">,</span> <span class="n">nX_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nY_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nCount_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tLastUpdate</span><span class="o">:=</span><span class="n">T</span><span class="c1">#0.1S);</span>
<span class="n">fbMonitor</span><span class="p">(</span><span class="n">fMinimumValidChange</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">fMaximumFrameTime</span><span class="o">:=</span><span class="mf">0.2</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">bIsUpdating</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Centroid update below threshold and is not updating&#39;</span><span class="p">);</span>

<span class="n">nCount</span> <span class="o">:=</span> <span class="n">nCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">WriteCentroidValue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fX</span><span class="o">:=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">fY</span><span class="o">:=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">nCount</span><span class="o">:=</span><span class="n">nCount</span><span class="p">,</span> <span class="n">nX_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nY_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nCount_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tLastUpdate</span><span class="o">:=</span><span class="n">T</span><span class="c1">#0.1S);</span>
<span class="n">fbMonitor</span><span class="p">(</span><span class="n">fMinimumValidChange</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">fMaximumFrameTime</span><span class="o">:=</span><span class="mf">0.2</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">bIsUpdating</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Centroid update above threshold and is updating&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Severity invalidation&#39;</span><span class="p">);</span>

<span class="n">nCount</span> <span class="o">:=</span> <span class="n">nCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">WriteCentroidValue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fX</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fY</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nCount</span><span class="o">:=</span><span class="n">nCount</span><span class="p">,</span> <span class="n">nX_Severity</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nY_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nCount_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tLastUpdate</span><span class="o">:=</span><span class="n">T</span><span class="c1">#0.2S);</span>
<span class="n">fbMonitor</span><span class="p">(</span><span class="n">fMinimumValidChange</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">bValid</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Invalid data - x severity&#39;</span><span class="p">);</span>

<span class="n">nCount</span> <span class="o">:=</span> <span class="n">nCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">WriteCentroidValue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fX</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">fY</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">nCount</span><span class="o">:=</span><span class="n">nCount</span><span class="p">,</span> <span class="n">nX_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nY_Severity</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nCount_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tLastUpdate</span><span class="o">:=</span><span class="n">T</span><span class="c1">#0.2S);</span>
<span class="n">fbMonitor</span><span class="p">(</span><span class="n">fMinimumValidChange</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">bValid</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Invalid data - y severity&#39;</span><span class="p">);</span>

<span class="n">nCount</span> <span class="o">:=</span> <span class="n">nCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">WriteCentroidValue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fX</span><span class="o">:=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">fY</span><span class="o">:=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">nCount</span><span class="o">:=</span><span class="n">nCount</span><span class="p">,</span> <span class="n">nX_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nY_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nCount_Severity</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span> <span class="n">tLastUpdate</span><span class="o">:=</span><span class="n">T</span><span class="c1">#0.2S);</span>
<span class="n">fbMonitor</span><span class="p">(</span><span class="n">fMinimumValidChange</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">bValid</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Invalid data - count severity&#39;</span><span class="p">);</span>

<span class="n">nCount</span> <span class="o">:=</span> <span class="n">nCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">WriteCentroidValue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fX</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fY</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nCount</span><span class="o">:=</span><span class="n">nCount</span><span class="p">,</span> <span class="n">nX_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nY_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nCount_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tLastUpdate</span><span class="o">:=</span><span class="n">T</span><span class="c1">#0.1S);</span>
<span class="n">fbMonitor</span><span class="p">(</span><span class="n">fMinimumValidChange</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">bValid</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Data valid&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">bIsUpdating</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Data valid and updating&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">WriteCentroidValue</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">fbMonitor</span> <span class="p">:</span> <span class="n">FB_EpicsCentroidMonitor</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">fX</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fY</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">nCount</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">nX_Severity</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">nY_Severity</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">nCount_Severity</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">tLastUpdate</span> <span class="p">:</span> <span class="n">TIME</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">WRITE_PROTECTED_INT</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">fbCentroidX</span><span class="o">.</span><span class="n">iPLCInternalSeverity</span><span class="p">),</span> <span class="n">nX_Severity</span><span class="p">);</span>
<span class="n">WRITE_PROTECTED_INT</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">fbCentroidY</span><span class="o">.</span><span class="n">iPLCInternalSeverity</span><span class="p">),</span> <span class="n">nY_Severity</span><span class="p">);</span>
<span class="n">WRITE_PROTECTED_INT</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">fbArrayCounter</span><span class="o">.</span><span class="n">iPLCInternalSeverity</span><span class="p">),</span> <span class="n">nCount_Severity</span><span class="p">);</span>

<span class="n">WRITE_PROTECTED_LREAL</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">fbCentroidX</span><span class="o">.</span><span class="n">fPLCInternalValue</span><span class="p">),</span> <span class="n">fX</span><span class="p">);</span>
<span class="n">WRITE_PROTECTED_LREAL</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">fbCentroidY</span><span class="o">.</span><span class="n">fPLCInternalValue</span><span class="p">),</span> <span class="n">fY</span><span class="p">);</span>
<span class="n">WRITE_PROTECTED_LREAL</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">fbArrayCounter</span><span class="o">.</span><span class="n">fPLCInternalValue</span><span class="p">),</span> <span class="n">INT_TO_LREAL</span><span class="p">(</span><span class="n">nCount</span><span class="p">));</span>

<span class="n">WRITE_PROTECTED_TIME</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">tLastUpdate</span><span class="p">),</span> <span class="n">TIME</span><span class="p">()</span> <span class="o">-</span> <span class="n">tLastUpdate</span><span class="p">);</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-epicscentroidmonitor">FB_EpicsCentroidMonitor</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-test-epicsmotormonitor">
<h2>FB_Test_EpicsMotorMonitor<a class="headerlink" href="#fb-test-epicsmotormonitor" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_Test_EpicsMotorMonitor</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">TestBasics</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">TestBasics</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbMonitor</span> <span class="p">:</span> <span class="n">FB_EpicsMotorMonitor</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Basic&#39;</span><span class="p">);</span>

<span class="n">WriteData</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fRBV</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nMoving</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nStatus</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nRBV_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nStatus_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nMoving_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">);</span>
<span class="n">fbMonitor</span><span class="p">();</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">bValid</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Data valid&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>


<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Severities&#39;</span><span class="p">);</span>

<span class="n">WriteData</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fRBV</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nMoving</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nStatus</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nRBV_Severity</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nStatus_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nMoving_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">);</span>
<span class="n">fbMonitor</span><span class="p">();</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">bValid</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Invalid RBV&#39;</span><span class="p">);</span>

<span class="n">WriteData</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fRBV</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nMoving</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nStatus</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nRBV_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nStatus_Severity</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nMoving_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">);</span>
<span class="n">fbMonitor</span><span class="p">();</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">bValid</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Invalid status&#39;</span><span class="p">);</span>

<span class="n">WriteData</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fRBV</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nMoving</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nStatus</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nRBV_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nStatus_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nMoving_Severity</span><span class="o">:=</span><span class="mi">2</span><span class="p">);</span>
<span class="n">fbMonitor</span><span class="p">();</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">bValid</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Invalid moving&#39;</span><span class="p">);</span>

<span class="n">WriteData</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fRBV</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nMoving</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nStatus</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nRBV_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nStatus_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nMoving_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">);</span>
<span class="n">fbMonitor</span><span class="p">();</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">bValid</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;All valid&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Moving&#39;</span><span class="p">);</span>

<span class="n">WriteData</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fRBV</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nMoving</span><span class="o">:=</span><span class="mi">0</span> <span class="p">(</span><span class="o">*</span> <span class="n">DMOV</span> <span class="o">*</span><span class="p">),</span> <span class="n">nStatus</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nRBV_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nStatus_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nMoving_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">);</span>
<span class="n">fbMonitor</span><span class="p">();</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">bIsMoving</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Moving&#39;</span><span class="p">);</span>

<span class="n">WriteData</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fRBV</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nMoving</span><span class="o">:=</span><span class="mi">1</span> <span class="p">(</span><span class="o">*</span> <span class="n">DMOV</span> <span class="o">*</span><span class="p">),</span> <span class="n">nStatus</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nRBV_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nStatus_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nMoving_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">);</span>
<span class="n">fbMonitor</span><span class="p">();</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">bIsMoving</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Not moving&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Position&#39;</span><span class="p">);</span>

<span class="n">WriteData</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fRBV</span><span class="o">:=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">nMoving</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nStatus</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nRBV_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nStatus_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nMoving_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">);</span>
<span class="n">fbMonitor</span><span class="p">();</span>
<span class="n">AssertEquals_LREAL</span><span class="p">(</span><span class="n">Actual</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span> <span class="n">Expected</span><span class="o">:=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Position 1 OK&#39;</span><span class="p">);</span>

<span class="n">WriteData</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fRBV</span><span class="o">:=</span><span class="mf">20.0</span><span class="p">,</span> <span class="n">nMoving</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nStatus</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nRBV_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nStatus_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nMoving_Severity</span><span class="o">:=</span><span class="mi">0</span><span class="p">);</span>
<span class="n">fbMonitor</span><span class="p">();</span>
<span class="n">AssertEquals_LREAL</span><span class="p">(</span><span class="n">Actual</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span> <span class="n">Expected</span><span class="o">:=</span><span class="mf">20.0</span><span class="p">,</span> <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Position 2 OK&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;MSTA set&#39;</span><span class="p">);</span>

<span class="n">WriteData</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fRBV</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nMoving</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nStatus</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#0FFFF, nRBV_Severity:=0, nStatus_Severity:=0, nMoving_Severity:=0);</span>
<span class="n">fbMonitor</span><span class="p">();</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bPositiveDirection</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bPositiveDirection True&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bDone True&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bPlusLimitSwitch</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bPlusLimitSwitch True&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bHomeLimitSwitch</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bHomeLimitSwitch True&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bUnused0</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bUnused0 True&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bClosedLoop</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bClosedLoop True&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bSlipStall</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bSlipStall True&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bHome</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bHome True&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bEncoderPresent</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bEncoderPresent True&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bHardwareProblem</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bHardwareProblem True&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bMoving</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bMoving True&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bGainSupport</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bGainSupport True&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bCommError</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bCommError True&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bMinusLimitSwitch</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bMinusLimitSwitch True&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bHomed</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bHomed True&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>


<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;MSTA zero&#39;</span><span class="p">);</span>

<span class="n">WriteData</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fRBV</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nMoving</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nStatus</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#0000, nRBV_Severity:=0, nStatus_Severity:=0, nMoving_Severity:=0);</span>
<span class="n">fbMonitor</span><span class="p">();</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bPositiveDirection</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bPositiveDirection False&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bDone False&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bPlusLimitSwitch</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bPlusLimitSwitch False&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bHomeLimitSwitch</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bHomeLimitSwitch False&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bUnused0</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bUnused0 False&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bClosedLoop</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bClosedLoop False&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bSlipStall</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bSlipStall False&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bHome</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bHome False&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bEncoderPresent</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bEncoderPresent False&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bHardwareProblem</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bHardwareProblem False&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bMoving</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bMoving False&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bGainSupport</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bGainSupport False&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bCommError</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bCommError False&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bMinusLimitSwitch</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bMinusLimitSwitch False&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bHomed</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bHomed False&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>


<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;MSTA something&#39;</span><span class="p">);</span>

<span class="n">WriteData</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">:=</span><span class="n">fbMonitor</span><span class="p">,</span> <span class="n">fRBV</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nMoving</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nStatus</span><span class="o">:=</span><span class="mi">2</span><span class="c1">#0100_0011_0000_0110, nRBV_Severity:=0, nStatus_Severity:=0, nMoving_Severity:=0);</span>
<span class="n">fbMonitor</span><span class="p">();</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bPositiveDirection</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bPositiveDirection&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bDone&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bPlusLimitSwitch</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bPlusLimitSwitch&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bHomeLimitSwitch</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bHomeLimitSwitch&#39;</span><span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bUnused0</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bUnused0&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bClosedLoop</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bClosedLoop&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bSlipStall</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bSlipStall&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bHome</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bHome&#39;</span><span class="p">);</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bEncoderPresent</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bEncoderPresent&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bHardwareProblem</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bHardwareProblem&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bMoving</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bMoving&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bGainSupport</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bGainSupport&#39;</span><span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bCommError</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bCommError&#39;</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bMinusLimitSwitch</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bMinusLimitSwitch&#39;</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">stMSTA</span><span class="o">.</span><span class="n">bHomed</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bHomed&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">WriteData</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">fbMonitor</span> <span class="p">:</span> <span class="n">FB_EpicsMotorMonitor</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">fRBV</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">nMoving</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">nStatus</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nRBV_Severity</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">nStatus_Severity</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">nMoving_Severity</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">WRITE_PROTECTED_INT</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">fbRBVCheck</span><span class="o">.</span><span class="n">iPLCInternalSeverity</span><span class="p">),</span> <span class="n">nRBV_Severity</span><span class="p">);</span>
<span class="n">WRITE_PROTECTED_INT</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">fbMotorStatusCheck</span><span class="o">.</span><span class="n">iPLCInternalSeverity</span><span class="p">),</span> <span class="n">nStatus_Severity</span><span class="p">);</span>
<span class="n">WRITE_PROTECTED_INT</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">fbMovingCheck</span><span class="o">.</span><span class="n">iPLCInternalSeverity</span><span class="p">),</span> <span class="n">nMoving_Severity</span><span class="p">);</span>

<span class="n">WRITE_PROTECTED_LREAL</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">fbRBVCheck</span><span class="o">.</span><span class="n">fPLCInternalValue</span><span class="p">),</span> <span class="n">fRBV</span><span class="p">);</span>
<span class="n">WRITE_PROTECTED_LREAL</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">fbMotorStatusCheck</span><span class="o">.</span><span class="n">fPLCInternalValue</span><span class="p">),</span> <span class="n">UINT_TO_LREAL</span><span class="p">(</span><span class="n">nStatus</span><span class="p">));</span>
<span class="n">WRITE_PROTECTED_LREAL</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbMonitor</span><span class="o">.</span><span class="n">fbMovingCheck</span><span class="o">.</span><span class="n">fPLCInternalValue</span><span class="p">),</span> <span class="n">INT_TO_LREAL</span><span class="p">(</span><span class="n">nMoving</span><span class="p">));</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-epicsmotormonitor">FB_EpicsMotorMonitor</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-thermocouple">
<h2>FB_ThermoCouple<a class="headerlink" href="#fb-thermocouple" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ThermoCouple</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Deprecated</span> <span class="k">as</span> <span class="n">of</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">02</span><span class="p">,</span> <span class="n">please</span> <span class="n">use</span> <span class="n">FB_TempSensor</span> <span class="n">instead</span>
    <span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">09</span> <span class="n">Zachary</span> <span class="n">Lentz</span>
<span class="o">*</span><span class="p">)</span>
<span class="p">{</span><span class="n">warning</span> <span class="s1">&#39;Function Block FB_ThermoCouple is deprecated and may be removed in a future release&#39;</span><span class="p">}</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Ratio</span> <span class="n">between</span> <span class="n">raw</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">actual</span> <span class="n">temperature</span><span class="o">.</span> <span class="n">Default</span> <span class="ow">is</span> <span class="mi">10</span> <span class="k">for</span> <span class="mi">10</span> <span class="n">steps</span> <span class="n">per</span> <span class="n">degree</span> <span class="p">(</span><span class="ow">or</span> <span class="mf">0.1</span> <span class="n">degree</span> <span class="n">resolution</span><span class="p">)</span>
    <span class="n">iScale</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STC</span><span class="p">:</span><span class="n">TEMP</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
    <span class="s1">&#39;}</span>
    <span class="n">fTemp</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STC</span><span class="p">:</span><span class="n">CONN</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">Connected</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">Disconnected</span>
    <span class="s1">&#39;}</span>
    <span class="n">bConnected</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STC</span><span class="p">:</span><span class="n">ERR</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
    <span class="s1">&#39;}</span>
    <span class="n">bError</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">bUnderrange</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bOverrange</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">iRaw</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">The</span> <span class="n">manual</span> <span class="n">states</span> <span class="n">that</span> <span class="n">we</span> <span class="n">are</span> <span class="n">disconnected</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="n">both</span> <span class="n">overrange</span> <span class="ow">and</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">error</span> <span class="n">state</span>
<span class="n">bConnected</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">bOverrange</span> <span class="n">AND</span> <span class="n">bError</span><span class="p">);</span>
<span class="n">fTemp</span> <span class="o">:=</span> <span class="n">INT_TO_LREAL</span><span class="p">(</span><span class="n">iRaw</span><span class="p">)</span> <span class="o">/</span> <span class="n">iScale</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-tempsensor">FB_TempSensor</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-timestampbuffer">
<h2>FB_TimeStampBuffer<a class="headerlink" href="#fb-timestampbuffer" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TimeStampBuffer</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">A</span> <span class="n">Companion</span> <span class="n">to</span> <span class="n">FB_LREALBuffer</span> <span class="n">that</span> <span class="n">accumulates</span> <span class="n">timestamps</span>
    <span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">09</span> <span class="n">Zachary</span> <span class="n">Lentz</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span><span class="s1">&#39;ll accumulate a value on this cycle.</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">arrOutput</span><span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1..1000</span><span class="p">]</span> <span class="n">OF</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bNewArray</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbUnixTime</span><span class="p">:</span> <span class="n">FB_UnixTimestamp</span><span class="p">;</span>
    <span class="n">fbLREALBuffer</span><span class="p">:</span> <span class="n">FB_LREALBuffer</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbUnixTime</span><span class="p">(</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bExecute</span><span class="p">,</span>
    <span class="n">fTime</span> <span class="o">=&gt;</span> <span class="n">fbLREALBuffer</span><span class="o">.</span><span class="n">fInput</span><span class="p">);</span>
<span class="n">fbLREALBuffer</span><span class="p">(</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bExecute</span><span class="p">,</span>
    <span class="n">arrOutput</span> <span class="o">=&gt;</span> <span class="n">arrOutput</span><span class="p">,</span>
    <span class="n">bNewArray</span> <span class="o">=&gt;</span> <span class="n">bNewArray</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-lrealbuffer">FB_LREALBuffer</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-timestampbufferglobal">
<h2>FB_TimeStampBufferGlobal<a class="headerlink" href="#fb-timestampbufferglobal" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TimeStampBufferGlobal</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">A</span> <span class="n">Variant</span> <span class="n">of</span> <span class="n">FB_TimeStampBuffer</span> <span class="n">that</span> <span class="n">uses</span> <span class="n">the</span> <span class="k">global</span> <span class="n">timestamp</span><span class="o">.</span>
    <span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">09</span> <span class="n">Zachary</span> <span class="n">Lentz</span>

    <span class="n">Assumes</span> <span class="n">an</span> <span class="n">instance</span> <span class="n">of</span> <span class="n">FB_UnixTimeStampGlobal</span> <span class="ow">is</span> <span class="n">running</span> <span class="n">every</span> <span class="n">cycle</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span><span class="s1">&#39;ll accumulate a value on this cycle.</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">arrOutput</span><span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1..1000</span><span class="p">]</span> <span class="n">OF</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bNewArray</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbLREALBuffer</span><span class="p">:</span> <span class="n">FB_LREALBuffer</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbLREALBuffer</span><span class="p">(</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bExecute</span><span class="p">,</span>
    <span class="n">fInput</span> <span class="o">:=</span> <span class="n">DefaultGlobals</span><span class="o">.</span><span class="n">fTimeStamp</span><span class="p">,</span>
    <span class="n">arrOutput</span> <span class="o">=&gt;</span> <span class="n">arrOutput</span><span class="p">,</span>
    <span class="n">bNewArray</span> <span class="o">=&gt;</span> <span class="n">bNewArray</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#defaultglobals">DefaultGlobals</a></p></li>
<li><p><a class="reference internal" href="#fb-lrealbuffer">FB_LREALBuffer</a></p></li>
<li><p><a class="reference internal" href="#fb-timestampbuffer">FB_TimeStampBuffer</a></p></li>
<li><p><a class="reference internal" href="#fb-unixtimestampglobal">FB_UnixTimeStampGlobal</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-unixtimestamp">
<h2>FB_UnixTimeStamp<a class="headerlink" href="#fb-unixtimestamp" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_UnixTimeStamp</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Get</span> <span class="n">the</span> <span class="n">unix</span> <span class="n">timestamp</span> <span class="n">equivalent</span> <span class="n">of</span> <span class="n">the</span> <span class="n">PLC</span><span class="s1">&#39;s time.</span>
    <span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">09</span> <span class="n">Zachary</span> <span class="n">Lentz</span>

    <span class="n">This</span> <span class="n">will</span> <span class="n">only</span> <span class="n">sync</span> <span class="k">with</span> <span class="n">the</span> <span class="n">Linux</span> <span class="n">host</span> <span class="n">when</span> <span class="n">both</span> <span class="n">hosts</span><span class="s1">&#39; clocks are correct.</span>
    <span class="n">Largely</span> <span class="n">stolen</span> <span class="kn">from</span> <span class="nn">stack</span> <span class="n">overflow</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span><span class="s1">&#39;ll try to update the output on this cycle.</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">seconds</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">timestamp</span>
    <span class="n">iSeconds</span><span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">milliseconds</span> <span class="n">past</span> <span class="n">the</span> <span class="n">seconds</span>
    <span class="n">iMilliseconds</span><span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Full</span> <span class="n">raw</span> <span class="n">number</span>
    <span class="n">iFull</span><span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Full</span> <span class="n">floating</span> <span class="n">point</span> <span class="n">number</span> <span class="ow">in</span> <span class="n">units</span> <span class="n">of</span> <span class="n">seconds</span>
    <span class="n">fTime</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">the</span> <span class="n">output</span> <span class="ow">is</span> <span class="n">okay</span> <span class="n">to</span> <span class="n">use</span> <span class="n">on</span> <span class="n">this</span> <span class="n">cycle</span><span class="o">.</span> <span class="n">Typically</span> <span class="n">the</span> <span class="n">output</span> <span class="ow">is</span> <span class="n">zero</span> <span class="n">when</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">FALSE</span><span class="o">.</span>
    <span class="n">bValid</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fbLocalTime</span><span class="p">:</span> <span class="n">FB_LocalSystemTime</span><span class="p">;</span>
    <span class="n">fbGetTimeZone</span><span class="p">:</span> <span class="n">FB_GetTimeZoneInformation</span><span class="p">;</span>
    <span class="n">fbTimeConv</span><span class="p">:</span> <span class="n">FB_TzSpecificLocalTimeToFileTime</span><span class="p">;</span>
    <span class="n">fileTime</span><span class="p">:</span> <span class="n">T_FILETIME</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fbGetTimeZone</span><span class="p">(</span><span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">tzInfo</span> <span class="o">=&gt;</span> <span class="n">fbTimeConv</span><span class="o">.</span><span class="n">tzInfo</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">bExecute</span> <span class="n">THEN</span>
    <span class="n">fbLocalTime</span><span class="p">(</span>
        <span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">dwCycle</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">bValid</span> <span class="o">=&gt;</span> <span class="n">bValid</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">bValid</span> <span class="n">THEN</span>
        <span class="n">fbTimeConv</span><span class="p">(</span>
            <span class="ow">in</span> <span class="o">:=</span> <span class="n">SYSTEMTIME_TO_FILETIME</span><span class="p">(</span><span class="n">fbLocalTime</span><span class="o">.</span><span class="n">systemTime</span><span class="p">),</span>
            <span class="n">out</span> <span class="o">=&gt;</span> <span class="n">fileTime</span><span class="p">);</span>
        <span class="n">iFull</span> <span class="o">:=</span> <span class="p">(</span><span class="n">SHL</span><span class="p">(</span><span class="n">DWORD_TO_ULINT</span><span class="p">(</span><span class="n">fileTime</span><span class="o">.</span><span class="n">dwHighDateTime</span><span class="p">),</span> <span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="n">DWORD_TO_ULINT</span><span class="p">(</span><span class="n">fileTime</span><span class="o">.</span><span class="n">dwLowDateTime</span><span class="p">))</span> <span class="o">/</span> <span class="mi">10000</span> <span class="o">-</span> <span class="mi">11644473600000</span><span class="p">;</span>
        <span class="n">fTime</span> <span class="o">:=</span> <span class="n">ULINT_TO_LREAL</span><span class="p">(</span><span class="n">iFull</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>
        <span class="n">iSeconds</span> <span class="o">:=</span> <span class="n">iFull</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>
        <span class="n">iMilliseconds</span> <span class="o">:=</span> <span class="n">iFull</span> <span class="n">MOD</span> <span class="mi">1000</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-unixtimestampglobal">
<h2>FB_UnixTimeStampGlobal<a class="headerlink" href="#fb-unixtimestampglobal" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_UnixTimeStampGlobal</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Runs</span> <span class="n">FB_UnixTimeStamp</span> <span class="ow">and</span> <span class="n">stuffs</span> <span class="n">the</span> <span class="n">result</span> <span class="n">into</span> <span class="n">this</span> <span class="n">library</span><span class="s1">&#39;s GVL</span>
    <span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">09</span> <span class="n">Zachary</span> <span class="n">Lentz</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">will</span> <span class="n">update</span> <span class="n">the</span> <span class="n">output</span> <span class="n">on</span> <span class="n">this</span> <span class="n">cycle</span><span class="o">.</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbTimeStamp</span><span class="p">:</span> <span class="n">FB_UnixTimeStamp</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbTimeStamp</span><span class="p">(</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bExecute</span><span class="p">,</span>
    <span class="n">fTime</span> <span class="o">=&gt;</span> <span class="n">DefaultGlobals</span><span class="o">.</span><span class="n">fTimeStamp</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#defaultglobals">DefaultGlobals</a></p></li>
<li><p><a class="reference internal" href="#fb-unixtimestamp">FB_UnixTimeStamp</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-xkoyoplcmodbus">
<h2>FB_XKoyoPLCModbus<a class="headerlink" href="#fb-xkoyoplcmodbus" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">Facilitates</span> <span class="n">communication</span> <span class="n">between</span> <span class="n">Beckhoff</span> <span class="ow">and</span> <span class="n">Koyo</span> <span class="n">PLC</span> <span class="n">over</span> <span class="n">the</span> <span class="n">network</span><span class="o">.</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_XKoyoPLCModbus</span>
<span class="n">VAR</span>
    <span class="n">fbKoyo_PLCInputCoilsRx</span>  <span class="p">:</span>       <span class="n">FB_MBReadCoils</span><span class="p">;</span> <span class="o">//</span><span class="n">FB</span> <span class="k">for</span> <span class="n">reading</span> <span class="n">the</span> <span class="n">coils</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">other</span> <span class="n">PLC</span>
    <span class="n">anKoyo_PLC_CnBits</span>       <span class="p">:</span>       <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0..20</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BYTE</span><span class="p">;</span> <span class="o">//</span><span class="n">Buffer</span> <span class="k">for</span> <span class="n">coil</span> <span class="n">readbacks</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;naming&#39;</span> <span class="o">:=</span> <span class="s1">&#39;omit&#39;</span><span class="p">}</span>
    <span class="n">ftReset</span> <span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span> <span class="o">//</span><span class="n">Reset</span> <span class="n">edge</span> <span class="n">sensor</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;naming&#39;</span> <span class="o">:=</span> <span class="s1">&#39;omit&#39;</span><span class="p">}</span>
    <span class="n">tonRetry</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span> <span class="o">//</span><span class="n">Retry</span> <span class="n">timer</span>
    <span class="n">nIndex</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span> <span class="o">//</span><span class="n">Index</span> <span class="k">for</span> <span class="n">clearing</span> <span class="n">the</span> <span class="n">coil</span> <span class="n">array</span>
<span class="n">END_VAR</span>

<span class="n">VAR_INPUT</span>
    <span class="n">i_tRetryTime</span> <span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#10S; //Retry time if modbus transaction fails</span>
    <span class="n">i_sIPAddr</span>        <span class="p">:</span> <span class="n">STRING</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span> <span class="o">//</span><span class="n">IP</span> <span class="n">address</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Koyo</span> <span class="n">PLC</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">q_xNoPLCResponse</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="o">//</span><span class="n">Could</span> <span class="ow">not</span> <span class="n">reach</span> <span class="n">the</span> <span class="n">PLC</span> <span class="k">if</span> <span class="n">true</span>
    <span class="n">q_anPLCResponse</span>   <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0..20</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BYTE</span><span class="p">;</span> <span class="o">//</span><span class="n">Buffer</span> <span class="n">of</span> <span class="n">coils</span> <span class="n">retrieved</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">other</span> <span class="n">PLC</span>
    <span class="n">q_xError</span>         <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span><span class="n">Transaction</span> <span class="ow">or</span> <span class="n">other</span> <span class="n">error</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Look</span> <span class="n">ma</span><span class="s1">&#39; no wires! *)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span><span class="p">,</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">7</span><span class="o">-</span><span class="mi">22</span>
<span class="n">XKoyoPLCModbus</span>

<span class="n">Facilitates</span> <span class="n">communication</span> <span class="n">between</span> <span class="n">Beckhoff</span> <span class="ow">and</span> <span class="n">Koyo</span> <span class="n">PLC</span> <span class="n">over</span> <span class="n">the</span> <span class="n">network</span><span class="o">.</span>

<span class="n">Useful</span> <span class="k">if</span> <span class="n">you</span> <span class="n">don</span><span class="s1">&#39;t have time to run a wire. Fairly reliable.</span>

<span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Modbus</span> <span class="n">Info</span> <span class="k">for</span> <span class="n">Koyo</span>
<span class="n">Modbus</span> <span class="n">Addresses</span> <span class="k">for</span>
<span class="n">Koyo</span> <span class="n">DL05</span><span class="o">/</span><span class="mi">06</span><span class="o">/</span><span class="mi">240</span><span class="o">/</span><span class="mi">250</span><span class="o">/</span><span class="mi">260</span><span class="o">/</span><span class="mi">430</span><span class="o">/</span><span class="mi">440</span><span class="o">/</span><span class="mi">450</span> <span class="n">PLCs</span>
<span class="n">PLC</span> <span class="n">Memory</span> <span class="n">Type</span>             <span class="o">|</span> <span class="n">Modbus</span> <span class="n">start</span> <span class="n">address</span> <span class="n">Decimal</span> <span class="p">(</span><span class="n">octal</span><span class="p">)</span> <span class="o">|</span> <span class="n">Function</span> <span class="n">codes</span>
<span class="n">Inputs</span> <span class="p">(</span><span class="n">X</span><span class="p">)</span>                    <span class="mi">2048</span> <span class="p">(</span><span class="mi">04000</span><span class="p">)</span>                                                  <span class="mi">2</span>
<span class="n">Special</span> <span class="n">Relays</span> <span class="p">(</span><span class="n">SP</span><span class="p">)</span>   <span class="mi">3072</span> <span class="p">(</span><span class="mi">06000</span><span class="p">)</span>                                                  <span class="mi">2</span>
<span class="n">Outputs</span> <span class="p">(</span><span class="n">Y</span><span class="p">)</span>                   <span class="mi">2048</span> <span class="p">(</span><span class="mi">04000</span><span class="p">)</span>                                                  <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span>
<span class="n">Control</span> <span class="n">Relays</span> <span class="p">(</span><span class="n">C</span><span class="p">)</span>    <span class="mi">3072</span> <span class="p">(</span><span class="mi">06000</span><span class="p">)</span>                                                  <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span>
<span class="n">Timer</span> <span class="n">Contacts</span> <span class="p">(</span><span class="n">T</span><span class="p">)</span>    <span class="mi">6144</span> <span class="p">(</span><span class="mi">014000</span><span class="p">)</span>                                                 <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span>
<span class="n">Counter</span> <span class="n">Contacts</span> <span class="p">(</span><span class="n">CT</span><span class="p">)</span> <span class="mi">6400</span> <span class="p">(</span><span class="mi">014400</span><span class="p">)</span>                                                 <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span>
<span class="n">Stage</span> <span class="n">Status</span> <span class="n">Bits</span> <span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="mi">6144</span> <span class="p">(</span><span class="mi">012000</span><span class="p">)</span>                                                 <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span>
<span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Begin</span> <span class="n">code</span> <span class="o">*</span><span class="p">)</span>
<span class="o">//</span> <span class="n">Retry</span> <span class="n">after</span> <span class="n">some</span> <span class="n">time</span>
<span class="n">tonRetry</span><span class="o">.</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">fbKoyo_PLCInputCoilsRx</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">tonRetry</span><span class="o">.</span><span class="n">PT</span> <span class="o">:=</span> <span class="n">i_tRetryTime</span><span class="p">;</span>
<span class="n">tonRetry</span><span class="p">();</span>

<span class="n">ftReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">fbKoyo_PLCInputCoilsRx</span><span class="o">.</span><span class="n">bBusy</span><span class="p">);</span>
<span class="n">ftReset</span><span class="p">();</span>

<span class="n">fbKoyo_PLCInputCoilsRx</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">ftReset</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">tonRetry</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="n">fbKoyo_PLCInputCoilsRx</span><span class="p">(</span><span class="n">sIPAddr</span><span class="o">:=</span><span class="s1">&#39;i_sIPAddr&#39;</span><span class="p">,</span> <span class="n">nTCPPort</span><span class="o">:=</span><span class="mi">502</span><span class="p">,</span> <span class="n">nQuantity</span><span class="o">:=</span><span class="mi">32</span><span class="p">,</span> <span class="n">nMBAddr</span><span class="o">:=</span><span class="mi">8</span><span class="c1">#6000, cbLength:=USINT_TO_UDINT(SIZEOF(anKoyo_PLC_CnBits)),  pDestAddr:=ADR(anKoyo_PLC_CnBits), tTimeout:=T#10S);</span>

<span class="o">//</span><span class="n">run</span> <span class="n">some</span> <span class="n">error</span> <span class="n">code</span> <span class="k">for</span> <span class="n">modbus</span>
<span class="n">IF</span> <span class="n">fbKoyo_PLCInputCoilsRx</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
    <span class="o">//</span><span class="k">if</span> <span class="n">there</span><span class="s1">&#39;s a modbus error, set all incoming bits to zero</span>
    <span class="p">{</span><span class="n">analysis</span> <span class="o">-</span><span class="mi">41</span><span class="p">}</span> <span class="o">//</span><span class="n">There</span> <span class="n">are</span> <span class="n">one</span><span class="o">-</span><span class="n">liners</span> <span class="k">for</span> <span class="n">resetting</span> <span class="n">an</span> <span class="n">array</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">but</span> <span class="n">they</span> <span class="n">don</span><span class="s1">&#39;t comply with 61131</span>
    <span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">USINT_TO_INT</span><span class="p">(</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">anKoyo_PLC_CnBits</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span> <span class="n">DO</span> <span class="o">//</span><span class="n">starts</span> <span class="n">at</span> <span class="mi">0</span>
        <span class="n">anKoyo_PLC_CnBits</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_FOR</span>
    <span class="p">{</span><span class="n">analysis</span> <span class="o">+</span><span class="mi">41</span><span class="p">}</span>
    <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">ELSIF</span> <span class="n">ftReset</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">fbKoyo_PLCInputCoilsRx</span><span class="o">.</span><span class="n">cbRead</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">fbKoyo_PLCInputCoilsRx</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_xNoPLCResponse</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="o">//</span><span class="n">more</span> <span class="n">error</span> <span class="n">code</span> <span class="n">cause</span> <span class="n">we</span> <span class="n">didn</span><span class="s1">&#39;t manage to read anything</span>
<span class="n">ELSIF</span> <span class="n">fbKoyo_PLCInputCoilsRx</span><span class="o">.</span><span class="n">cbRead</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">q_xNoPLCResponse</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">END_IF</span>

<span class="n">q_anPLCResponse</span> <span class="o">:=</span> <span class="n">anKoyo_PLC_CnBits</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="resetcircuitbreakerglobals">
<h2>ResetCircuitBreakerGlobals<a class="headerlink" href="#resetcircuitbreakerglobals" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">ResetCircuitBreakerGlobals</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">GVL_Logger</span><span class="o">.</span><span class="n">bTrickleTripped</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">GVL_Logger</span><span class="o">.</span><span class="n">nGlobAccEvents</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#gvl-logger">GVL_Logger</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="run-tests">
<h2>RUN_TESTS<a class="headerlink" href="#run-tests" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">RUN_TESTS</span>
<span class="n">VAR</span>
    <span class="n">CbTest</span>    <span class="p">:</span>    <span class="n">FB_CircuitBreaker_Test</span><span class="p">;</span>
    <span class="n">fbCentroidTest</span> <span class="p">:</span> <span class="n">FB_Test_EpicsCentroidMonitor</span><span class="p">;</span>
    <span class="n">fbMotorTest</span> <span class="p">:</span> <span class="n">FB_Test_EpicsMotorMonitor</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">TcUnit</span><span class="o">.</span><span class="n">RUN</span><span class="p">();</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-circuitbreaker-test">FB_CircuitBreaker_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-test-epicscentroidmonitor">FB_Test_EpicsCentroidMonitor</a></p></li>
<li><p><a class="reference internal" href="#fb-test-epicsmotormonitor">FB_Test_EpicsMotorMonitor</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="system-time-to-rfc3339">
<h2>SYSTEM_TIME_TO_RFC3339<a class="headerlink" href="#system-time-to-rfc3339" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">Converts</span> <span class="n">Beckhoff</span> <span class="n">PLC</span> <span class="n">SYSTEMTIME</span> <span class="n">to</span> <span class="n">RFC3339</span> <span class="n">time</span> <span class="nb">format</span> <span class="k">as</span> <span class="n">a</span> <span class="n">string</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;naming&#39;</span> <span class="o">:=</span> <span class="s1">&#39;omit&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;analysis&#39;</span> <span class="o">:=</span> <span class="s1">&#39;-23&#39;</span><span class="p">}</span>
<span class="n">FUNCTION</span> <span class="n">SYSTEM_TIME_TO_RFC3339</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;naming&#39;</span> <span class="o">:=</span> <span class="s1">&#39;omit&#39;</span><span class="p">}</span>
    <span class="n">tCurrentTime</span>    <span class="p">:</span>       <span class="n">TIMESTRUCT</span><span class="p">;</span> <span class="o">//</span><span class="n">TIMESTRUCT</span> <span class="n">Time</span> <span class="n">to</span> <span class="n">convert</span> <span class="n">to</span> <span class="n">RFC3339</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">SYSTEM_TIME_TO_RFC3339</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">REPLACE</span><span class="p">(</span><span class="n">SYSTEMTIME_TO_STRING</span><span class="p">(</span><span class="n">tCurrentTime</span><span class="p">),</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="s1">&#39;Z&#39;</span><span class="p">);</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="time-to-100ns">
<h2>TIME_TO_100NS<a class="headerlink" href="#time-to-100ns" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">TIME_TO_100NS</span> <span class="p">:</span> <span class="n">ULINT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTime</span> <span class="p">:</span> <span class="n">TIME</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">TIME_TO_100NS</span> <span class="o">:=</span> <span class="n">TIME_TO_ULINT</span><span class="p">(</span><span class="n">nTime</span><span class="p">)</span><span class="o">*</span><span class="mi">10000</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="LCLSGeneral_LCLSGeneral_epics.html" class="btn btn-neutral float-left" title="Data Types" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, SLAC National Accelerator Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>