
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>PLC Project (1): LCLSGeneral &#8212; pcdshub/lcls-twincat-general  documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="LCLSGeneral.tmc" href="LCLSGeneral.tmc.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="plc-project-1-lclsgeneral">
<h1>PLC Project (1): LCLSGeneral<a class="headerlink" href="#plc-project-1-lclsgeneral" title="Permalink to this headline">¶</a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Project</span> <span class="n">root</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">travis</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">pcdshub</span><span class="o">/</span><span class="n">lcls</span><span class="o">-</span><span class="n">twincat</span><span class="o">-</span><span class="n">general</span><span class="o">/</span><span class="n">LCLSGeneral</span>
<span class="n">Project</span> <span class="n">path</span><span class="p">:</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">LCLSGeneral</span><span class="o">.</span><span class="n">plcproj</span>
<span class="n">TMC</span> <span class="n">path</span><span class="p">:</span>     <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">LCLSGeneral</span><span class="o">.</span><span class="n">tmc</span>
<span class="n">AMS</span> <span class="n">ID</span><span class="p">:</span>       
<span class="n">IP</span> <span class="n">Address</span><span class="p">:</span>    <span class="p">(</span><span class="o">*</span> <span class="n">based</span> <span class="n">on</span> <span class="n">AMS</span> <span class="n">ID</span><span class="p">)</span>
<span class="n">Port</span><span class="p">:</span>         <span class="mi">851</span>

<span class="n">Source</span> <span class="n">files</span><span class="p">:</span>
    <span class="mf">1.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">Data</span> <span class="n">types</span><span class="o">/</span><span class="n">Misc</span><span class="o">/</span><span class="n">ST_EcDevice</span><span class="o">.</span><span class="n">TcDUT</span>
    <span class="mf">2.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">Data</span> <span class="n">types</span><span class="o">/</span><span class="n">Misc</span><span class="o">/</span><span class="n">ST_FbDiagnostics</span><span class="o">.</span><span class="n">TcDUT</span>
    <span class="mf">3.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">Data</span> <span class="n">types</span><span class="o">/</span><span class="n">Misc</span><span class="o">/</span><span class="n">ST_System</span><span class="o">.</span><span class="n">TcDUT</span>
    <span class="mf">4.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">GVLs</span><span class="o">/</span><span class="n">DefaultGlobals</span><span class="o">.</span><span class="n">TcGVL</span>
    <span class="mf">5.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">GVLs</span><span class="o">/</span><span class="n">Global_Variables_EtherCAT</span><span class="o">.</span><span class="n">TcGVL</span>
    <span class="mf">6.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">FB_BasicStats</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">7.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">FB_DataBuffer</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">8.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">FB_LREALBuffer</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">9.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">FB_LREALFromEPICS</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">10.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">FB_TimeStampBuffer</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">11.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">FB_TimeStampBufferGlobal</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">12.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Diagnostics</span><span class="o">/</span><span class="n">DUT</span><span class="o">/</span><span class="n">E_EcatDiagState</span><span class="o">.</span><span class="n">TcDUT</span>
    <span class="mf">13.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Diagnostics</span><span class="o">/</span><span class="n">DUT</span><span class="o">/</span><span class="n">E_EcCommState</span><span class="o">.</span><span class="n">TcDUT</span>
    <span class="mf">14.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Diagnostics</span><span class="o">/</span><span class="n">DUT</span><span class="o">/</span><span class="n">ST_EcMasterDevState</span><span class="o">.</span><span class="n">TcDUT</span>
    <span class="mf">15.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Diagnostics</span><span class="o">/</span><span class="n">DUT</span><span class="o">/</span><span class="n">ST_PortAddr</span><span class="o">.</span><span class="n">TcDUT</span>
    <span class="mf">16.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Diagnostics</span><span class="o">/</span><span class="n">DUT</span><span class="o">/</span><span class="n">ST_SlaveState</span><span class="o">.</span><span class="n">TcDUT</span>
    <span class="mf">17.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Diagnostics</span><span class="o">/</span><span class="n">DUT</span><span class="o">/</span><span class="n">ST_SlaveStateInfo</span><span class="o">.</span><span class="n">TcDUT</span>
    <span class="mf">18.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Diagnostics</span><span class="o">/</span><span class="n">DUT</span><span class="o">/</span><span class="n">ST_SlaveStateInfoScanned</span><span class="o">.</span><span class="n">TcDUT</span>
    <span class="mf">19.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Diagnostics</span><span class="o">/</span><span class="n">DUT</span><span class="o">/</span><span class="n">ST_TopologyData</span><span class="o">.</span><span class="n">TcDUT</span>
    <span class="mf">20.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Diagnostics</span><span class="o">/</span><span class="n">FB_EcatDiagWrapper</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">21.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Diagnostics</span><span class="o">/</span><span class="n">FB_EtherCATDiag</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">22.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Diagnostics</span><span class="o">/</span><span class="n">FB_EtherCATFrameDiag</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">23.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Functions</span><span class="o">/</span><span class="n">FB_EcatDiag</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">24.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Functions</span><span class="o">/</span><span class="n">FB_Index</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">25.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Functions</span><span class="o">/</span><span class="n">FB_UnixTimeStamp</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">26.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Functions</span><span class="o">/</span><span class="n">FB_UnixTimeStampGlobal</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">27.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Functions</span><span class="o">/</span><span class="n">FB_XKoyoPLCModbus</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">28.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Functions</span><span class="o">/</span><span class="n">F_ConvertTicksToUnixTimestamp</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">29.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Hardware</span><span class="o">/</span><span class="n">FB_AnalogOutput</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">30.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Hardware</span><span class="o">/</span><span class="n">FB_AnalogInput</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">31.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Hardware</span><span class="o">/</span><span class="n">FB_CoE_FastRead</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">32.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Hardware</span><span class="o">/</span><span class="n">FB_EL6_Com</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">33.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Hardware</span><span class="o">/</span><span class="n">FB_ThermoCouple</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">34.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Hardware</span><span class="o">/</span><span class="n">FB_TempSensor</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">35.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Logger</span><span class="o">/</span><span class="n">DUTs</span><span class="o">/</span><span class="n">E_LogEventType_WC</span><span class="o">.</span><span class="n">TcDUT</span>
    <span class="mf">36.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Logger</span><span class="o">/</span><span class="n">DUTs</span><span class="o">/</span><span class="n">ST_LoggingEventInfo_WC</span><span class="o">.</span><span class="n">TcDUT</span>
    <span class="mf">37.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Logger</span><span class="o">/</span><span class="n">DUTs</span><span class="o">/</span><span class="n">ST_PendingEvent</span><span class="o">.</span><span class="n">TcDUT</span>
    <span class="mf">38.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Logger</span><span class="o">/</span><span class="n">FB_Listener</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">39.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Logger</span><span class="o">/</span><span class="n">FB_LogHandler</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">40.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Logger</span><span class="o">/</span><span class="n">FB_LogMessage</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">41.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Logger</span><span class="o">/</span><span class="n">F_SendUDPMessage</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">42.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Logger</span><span class="o">/</span><span class="n">GVL_Logger</span><span class="o">.</span><span class="n">TcGVL</span>
    <span class="mf">43.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Logger</span><span class="o">/</span><span class="n">DUTs</span><span class="o">/</span><span class="n">E_Subsystem</span><span class="o">.</span><span class="n">TcDUT</span>
    <span class="mf">44.</span><span class="p">)</span> <span class="n">LCLSGeneral</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">Logger</span><span class="o">/</span><span class="n">SYSTEM_TIME_TO_RFC3339</span><span class="o">.</span><span class="n">TcPOU</span>

<span class="n">POUs</span><span class="p">:</span>
    <span class="mf">1.</span><span class="p">)</span> <span class="n">FB_AnalogInput</span>
    <span class="mf">2.</span><span class="p">)</span> <span class="n">FB_AnalogOutput</span>
    <span class="mf">3.</span><span class="p">)</span> <span class="n">FB_BasicStats</span>
    <span class="mf">4.</span><span class="p">)</span> <span class="n">FB_CoE_FastRead</span>
    <span class="mf">5.</span><span class="p">)</span> <span class="n">FB_DataBuffer</span>
    <span class="mf">6.</span><span class="p">)</span> <span class="n">FB_EL6_Com</span>
    <span class="mf">7.</span><span class="p">)</span> <span class="n">FB_EcatDiag</span>
    <span class="mf">8.</span><span class="p">)</span> <span class="n">FB_EcatDiagWrapper</span>
    <span class="mf">9.</span><span class="p">)</span> <span class="n">FB_EtherCATDiag</span>
    <span class="mf">10.</span><span class="p">)</span> <span class="n">FB_EtherCATFrameDiag</span>
    <span class="mf">11.</span><span class="p">)</span> <span class="n">FB_Index</span>
    <span class="mf">12.</span><span class="p">)</span> <span class="n">FB_LREALBuffer</span>
    <span class="mf">13.</span><span class="p">)</span> <span class="n">FB_LREALFromEPICS</span>
    <span class="mf">14.</span><span class="p">)</span> <span class="n">FB_Listener</span>
    <span class="mf">15.</span><span class="p">)</span> <span class="n">FB_LogHandler</span>
    <span class="mf">16.</span><span class="p">)</span> <span class="n">FB_LogMessage</span>
    <span class="mf">17.</span><span class="p">)</span> <span class="n">FB_TempSensor</span>
    <span class="mf">18.</span><span class="p">)</span> <span class="n">FB_ThermoCouple</span>
    <span class="mf">19.</span><span class="p">)</span> <span class="n">FB_TimeStampBuffer</span>
    <span class="mf">20.</span><span class="p">)</span> <span class="n">FB_TimeStampBufferGlobal</span>
    <span class="mf">21.</span><span class="p">)</span> <span class="n">FB_UnixTimeStamp</span>
    <span class="mf">22.</span><span class="p">)</span> <span class="n">FB_UnixTimeStampGlobal</span>
    <span class="mf">23.</span><span class="p">)</span> <span class="n">FB_XKoyoPLCModbus</span>
    <span class="mf">24.</span><span class="p">)</span> <span class="n">F_ConvertTicksToUnixTimestamp</span>
    <span class="mf">25.</span><span class="p">)</span> <span class="n">F_SendUDPMessage</span>
    <span class="mf">26.</span><span class="p">)</span> <span class="n">SYSTEM_TIME_TO_RFC3339</span>

<span class="n">GVLs</span><span class="p">:</span>
    <span class="mf">1.</span><span class="p">)</span> <span class="n">DefaultGlobals</span>
    <span class="mf">2.</span><span class="p">)</span> <span class="n">GVL_Logger</span>
    <span class="mf">3.</span><span class="p">)</span> <span class="n">Global_Variables_EtherCAT</span>
</pre></div>
</div>
<div class="section" id="dut-e-eccommstate">
<h2>DUT: E_EcCommState<a class="headerlink" href="#dut-e-eccommstate" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Diagnostics/DUT/E_EcCommState.TcDUT</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="k">TYPE</span> <span class="n">E_EcCommState</span> <span class="o">:</span> <span class="p">(</span>
	<span class="n">eEcState_UNDEFINED</span> 	<span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">eEcState_INIT</span> 		<span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">eEcState_PREOP</span> 		<span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">eEcState_BOOT</span> 		<span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">eEcState_SAFEOP</span> 	<span class="o">:=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">eEcState_OP</span> 		<span class="o">:=</span> <span class="mi">8</span>
<span class="p">)</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="dut-e-ecatdiagstate">
<h2>DUT: E_EcatDiagState<a class="headerlink" href="#dut-e-ecatdiagstate" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Diagnostics/DUT/E_EcatDiagState.TcDUT</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="k">TYPE</span> <span class="n">E_EcatDiagState</span> <span class="o">:</span>
<span class="p">(</span>
	<span class="n">Idle</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">GetSlaveAddresses</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">GetSlaveStates</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">GetTopoDataLen</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">GetTopoData</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">ScanSlaves</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">GetSlaveIdentity</span> <span class="o">:=</span> <span class="mi">6</span><span class="p">,</span>
    <span class="n">GetSlaveName</span> <span class="o">:=</span> <span class="mi">7</span><span class="p">,</span>
    <span class="n">GetScannedSlaveName</span> <span class="o">:=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">LogDiagnostics</span> <span class="o">:=</span> <span class="mi">9</span><span class="p">,</span>
    <span class="n">Done</span> <span class="o">:=</span> <span class="mi">8000</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="dut-e-logeventtype-wc">
<h2>DUT: E_LogEventType_WC<a class="headerlink" href="#dut-e-logeventtype-wc" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Logger/DUTs/E_LogEventType_WC.TcDUT</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>{attribute &#39;qualified_only&#39;}
{attribute &#39;strict&#39;}
TYPE E_LogEventType_WC :
(
	AlarmCleared 	:= 0,
	AlarmConfirmed 	:= 1,
	AlarmRaised 	:= 2,
	MessageSent 	:= 3
);
END_TYPE

(* Note: this is the working copy version that is automatically made a
   global type when pinning ST_LoggingEventInfo *)
</pre></div>
</div>
</div>
<div class="section" id="dut-e-subsystem">
<h2>DUT: E_Subsystem<a class="headerlink" href="#dut-e-subsystem" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Logger/DUTs/E_Subsystem.TcDUT</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">LCLS</span> <span class="n">Defined</span> <span class="n">subsystems</span><span class="p">,</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">these</span> <span class="n">correspond</span> <span class="k">with</span> <span class="n">casSubsystems</span> <span class="k">in</span> <span class="n">FB_LogMessage</span>
<span class="k">TYPE</span> <span class="n">E_Subsystem</span> <span class="o">:</span>
<span class="p">(</span>
	<span class="n">NILVALUE</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">//</span><span class="n">Undefined</span> <span class="n">system</span>
	<span class="n">VACUUM</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">//</span><span class="n">Vacuum</span> <span class="n">control</span> <span class="n">system</span>
	<span class="n">MPS</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span> <span class="o">//</span><span class="n">Machine</span> <span class="n">protection</span> <span class="n">system</span>
	<span class="n">MOTION</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span> <span class="o">//</span><span class="n">Motion</span> <span class="n">control</span> <span class="n">systems</span>
	<span class="n">FIELDBUS</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">,</span> <span class="o">//</span><span class="n">EtherCAT</span> <span class="n">networks</span>
	<span class="n">SDS</span> <span class="o">:=</span> <span class="mi">5</span> <span class="o">//</span><span class="n">Sample</span> <span class="n">delivery</span> <span class="n">system</span>
<span class="p">)</span><span class="n">WORD</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="dut-st-ecdevice">
<h2>DUT: ST_EcDevice<a class="headerlink" href="#dut-st-ecdevice" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/Data types/Misc/ST_EcDevice.TcDUT</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">EtherCAT</span> <span class="n">Device</span> <span class="n">struct</span> <span class="k">for</span> <span class="n">EtherCAT</span> <span class="n">diagnostics</span>
<span class="k">TYPE</span> <span class="n">ST_EcDevice</span> <span class="o">:</span>
<span class="n">STRUCT</span>
	<span class="n">nDeviceState</span><span class="o">:</span> <span class="n">BYTE</span><span class="p">;</span> <span class="o">//</span><span class="n">EtherCAT</span> <span class="n">state</span> <span class="n">machine</span> <span class="n">state</span> <span class="n">number</span><span class="p">,</span> <span class="mi">8</span> <span class="k">is</span> <span class="n">OP</span> <span class="k">is</span> <span class="n">good</span>
	<span class="n">sDeviceState</span> <span class="o">:</span><span class="kt">STRING</span><span class="p">;</span> <span class="o">//</span><span class="n">EtherCAT</span> <span class="n">state</span> <span class="n">machine</span> <span class="n">state</span><span class="p">,</span> <span class="n">OP</span> <span class="k">is</span> <span class="n">good</span>
	<span class="n">nLinkState</span><span class="o">:</span> <span class="n">BYTE</span><span class="p">;</span> <span class="o">//</span><span class="n">EtherCAT</span> <span class="n">link</span> <span class="n">state</span><span class="p">,</span> <span class="mi">8</span> <span class="k">is</span> <span class="n">good</span>
	<span class="n">nAddrr</span><span class="o">:</span> <span class="n">WORD</span><span class="p">;</span> <span class="o">//</span><span class="n">EtherCAT</span> <span class="n">slave</span> <span class="n">address</span>
	<span class="n">sType</span><span class="o">:</span> <span class="kt">STRING</span><span class="p">;</span> <span class="o">//</span><span class="n">EtherCAT</span> <span class="n">slave</span> <span class="k">type</span>
	<span class="n">sName</span><span class="o">:</span><span class="kt">STRING</span><span class="p">;</span> <span class="o">//</span><span class="n">EtherCAT</span> <span class="n">slave</span> <span class="n">name</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="dut-st-ecmasterdevstate">
<h2>DUT: ST_EcMasterDevState<a class="headerlink" href="#dut-st-ecmasterdevstate" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Diagnostics/DUT/ST_EcMasterDevState.TcDUT</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="k">TYPE</span> <span class="n">ST_EcMasterDevState</span> <span class="o">:</span>
<span class="n">STRUCT</span>
	<span class="n">eEcState</span>	 		<span class="o">:</span> <span class="n">E_EcCommState</span><span class="p">;</span>
	<span class="n">nReserved</span>			<span class="o">:</span> <span class="k">ARRAY</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">2</span><span class="p">]</span> <span class="k">OF</span> <span class="n">UINT</span><span class="p">;</span>

	<span class="n">bLinkError</span>			<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
	<span class="n">bResetRequired</span>		<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
	<span class="n">bMissFrmRedMode</span>		<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
	<span class="n">bWatchdogTriggerd</span>	<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
	<span class="n">bDriverNotFound</span>		<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
	<span class="n">bResetActive</span>		<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
	<span class="n">bAtLeastOneNotInOp</span>	<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
	<span class="n">bDcNotInSync</span>		<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="dut-st-fbdiagnostics">
<h2>DUT: ST_FbDiagnostics<a class="headerlink" href="#dut-st-fbdiagnostics" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/Data types/Misc/ST_fbDiagnostics.TcDUT</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>//Stuff to log messages within function blocks
TYPE ST_FbDiagnostics :
STRUCT
	asResults	:	ARRAY [1..20] OF T_MaxString; //Diagnostic messages, use to record state changes or other important events.
	{attribute &#39;naming&#39; := &#39;omit&#39;}
	//Incrementer, included here to facilitate using asResults
	resultIdx	:	FB_Index := ( 
		LowerLimit := 1,
		UpperLimit := 20
	);
	{attribute &#39;naming&#39; := &#39;omit&#39;}
	fString	:	FB_FormatString; //Use to create good log messages, similar to C++ fstring
END_STRUCT
END_TYPE
</pre></div>
</div>
</div>
<div class="section" id="dut-st-loggingeventinfo-wc">
<h2>DUT: ST_LoggingEventInfo_WC<a class="headerlink" href="#dut-st-loggingeventinfo-wc" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Logger/DUTs/ST_LoggingEventInfo_WC.TcDUT</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>TYPE ST_LoggingEventInfo_WC :
STRUCT
	(* 
		Message or Alarm{Cleared,Confirmed,Raised} event information
		
		** Working copy - to be used for the pinned ST_LoggingEventInfo **
		* The process for updating this type is as follows:
			1. Copy this structure and rename to ST_LoggingEventInfo
			2. Remove the working copy notes section
			3. Pin the global data type  
		** End of working copy information **
 
		Note that elements here do not follow the usual Hungarian notation / 
		variable-type-prefixing naming convention due to the member names being
		used directly in the generation of the JSON document.
	*)
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: Schema
		io: i
		field: DESC Schema string
	&#39;}
	schema		:	STRING := &#39;twincat-event-0&#39;;
	  
	{attribute &#39;pytmc&#39; := &#39;
		pv: Timestamp 
		io: i
		field: DESC Unix timestamp
	&#39;}
  	ts			:	LREAL;
	
  	{attribute &#39;pytmc&#39; := &#39;
		pv: Hostname 
		io: i
		field: DESC PLC Hostname
	&#39;}
  	plc			:	STRING;
  
	{attribute &#39;pytmc&#39; := &#39;
		pv: Severity
		io: i
		field: DESC TcEventSeverity	
		field: ZRST Verbose
		field: ONST Info
		field: TWST Warning
		field: THST Error
	&#39;}
	severity	:	TcEventSeverity;
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: MessageID
		io: i
		field: DESC TwinCAT Message ID	
	&#39;}
	id			:	UDINT;

	{attribute &#39;pytmc&#39; := &#39;
		pv: EventClass
		io: i
		field: DESC TwinCAT Event class	
	&#39;}
	event_class		:	STRING;
		
	{attribute &#39;pytmc&#39; := &#39;
		pv: Message
		io: i
	&#39;}
	msg				: STRING(255);	 
	// This is actually: T_MaxString
	// which has been expanded due to requirements for pinning global data types.
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: Source
		io: i
	&#39;}
	source			: STRING(255);	 
	// This is actually: STRING(Tc3_EventLogger.ParameterList.cSourceNameSize - 1)
	// which has been expanded due to requirements for pinning global data types.
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: EventType
		io: i
		field: DESC The event type
	&#39;}
	event_type	:	 E_LogEventType;
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: MessageJSON
		io: i
		field: DESC Metadata with the message	
	&#39;}
	json 		:	STRING(10000);
	(* 
	NOTE: this JSON gets inserted as an escaped string in the &quot;json&quot; key.
	TODO: it may be possible to use `fbJson.AddRawObject`, but this would
		  require us to switch back to creating the JSON in a more manual
		  way with AddKey/AddInt (and such).
	*)		 

END_STRUCT
END_TYPE
</pre></div>
</div>
</div>
<div class="section" id="dut-st-pendingevent">
<h2>DUT: ST_PendingEvent<a class="headerlink" href="#dut-st-pendingevent" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Logger/DUTs/ST_PendingEvent.TcDUT</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>TYPE ST_PendingEvent :
STRUCT
	
	{attribute &#39;pytmc&#39; := &#39;
		pv:
	&#39;}
	stEventInfo			:	ST_LoggingEventInfo;
	bInUse				:	BOOL;
	fbRequestEventText	:	FB_RequestEventText;
	
END_STRUCT
END_TYPE
</pre></div>
</div>
</div>
<div class="section" id="dut-st-portaddr">
<h2>DUT: ST_PortAddr<a class="headerlink" href="#dut-st-portaddr" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Diagnostics/DUT/ST_PortAddr.TcDUT</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="k">TYPE</span> <span class="n">ST_PortAddr</span> <span class="o">:</span>
<span class="n">STRUCT</span>
	<span class="n">portA</span> <span class="o">:</span> <span class="n">UINT</span><span class="p">;</span>
	<span class="n">portB</span> <span class="o">:</span> <span class="n">UINT</span><span class="p">;</span>
	<span class="n">portC</span> <span class="o">:</span> <span class="n">UINT</span><span class="p">;</span>
	<span class="n">portD</span> <span class="o">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="dut-st-slavestate">
<h2>DUT: ST_SlaveState<a class="headerlink" href="#dut-st-slavestate" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Diagnostics/DUT/ST_SlaveState.TcDUT</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="k">TYPE</span> <span class="n">ST_SlaveState</span> <span class="o">:</span>
<span class="n">STRUCT</span>
	<span class="p">(</span><span class="o">*</span> <span class="n">slave</span> <span class="n">state</span> <span class="o">*</span><span class="p">)</span>
	<span class="n">eEcState</span> 		<span class="o">:</span> <span class="n">E_EcCommState</span><span class="p">;</span>
	<span class="n">nReserved</span>		<span class="o">:</span> <span class="n">UINT</span><span class="p">;</span>
	<span class="n">bError</span>			<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
	<span class="n">bInvalidVPRS</span>	<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
	<span class="n">nReserved2</span>		<span class="o">:</span> <span class="n">UINT</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span> <span class="n">link</span> <span class="n">state</span> <span class="o">*</span><span class="p">)</span>
	<span class="n">bNoCommToSlave</span>	<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
	<span class="n">bLinkError</span>		<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
	<span class="n">bMissingLink</span>	<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
	<span class="n">bUnexpectedLink</span>	<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
	<span class="n">bPortA</span>			<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
	<span class="n">bPortB</span>			<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
	<span class="n">bPortC</span>			<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
	<span class="n">bPortD</span>			<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="dut-st-slavestateinfo">
<h2>DUT: ST_SlaveStateInfo<a class="headerlink" href="#dut-st-slavestateinfo" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Diagnostics/DUT/ST_SlaveStateInfo.TcDUT</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="k">TYPE</span> <span class="n">ST_SlaveStateInfo</span> <span class="o">:</span>
<span class="n">STRUCT</span>
	<span class="n">nIndex</span> 			<span class="o">:</span> <span class="n">DINT</span><span class="p">;</span>
	<span class="n">sName</span> 			<span class="o">:</span> <span class="kt">STRING</span><span class="p">;</span> 		<span class="p">(</span><span class="o">*</span> <span class="n">name</span> <span class="k">of</span> <span class="n">slave</span> <span class="n">given</span> <span class="k">in</span> <span class="n">System</span> <span class="n">Manager</span> <span class="o">*</span><span class="p">)</span>
	<span class="n">sType</span> 			<span class="o">:</span> <span class="kt">STRING</span><span class="p">;</span>		<span class="p">(</span><span class="o">*</span> <span class="k">type</span> <span class="k">of</span> <span class="n">slave</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span> <span class="n">EK1100</span><span class="o">*</span><span class="p">)</span>
	<span class="n">nECAddr</span> 		<span class="o">:</span> <span class="n">UINT</span><span class="p">;</span>			<span class="p">(</span><span class="o">*</span> <span class="n">EtherCAT</span> <span class="n">Slave</span> <span class="n">Addr</span> <span class="o">*</span><span class="p">)</span>
	<span class="n">bDiagData</span>		<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>			<span class="p">(</span><span class="o">*</span> <span class="n">DiagData</span> <span class="k">in</span> <span class="n">Slave</span> <span class="n">State</span> <span class="o">*</span><span class="p">)</span>
	<span class="n">stPortCRCErrors</span>	<span class="o">:</span> <span class="n">ST_EcCrcErrorEx</span><span class="p">;(</span><span class="o">*</span> <span class="n">Slave</span> <span class="n">CRC</span><span class="o">-</span><span class="n">Errors</span><span class="p">,</span> <span class="n">separate</span> <span class="k">for</span> <span class="n">each</span> <span class="k">Port</span> <span class="o">*</span><span class="p">)</span>
	<span class="n">nSumCRCErrors</span>	<span class="o">:</span> <span class="n">UDINT</span><span class="p">;</span>		<span class="p">(</span><span class="o">*</span> <span class="n">Slave</span> <span class="n">CRC</span><span class="o">-</span><span class="n">Errors</span><span class="p">,</span> <span class="n">sum</span> <span class="k">of</span> <span class="k">all</span> <span class="n">Ports</span> <span class="o">*</span><span class="p">)</span>
	<span class="n">stState</span> 		<span class="o">:</span> <span class="n">ST_SlaveState</span><span class="p">;(</span><span class="o">*</span> <span class="n">EtherCAT</span> <span class="n">State</span> <span class="k">and</span> <span class="n">Link</span> <span class="n">state</span><span class="o">*</span><span class="p">)</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="dut-st-slavestateinfoscanned">
<h2>DUT: ST_SlaveStateInfoScanned<a class="headerlink" href="#dut-st-slavestateinfoscanned" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Diagnostics/DUT/ST_SlaveStateInfoScanned.TcDUT</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="k">TYPE</span> <span class="n">ST_SlaveStateInfoScanned</span> <span class="o">:</span>
<span class="n">STRUCT</span>
	<span class="n">nIndex</span> 			<span class="o">:</span> <span class="n">DINT</span><span class="p">;</span>
	<span class="n">sName</span> 			<span class="o">:</span> <span class="kt">STRING</span><span class="p">;</span> 		<span class="p">(</span><span class="o">*</span> <span class="n">name</span> <span class="k">of</span> <span class="n">slave</span> <span class="n">given</span> <span class="k">in</span> <span class="n">System</span> <span class="n">Manager</span> <span class="o">*</span><span class="p">)</span>
	<span class="n">sType</span> 			<span class="o">:</span> <span class="kt">STRING</span><span class="p">;</span>		<span class="p">(</span><span class="o">*</span> <span class="k">type</span> <span class="k">of</span> <span class="n">slave</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span> <span class="n">EK1100</span><span class="o">*</span><span class="p">)</span>
	<span class="n">nECAddr</span> 		<span class="o">:</span> <span class="n">UINT</span><span class="p">;</span>			<span class="p">(</span><span class="o">*</span> <span class="n">EtherCAT</span> <span class="n">Slave</span> <span class="n">Addr</span> <span class="o">*</span><span class="p">)</span>
	<span class="n">bDifferentName</span>	<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>			<span class="p">(</span><span class="o">*</span> <span class="n">Name</span> <span class="k">of</span> <span class="n">Scanned</span> <span class="k">configuration</span> <span class="n">differs</span> <span class="n">from</span> <span class="n">Configured</span> <span class="k">configuration</span> <span class="o">*</span><span class="p">)</span>
	<span class="n">bDifferentType</span>	<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>			<span class="p">(</span><span class="o">*</span> <span class="k">Type</span> <span class="k">Of</span> <span class="n">Scanned</span> <span class="k">configuration</span> <span class="n">differs</span> <span class="n">from</span> <span class="n">Configured</span> <span class="k">configuration</span> <span class="o">*</span><span class="p">)</span>
	<span class="n">bDifferentAddr</span>	<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>			<span class="p">(</span><span class="o">*</span> <span class="n">EcAddress</span> <span class="k">of</span> <span class="n">Scanned</span> <span class="k">configuration</span> <span class="n">differs</span> <span class="n">from</span> <span class="n">Configured</span> <span class="k">configuration</span> <span class="o">*</span><span class="p">)</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="dut-st-system">
<h2>DUT: ST_System<a class="headerlink" href="#dut-st-system" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/Data types/Misc/ST_System.TcDUT</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>//Defacto system structure, must be included in all projects
TYPE ST_System :
STRUCT
	
	xSwAlmRst 		: BOOL;(* Global Alarm Reset - EPICS Command *)
	xAtVacuum 	    : BOOL;(* System At Vacuum *)
	xFirstScan	    : BOOL; (* This boolean is true for the first scan, and is false thereafter, use for initialization of stuff *)
	xOverrideMode	: BOOL; //This bit is set when using the override features of the system
	xIOState        : BOOL; (* ECat Bus Health *)
	{attribute &#39;naming&#39; := &#39;omit&#39;}
	I_EcatMaster1 AT %I* : AMSNETID; (* AMS Net ID used for FB_EcatDiag, among others *)

END_STRUCT
END_TYPE
</pre></div>
</div>
</div>
<div class="section" id="dut-st-topologydata">
<h2>DUT: ST_TopologyData<a class="headerlink" href="#dut-st-topologydata" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Diagnostics/DUT/ST_TopologyData.TcDUT</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="k">TYPE</span> <span class="n">ST_TopologyData</span> <span class="o">:</span>
<span class="n">STRUCT</span>
	<span class="n">iOwnPhysicalAddr</span> 	<span class="o">:</span> <span class="n">UINT</span><span class="p">;</span>
	<span class="n">iOwnAutoIncAddr</span>		<span class="o">:</span> <span class="n">UINT</span><span class="p">;</span>
	<span class="n">stPhysicalAddr</span>		<span class="o">:</span> <span class="n">ST_PortAddr</span><span class="p">;</span>
	<span class="n">stAutoIncAddr</span>		<span class="o">:</span> <span class="n">ST_PortAddr</span><span class="p">;</span>
	<span class="n">iPortDelay</span>			<span class="o">:</span> <span class="k">ARRAY</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">2</span><span class="p">]</span> <span class="k">OF</span> <span class="n">UDINT</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">EC_AD</span><span class="p">,</span> <span class="n">EC_DB</span><span class="p">,</span> <span class="n">EC_BC</span> <span class="o">*</span><span class="p">)</span>
	<span class="n">iReserved</span>			<span class="o">:</span> <span class="k">ARRAY</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">7</span><span class="p">]</span> <span class="k">OF</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="gvl-defaultglobals">
<h2>GVL: DefaultGlobals<a class="headerlink" href="#gvl-defaultglobals" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/GVLs/DefaultGlobals.TcGVL</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">These</span> <span class="n">are</span> <span class="n">variables</span> <span class="n">every</span> <span class="n">PLC</span> <span class="n">project</span> <span class="n">should</span> <span class="n">have</span>
<span class="n">VAR_GLOBAL</span>
	
	<span class="n">stSys</span>	<span class="o">:</span>	<span class="n">ST_System</span><span class="p">;</span> <span class="o">//</span><span class="n">Included</span> <span class="k">for</span> <span class="n">you</span>
	<span class="n">fTimeStamp</span><span class="o">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</div>
<div class="section" id="gvl-gvl-logger">
<h2>GVL: GVL_Logger<a class="headerlink" href="#gvl-gvl-logger" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Logger/GVL_Logger.TcGVL</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>{attribute &#39;qualified only&#39;}
//Global variables for logging to syslog
VAR_GLOBAL CONSTANT
	(*
	Using the IP address directly avoids DNS configuration issues.
	While we may want to address this in the future, for now the static IP
	will suffice:

	$ nslookup ctl-logsrv01
	Name:   ctl-logsrv01.pcdsn
	Address: 172.21.32.36
	*)
	{attribute &#39;pytmc&#39; := &#39;
		pv: @(PREFIX)LCLSGeneral:LogHost
		io: io
		field: DESC The log host IP address
	&#39;}
	cLogHost		:	STRING(15)	:= &#39;172.21.32.36&#39;;
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: @(PREFIX)LCLSGeneral:LogPort
		io: io
		field: DESC The log host UDP port
	&#39;}
	iLogPort		:	UINT		:= 54321;
    
    sIpTidbit : STRING(6) := &#39;172.21&#39;;
END_VAR

VAR_GLOBAL
	sPlcHostname	:	STRING		:= &#39;unknown&#39;;
	
	(* Ref: https://infosys.beckhoff.com/english.php?content=../content/1033/tcpipserver/html/TcPlcLibTcpIp_FB_SocketUdpSendTo.htm
		TODO: Activate the &quot;Replace constants&quot; option in the
		TwinCAT PLC Control-&gt;&quot;Project-&gt;Options...-&gt;Build&quot; dialog window. 
	*)
	TCPADS_MAXUDP_BUFFSIZE : UDINT :=10000;
	
	{analysis -33}
	fbRootLogger : FB_LogMessage; //Instantiated here to be used everywhere
	{analysis +33}
END_VAR
</pre></div>
</div>
</div>
<div class="section" id="gvl-global-variables-ethercat">
<h2>GVL: Global_Variables_EtherCAT<a class="headerlink" href="#gvl-global-variables-ethercat" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/GVLs/Global_Variables_EtherCAT.TcGVL</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="n">VAR_GLOBAL</span> <span class="k">CONSTANT</span>
	<span class="n">iSLAVEADDR_ARR_SIZE</span>	<span class="o">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">256</span><span class="p">;</span>
    <span class="n">ESC_MAX_PORTS</span> <span class="o">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span> <span class="o">//</span> <span class="n">Maximum</span> <span class="n">number</span> <span class="k">of</span> <span class="n">ports</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">on</span> <span class="n">ESC</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-analoginput">
<h2>POU: FB_AnalogInput<a class="headerlink" href="#pou-fb-analoginput" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Hardware/FB_AnalogInput.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_AnalogInput</span>
<span class="p">(</span><span class="o">*</span>
	<span class="n">Converts</span> <span class="n">the</span> <span class="kt">integer</span> <span class="n">from</span> <span class="n">an</span> <span class="n">analog</span> <span class="n">input</span> <span class="n">terminal</span> <span class="k">to</span> <span class="n">a</span> <span class="n">real</span> <span class="n">unit</span> <span class="n">value</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.,</span> <span class="n">volts</span><span class="p">)</span>
	<span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">09</span> <span class="n">Zachary</span> <span class="n">Lentz</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
	<span class="o">//</span> <span class="n">Connect</span> <span class="n">this</span> <span class="n">input</span> <span class="k">to</span> <span class="n">the</span> <span class="n">terminal</span>
	<span class="n">iRaw</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*:</span> <span class="n">INT</span><span class="p">;</span>
	<span class="o">//</span> <span class="n">The</span> <span class="n">number</span> <span class="k">of</span> <span class="n">bits</span> <span class="n">correlated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">terminal</span><span class="na">&#39;s</span> <span class="n">max</span> <span class="n">value</span><span class="p">.</span> <span class="n">This</span> <span class="k">is</span> <span class="k">not</span> <span class="n">necessarily</span> <span class="n">the</span> <span class="n">resolution</span> <span class="n">parameter</span><span class="p">.</span>
	<span class="n">iTermBits</span><span class="o">:</span> <span class="n">UINT</span><span class="p">;</span>
	<span class="o">//</span> <span class="n">The</span> <span class="n">fReal</span> <span class="n">value</span> <span class="n">correlated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">terminal</span><span class="na">&#39;s</span> <span class="n">max</span> <span class="n">value</span>
	<span class="n">fTermMax</span><span class="o">:</span> <span class="n">LREAL</span><span class="p">;</span>
	<span class="o">//</span> <span class="n">The</span> <span class="n">fReal</span> <span class="n">value</span> <span class="n">correlated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">terminal</span><span class="na">&#39;s</span> <span class="n">min</span> <span class="n">value</span>
	<span class="n">fTermMin</span><span class="o">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
	<span class="o">//</span> <span class="n">The</span> <span class="n">real</span> <span class="n">value</span> <span class="n">read</span> <span class="n">from</span> <span class="n">the</span> <span class="n">output</span>
	<span class="n">fReal</span><span class="o">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
	<span class="n">fScale</span><span class="o">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="k">IF</span> <span class="n">fScale</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">AND</span> <span class="n">fTermMax</span> <span class="o">&gt;</span> <span class="n">fTermMin</span> <span class="k">THEN</span>
	<span class="n">fScale</span> <span class="o">:=</span> <span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">iTermBits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fTermMax</span> <span class="o">-</span> <span class="n">fTermMin</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="k">IF</span> <span class="n">fScale</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">THEN</span>
	<span class="n">fReal</span> <span class="o">:=</span> <span class="n">iRaw</span> <span class="o">/</span> <span class="n">fScale</span> <span class="o">+</span> <span class="n">fTermMin</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-analogoutput">
<h2>POU: FB_AnalogOutput<a class="headerlink" href="#pou-fb-analogoutput" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Hardware/FB_AnalogOutput.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_AnalogOutput</span>
<span class="p">(</span><span class="o">*</span>
	<span class="n">Converts</span> <span class="n">a</span> <span class="n">real</span> <span class="n">unit</span> <span class="n">value</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.,</span> <span class="n">volts</span><span class="p">)</span> <span class="k">to</span> <span class="n">the</span> <span class="kt">integer</span> <span class="n">needed</span> <span class="k">for</span> <span class="n">an</span> <span class="n">analog</span> <span class="n">output</span> <span class="n">terminal</span><span class="p">.</span>
	<span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">09</span> <span class="n">Zachary</span> <span class="n">Lentz</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
	<span class="o">//</span> <span class="n">The</span> <span class="n">real</span> <span class="n">value</span> <span class="k">to</span> <span class="n">send</span> <span class="k">to</span> <span class="n">the</span> <span class="n">output</span>
	<span class="n">fReal</span><span class="o">:</span> <span class="n">LREAL</span><span class="p">;</span>
	<span class="o">//</span> <span class="n">The</span> <span class="n">maximum</span> <span class="n">allowed</span> <span class="n">real</span> <span class="n">value</span> <span class="k">for</span> <span class="n">the</span> <span class="n">connected</span> <span class="n">hardware</span>
	<span class="n">fSafeMax</span><span class="o">:</span> <span class="n">LREAL</span><span class="p">;</span>
	<span class="o">//</span> <span class="n">The</span> <span class="n">minimum</span> <span class="n">allowed</span> <span class="n">real</span> <span class="n">value</span> <span class="k">for</span> <span class="n">the</span> <span class="n">connected</span> <span class="n">hardware</span>
	<span class="n">fSafeMin</span><span class="o">:</span> <span class="n">LREAL</span><span class="p">;</span>
	<span class="o">//</span> <span class="n">The</span> <span class="n">number</span> <span class="k">of</span> <span class="n">bits</span> <span class="n">correlated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">terminal</span><span class="na">&#39;s</span> <span class="n">max</span> <span class="n">output</span><span class="p">.</span> <span class="n">This</span> <span class="k">is</span> <span class="k">not</span> <span class="n">necessarily</span> <span class="n">the</span> <span class="n">resolution</span> <span class="n">parameter</span><span class="p">.</span>
	<span class="n">iTermBits</span><span class="o">:</span> <span class="n">UINT</span><span class="p">;</span>
	<span class="o">//</span> <span class="n">The</span> <span class="n">fReal</span> <span class="n">value</span> <span class="n">correlated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">terminal</span><span class="na">&#39;s</span> <span class="n">max</span> <span class="n">output</span>
	<span class="n">fTermMax</span><span class="o">:</span> <span class="n">LREAL</span><span class="p">;</span>
	<span class="o">//</span> <span class="n">The</span> <span class="n">fReal</span> <span class="n">value</span> <span class="n">correlated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">terminal</span><span class="na">&#39;s</span> <span class="n">min</span> <span class="n">output</span>
	<span class="n">fTermMin</span><span class="o">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
	<span class="o">//</span> <span class="n">Connect</span> <span class="n">this</span> <span class="n">output</span> <span class="k">to</span> <span class="n">the</span> <span class="n">terminal</span>
	<span class="n">iRaw</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
	<span class="n">fScale</span><span class="o">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">scaling</span> <span class="n">from</span> <span class="n">real</span> <span class="k">to</span> <span class="n">raw</span>
<span class="k">IF</span> <span class="n">fScale</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">AND</span> <span class="n">fTermMax</span> <span class="o">&gt;</span> <span class="n">fTermMin</span> <span class="k">THEN</span>
	<span class="n">fScale</span> <span class="o">:=</span> <span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">iTermBits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fTermMax</span> <span class="o">-</span> <span class="n">fTermMin</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Adjust</span> <span class="n">real</span> <span class="n">value</span> <span class="k">to</span> <span class="n">be</span> <span class="n">within</span> <span class="n">the</span> <span class="n">limits</span>
<span class="n">fReal</span> <span class="o">:=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">fReal</span><span class="p">,</span> <span class="n">fSafeMax</span><span class="p">,</span> <span class="n">fTermMax</span><span class="p">);</span>
<span class="n">fReal</span> <span class="o">:=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">fReal</span><span class="p">,</span> <span class="n">fSafeMin</span><span class="p">,</span> <span class="n">fTermMin</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Scale</span> <span class="n">the</span> <span class="n">output</span> <span class="n">accordingly</span>
<span class="n">iRaw</span> <span class="o">:=</span> <span class="n">LREAL_TO_INT</span><span class="p">((</span><span class="n">fReal</span> <span class="o">-</span> <span class="n">fTermMin</span><span class="p">)</span> <span class="o">*</span> <span class="n">fScale</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-basicstats">
<h2>POU: FB_BasicStats<a class="headerlink" href="#pou-fb-basicstats" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Data/FB_BasicStats.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_BasicStats
(*
	Minimalist Array Stats for LREALs
	2019-10-10 Zachary Lentz
	
	Calculates the most basic stats for an array and provides pytmc control points.
	This is an alternative to the TC3 Condition Monitoring library which requires an
	additional license and had a more complicated interface.
*)
VAR_IN_OUT
	// Input array of floats
	{attribute &#39;pytmc&#39; := &#39;
		pv: STATS:DATA
		io: i
	&#39;}
	aSignal: ARRAY[*] OF LREAL;
END_VAR
VAR_INPUT
	// If TRUE, we will update the results every cycle
	{attribute &#39;pytmc&#39; := &#39;pv: STATS:ALWAYS_CALC&#39;}
	bAlwaysCalc: BOOL;
	// On rising edge, do one calculation
	{attribute &#39;pytmc&#39; := &#39;pv: STATS:EXECUTE&#39;}
	bExecute: BOOL;
	// If set to TRUE, reset outputs
	{attribute &#39;pytmc&#39; := &#39;pv: STATS:RESET&#39;}
	bReset: BOOL;
	// If nonzero, we will only pay attention to the first nElems items in aSignal
	{attribute &#39;pytmc&#39; := &#39;
		pv: STATS:NELM
		io: i
	&#39;}
	nElems: UDINT;
END_VAR
VAR_OUTPUT
	// Average of all values in the array
	{attribute &#39;pytmc&#39; := &#39;
		pv: STATS:MEAN
		io: i
	&#39;}
	fMean: LREAL;
	// Standard deviation of all values in the array
	{attribute &#39;pytmc&#39; := &#39;
		pv: STATS:STDEV
		io: i
	&#39;}
	fStDev: LREAL;
	// Largest value in the array
	{attribute &#39;pytmc&#39; := &#39;
		pv: STATS:MAX
		io: i
	&#39;}
	fMax: LREAL;
	// Smallest value in the array
	{attribute &#39;pytmc&#39; := &#39;
		pv: STATS:MIN
		io: i
	&#39;}
	fMin: LREAL;
	// Largest array element subtracted by the smallest
	{attribute &#39;pytmc&#39; := &#39;
		pv: STATS:RANGE
		io: i
	&#39;}
	fRange: LREAL;
	// True if the other outputs are valid
	{attribute &#39;pytmc&#39; := &#39;
		pv: STATS:VALID
		io: i
	&#39;}
	bValid: BOOL;
END_VAR
VAR
	rTrig: R_TRIG;
	nIndex: DINT;
	nElemsSeen: UDINT;
	fSum: LREAL;
	fVarianceSum: LREAL;
	fVarianceMean: LREAL;
END_VAR
rTrig(CLK:=bExecute);
IF bReset THEN
	fMean := 0;
	fStDev := 0;
	fMax := 0;
	fMin := 0;
	fRange := 0;
	bValid := FALSE;
	bReset := FALSE;
ELSIF NOT (bExecute OR bAlwaysCalc) THEN
	bValid := FALSE;
ELSIF bAlwaysCalc OR rTrig.Q THEN
	// First pass through aSignal: get sum, mean, max, min
	nElemsSeen := 0;
	fSum := 0;
	fMax := aSignal[LOWER_BOUND(aSignal, 1)];
	fMin := fMax;
	FOR nIndex := LOWER_BOUND(aSignal, 1) TO UPPER_BOUND(aSignal, 1) DO
		nElemsSeen := nElemsSeen + 1;
		fSum := fSum + aSignal[nIndex];
		IF aSignal[nIndex] &gt; fMax THEN
			fMax := aSignal[nIndex];
		ELSIF aSignal[nIndex] &lt; fMin tHEN
			fMin := aSignal[nIndex];
		END_IF
		IF nElems &gt; 0 AND nElemsSeen &gt;= nElems THEN
			EXIT;
		END_IF
	END_FOR
	IF nElemsSeen &gt; 0 THEN
		fMean := fSum / nElemsSeen;
		fRange := fMax - fMin;

		// Second pass through aSignal: get the sum of the variances and then the stdev
		nElemsSeen := 0;
		fVarianceSum := 0;
		FOR nIndex := LOWER_BOUND(aSignal, 1) TO UPPER_BOUND(aSignal, 1) DO
			nElemsSeen := nElemsSeen + 1;
			fVarianceSum := fVarianceSum + (aSignal[nIndex] - fMean) * (aSignal[nIndex] - fMean);
			IF nElems &gt; 0 AND nElemsSeen &gt;= nElems THEN
				EXIT;
			END_IF
		END_FOR
		IF nElemsSeen &gt; 1 THEN
			fVarianceMean := fVarianceSum / (nElemsSeen - 1);
			fStDev := SQRT(fVarianceMean);
			bValid := TRUE;
		END_IF
	END_IF
END_IF

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-coe-fastread">
<h2>POU: FB_CoE_FastRead<a class="headerlink" href="#pou-fb-coe-fastread" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Hardware/FB_CoE_FastRead.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_CoE_FastRead
(*
	Utility to repeatedly read a CoE parameter
	2019-10-09 Zachary Lentz
	
	In practice, it&#39;s impossible to read most CoE parameters every cycle,
	but this is a best effort and will work if the data is available
*)
VAR_INPUT
	// If TRUE we&#39;ll attempt a CoE read this cycle.
	bExecute: BOOL;
	// Link this to your terminal&#39;s drive reference variables under InfoData.
	stPlcDriveRef AT %I*: ST_PlcDriveRef;
	// Hexadecimal index of CoE, e.g. the 8010 in 8010:12
	nIndex: UINT;
	// Hexadecimal subindex of CoE, e.g. the 12 in 8010:12
	nSubIndex: BYTE;
	// Pointer to a value to fill with the result of the read, e.g. ADR(MyValue)
	pDstBuf: PVOID;
	// Data size of pDstBuf, e.g. SIZEOF(MyValue)
	cbBufLen: UINT;
END_VAR
VAR_OUTPUT
	// TRUE if the value was updated on this cycle.
	bNewValue: BOOL;
END_VAR
VAR
	fbRead: FB_CoERead_ByDriveRef;
	stDriveRef: ST_DriveRef;
	iLoop: INT;
	bInnerExec: BOOL;
END_VAR
stDriveRef.sNetId := F_CreateAmsNetId(stPlcDriveRef.aNetId);
stDriveRef.nSlaveAddr := stPlcDriveRef.nSlaveAddr;
stDriveRef.nDriveNo := stPlcDriveRef.nDriveNo;
stDriveRef.nDriveType := stPlcDriveRef.nDriveType;

bNewValue := FALSE;
IF bExecute THEN
	// You need to do this block 3 times per cycle to have a chance at always getting a read
	FOR iLoop:= 1 TO 3 DO
		fbRead(
			stDriveRef := stDriveRef,
			nIndex := nIndex,
			nSubIndex := nSubIndex,
			pDstBuf := pDstBuf,
			cbBufLen := cbBufLen,
			bExecute := bInnerExec,
			tTimeout := T#1s);
			
		IF bInnerExec AND NOT fbRead.bBusy AND NOT fbRead.bError THEN
			bInnerExec := FALSE;
			bNewValue := TRUE;
		ELSE
			bInnerExec := TRUE;
		END_IF
	END_FOR
END_IF

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-databuffer">
<h2>POU: FB_DataBuffer<a class="headerlink" href="#pou-fb-databuffer" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Data/FB_DataBuffer.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_DataBuffer</span>
<span class="p">(</span><span class="o">*</span>
	<span class="k">Function</span> <span class="k">Block</span> <span class="k">to</span> <span class="n">accumulate</span> <span class="n">data</span> <span class="n">into</span> <span class="n">an</span> <span class="k">array</span><span class="p">.</span>
	<span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">09</span> <span class="n">Zachary</span> <span class="n">Lentz</span>
	
	<span class="n">Requires</span> <span class="n">the</span> <span class="n">user</span> <span class="k">to</span> <span class="n">supply</span> <span class="n">pointers</span> <span class="k">to</span> <span class="n">the</span> <span class="n">value</span> <span class="k">and</span> <span class="k">to</span> <span class="mi">2</span> <span class="n">arrays</span><span class="o">:</span>
	<span class="mi">1</span><span class="p">.</span> <span class="n">A</span> <span class="n">partial</span> <span class="k">buffer</span> <span class="n">that</span> <span class="n">we</span> <span class="n">will</span> <span class="n">slowly</span> <span class="n">fill</span> <span class="n">one</span> <span class="n">value</span> <span class="n">at</span> <span class="n">a</span> <span class="kt">time</span>
	<span class="mi">2</span><span class="p">.</span> <span class="n">An</span> <span class="n">output</span> <span class="k">buffer</span> <span class="n">that</span> <span class="n">will</span> <span class="n">only</span> <span class="n">update</span> <span class="k">when</span> <span class="n">the</span> <span class="n">partial</span> <span class="k">buffer</span> <span class="k">is</span> <span class="n">full</span>
	
	<span class="n">Take</span> <span class="n">great</span> <span class="n">care</span> <span class="k">of</span> <span class="n">the</span> <span class="n">following</span><span class="p">,</span> <span class="k">or</span> <span class="k">else</span> <span class="n">your</span> <span class="n">program</span> <span class="n">will</span> <span class="n">likely</span> <span class="n">crash</span><span class="p">,</span>
	<span class="k">or</span> <span class="n">at</span> <span class="n">least</span> <span class="n">have</span> <span class="n">corrupt</span> <span class="n">data</span><span class="o">:</span>
	<span class="mi">1</span><span class="p">.</span> <span class="n">The</span> <span class="n">input</span> <span class="k">type</span> <span class="k">and</span> <span class="k">array</span> <span class="n">types</span> <span class="n">must</span> <span class="n">match</span>
	<span class="mi">2</span><span class="p">.</span> <span class="n">The</span> <span class="n">provided</span> <span class="n">element</span> <span class="n">count</span> <span class="n">must</span> <span class="n">be</span> <span class="n">accurate</span> <span class="k">and</span> <span class="n">match</span> <span class="n">both</span> <span class="n">arrays</span>
	<span class="mi">3</span><span class="p">.</span> <span class="n">The</span> <span class="n">provided</span> <span class="n">element</span> <span class="n">size</span> <span class="k">is</span> <span class="n">correct</span>
	
	<span class="n">As</span> <span class="n">this</span> <span class="k">function</span> <span class="k">block</span> <span class="n">as</span> <span class="n">no</span> <span class="n">way</span> <span class="k">of</span> <span class="n">checking</span> <span class="n">that</span> <span class="n">you</span> <span class="n">did</span> <span class="n">this</span> <span class="n">correctly</span><span class="p">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
	<span class="o">//</span> <span class="n">Whether</span> <span class="k">or</span> <span class="k">not</span> <span class="k">to</span> <span class="n">accumulate</span> <span class="k">on</span> <span class="n">this</span> <span class="n">cycle</span>
	<span class="n">bExecute</span><span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
	<span class="o">//</span> <span class="n">Address</span> <span class="k">of</span> <span class="n">the</span> <span class="n">value</span> <span class="k">to</span> <span class="n">accumulate</span>
	<span class="n">pInputAdr</span><span class="o">:</span> <span class="n">PVOID</span><span class="p">;</span>
	<span class="o">//</span> <span class="n">Size</span> <span class="k">of</span> <span class="n">the</span> <span class="n">accumulated</span> <span class="n">value</span>
	<span class="n">iInputSize</span><span class="o">:</span> <span class="n">UDINT</span><span class="p">;</span>
	<span class="o">//</span> <span class="n">Number</span> <span class="k">of</span> <span class="n">values</span> <span class="k">in</span> <span class="n">the</span> <span class="n">output</span> <span class="k">array</span>
	<span class="n">iElemCount</span><span class="o">:</span> <span class="n">UDINT</span><span class="p">;</span>
	<span class="o">//</span> <span class="n">Address</span> <span class="k">of</span> <span class="n">the</span> <span class="n">rolling</span> <span class="k">buffer</span> <span class="k">to</span> <span class="n">be</span> <span class="n">filled</span> <span class="n">every</span> <span class="n">cycle</span>
	<span class="n">pPartialAdr</span><span class="o">:</span> <span class="n">PVOID</span><span class="p">;</span>
	<span class="o">//</span> <span class="n">Address</span> <span class="k">of</span> <span class="n">the</span> <span class="n">output</span> <span class="k">buffer</span> <span class="k">to</span> <span class="n">be</span> <span class="n">filled</span> <span class="k">when</span> <span class="n">the</span> <span class="n">rolling</span> <span class="k">buffer</span> <span class="k">is</span> <span class="n">full</span>
	<span class="n">pOutputAdr</span><span class="o">:</span> <span class="n">PVOID</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
	<span class="o">//</span> <span class="n">Set</span> <span class="k">to</span> <span class="n">TRUE</span> <span class="k">on</span> <span class="n">the</span> <span class="n">cycle</span> <span class="n">that</span> <span class="n">we</span> <span class="n">copy</span> <span class="n">the</span> <span class="n">output</span> <span class="k">array</span>
	<span class="n">bNewArray</span><span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
	<span class="n">iArrayIndex</span><span class="o">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">bNewArray</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="k">IF</span> <span class="n">bExecute</span> <span class="k">THEN</span>
	<span class="n">MEMCPY</span><span class="p">(</span>
		<span class="n">destAddr</span> <span class="o">:=</span> <span class="n">pPartialAdr</span> <span class="o">+</span> <span class="n">iArrayIndex</span><span class="o">*</span><span class="n">iInputSize</span><span class="p">,</span>
		<span class="n">srcAddr</span> <span class="o">:=</span> <span class="n">pInputAdr</span><span class="p">,</span>
		<span class="n">n</span> <span class="o">:=</span> <span class="n">iInputSize</span><span class="p">);</span>
	<span class="n">iArrayIndex</span> <span class="o">:=</span> <span class="n">iArrayIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">IF</span> <span class="n">iArrayIndex</span> <span class="o">&gt;=</span> <span class="n">iElemCount</span> <span class="k">THEN</span>
		<span class="n">MEMCPY</span><span class="p">(</span>
			<span class="n">destAddr</span> <span class="o">:=</span> <span class="n">pOutputAdr</span><span class="p">,</span>
			<span class="n">srcAddr</span> <span class="o">:=</span> <span class="n">pPartialAdr</span><span class="p">,</span>
			<span class="n">n</span> <span class="o">:=</span> <span class="n">iElemCount</span><span class="o">*</span><span class="n">iInputSize</span><span class="p">);</span>
		<span class="n">iArrayIndex</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bNewArray</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-el6-com">
<h2>POU: FB_EL6_Com<a class="headerlink" href="#pou-fb-el6-com" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Hardware/FB_EL6_Com.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_EL6_Com
(*
	Communicate with a serial device connected to an EL6XXX
	2019-10-09 Zachary Lentz and Jackson Sheppard
	
	May contain assumptions about the device we wrote it for, potentially will need to be adjusted
*)
VAR_INPUT
	// Command to send to the serial device
	{attribute &#39;pytmc&#39; := &#39;
		pv: CMD
		io: io
	&#39;}
	sCmd: STRING;
	
	// Pulse this to TRUE and back to FALSE when it&#39;s time to send
	{attribute &#39;pytmc&#39; := &#39;
		pv: SEND
		io: io
	&#39;}
	bSend: BOOL;
	
	// Any static prefix to add before every sent message
	sSendPrefix: STRING;
	// Any static suffix to add after every sent message
	sSendSuffix: STRING;
	// Any static prefix to strip off of every recieved message
	sRecvPrefix: STRING;
	// Any static suffic to strip off of every recieved message
	sRecvSuffix: STRING;
	tTimeout: TIME := T#1S;
END_VAR
VAR_IN_OUT
	stIn_EL6: EL6inData22B;
	stOut_EL6: EL6outData22B;
END_VAR
VAR_OUTPUT
	// The response recieved from the serial device
	{attribute &#39;pytmc&#39; := &#39;
		pv: RESP
		io: input
	&#39;}
	sResponse: STRING;
	
	// This is set to TRUE after recieving a response
	{attribute &#39;pytmc&#39; := &#39;
		pv: DONE
		io: input
	&#39;}
	bDone: BOOL;
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: ERR:SER
		io: input
	&#39;}
	eSerialLineErrorID: ComError_t;
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: ERR:SEND
		io: input
	&#39;}
	eSendErrorID: ComError_t;
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: ERR:RECV
		io: input
	&#39;}
	eRecvErrorID: ComError_t;
END_VAR
VAR
	// Communication Buffers
	TxBuffer: ComBuffer;
	RxBuffer: ComBuffer;
	fbClearComBuffer: ClearComBuffer;
	
	// Parameters for PLC -&gt; EL6
	fbEL6Ctrl: SerialLineControl;
	bEL6CtrlError: BOOL;
	eEL6CtrlErrorID: ComError_t;
	
	// Parameters for EL6 -&gt; Serial Device
	fbSend: SendString;
	bSendBusy: BOOL;
	eLastSendErrorID: ComError_t;
	fbReceive: ReceiveString;
	sReceivedString: STRING;
	sLastReceivedString: STRING;
	bStringReceived: BOOL;
	bReceiveBusy: BOOL;
	bReceiveError: BOOL;
	eReceiveErrorID: ComError_t;
	bReceiveTimeout: BOOL;
	nReceiveCounter: UDINT;
	nSendCounter: UDINT;
	sStringToSend: STRING;
	fbFormatString: FB_FormatString;
	
	// Parameters for state-machine implementation
	nStep: INT := 0;
END_VAR
fbEL6Ctrl(
	Mode:= SERIALLINEMODE_EL6_22B, 
	pComIn:= ADR(stIn_EL6), 
	pComOut:= ADR(stOut_EL6), 
	SizeComIn:= UINT_TO_INT(SIZEOF(stIn_EL6)), 
	Error=&gt; , 
	ErrorID=&gt; eSerialLineErrorID, 
	TxBuffer:= TxBuffer, 
	RxBuffer:= RxBuffer );
IF fbEL6Ctrl.Error THEN
	bEL6CtrlError := TRUE;
	eEL6CtrlErrorID := fbEL6Ctrl.ErrorID;
END_IF
IF bSend THEN
	nStep := 10;
	bSend := FALSE;
	bDone := FALSE;
END_IF
// Attempt at solution that sends one command at a time, not on constant loop
CASE nStep OF
	0:
		; // idle
	10:
		// Clear buffers in case any lingering data
		fbClearComBuffer(Buffer:=TxBuffer);
		fbClearComBuffer(Buffer:=RxBuffer);
		// Prepare string to send
		sStringToSend := CONCAT(sSendPrefix, CONCAT(sCmd, sSendSuffix));
		// Send string
		fbSend(	SendString:= sStringToSend,
				TXbuffer:= TxBuffer,
				Busy=&gt; bSendBusy,
				Error=&gt; eSendErrorID);
		IF fbSend.Error &lt;&gt; COMERROR_NOERROR THEN
			eLastSendErrorID := fbSend.Error;
		ELSE
			nSendCounter := nSendCounter + 1;
		END_IF
		nStep := nStep + 10;
	20:
		// Finish sending String
		IF fbSend.Busy THEN
			fbSend(	SendString:= sStringToSend,
					TXbuffer:= TxBuffer,
					Busy=&gt; bSendBusy,
					Error=&gt; eSendErrorID);
			IF fbSend.Error &lt;&gt; COMERROR_NOERROR THEN
				eLastSendErrorID := fbSend.Error;
			ELSE
				nSendCounter := nSendCounter + 1;
			END_IF
		ELSE
			nStep := nStep + 10;
		END_IF
	30:
		// Get Reply
		fbReceive(
			Prefix:= sRecvPrefix,
			Suffix:= sRecvSuffix,
			Timeout:= tTimeout,
			ReceivedString:= sReceivedString,
			RXbuffer:= RxBuffer,
			StringReceived=&gt; bStringReceived,
			Busy=&gt; bReceiveBusy,
			Error=&gt; eRecvErrorID,
			RxTimeout=&gt; bReceiveTimeout );
		IF fbReceive.Error &lt;&gt; COMERROR_NOERROR THEN
			eReceiveErrorID := fbReceive.Error;
		END_IF
		IF bStringReceived THEN
			nReceiveCounter := nReceiveCounter + 1;
			// Check for response
			IF FIND(sReceivedString, sStringToSend)=0 THEN
				sResponse := sReceivedString;
				bDone := TRUE;
				nStep := 0;
			END_IF
		END_IF
END_CASE

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-ecatdiag">
<h2>POU: FB_EcatDiag<a class="headerlink" href="#pou-fb-ecatdiag" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Functions/FB_EcatDiag.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>(* 
Ecat bus diagnostic tool
2015-11-4 Alex Wallace
This function block checks the states of all slaves on the ecat bus network, 
it could be modified to export the states of the slaves on an individual basis,
but for now it sets the output boolean true if all slaves are OP and false otherwise.
To start the block provide a falling edge on the first pass boolean input.

2018-05-05 Margaret Ghaly
Function block has been modified to retrieve the Device State of the Ethercat Master.
It also exports the states and information of each individual configured Slave. 
And saves them in the array q_aEcConfSlaveInfo.
*)
FUNCTION_BLOCK FB_EcatDiag
VAR_INPUT
	{attribute &#39;naming&#39; := &#39;omit&#39;}
	I_AMSNetId AT %I* : AMSNETID; //Link to the AMSNETID name in the ethercat master info.
	i_xFirstPass: BOOL; //Hook to system first pass boolean for proper intialization (must be true for the first cycle of the PLC)
END_VAR
VAR_OUTPUT
	q_xAllSlaveStatesGood: BOOL; // Set to True if all Slaves are in OP State
	q_anTermStates: ARRAY[1..256] OF BYTE; //ECAT State of terminals in the bus
	q_xMasterStateGood:BOOL; // Set to True if the Master Device State is OP
	q_nMasterState: WORD; // The Device State of the Master
	q_sMasterState:STRING; //State of the ECAT master
	q_astEcConfSlaveInfo :  ARRAY[1..256] OF ST_EcDevice; //State of all ECAT slaves in the bus
	q_nSlaves: UINT; // the Number of the connected Slaves
END_VAR
VAR
	sNetId: T_AmsNetId; //NetId string
	astTermStates: ARRAY[1..256] OF ST_EcSlaveState; //ECAT Slave States Buffer
	astEcConfSlaveInfo: ARRAY[1..256] OF ST_EcSlaveConfigData; //ECAT Slave Configs Buffer
	fbGetAllSlaveStates: FB_EcGetAllSlaveStates; //Acquires the ECAT Slave States puts them into astTermStates 
	
	fbGetMasterState: FB_EcGetMasterState; //Acquires ECAT Master State
	fbGetConfSlaves: FB_EcGetConfSlaves; //Acquires the ECAT slave configuration of the bus (how many, what kind, etc)
	{attribute &#39;naming&#39; := &#39;omit&#39;} 
	ftReset: F_TRIG; //Reset trigger sensor
	{attribute &#39;naming&#39; := &#39;omit&#39;}
	ftMasterReset: F_TRIG; //Retrigger sensor for GetMasterState
	nIterator: INT; //Generic iterator placeholder
END_VAR
//Create the net ID string
sNetId := F_CreateAmsNetId(I_AMSNetId);

//Query the state of all terminals, collect in astTermStates
ftReset(CLK:=fbGetAllSlaveStates.bBusy OR i_xFirstPass);
fbGetAllSlaveStates.bExecute := ftReset.Q;
fbGetAllSlaveStates(sNetId:=sNetId, pStateBuf := ADR(astTermStates), cbBufLen:=SIZEOF(astTermStates));
//Keep checking...



//Cycle through each entry in the array and check if we have anyone not in OP and that the link state is good.
// If so, then set our global IO bad boolean.
IF fbGetAllSlaveStates.nSlaves &gt; 0 THEN
	q_xAllSlaveStatesGood := TRUE;
FOR nIterator := 1 TO (UINT_TO_INT(fbGetAllSlaveStates.nSlaves) ) BY 1
	DO
	IF NOT( (astTermStates[nIterator].deviceState = EC_DEVICE_STATE_OP) AND (astTermStates[nIterator].linkState = EC_LINK_STATE_OK)) THEN
		q_xAllSlaveStatesGood := FALSE;
	END_IF
	q_anTermStates[nIterator] := astTermStates[nIterator].deviceState;
	q_astEcConfSlaveInfo[nIterator].nDeviceState :=astTermStates[nIterator].deviceState;//
	q_astEcConfSlaveInfo[nIterator].nLinkState :=astTermStates[nIterator].linkState;//
	q_astEcConfSlaveInfo[nIterator].sDeviceState:= F_ConvSlaveStateToString(state:=astTermStates[nIterator]);//
	
END_FOR
END_IF

// Read the EtherCAT state of the master. If the call is successful, 
//the State output variable of type WORD contains the requested status information.
ftMasterReset(CLK:=fbGetMasterState.bBusy OR i_xFirstPass);
fbGetMasterState(sNetId:= sNetId, bExecute:=ftMasterReset.Q, 
				state =&gt; q_nMasterState,bError=&gt;,
				nErrId=&gt;);
q_xMasterStateGood:= (fbGetMasterState.state = BYTE_TO_UINT(EC_DEVICE_STATE_OP));
q_sMasterState := F_ConvMasterDevStateToString(fbGetMasterState.state);

//This function is used to read a list of all configured slaves from the EtherCat master object Directory
//needs to run only once
fbGetConfSlaves(bExecute := i_xFirstPass, sNetId :=sNetId, pArrEcConfSlaveInfo := ADR(astEcConfSlaveInfo),cbBufLen := SIZEOF(astEcConfSlaveInfo));
q_nSlaves:=fbGetConfSlaves.nSlaves;

IF  NOT (fbGetConfSlaves.bBusy) THEN
	FOR nIterator := 1 TO (UINT_TO_INT(fbGetConfSlaves.nSlaves) ) BY 1
	DO
	q_astEcConfSlaveInfo[nIterator].nAddrr :=astEcConfSlaveInfo[nIterator].nAddr;
	q_astEcConfSlaveInfo[nIterator].sName :=astEcConfSlaveInfo[nIterator].sName;
	q_astEcConfSlaveInfo[nIterator].sType :=astEcConfSlaveInfo[nIterator].sType;
END_FOR
	fbGetConfSlaves.bExecute := FALSE;
END_IF

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-ecatdiagwrapper">
<h2>POU: FB_EcatDiagWrapper<a class="headerlink" href="#pou-fb-ecatdiagwrapper" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Diagnostics/FB_EcatDiagWrapper.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_EcatDiagWrapper
VAR_INPUT
END_VAR
VAR_OUTPUT
    bAllFrameWcStatesOK		: BOOL;				// all frames are OK
    bEtherCATOK				: BOOL;				// no problem on EtherCAT
	bFrameWcStateError		: BOOL;				// at least one fram with error
	bSlaveCountError		: BOOL;				// EtherCAT slave count mismatch (# of cfg slaves &lt;&gt; # of found slaves)
	bMasterDevStateError	: BOOL;				// EtherCAT master device state signals error
	stMasterDevState		: ST_EcMasterDevState; // device state split to a structure
	bBusy					: BOOL;				// diagnostic FB is busy
	bError					: BOOL;				// diagnostic FB has an error
	iErrorID				: UDINT;			// error ID of diagnostic FB
END_VAR
VAR
    
    (* ******************* EtherCAT Frame ***************************** *)
	fbEtherCATFrameDiag		: FB_EtherCATFrameDiag; // frame diagnostic
    {attribute &#39;TcLinkTo&#39; := &#39;TIID^Device 1 (EtherCAT)^Inputs^Frm1WcState&#39;} 
	wFrmXWcState AT %I*		: WORD; 			// link to task related ethercat frame state (Frm1WcState)
	wReqZeroMask			: WORD := 16#FFFF; 	// clear bit to ignore datagram error of Frm1WcState
	bFrameWcStateOK			: BOOL;				// this frame is OK 

    (* ******************* EtherCAT Diag ***************************** *)
    fbEtherCATDiag			: FB_EtherCATDiag;	// deep EtherCAT diagnostic

	(* cyclic variables from EtherCAT Master *)
    {attribute &#39;TcLinkTo&#39; := &#39;TIID^Device 1 (EtherCAT)^Inputs^SlaveCount&#39;}
	nEcMasterSlaveCount AT %I* 	: UINT;			// link to SlaveCount of EtherCAT Master (Inputs)
    {attribute &#39;TcLinkTo&#39; := &#39;TIID^Device 1 (EtherCAT)^Inputs^DevState&#39;}
	nEcMasterDevState AT %I* 	: UINT;			// link to DevState of EtherCAT Master (Inputs)
    {attribute &#39;TcLinkTo&#39; := &#39;TIID^Device 1 (EtherCAT)^InfoData^DevId&#39;}
	nEcMasterDeviceId AT %I*	: UINT;			// link to DevID of EtherCAT Master (InfoData)
    {attribute &#39;TcLinkTo&#39; := &#39;TIID^Device 1 (EtherCAT)^InfoData^AmsNetId&#39;}
	arrEcMasterNetId AT %I* 	: T_AmsNetIdArr;// link to NetID of EtherCAT Master (InfoData)
	sEcMasterNetId  			: T_AmsNetId := &#39;&#39;;
    {attribute &#39;TcLinkTo&#39; := &#39;TIID^Device 1 (EtherCAT)^InfoData^CfgSlaveCount&#39;}
	nEcMasterSlaveCountCfg AT %I* 	: UINT;		// link to CfgSlaveCount of EtherCAT Master (InfoData)

	(* general variables *)
	arrDiagSlaveInfo 			: ARRAY [0..ESC_MAX_PORTS] OF ST_SlaveStateInfo;		// read in info of configured EtherCAT slaves 
	arrDiagSlaveInfoScanned		: ARRAY [0..ESC_MAX_PORTS] OF ST_SlaveStateInfoScanned; // read in info of scanned EtherCAT slaves  
END_VAR
(*************************************** Frame Diag *********************************************)
fbEtherCATFrameDiag(
	wFrmXWcState 	:= wFrmXWcState,
	wReqZeroMask 	:= wReqZeroMask,
	bFrameWcStateOK	=&gt; bFrameWcStateOK
);
bAllFrameWcStatesOK := bFrameWcStateOK;

(*************************************** EtherCAT Diag *********************************************)
(* generate Net Id *)
sEcMasterNetId := F_CreateAmsNetId(nIds := arrEcMasterNetId);
fbEtherCATDiag(
	sIPCNetID			:= &#39;&#39;,
	sMasterNetID		:= sEcMasterNetId,
	nMasterDevID		:= nEcMasterDeviceId,
	nSlaveCount			:= nEcMasterSlaveCount,
	nSlaveCountCfg		:= nEcMasterSlaveCountCfg,
	nMasterDevState		:= nEcMasterDevState,
	bAllFrameWcStatesOK	:= bAllFrameWcStatesOK,
	tTimeout			:= T#5s,
	arrDiagSlaveInfo	:= arrDiagSlaveInfo,
	arrDiagSlaveInfoScanned	:= arrDiagSlaveInfoScanned,
	bEtherCATOK			=&gt; bEtherCATOK,
	bFrameWcStateError	=&gt; bFrameWcStateError,
	bSlaveCountError	=&gt; bSlaveCountError,
	bMasterDevStateError=&gt; bMasterDevStateError,
	stMasterDevState	=&gt; stMasterDevState,
	bBusy				=&gt; bBusy,
	bError				=&gt; bError,
	iErrorID			=&gt; iErrorID
);

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-ethercatdiag">
<h2>POU: FB_EtherCATDiag<a class="headerlink" href="#pou-fb-ethercatdiag" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Diagnostics/FB_EtherCATDiag.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_EtherCATDiag
VAR_INPUT
	sIPCNetID					: T_AmsNetId; 	// AmsNetId of the IPC 
	sMasterNetID				: T_AmsNetId; 	// AmsNetId of the EtherCAT master device 
	nMasterDevID				: UINT;			// Device ID of EtherCAT master
	nSlaveCount 				: UINT;			// current slave count
	nSlaveCountCfg 				: UINT;			// configured slave count
	nMasterDevState				: WORD;			// device state of EtherCAT Master
	bAllFrameWcStatesOK			: BOOL;			// all FrameWcState OK?
	tTimeout					: TIME := T#5S; // ads timeout
    eSubSystem : E_Subsystem := E_Subsystem.FIELDBUS; // Subsystem, change to (MPS, VACUUM, MOTION, etc)
END_VAR
VAR_OUTPUT
	bEtherCATOK					: BOOL;			// no problem on EtherCAT
	bFrameWcStateError			: BOOL;			// error in at least one frame
	bSlaveCountError			: BOOL;			// EtherCAT slave count mismatch (# of cfg slaves &lt;&gt; # of found slaves)
	bMasterDevStateError		: BOOL;			// error in master device state
	stMasterDevState			: ST_EcMasterDevState; // splitted master device state
	bBusy						: BOOL;			// FB busy
	bError						: BOOL;			// FB with error
	iErrorID					: UDINT;		// FB error ID
END_VAR
VAR_IN_OUT
	arrDiagSlaveInfo 			: ARRAY [0..ESC_MAX_PORTS] OF ST_SlaveStateInfo;		// read in info from configured slaves
	arrDiagSlaveInfoScanned		: ARRAY [0..ESC_MAX_PORTS] OF ST_SlaveStateInfoScanned;	// read in info from scanned slaves
END_VAR
VAR
	iState						: E_EcatDiagState;
	nMasterDevStatePrev			: WORD;
	bSlaveCountErrorPrev		: BOOL;
	bAllFrameWcStatesOKPrev		: BOOL;
	bDiagReq					: BOOL := TRUE;
	I							: UDINT;
    P							: UDINT;
    
    arrSlaveInfo 				: ARRAY [0..iSLAVEADDR_ARR_SIZE] OF ST_SlaveStateInfo;
    rSlaveInfo  :   REFERENCE TO ST_SlaveStateInfo;

	(* -- Get Slave Addresses *)
	fbGetSlaveAddresses 		: FB_EcGetAllSlaveAddr;
	arrSlaveAddresses 			: ARRAY[0..iSLAVEADDR_ARR_SIZE] OF UINT;
	iNumOfSlavesRead			: UINT;

	(* -- Get Slave States *)
	fbGetAllSlaveStates			: FB_EcGetAllSlaveStates;
	arrSlaveStates 				: ARRAY[0..iSLAVEADDR_ARR_SIZE] OF ST_EcSlaveState;

	(* -- Get Topology Data *)
	iTopologyData				: UDINT;
	fbGetTopologyData			: ADSREAD;
	arrTopologyData				: ARRAY[0..iSLAVEADDR_ARR_SIZE] OF ST_TopologyData;

	(* -- Check Topology *)
	aiDiagIndex					: ARRAY [0..ESC_MAX_PORTS] OF UINT;
    iDiagIndex : UINT;    
	aiDiagPort					: ARRAY [0..ESC_MAX_PORTS] OF UINT;
    iDiagPort : UINT;
	iIdx						: DINT;

	(* -- Scan Slaves *)
	fbEcGetScannedSlaves		: FB_EcGetScannedSlaves;
	arrScannedSlaveInfo			: ARRAY [0..iSLAVEADDR_ARR_SIZE] OF ST_EcSlaveScannedData; // what...
    rScannedSlaveInfo   :   REFERENCE TO ST_EcSlaveScannedData;
	nScannedSlaves				: UINT;

	(* -- Get Slave Identities *)
	fbGetSlaveIdentity			: FB_EcGetSlaveIdentity;
	stIdentity 					: ST_EcSlaveIdentity;

	(* -- Get Slave Names *)
	fbGetSlaveName 				: IOF_GetBoxNameByAddr;
    arrSlaveInfoScanned			: ARRAY [0..iSLAVEADDR_ARR_SIZE] OF ST_SlaveStateInfoScanned; // the F
    rSlaveInfoScanned   :   REFERENCE TO ST_SlaveStateInfoScanned;
	strName						: STRING;

	
    
    // Logging components
    fbLogger : FB_LogMessage := (eSubsystem := eSubsystem);
    
    fbJson : FB_JsonSaxWriter;
    fbJsonDataType : FB_JsonReadWriteDataType;
    rDiagSlaveInfo : REFERENCE TO ST_SlaveStateInfo;
    aDiagJson : ARRAY [0..iSLAVEADDR_ARR_SIZE] OF T_MaxString;
    tEtherCATOK : F_TRIG;
    tFrameWcStateError : R_TRIG;
    tMasterError : R_TRIG;
    jsonIdx : UINT;
    test : T_MaxString;
END_VAR
(* cyclic diag *)
bFrameWcStateError := NOT bAllFrameWcStatesOK;

bSlaveCountError := (nSlaveCount &lt;&gt; nSlaveCountCfg) OR (nSlaveCount = 0);
IF (bSlaveCountError AND NOT bSlaveCountErrorPrev) OR (NOT bSlaveCountError AND bSlaveCountErrorPrev) THEN
	bSlaveCountErrorPrev := bSlaveCountError;
	bDiagReq := TRUE; // slave count error change detected --&gt; diag required
END_IF

IF (bAllFrameWcStatesOK AND NOT bAllFrameWcStatesOKPrev) OR (NOT bAllFrameWcStatesOK AND bAllFrameWcStatesOKPrev) THEN
	bAllFrameWcStatesOKPrev := bAllFrameWcStatesOK;
	bDiagReq := TRUE; // frame error change detected --&gt; diag required
END_IF

IF (nMasterDevState &lt;&gt; nMasterDevStatePrev) THEN
	M_CheckMasterDevState();
	bDiagReq := TRUE; // devstate change detected --&gt; diag required
END_IF

(* acyclic diag *)
CASE iState OF
E_EcatDiagState.Idle: (* IDLE *)
	IF bDiagReq THEN				// diag requested
		bDiagReq := FALSE;

		IF sMasterNetID &lt;&gt; &#39;&#39; AND sMasterNetID &lt;&gt; &#39;0.0.0.0.0.0&#39; THEN
			iState := E_EcatDiagState.GetSlaveAddresses;	// execute diag
			bBusy := TRUE;
		ELSE
			bError := TRUE;
			iErrorID := 7;
		END_IF

		bEtherCATOK := FALSE;
	ELSE
		// check for changes in idle
		IF (bSlaveCountError OR bMasterDevStateError OR NOT bAllFrameWcStatesOK) AND NOT (arrSlaveInfo[aiDiagIndex[0]].bDiagData) THEN
			bEtherCATOK := FALSE;
			bDiagReq := TRUE;//new error --&gt; diag requested    
		ELSIF (bSlaveCountError AND NOT bSlaveCountErrorPrev) OR (NOT bSlaveCountError AND bSlaveCountErrorPrev) THEN
			bSlaveCountErrorPrev := bSlaveCountError;
			bEtherCATOK := FALSE;
			bDiagReq := TRUE;// slave count error change detected --&gt; diag required
		ELSIF (nMasterDevState &lt;&gt; nMasterDevStatePrev) THEN
			bEtherCATOK := FALSE;
			bDiagReq := TRUE;// devstate change detected --&gt; diag required
		ELSIF (bAllFrameWcStatesOK AND NOT bAllFrameWcStatesOKPrev) OR (NOT bAllFrameWcStatesOK AND bAllFrameWcStatesOKPrev) THEN
			bAllFrameWcStatesOKPrev := bAllFrameWcStatesOK;
			bEtherCATOK := FALSE;
			bDiagReq := TRUE;// frame error change detected --&gt; diag required
		ELSIF (bSlaveCountError OR bMasterDevStateError OR NOT bAllFrameWcStatesOK OR arrSlaveInfo[aiDiagIndex[0]].bDiagData) THEN
			bEtherCATOK := FALSE;
		ELSE
			bEtherCATOK := TRUE;
		END_IF
	END_IF

E_EcatDiagState.GetSlaveAddresses: (* get adresses *)
	M_GetSlaveAdresses();

E_EcatDiagState.GetSlaveStates: (* get states *)
	M_GetSlaveStates();

E_EcatDiagState.GetTopoDataLen:	(* get topology data length *)
	M_GetTopoDataLen();

E_EcatDiagState.GetTopoData:	(* get topology data *)
	M_GetTopoData();

E_EcatDiagState.ScanSlaves:	(* scan slaves *)
	M_ScanSlaves();

E_EcatDiagState.GetSlaveIdentity:	(* get identity *)
	M_GetSlaveIdentity();

E_EcatDiagState.GetSlaveName:	(* get name *)
	M_GetSlaveName();

E_EcatDiagState.GetScannedSlaveName:	(* get scanned name *)
	M_GetScannedSlaveName();

E_EcatDiagState.LogDiagnostics: (* Log diagnostics *)
    (* I can&#39;t get the fbJsonDataType to actually convert the slave info 
    structures. I just get nulls. Either I am doing this wrong, or when 
    the symbol parser encounters datatypes it can&#39;t deal with it nulls
    the whole thing. I&#39;ll keep this code commented out until someone figures
    out how to deal with parsing the slave structs into the json payload *)
    
    IF jsonIdx &lt; iNumOfSlavesRead - 1 THEN
        jsonIdx := jsonIdx + 1;
        rDiagSlaveInfo REF= arrSlaveInfo[jsonIdx];
        DiagnosticJson();
        fbLogger(sMsg:=CONCAT(&#39;Diag Results: &#39;, rDiagSlaveInfo.sName), 
                eSevr:=TcEventSeverity.Info);
    ELSE
        jsonIdx := 0;
        iState := E_EcatDiagState.Done;    
	END_IF
        
    
E_EcatDiagState.Done:	(* DONE *)
	bBusy := FALSE;
	iState := 0;

END_CASE

// Log messages
tEtherCATOK(CLK:=bEtherCATOK);
IF tEtherCATOK.Q THEN
    fbLogger(sMsg:=&#39;EtherCAT failure, starting diagnostic&#39;, eSevr:=TcEventSeverity.Critical, sJson:=&#39;&#39;);
END_IF

tFrameWcStateError(CLK:=bFrameWcStateError);
IF tFrameWcStateError.Q THEN
    fbLogger(sMsg:=&#39;Working Counter Frame Error: error in at least one frame&#39;, eSevr:=TcEventSeverity.Error, sJson:=&#39;&#39;);
END_IF

tMasterError(CLK:=bMasterDevStateError);
IF tMasterError.Q THEN
    fbJson.StartObject();
    fbJson.AddKey(&#39;ecMstrDiag&#39;);
        fbJson.StartObject();
        fbJson.AddKey(&#39;ecat_master_bAtLeastOneNotInOp&#39;);
        fbJson.AddBool(stMasterDevState.bAtLeastOneNotInOp);
        fbJson.AddKey(&#39;ecat_master_bDcNotInSync&#39;);
        fbJson.AddBool(stMasterDevState.bDcNotInSync);
        fbJson.AddKey(&#39;ecat_master_bDriverNotFound&#39;);
        fbJson.AddBool(stMasterDevState.bDriverNotFound);
        fbJson.AddKey(&#39;ecat_master_bLinkError&#39;);
        fbJson.AddBool(stMasterDevState.bLinkError);
        fbJson.AddKey(&#39;ecat_master_bMissFrmRedMode&#39;);
        fbJson.AddBool(stMasterDevState.bMissFrmRedMode);
        fbJson.AddKey(&#39;ecat_master_bResetActive&#39;);
        fbJson.AddBool(stMasterDevState.bResetActive);
        fbJson.AddKey(&#39;ecat_master_bResetRequired&#39;);
        fbJson.AddBool(stMasterDevState.bResetRequired);
        fbJson.AddKey(&#39;ecat_master_bWatchdogTriggerd&#39;);
        fbJson.AddBool(stMasterDevState.bWatchdogTriggerd);
        fbJson.AddKey(&#39;ecat_master_eEcState&#39;);
        fbJson.AddUdint(stMasterDevState.eEcState);
        fbJson.EndObject();
    fbJson.EndObject();
    fbLogger(sMsg:=&#39;Master error&#39;, eSevr:=TcEventSeverity.Critical, sJson:=fbJson.GetDocument());
    fbJson.ResetDocument();
END_IF

END_FUNCTION_BLOCK
ACTION DiagnosticJson:
fbJson.StartObject();
    fbJson.AddKey(&#39;ecSlvDiag&#39;);
    fbJson.StartObject();    
    //    fbJson.AddKey(&#39;nIndex&#39;);
    //    fbJson.AddDint(rDiagSlaveInfo.nIndex);
        
    //    fbJson.AddKey(&#39;sName&#39;);
    //    fbJson.AddString(rDiagSlaveInfo.sName);
        
        fbJson.AddKey(&#39;Typ&#39;);
        fbJson.AddString(rDiagSlaveInfo.sType);
        
        fbJson.AddKey(&#39;Adr&#39;);
        fbJson.AddUdint(rDiagSlaveInfo.nECAddr);
        
    //    fbJson.AddKey(&#39;bDiagData&#39;);
    //    fbJson.AddBool(rDiagSlaveInfo.bDiagData);
        (*
        fbJson.AddKey(&#39;stPortCRCErrors&#39;);
        fbjson.StartObject();
        fbJson.AddKey(&#39;portA&#39;);
        fbJson.AddUdint(rDiagSlaveInfo.stPortCRCErrors.portA);
        fbJson.AddKey(&#39;portB&#39;);
        fbJson.AddUdint(rDiagSlaveInfo.stPortCRCErrors.portB);
        fbJson.AddKey(&#39;portC&#39;);
        fbJson.AddUdint(rDiagSlaveInfo.stPortCRCErrors.portC);
        fbJson.AddKey(&#39;portD&#39;);
        fbJson.AddUdint(rDiagSlaveInfo.stPortCRCErrors.portD);
        fbJson.EndObject();
    *)    
        fbJson.AddKey(&#39;SumCRCErr&#39;);
        fbjson.AddUdint(rDiagSlaveInfo.nSumCRCErrors);
        
        fbJson.AddKey(&#39;EcSt&#39;);
        fbJson.AddUdint(rDiagSlaveInfo.stState.eEcState);
    //        fbJson.AddKey(&#39;nReserved&#39;);
    //        fbJson.AddUdint(rDiagSlaveInfo.stState.nReserved);
        fbJson.AddKey(&#39;Err&#39;);
        fbJson.AddBool(rDiagSlaveInfo.stState.bError);
        fbJson.AddKey(&#39;InvldVPRS&#39;);
        fbJson.AddBool(rDiagSlaveInfo.stState.bInvalidVPRS);
    //        fbJson.AddKey(&#39;nReserved2&#39;);
    //        fbJson.AddUdint(rDiagSlaveInfo.stState.nReserved2);
        fbJson.AddKey(&#39;NoComm&#39;);
        fbJson.AddBool(rDiagSlaveInfo.stState.bNoCommToSlave);
        fbJson.AddKey(&#39;LnkErr&#39;);
        fbJson.AddBool(rDiagSlaveInfo.stState.bLinkError);
        fbJson.AddKey(&#39;MissLnk&#39;);
        fbJson.AddBool(rDiagSlaveInfo.stState.bMissingLink);
        fbJson.AddKey(&#39;UnexLnk&#39;);
        fbJson.AddBool(rDiagSlaveInfo.stState.bUnexpectedLink);
        fbJson.AddKey(&#39;A&#39;);
        fbJson.AddBool(rDiagSlaveInfo.stState.bPortA);
        fbJson.AddKey(&#39;B&#39;);
        fbJson.AddBool(rDiagSlaveInfo.stState.bPortB);
        fbJson.AddKey(&#39;C&#39;);
        fbJson.AddBool(rDiagSlaveInfo.stState.bPortC);
        fbJson.AddKey(&#39;D&#39;);
        fbJson.AddBool(rDiagSlaveInfo.stState.bPortD);
        
    fbJson.EndObject();
fbJson.EndObject();

fbJson.CopyDocument(fbLogger.sJson, SIZEOF(fbLogger.sJson));
fbJson.ResetDocument();
END_ACTION
ACTION M_CheckMasterDevState:
(* check master errors based on devstate *)
bMasterDevStateError 				:= nMasterDevState &lt;&gt; 0;
stMasterDevState.bLinkError 		:= ((nMasterDevState AND 16#000F) = 1) OR ((nMasterDevState AND 16#000F) = 4);
stMasterDevState.bResetRequired 	:= ((nMasterDevState AND 16#000F) = 2) OR ((nMasterDevState AND 16#FFF0) = 16#10);
stMasterDevState.bMissFrmRedMode 	:= (nMasterDevState AND 16#000F) = 8;
stMasterDevState.bWatchdogTriggerd 	:= (nMasterDevState AND 16#20) = 16#20;
stMasterDevState.bDriverNotFound 	:= (nMasterDevState AND 16#40) = 16#40;
stMasterDevState.bResetActive 		:= (nMasterDevState AND 16#80) = 16#80;
stMasterDevState.bAtLeastOneNotInOp := ((nMasterDevState AND 16#100) = 16#100) OR ((nMasterDevState AND 16#200) = 16#200) OR
										((nMasterDevState AND 16#400) = 16#400) OR ((nMasterDevState AND 16#800) = 16#800);
stMasterDevState.bDcNotInSync 		:= (nMasterDevState AND 16#1000) = 16#1000;
nMasterDevStatePrev 				:= nMasterDevState;
END_ACTION
ACTION M_GetScannedSlaveName:
rSlaveInfoScanned REF= arrSlaveInfoScanned[aiDiagIndex[iIdx]];
rScannedSlaveInfo REF= arrScannedSlaveInfo[aiDiagIndex[iIdx]];

fbGetSlaveName(
	NETID		:= sIPCNetId,
	DEVICEID	:= nMasterDevID,
	BOXADDR		:= rScannedSlaveInfo.nAddr,
	START		:= TRUE,
	TMOUT		:= tTimeout,
	BOXNAME		=&gt; strName
);

IF NOT fbGetSlaveName.BUSY THEN
	fbGetSlaveName(START:= FALSE);

	(* add scanned info *)
	rSlaveInfoScanned.nIndex 	:= iDiagIndex + 1;
	IF rScannedSlaveInfo.nAddr &lt;&gt; 0 THEN
		IF NOT fbGetSlaveName.ERR THEN
			rSlaveInfoScanned.sName := strName;
		END_IF
	ELSE
		rSlaveInfoScanned.sType		:= &#39;&#39;;
	END_IF

	IF (iDiagIndex &lt; nScannedSlaves) THEN
		rSlaveInfoScanned.sType		:= F_ConvProductCodeToString(rScannedSlaveInfo.stSlaveIdentity);
	ELSE
		rSlaveInfoScanned.sType		:= &#39;&#39;;
	END_IF

	rSlaveInfoScanned.nECAddr	:= rScannedSlaveInfo.nAddr;

	IF rSlaveInfoScanned.sName &lt;&gt; rSlaveInfo.sName THEN
		rSlaveInfoScanned.bDifferentName := TRUE;
	ELSE
		rSlaveInfoScanned.bDifferentName := FALSE;
	END_IF

	IF rSlaveInfoScanned.nECAddr &lt;&gt; rSlaveInfo.nECAddr THEN
		rSlaveInfoScanned.bDifferentAddr := TRUE;
	ELSE
		rSlaveInfoScanned.bDifferentAddr := FALSE;
	END_IF

	IF rSlaveInfoScanned.sType &lt;&gt; rSlaveInfo.sType THEN
		rSlaveInfoScanned.bDifferentType := TRUE;
	ELSE
		rSlaveInfoScanned.bDifferentType := FALSE;
	END_IF

	IF iIdx &lt; ESC_MAX_PORTS THEN
		iIdx := iIdx + 1;
		iState := E_EcatDiagState.GetSlaveIdentity; // loop back
	ELSE
		iIdx := 0;
		iState := E_EcatDiagState.LogDiagnostics;

		FOR I := 0 TO ESC_MAX_PORTS DO
			IF aiDiagPort[I] &lt;&gt; 0 THEN
				arrDiagSlaveInfo[I] := arrSlaveInfo[aiDiagIndex[I]];
				arrDiagSlaveInfoScanned[I] := arrSlaveInfoScanned[aiDiagIndex[I]];
			ELSE
				MEMSET(ADR(arrDiagSlaveInfo[I]), 0, SIZEOF(arrDiagSlaveInfo[I]));
				MEMSET(ADR(arrDiagSlaveInfoScanned[I]), 0, SIZEOF(arrDiagSlaveInfoScanned[I]));
			END_IF
		END_FOR
	END_IF
END_IF
END_ACTION
ACTION M_GetSlaveAdresses:
fbGetSlaveAddresses(
	sNetId		:= sMasterNetID,
	pAddrBuf	:= ADR(arrSlaveAddresses),
	cbBufLen	:= SIZEOF(arrSlaveAddresses),
	bExecute	:= TRUE,
	tTimeout	:= tTimeout,
	nSlaves		=&gt; iNumOfSlavesRead
);

IF NOT fbGetSlaveAddresses.bBusy THEN
	fbGetSlaveAddresses(bExecute:= FALSE);
	IF NOT fbGetSlaveAddresses.bError THEN
		FOR I := 0 TO MIN(iNumOfSlavesRead, iSLAVEADDR_ARR_SIZE) DO
			arrSlaveInfo[I].nECAddr := arrSlaveAddresses[I];
		END_FOR
	END_IF
	iState := GetSlaveStates;
END_IF
END_ACTION
ACTION M_GetSlaveIdentity:
iDiagIndex := aiDiagIndex[iIdx];
iDiagPort := aiDiagPort[iIdx];

rSlaveInfo REF= arrSlaveInfo[iDiagIndex];

fbGetSlaveIdentity(
	sNetId		:= sMasterNetID,
	nSlaveAddr	:= rSlaveInfo.nECAddr,
	bExecute	:= TRUE,
	tTimeout	:= tTimeout,
	identity	=&gt; stIdentity
);

IF NOT fbGetSlaveIdentity.bBusy THEN
	fbGetSlaveIdentity(bExecute:= FALSE);

	IF NOT fbGetSlaveIdentity.bError THEN
		IF aiDiagPort[iIdx] &lt;&gt; 0 THEN
			rSlaveInfo.nIndex	:= aiDiagIndex[iIdx] + 1;
			rSlaveInfo.sType 	:= F_ConvProductCodeToString(stSlaveIdentity := stIdentity);
		END_IF
	END_IF
	iState := E_EcatDiagState.GetSlaveName;
END_IF
END_ACTION
ACTION M_GetSlaveName:
fbGetSlaveName(
	NETID		:= sIPCNetId,
	DEVICEID	:= nMasterDevID,
	BOXADDR		:= rSlaveInfo.nECAddr,
	START		:= TRUE,
	TMOUT		:= tTimeout,
	BOXNAME		=&gt; strName
);

IF NOT fbGetSlaveName.BUSY THEN
	fbGetSlaveName(START:= FALSE);

	IF NOT fbGetSlaveName.ERR THEN
		IF iDiagPort &lt;&gt; 0 THEN
			rSlaveInfo.sName 	:= strName;
		END_IF
	END_IF

	iState := E_EcatDiagState.GetScannedSlaveName;
END_IF
END_ACTION
ACTION M_GetSlaveStates:
fbGetAllSlaveStates(
	sNetId		:= sMasterNetID,
	pStateBuf	:= ADR(arrSlaveStates),
	cbBufLen	:= SIZEOF(arrSlaveStates),
	bExecute	:= TRUE,
	tTimeout	:= tTimeout,
	nSlaves		=&gt; iNumOfSlavesRead
);

IF NOT fbGetAllSlaveStates.bBusy THEN
	fbGetAllSlaveStates(bExecute:= FALSE);

	IF NOT fbGetAllSlaveStates.bError THEN
		IF iNumOfSlavesRead = nSlaveCountCfg THEN
			FOR I := 0 TO ESC_MAX_PORTS DO
				aiDiagIndex[I] := 0;
			END_FOR

			(* split slave state and link state *)
			FOR I := 0 TO MIN(iNumOfSlavesRead, iSLAVEADDR_ARR_SIZE) DO
				(* slave state*)
				arrSlaveInfo[I].stState.eEcState 		:= arrSlaveStates[I].deviceState AND 16#0F;
				arrSlaveInfo[I].stState.bError 			:= arrSlaveStates[I].deviceState.4;
				arrSlaveInfo[I].stState.bInvalidVPRS 	:= arrSlaveStates[I].deviceState.5;
				(* link state *)
				arrSlaveInfo[I].stState.bNoCommToSlave 	:= arrSlaveStates[I].linkState.0;
				arrSlaveInfo[I].stState.bLinkError 		:= arrSlaveStates[I].linkState.1;
				arrSlaveInfo[I].stState.bMissingLink 	:= arrSlaveStates[I].linkState.2;
				arrSlaveInfo[I].stState.bUnexpectedLink := arrSlaveStates[I].linkState.3;
				arrSlaveInfo[I].stState.bPortA 			:= arrSlaveStates[I].linkState.4;
				arrSlaveInfo[I].stState.bPortB 			:= arrSlaveStates[I].linkState.5;
				arrSlaveInfo[I].stState.bPortC 			:= arrSlaveStates[I].linkState.6;
				arrSlaveInfo[I].stState.bPortD 			:= arrSlaveStates[I].linkState.7;
				(* DiagData *)
				arrSlaveInfo[I].bDiagData	:= ((arrSlaveStates[I].deviceState AND 16#F0) &lt;&gt; 0) OR
					(((arrSlaveStates[I].deviceState AND 16#0F) &gt; 0) AND ((arrSlaveStates[I].deviceState AND 16#0F) &lt; 8)) OR
					(arrSlaveStates[I].linkState &lt;&gt; 0);

				IF arrSlaveInfo[I].bDiagData THEN
					IF (I=0) THEN
						aiDiagIndex[0] := 0;
					ELSE
						IF (aiDiagIndex[0] = 0) AND NOT arrSlaveInfo[0].bDiagData THEN
							aiDiagIndex[0] :=  UDINT_TO_UINT(I);
						END_IF
					END_IF
				END_IF
			END_FOR
		END_IF
	END_IF

	IF arrSlaveInfo[aiDiagIndex[0]].bDiagData THEN
		iState := E_EcatDiagState.GetTopoDataLen;
	ELSE
		FOR I := 0 TO ESC_MAX_PORTS DO
			MEMSET(ADR(arrDiagSlaveInfo[I]), 0, SIZEOF(arrDiagSlaveInfo[I]));
			MEMSET(ADR(arrDiagSlaveInfoScanned[I]), 0, SIZEOF(arrDiagSlaveInfoScanned[I]));
		END_FOR
		iState := E_EcatDiagState.Done;
	END_IF
END_IF
END_ACTION
ACTION M_GetTopoData:
fbGetTopologyData(
	NETID	:= sMasterNetID,
	PORT	:= 16#FFFF,
	IDXGRP	:= 16#22,
	IDXOFFS	:= 0,
	LEN		:= iTopologyData*SIZEOF(arrTopologyData[0]),
	DESTADDR:= ADR(arrTopologyData),
	READ	:= TRUE,
	TMOUT	:= tTimeout,
);

IF NOT fbGetTopologyData.BUSY THEN
	fbGetTopologyData(READ := FALSE);

	IF NOT fbGetTopologyData.ERR THEN
		aiDiagPort[0] := arrTopologyData[aiDiagIndex[0]].iOwnPhysicalAddr;
		aiDiagPort[1] := arrTopologyData[aiDiagIndex[0]].stPhysicalAddr.portB;
		aiDiagPort[2] := arrTopologyData[aiDiagIndex[0]].stPhysicalAddr.portC;
		aiDiagPort[ESC_MAX_PORTS] := arrTopologyData[aiDiagIndex[0]].stPhysicalAddr.portD;

		(* clear diag index  *)
		aiDiagIndex[1] := 0;
		aiDiagIndex[2] := 0;
		aiDiagIndex[ESC_MAX_PORTS] := 0;
        
        (* find slaves on PortB-D of first slave with diag *)
        FOR P := 0 TO ESC_MAX_PORTS DO
            IF aiDiagPort[P] &lt;&gt; 0 THEN
			FOR I := 0 TO MIN(iTopologyData-1,iSLAVEADDR_ARR_SIZE) DO
				IF arrTopologyData[I].iOwnPhysicalAddr = aiDiagPort[P] THEN
					aiDiagIndex[P] := UDINT_TO_UINT(I);
					EXIT;
				END_IF
			END_FOR
		END_IF
		END_FOR
    END_IF

	iIdx := 0;
	iState := E_EcatDiagState.ScanSlaves;
END_IF
END_ACTION
ACTION M_GetTopoDataLen:
fbGetTopologyData(
	NETID	:= sMasterNetID,
	PORT	:= 16#FFFF,
	IDXGRP	:= EC_ADS_IGRP_MASTER_COUNT_SLAVE,
	IDXOFFS	:= EC_ADS_IOFFS_MASTER_COUNT_SLAVE,
	LEN		:= SIZEOF(iTopologyData),
	DESTADDR:= ADR(iTopologyData),
	READ	:= TRUE,
	TMOUT	:= tTimeout,
);

IF NOT fbGetTopologyData.BUSY THEN
	fbGetTopologyData(READ := FALSE);

	iState := E_EcatDiagState.GetTopoData;
END_IF
END_ACTION
ACTION M_ScanSlaves:
fbEcGetScannedSlaves(
	bExecute				:= TRUE,
	sNetId					:= sMasterNetID,
	pArrEcScannedSlaveInfo	:= ADR(arrScannedSlaveInfo),
	cbBufLen				:= SIZEOF(arrScannedSlaveInfo),
	tTimeout				:= tTimeout
);

IF NOT fbEcGetScannedSlaves.bBusy THEN
	fbEcGetScannedSlaves(bExecute := FALSE);
	
	IF fbEcGetScannedSlaves.bError THEN
		nScannedSlaves := 0;
	ELSE
		nScannedSlaves := fbEcGetScannedSlaves.nSlaves;
	END_IF
    
    iState := E_EcatDiagState.GetSlaveIdentity;
    
END_IF
END_ACTION
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-ethercatframediag">
<h2>POU: FB_EtherCATFrameDiag<a class="headerlink" href="#pou-fb-ethercatframediag" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Diagnostics/FB_EtherCATFrameDiag.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_EtherCATFrameDiag</span>
<span class="n">VAR_INPUT</span>
	<span class="n">wFrmXWcState</span> 		<span class="o">:</span> <span class="n">WORD</span><span class="p">;</span>				<span class="o">//</span> <span class="n">FrmXWcState</span>
	<span class="n">wReqZeroMask</span> 		<span class="o">:</span> <span class="n">WORD</span> <span class="o">:=</span> <span class="mi">16#FFFF</span><span class="p">;</span>	<span class="o">//</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">bit</span> <span class="n">TRUE</span><span class="o">:</span> <span class="n">require</span> <span class="n">wFrmXWcState</span><span class="p">.</span><span class="kt">bit</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="kt">bit</span> <span class="n">FALSE</span><span class="o">:</span> <span class="n">ignore</span> <span class="n">wFrmXWcState</span><span class="p">.</span><span class="kt">bit</span> <span class="o">*</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
	<span class="n">bFrameWcStateOK</span>		<span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>				<span class="o">//</span> <span class="n">result</span> <span class="k">of</span> <span class="n">fram</span> <span class="n">state</span> <span class="n">check</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">mask</span> <span class="k">out</span> <span class="n">ignored</span> <span class="n">error</span> <span class="n">bits</span> <span class="k">and</span> <span class="n">compare</span> <span class="n">result</span> <span class="n">against</span> <span class="mi">0</span> <span class="o">*</span><span class="p">)</span>
<span class="n">bFrameWcStateOK</span> <span class="o">:=</span> <span class="p">((</span><span class="n">wFrmXWcState</span> <span class="k">AND</span> <span class="n">wReqZeroMask</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-index">
<h2>POU: FB_Index<a class="headerlink" href="#pou-fb-index" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Functions/FB_Index.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>(* Index FB
A. Wallace 2016-9-3

Why doesn&#39;t beckhoff have this as a builtin type?

Use this thing to have a simple indexer with rollover.

*)
FUNCTION_BLOCK FB_Index
VAR_INPUT
	{attribute &#39;naming&#39; := &#39;off&#39;}
	LowerLimit : INT := 1; //Incrementer will rollver over to this value (and initialize to this value)
	ValInc : INT := 1; //Incrementer increments by this value
	UpperLimit	:	INT := 1; //Incrementer will rollover at this value to lower limit
	{attribute &#39;naming&#39; := &#39;off&#39;}
END_VAR
VAR_OUTPUT
	
END_VAR
VAR
	nVal	:	INT := LowerLimit; //Internal incrementer value, initialized to LowerLimit
END_VAR
{analysis -2} //Only the methods and actions are needed

END_FUNCTION_BLOCK
ACTION Dec:
nVal := nVal - ValInc;
IF nVal &lt; LowerLimit THEN nVal := UpperLimit; END_IF
END_ACTION
ACTION Inc:
// Dont use this, use ValInc
nVal := nVal + ValInc;
IF nVal &gt;  UpperLimit THEN nVal := LowerLimit; END_IF
END_ACTION
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-lrealbuffer">
<h2>POU: FB_LREALBuffer<a class="headerlink" href="#pou-fb-lrealbuffer" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Data/FB_LREALBuffer.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_LREALBuffer</span>
<span class="p">(</span><span class="o">*</span>
	<span class="n">An</span> <span class="n">example</span> <span class="k">use</span> <span class="nn">of</span> <span class="n">FB_DataBuffer</span> <span class="k">for</span> <span class="n">the</span> <span class="n">likely</span> <span class="n">most</span><span class="o">-</span><span class="n">common</span> <span class="k">use</span> <span class="nn">case.</span>
	<span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">09</span> <span class="n">Zachary</span> <span class="n">Lentz</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
	<span class="o">//</span> <span class="k">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span><span class="na">&#39;ll</span> <span class="n">accumulate</span> <span class="n">a</span> <span class="n">value</span> <span class="k">on</span> <span class="n">this</span> <span class="n">cycle</span><span class="p">.</span>
	<span class="n">bExecute</span><span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
	<span class="o">//</span> <span class="n">The</span> <span class="n">value</span> <span class="k">to</span> <span class="n">accumulate</span><span class="p">.</span>
	<span class="n">fInput</span><span class="o">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
	<span class="n">arrOutput</span><span class="o">:</span> <span class="k">ARRAY</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="mi">1000</span><span class="p">]</span> <span class="k">OF</span> <span class="n">LREAL</span><span class="p">;</span>
	<span class="n">bNewArray</span><span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
	<span class="n">arrPartial</span><span class="o">:</span> <span class="k">ARRAY</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="mi">1000</span><span class="p">]</span> <span class="k">OF</span> <span class="n">LREAL</span><span class="p">;</span>
	<span class="n">fbDataBuffer</span><span class="o">:</span> <span class="n">FB_DataBuffer</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbDataBuffer</span><span class="p">(</span>
	<span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bExecute</span><span class="p">,</span>
	<span class="n">pInputAdr</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fInput</span><span class="p">),</span>
	<span class="n">iInputSize</span> <span class="o">:=</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">fInput</span><span class="p">),</span>
	<span class="n">iElemCount</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">,</span>
	<span class="n">pPartialAdr</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">arrPartial</span><span class="p">),</span>
	<span class="n">pOutputAdr</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">arrOutput</span><span class="p">),</span>
	<span class="n">bNewArray</span> <span class="o">=&gt;</span> <span class="n">bNewArray</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-lrealfromepics">
<h2>POU: FB_LREALFromEPICS<a class="headerlink" href="#pou-fb-lrealfromepics" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Data/FB_LREALFromEPICS.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>(*
Function block to link an analog value from EPICS to an LREAL on the PLC

Usage:

	{attribute &#39;pytmc&#39; := &#39;
		pv: INTERNAL:RECORD
		link: PV:NAME:TO:LINK:TO
	&#39;}
	fbLinkedValue1 : FB_LREALFromEPICS;
	
Such that when PV:NAME:TO:LINK:TO changes in EPICS, the INTERNAL:RECORD will be used to
push a value through to the PLC with this function block. 

As this block takes care of IOC heartbeat signals and monitors the link and value severity,
the end-user should then only have to look at `.bValid` and `.fValue`. These are guaranteed to
be up-to-date and valid within `tTimeout` seconds.
*)

FUNCTION_BLOCK FB_LREALFromEPICS

VAR_OUTPUT
	bValid				: BOOL;
	fValue				: LREAL;
END_VAR

VAR
	iValueInvalidate	: POINTER TO ULINT;
	tonValueTimeout		: TON;
	tonSeverityTimeout	: TON;
	
	fLastValidValue 	: LREAL;
	iLastValidSeverity 	: INT;
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: EPICSLink
		link:
		field: DESC Internal variable used to monitor EPICS PV in PLC
	&#39;}
	fPLCInternalValue : LREAL;

	// Use special link syntax for now to get EPICSLink.SEVR here:
	{attribute &#39;pytmc&#39; := &#39;
		pv: EPICSLink:LinkSeverity
		link: *EPICSLink.SEVR
		field: DESC Internal variable used to monitor EPICS PV severity in PLC
	&#39;}
	iPLCInternalSeverity : INT;

END_VAR
VAR CONSTANT
	tTimeout			: TIME := T#2S;
	NAN_VALUE   		: ULINT := 16#7f_ff_ff_ff__ff_ff_ff_ff;
END_VAR
iValueInvalidate := ADR(fPLCInternalValue);

IF iPLCInternalSeverity &lt;&gt; -1 THEN
	// New severity value
	iLastValidSeverity := iPLCInternalSeverity;
	iPLCInternalSeverity := -1;
	
 	// Reset the timer
	tonSeverityTimeout(IN:=FALSE);
	tonSeverityTimeout(IN:=TRUE, PT:=tTimeout);
END_IF

IF iValueInvalidate^ &lt;&gt; NAN_VALUE THEN
	// New value from EPICS
	fLastValidValue 	:= fPLCInternalValue;
	iValueInvalidate^	:= NAN_VALUE;
	
	// Reset the timer
	tonValueTimeout(IN:=FALSE);
	tonValueTimeout(IN:=TRUE, PT:=tTimeout);
END_IF

tonValueTimeout();
tonSeverityTimeout();
bValid := (NOT tonValueTimeout.Q) AND 
		  (NOT tonSeverityTimeout.Q) AND 
		  (iLastValidSeverity = 0);
fValue := fLastValidValue;

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-listener">
<h2>POU: FB_Listener<a class="headerlink" href="#pou-fb-listener" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Logger/FB_Listener.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_Listener EXTENDS FB_ListenerBase
VAR_INPUT
END_VAR

VAR_OUTPUT
END_VAR

VAR
	nEventIdx			:	UINT := 0;
	nPendingEvents		:	UINT := 0;
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: LogToVisualStudio
		io: io
	&#39;}
	bLogToVisualStudio	:	BOOL := FALSE;
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: MessagesSent
		io: i
	&#39;}
	nCntMessagesSent 	: UDINT := 0;

	{attribute &#39;pytmc&#39; := &#39;
		pv: AlarmsRaised
		io: i
	&#39;}
	nCntAlarmsRaised 	: UDINT := 0;
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: AlarmsConfirmed
		io: i
	&#39;}
	nCntAlarmsConfirmed : UDINT := 0;
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: AlarmsCleared
		io: i
	&#39;}
	nCntAlarmsCleared 	: UDINT := 0;
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: MinSeverity
		io: io
	&#39;}
	eMinSeverity	 	: TcEventSeverity;

	{attribute &#39;pytmc&#39; := &#39;
		pv: Log
	&#39;}
	stEventInfo 		:	REFERENCE TO ST_LoggingEventInfo;

	stPendingEvents		:	ARRAY [0..nMaxEvents - 1] OF ST_PendingEvent;
	ipMessageConfig		:	ITcEventFilterConfig;
	fbSocket			:	POINTER TO FB_ConnectionlessSocket;
	bConfigured			:	BOOL	:= FALSE;
END_VAR

VAR_IN_OUT
	
END_VAR

VAR CONSTANT
	// The maximum number of events allowed *per-cycle*
	nMaxEvents			:	UINT := 10;
END_VAR


END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-loghandler">
<h2>POU: FB_LogHandler<a class="headerlink" href="#pou-fb-loghandler" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Logger/FB_LogHandler.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_LogHandler
VAR_INPUT
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: ADS
	&#39;}
	fbTcAdsListener : FB_Listener;	
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: Router
	&#39;}
	fbTcRouterListener : FB_Listener;
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: RTime
	&#39;}
	fbTcRTimeListener : FB_Listener;	
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: System
	&#39;}
	fbTcSystemListener : FB_Listener;
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: Windows
	&#39;}
	fbWindowsListener : FB_Listener;	

	{attribute &#39;pytmc&#39; := &#39;
		pv: LCLS
	&#39;}
	fbLCLSListener 	: FB_Listener;	

END_VAR
VAR_OUTPUT
END_VAR

VAR
	
	bInitialized	:	BOOL	:= FALSE;
	bReadyToLog		: 	BOOL	:= FALSE;
	rtFirstLog		: 	R_TRIG;
	
	fbGetHostName		:	FB_GetHostName := (bExecute := TRUE, sNetID := &#39;&#39;); //Acquires name of the PLC
    fbGetAdapterIP : FB_GetAdaptersInfo := (bExecute := TRUE, sNetID := &#39;&#39;); // Acquire IP of the correct adapter
	bHostnameSet	:	BOOL	:= FALSE;
    idxPortFind : UDINT;

	fbListener		:	REFERENCE TO FB_Listener;
	fbListeners		: 	ARRAY [0..nNumListeners - 1] OF POINTER TO FB_Listener;
	
	// Default minimum severity for subscriptions
	eMinSeverity	:	TcEventSeverity := TcEventSeverity.Verbose;	
	
	{attribute &#39;naming&#39; := &#39;omit&#39;}
	rtReset				:	R_TRIG; //Reset trigger
	bReset				:	BOOL;
		
	fbSocket	   		:	FB_ConnectionlessSocket;
	
	nI					:	UINT;
    
    SocketEnable : BOOL;
    
    bAdapterSet : BOOL;
    
    ctuSocketError : CTU := (PV:=3); // Circuit breaker for socket errors. 3 errors before it stops.
    
    tRetryConnection : TON := (PT:=T#1h); // Retry after an hour
END_VAR

VAR CONSTANT
	nNumListeners		:	UINT	:= 6;
END_VAR
IF NOT bInitialized THEN 
	bInitialized := TRUE;
	fbTcAdsListener.Configure(i_EventClass:=TC_EVENT_CLASSES.TcGeneralAdsEventClass, i_MinSeverity:=eMinSeverity, i_fbSocket:=ADR(fbSocket));
	fbTcRouterListener.Configure(i_EventClass:=TC_EVENT_CLASSES.TcRouterEventClass, i_MinSeverity:=eMinSeverity, i_fbSocket:=ADR(fbSocket));
	fbTcRTimeListener.Configure(i_EventClass:=TC_EVENT_CLASSES.TcRTimeEventClass, i_MinSeverity:=eMinSeverity, i_fbSocket:=ADR(fbSocket));
	fbTcSystemListener.Configure(i_EventClass:=TC_EVENT_CLASSES.TcSystemEventClass, i_MinSeverity:=eMinSeverity, i_fbSocket:=ADR(fbSocket));
	fbWindowsListener.Configure(i_EventClass:=TC_EVENT_CLASSES.Win32EventClass, i_MinSeverity:=eMinSeverity, i_fbSocket:=ADR(fbSocket));
	fbLCLSListener.Configure(i_EventClass:=TC_EVENT_CLASSES.LCLSGeneralEventClass, i_MinSeverity:=eMinSeverity, i_fbSocket:=ADR(fbSocket));

	fbListeners[0] := ADR(fbTcAdsListener);
	fbListeners[1] := ADR(fbTcRouterListener);
	fbListeners[2] := ADR(fbTcRTimeListener);
	fbListeners[3] := ADR(fbTcSystemListener);
	fbListeners[4] := ADR(fbWindowsListener);
	fbListeners[5] := ADR(fbLCLSListener);
    
END_IF 
	
IF NOT bHostnameSet THEN
	fbGetHostName();
	IF NOT (fbGetHostName.bBusy OR fbGetHostName.bError) THEN
		GVL_Logger.sPlcHostname := fbGetHostName.sHostName;
		bHostnameSet 			:= TRUE;
	END_IF
END_IF

IF NOT bAdapterSet THEN
    fbGetAdapterIP();
    IF NOT (fbGetAdapterIP.bBusy or fbGetAdapterIP.bError) THEN
        FOR idxPortFind := 0 TO MAX_LOCAL_ADAPTERS DO
            IF FIND(fbGetAdapterIP.arrAdapters[idxPortFind].sIpAddr,
               GVL_Logger.sIpTidbit) &lt;&gt; 0 THEN
                fbSocket.sLocalHost := fbGetAdapterIP.arrAdapters[idxPortFind].sIpAddr;
                SocketEnable := TRUE;
                bAdapterSet := TRUE;
                EXIT;
            END_IF
        END_FOR
    END_IF
END_IF

(* Ensure the socket is ready for when JSON documents are emitted *)
rtReset(CLK:=bReset);

IF (rtReset.Q AND fbSocket.bEnable) THEN
	fbSocket(bEnable:=FALSE);
END_IF

// Disable fbSocket if too many errors occur
ctuSocketError(CU:=fbSocket.bError, RESET:=tRetryConnection.Q OR rtReset.Q);
SocketEnable R= ctuSocketError.Q;
// Retry an hour later
tRetryConnection(IN:=ctuSocketError.Q);
SocketEnable S= tRetryConnection.Q OR rtReset.Q;

fbSocket(
	nLocalPort:=0,
	bEnable:=SocketEnable,
	nMode:=CONNECT_MODE_ENABLEDBG,
);

bReadyToLog := (bAdapterSet AND bHostnameSet AND bInitialized AND 
                fbSocket.bEnable AND NOT fbSocket.bError);
rtFirstLog(CLK:=bReadyToLog);

IF rtFirstLog.Q THEN
    fbRootLogger(sMsg:=&#39;Logging system online&#39;, eSevr:=TcEventSeverity.Info,
                 eSubsystem:=E_Subsystem.NILVALUE);
END_IF

(* Poke all of the listeners *)
FOR nI := 0 TO nNumListeners - 1 DO
	fbListener REF= fbListeners[nI]^;
	fbListener.Execute();
	fbListener.PublishEvents();
END_FOR

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-logmessage">
<h2>POU: FB_LogMessage<a class="headerlink" href="#pou-fb-logmessage" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Logger/FB_LogMessage.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>{attribute &#39;reflection&#39;}
FUNCTION_BLOCK FB_LogMessage
VAR_INPUT
	sMsg			: T_MaxString; 					// Message to send
	eSevr			: TcEventSeverity	:= TcEventSeverity.Verbose;
	eSubsystem		: E_Subsystem; 					// Subsystem
	sJson			: T_MaxString	:= &#39;{}&#39;;		// JSON to add to the message
END_VAR

VAR_OUTPUT
END_VAR

VAR
	bInitialized		:	BOOL := FALSE;
	bInitFailed			:	BOOL := FALSE;
	sSubsystemSource	:	STRING;
	fbMessage			:	REFERENCE TO FB_TcMessage;
	fbMessages 			:	ARRAY [0..4] OF FB_TcMessage;
	fbSource 			:	FB_TcSourceInfo;
	ipResultMessage	 	:	I_TcMessage;
	hr 					:	HRESULT;
	hrLastInternalError :	HRESULT;
	eTraceLevel 		:	TcEventSeverity := TcEventSeverity.Verbose;
	
	{attribute &#39;instance-path&#39;} 
    {attribute &#39;noinit&#39;} 
	sPath				:	T_MaxString;
END_VAR
IF NOT bInitialized AND NOT bInitFailed THEN
	hr := fbMessages[TC_EVENTS.LCLSGeneralEventClass.Verbose.nEventId].CreateEx(TC_EVENTS.LCLSGeneralEventClass.Verbose, 0 (*fbSource*) );
	IF FAILED(hr) THEN
		bInitFailed := TRUE;
		hrLastInternalError := hr;
	END_IF

	hr := fbMessages[TC_EVENTS.LCLSGeneralEventClass.Warning.nEventId].CreateEx(TC_EVENTS.LCLSGeneralEventClass.Warning, 0 (*fbSource*) );
	IF FAILED(hr) THEN
		bInitFailed := TRUE;
		hrLastInternalError := hr;
	END_IF

	hr := fbMessages[TC_EVENTS.LCLSGeneralEventClass.Info.nEventId].CreateEx(TC_EVENTS.LCLSGeneralEventClass.Info, 0 (*fbSource*) );
	IF FAILED(hr) THEN
		bInitFailed := TRUE;
		hrLastInternalError := hr;
	END_IF

	hr := fbMessages[TC_EVENTS.LCLSGeneralEventClass.Error.nEventId].CreateEx(TC_EVENTS.LCLSGeneralEventClass.Error, 0 (*fbSource*) );
	IF FAILED(hr) THEN
		bInitFailed := TRUE;
		hrLastInternalError := hr;
	END_IF

	hr := fbMessages[TC_EVENTS.LCLSGeneralEventClass.Critical.nEventId].CreateEx(TC_EVENTS.LCLSGeneralEventClass.Critical, 0 (*fbSource*) );
	IF FAILED(hr) THEN
		bInitFailed := TRUE;
		hrLastInternalError := hr;
	END_IF
	
	IF bInitFailed THEN
		ADSLOGSTR(
			msgCtrlMask := ADSLOG_MSGTYPE_ERROR, 
			msgFmtStr   := &#39;[LOGGER] Initialization failed in %s&#39;, 
			strArg      := sPath,
		); 
	ELSE
		bInitialized := TRUE;
	END_IF
END_IF

IF bInitFailed THEN
	RETURN;
END_IF
	
// Map the message severity to the LCLSGeneralEventClass:
CASE eSevr OF
	TcEventSeverity.Verbose: 	fbMessage REF= fbMessages[TC_EVENTS.LCLSGeneralEventClass.Verbose.nEventId];
	TcEventSeverity.Warning:	fbMessage REF= fbMessages[TC_EVENTS.LCLSGeneralEventClass.Warning.nEventId];
	TcEventSeverity.Info:		fbMessage REF= fbMessages[TC_EVENTS.LCLSGeneralEventClass.Info.nEventId];		
	TcEventSeverity.Error:		fbMessage REF= fbMessages[TC_EVENTS.LCLSGeneralEventClass.Error.nEventId]; 
	TcEventSeverity.Critical:	fbMessage REF= fbMessages[TC_EVENTS.LCLSGeneralEventClass.Critical.nEventId];
	ELSE
		RETURN;
END_CASE

CASE eSubsystem OF
	E_Subsystem.FIELDBUS: 	sSubsystemSource := &#39;/Fieldbus&#39;;
	E_Subsystem.MOTION: 	sSubsystemSource := &#39;/Motion&#39;;
	E_Subsystem.MPS: 		sSubsystemSource := &#39;/MPS&#39;;
	E_Subsystem.SDS: 		sSubsystemSource := &#39;/SDS&#39;;
	E_Subsystem.VACUUM:		sSubsystemSource := &#39;/Vacuum&#39;;	
	ELSE
		sSubsystemSource := &#39;/Unknown&#39;;
END_CASE

// Clearing the source here will clear the event GUID, causing the message to not be resolved.
// However, we can change the name as desired:
//fbSource.Clear();
fbSource.sName := CONCAT(sPath, sSubsystemSource);

ipResultMessage := fbMessage;
hr := fbMessage.CreateEx(stEventEntry:=ipResultMessage.stEventEntry, ipSourceInfo:=fbSource);

// This is where the message text gets appended:
fbMessage.ipArguments.Clear();
fbMessage.ipArguments.AddString(sMsg);

IF LEN(sJson) = 0 THEN
	// Ensure there&#39;s a valid JSON string here
	sJson := &#39;{}&#39;;
END_IF

fbMessage.SetJsonAttribute(sJson);

// For a final format of:
// &#39;Path.to.FB_LogMessage/Subsystem&#39;: {Unknown,Error,Warning,Verbose} (message)

IF NOT FAILED(hr) AND fbMessage.eSeverity &gt;= eTraceLevel THEN
	hr := fbMessage.Send(0);
END_IF

IF FAILED(hr) THEN
	hrLastInternalError := hr;
END_IF

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-tempsensor">
<h2>POU: FB_TempSensor<a class="headerlink" href="#pou-fb-tempsensor" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Hardware/FB_TempSensor.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_TempSensor
(*
    Handles scaling and default diagnostics for temperature sensors,
    such as thermocouples, RTDs, and others.
    2020-03-02 Zachary Lentz
*)
VAR_INPUT
    // Resolution parameter from the Beckhoff docs. Default is 0.1 for 0.1 degree resolution
    fResolution: LREAL := 0.1;
END_VAR
VAR_OUTPUT
    {attribute &#39;pytmc&#39; := &#39;
        pv: TEMP
        io: input
        field: EGU C
        field: PREC 2
    &#39;}
    fTemp: LREAL;

    {attribute &#39;pytmc&#39; := &#39;
        pv: CONN
        io: input
        field: ONAM Connected
        field: ZNAM Disconnected
    &#39;}
    bConnected: BOOL;

    {attribute &#39;pytmc&#39; := &#39;
        pv: ERR
        io: input
        field: ONAM True
        field: ZNAM False
    &#39;}
    bError AT %I*: BOOL := TRUE;

    bUnderrange AT %I*: BOOL;
    bOverrange AT %I*: BOOL;
END_VAR
VAR
    iRaw AT %I*: INT;
END_VAR
// The manual states that we are disconnected if we are both overrange and in an error state
bConnected := NOT (bOverrange AND bError);
fTemp := INT_TO_LREAL(iRaw) * fResolution;

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-thermocouple">
<h2>POU: FB_ThermoCouple<a class="headerlink" href="#pou-fb-thermocouple" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Hardware/FB_ThermoCouple.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_ThermoCouple
(*
	Deprecated as of 2020-03-02, please use FB_TempSensor instead
	2019-10-09 Zachary Lentz
*)
{warning &#39;Function Block FB_ThermoCouple is deprecated and may be removed in a future release&#39;}
VAR_INPUT
	// Ratio between raw value and actual temperature. Default is 10 for 10 steps per degree (or 0.1 degree resolution)
	iScale: INT := 10;
END_VAR
VAR_OUTPUT
	{attribute &#39;pytmc&#39; := &#39;
		pv: STC:TEMP
		io: input
	&#39;}
	fTemp: LREAL;
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: STC:CONN
		io: input
		field: ONAM Connected
		field: ZNAM Disconnected
	&#39;}
	bConnected: BOOL;
	
	{attribute &#39;pytmc&#39; := &#39;
		pv: STC:ERR
		io: input
	&#39;}
	bError AT %I*: BOOL;
	
	bUnderrange AT %I*: BOOL;
	bOverrange AT %I*: BOOL;
END_VAR
VAR
	iRaw AT %I*: INT;
END_VAR
// The manual states that we are disconnected if we are both overrange and in an error state
bConnected := NOT (bOverrange AND bError);
fTemp := INT_TO_LREAL(iRaw) / iScale;

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-timestampbuffer">
<h2>POU: FB_TimeStampBuffer<a class="headerlink" href="#pou-fb-timestampbuffer" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Data/FB_TimestampBuffer.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TimeStampBuffer</span>
<span class="p">(</span><span class="o">*</span>
	<span class="n">A</span> <span class="n">Companion</span> <span class="k">to</span> <span class="n">FB_LREALBuffer</span> <span class="n">that</span> <span class="n">accumulates</span> <span class="n">timestamps</span>
	<span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">09</span> <span class="n">Zachary</span> <span class="n">Lentz</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
	<span class="o">//</span> <span class="k">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span><span class="na">&#39;ll</span> <span class="n">accumulate</span> <span class="n">a</span> <span class="n">value</span> <span class="k">on</span> <span class="n">this</span> <span class="n">cycle</span><span class="p">.</span>
	<span class="n">bExecute</span><span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
	<span class="n">arrOutput</span><span class="o">:</span> <span class="k">ARRAY</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="mi">1000</span><span class="p">]</span> <span class="k">OF</span> <span class="n">LREAL</span><span class="p">;</span>
	<span class="n">bNewArray</span><span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
	<span class="n">fbUnixTime</span><span class="o">:</span> <span class="n">FB_UnixTimestamp</span><span class="p">;</span>
	<span class="n">fbLREALBuffer</span><span class="o">:</span> <span class="n">FB_LREALBuffer</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbUnixTime</span><span class="p">(</span>
	<span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bExecute</span><span class="p">,</span>
	<span class="n">fTime</span> <span class="o">=&gt;</span> <span class="n">fbLREALBuffer</span><span class="p">.</span><span class="n">fInput</span><span class="p">);</span>
<span class="n">fbLREALBuffer</span><span class="p">(</span>
	<span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bExecute</span><span class="p">,</span>
	<span class="n">arrOutput</span> <span class="o">=&gt;</span> <span class="n">arrOutput</span><span class="p">,</span>
	<span class="n">bNewArray</span> <span class="o">=&gt;</span> <span class="n">bNewArray</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-timestampbufferglobal">
<h2>POU: FB_TimeStampBufferGlobal<a class="headerlink" href="#pou-fb-timestampbufferglobal" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Data/FB_TimeStampBufferGlobal.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TimeStampBufferGlobal</span>
<span class="p">(</span><span class="o">*</span>
	<span class="n">A</span> <span class="n">Variant</span> <span class="k">of</span> <span class="n">FB_TimeStampBuffer</span> <span class="n">that</span> <span class="n">uses</span> <span class="n">the</span> <span class="n">global</span> <span class="n">timestamp</span><span class="p">.</span>
	<span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">09</span> <span class="n">Zachary</span> <span class="n">Lentz</span>

	<span class="n">Assumes</span> <span class="n">an</span> <span class="n">instance</span> <span class="k">of</span> <span class="n">FB_UnixTimeStampGlobal</span> <span class="k">is</span> <span class="n">running</span> <span class="n">every</span> <span class="n">cycle</span><span class="p">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
	<span class="o">//</span> <span class="k">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span><span class="na">&#39;ll</span> <span class="n">accumulate</span> <span class="n">a</span> <span class="n">value</span> <span class="k">on</span> <span class="n">this</span> <span class="n">cycle</span><span class="p">.</span>
	<span class="n">bExecute</span><span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
	<span class="n">arrOutput</span><span class="o">:</span> <span class="k">ARRAY</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="mi">1000</span><span class="p">]</span> <span class="k">OF</span> <span class="n">LREAL</span><span class="p">;</span>
	<span class="n">bNewArray</span><span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
	<span class="n">fbLREALBuffer</span><span class="o">:</span> <span class="n">FB_LREALBuffer</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbLREALBuffer</span><span class="p">(</span>
	<span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bExecute</span><span class="p">,</span>
	<span class="n">fInput</span> <span class="o">:=</span> <span class="n">DefaultGlobals</span><span class="p">.</span><span class="n">fTimeStamp</span><span class="p">,</span>
	<span class="n">arrOutput</span> <span class="o">=&gt;</span> <span class="n">arrOutput</span><span class="p">,</span>
	<span class="n">bNewArray</span> <span class="o">=&gt;</span> <span class="n">bNewArray</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-unixtimestamp">
<h2>POU: FB_UnixTimeStamp<a class="headerlink" href="#pou-fb-unixtimestamp" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Functions/FB_UnixTimeStamp.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_UnixTimeStamp</span>
<span class="p">(</span><span class="o">*</span>
	<span class="n">Get</span> <span class="n">the</span> <span class="n">unix</span> <span class="n">timestamp</span> <span class="n">equivalent</span> <span class="k">of</span> <span class="n">the</span> <span class="n">PLC</span><span class="na">&#39;s</span> <span class="kt">time</span><span class="p">.</span>
	<span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">09</span> <span class="n">Zachary</span> <span class="n">Lentz</span>
	
	<span class="n">This</span> <span class="n">will</span> <span class="n">only</span> <span class="n">sync</span> <span class="k">with</span> <span class="n">the</span> <span class="n">Linux</span> <span class="n">host</span> <span class="k">when</span> <span class="n">both</span> <span class="n">hosts</span><span class="p">&#39;</span> <span class="n">clocks</span> <span class="n">are</span> <span class="n">correct</span><span class="p">.</span>
	<span class="n">Largely</span> <span class="n">stolen</span> <span class="n">from</span> <span class="n">stack</span> <span class="n">overflow</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
	<span class="o">//</span> <span class="k">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span><span class="na">&#39;ll</span> <span class="n">try</span> <span class="k">to</span> <span class="n">update</span> <span class="n">the</span> <span class="n">output</span> <span class="k">on</span> <span class="n">this</span> <span class="n">cycle</span><span class="p">.</span>
	<span class="n">bExecute</span><span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
	<span class="o">//</span> <span class="n">Number</span> <span class="k">of</span> <span class="n">seconds</span> <span class="k">in</span> <span class="n">the</span> <span class="n">timestamp</span>
	<span class="n">iSeconds</span><span class="o">:</span> <span class="n">ULINT</span><span class="p">;</span>
	<span class="o">//</span> <span class="n">Number</span> <span class="k">of</span> <span class="n">milliseconds</span> <span class="n">past</span> <span class="n">the</span> <span class="n">seconds</span>
	<span class="n">iMilliseconds</span><span class="o">:</span> <span class="n">ULINT</span><span class="p">;</span>
	<span class="o">//</span> <span class="n">Full</span> <span class="n">raw</span> <span class="n">number</span>
	<span class="n">iFull</span><span class="o">:</span> <span class="n">ULINT</span><span class="p">;</span>
	<span class="o">//</span> <span class="n">Full</span> <span class="n">floating</span> <span class="n">point</span> <span class="n">number</span> <span class="k">in</span> <span class="k">units</span> <span class="k">of</span> <span class="n">seconds</span>
	<span class="n">fTime</span><span class="o">:</span> <span class="n">LREAL</span><span class="p">;</span>
	<span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">the</span> <span class="n">output</span> <span class="k">is</span> <span class="n">okay</span> <span class="k">to</span> <span class="k">use</span> <span class="nn">on</span> <span class="n">this</span> <span class="n">cycle</span><span class="p">.</span> <span class="n">Typically</span> <span class="n">the</span> <span class="n">output</span> <span class="k">is</span> <span class="n">zero</span> <span class="k">when</span> <span class="n">this</span> <span class="k">is</span> <span class="n">FALSE</span><span class="p">.</span>
	<span class="n">bValid</span><span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
	<span class="n">bInit</span><span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
	<span class="n">fbLocalTime</span><span class="o">:</span> <span class="n">FB_LocalSystemTime</span><span class="p">;</span>
	<span class="n">fbGetTimeZone</span><span class="o">:</span> <span class="n">FB_GetTimeZoneInformation</span><span class="p">;</span>
	<span class="n">fbTimeConv</span><span class="o">:</span> <span class="n">FB_TzSpecificLocalTimeToFileTime</span><span class="p">;</span>
	<span class="n">fileTime</span><span class="o">:</span> <span class="n">T_FILETIME</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="k">IF</span> <span class="k">NOT</span> <span class="n">bInit</span> <span class="k">THEN</span>
	<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="n">fbGetTimeZone</span><span class="p">(</span><span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">tzInfo</span> <span class="o">=&gt;</span> <span class="n">fbTimeConv</span><span class="p">.</span><span class="n">tzInfo</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="k">IF</span> <span class="n">bExecute</span> <span class="k">THEN</span>
	<span class="n">fbLocalTime</span><span class="p">(</span>
		<span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
		<span class="n">dwCycle</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="n">bValid</span> <span class="o">=&gt;</span> <span class="n">bValid</span><span class="p">);</span>
	<span class="k">IF</span> <span class="n">bValid</span> <span class="k">THEN</span>
		<span class="n">fbTimeConv</span><span class="p">(</span>
			<span class="k">in</span> <span class="o">:=</span> <span class="n">SYSTEMTIME_TO_FILETIME</span><span class="p">(</span><span class="n">fbLocalTime</span><span class="p">.</span><span class="n">systemTime</span><span class="p">),</span>
			<span class="k">out</span> <span class="o">=&gt;</span> <span class="n">fileTime</span><span class="p">);</span>
		<span class="n">iFull</span> <span class="o">:=</span> <span class="p">(</span><span class="n">SHL</span><span class="p">(</span><span class="n">DWORD_TO_ULINT</span><span class="p">(</span><span class="n">fileTime</span><span class="p">.</span><span class="n">dwHighDateTime</span><span class="p">),</span> <span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="n">DWORD_TO_ULINT</span><span class="p">(</span><span class="n">fileTime</span><span class="p">.</span><span class="n">dwLowDateTime</span><span class="p">))</span> <span class="o">/</span> <span class="mi">10000</span> <span class="o">-</span> <span class="mi">11644473600000</span><span class="p">;</span>
		<span class="n">fTime</span> <span class="o">:=</span> <span class="n">ULINT_TO_LREAL</span><span class="p">(</span><span class="n">iFull</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>
		<span class="n">iSeconds</span> <span class="o">:=</span> <span class="n">iFull</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>
		<span class="n">iMilliseconds</span> <span class="o">:=</span> <span class="n">iFull</span> <span class="k">MOD</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-unixtimestampglobal">
<h2>POU: FB_UnixTimeStampGlobal<a class="headerlink" href="#pou-fb-unixtimestampglobal" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Functions/FB_UnixTimeStampGlobal.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_UnixTimeStampGlobal</span>
<span class="p">(</span><span class="o">*</span>
	<span class="n">Runs</span> <span class="n">FB_UnixTimeStamp</span> <span class="k">and</span> <span class="n">stuffs</span> <span class="n">the</span> <span class="n">result</span> <span class="n">into</span> <span class="n">this</span> <span class="k">library</span><span class="na">&#39;s</span> <span class="n">GVL</span>
	<span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">09</span> <span class="n">Zachary</span> <span class="n">Lentz</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
	<span class="o">//</span> <span class="k">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">will</span> <span class="n">update</span> <span class="n">the</span> <span class="n">output</span> <span class="k">on</span> <span class="n">this</span> <span class="n">cycle</span><span class="p">.</span>
	<span class="n">bExecute</span><span class="o">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
	<span class="n">fbTimeStamp</span><span class="o">:</span> <span class="n">FB_UnixTimeStamp</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbTimeStamp</span><span class="p">(</span>
	<span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bExecute</span><span class="p">,</span>
	<span class="n">fTime</span> <span class="o">=&gt;</span> <span class="n">DefaultGlobals</span><span class="p">.</span><span class="n">fTimeStamp</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-xkoyoplcmodbus">
<h2>POU: FB_XKoyoPLCModbus<a class="headerlink" href="#pou-fb-xkoyoplcmodbus" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Functions/FB_XKoyoPLCModbus.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>//Facilitates communication between Beckhoff and Koyo PLC over the network.
FUNCTION_BLOCK FB_XKoyoPLCModbus
VAR
	fbKoyo_PLCInputCoilsRx	:	FB_MBReadCoils; //FB for reading the coils from the other PLC
	anKoyo_PLC_CnBits	:	ARRAY [0..20] OF BYTE; //Buffer for coil readbacks
	{attribute &#39;naming&#39; := &#39;omit&#39;}
	ftReset	: F_TRIG; //Reset edge sensor
	{attribute &#39;naming&#39; := &#39;omit&#39;}
	tonRetry : TON; //Retry timer
	nIndex : INT; //Index for clearing the coil array
END_VAR

VAR_INPUT
	i_tRetryTime : TIME := T#10S; //Retry time if modbus transaction fails
	i_sIPAddr	 : STRING[15]; //IP address of the Koyo PLC
END_VAR

VAR_OUTPUT
	q_xNoPLCResponse : BOOL := TRUE; //Could not reach the PLC if true
	q_anPLCResponse   : ARRAY [0..20] OF BYTE; //Buffer of coils retrieved from the other PLC
	q_xError         : BOOL := FALSE; //Transaction or other error
END_VAR
(* Look ma&#39; no wires! *)
(* A. Wallace, 2015-7-22 
XKoyoPLCModbus

Facilitates communication between Beckhoff and Koyo PLC over the network.

Useful if you don&#39;t have time to run a wire. Fairly reliable.

*)

(* Modbus Info for Koyo
Modbus Addresses for
Koyo DL05/06/240/250/260/430/440/450 PLCs
PLC Memory Type		| Modbus start address Decimal (octal) | Function codes
Inputs (X)			  2048 (04000)							2
Special Relays (SP)	  3072 (06000)							2
Outputs (Y)			  2048 (04000)							1, 5, 15
Control Relays (C)	  3072 (06000)							1, 5, 15
Timer Contacts (T)	  6144 (014000)							1, 5, 15
Counter Contacts (CT) 6400 (014400)							1, 5, 15
Stage Status Bits (S) 6144 (012000)							1, 5, 15
*)

(* Begin code *)
// Retry after some time
tonRetry.IN := NOT fbKoyo_PLCInputCoilsRx.bBusy;
tonRetry.PT := i_tRetryTime;
tonRetry();

ftReset(CLK:=fbKoyo_PLCInputCoilsRx.bBusy);
ftReset();

fbKoyo_PLCInputCoilsRx.bExecute := ftReset.Q OR tonRetry.Q;

fbKoyo_PLCInputCoilsRx(sIPAddr:=&#39;i_sIPAddr&#39;, nTCPPort:=502, nQuantity:=32, nMBAddr:=8#6000, cbLength:=USINT_TO_UDINT(SIZEOF(anKoyo_PLC_CnBits)),  pDestAddr:=ADR(anKoyo_PLC_CnBits), tTimeout:=T#10S);

//run some error code for modbus
IF fbKoyo_PLCInputCoilsRx.bError THEN
	//if there&#39;s a modbus error, set all incoming bits to zero
	{analysis -41} //There are one-liners for resetting an array to zero but they don&#39;t comply with 61131
	FOR nIndex := 0 TO USINT_TO_INT(SIZEOF(anKoyo_PLC_CnBits))-1 DO //starts at 0
		anKoyo_PLC_CnBits[nIndex]:=0;
	END_FOR
	{analysis +41}
	q_xError := TRUE;
	
ELSIF ftReset.Q AND fbKoyo_PLCInputCoilsRx.cbRead &gt; 0 THEN
	fbKoyo_PLCInputCoilsRx.bExecute := FALSE;
	q_xNoPLCResponse:= FALSE;
	q_xError := FALSE;

//more error code cause we didn&#39;t manage to read anything	
ELSIF fbKoyo_PLCInputCoilsRx.cbRead = 0 THEN
	q_xError := TRUE;
	q_xNoPLCResponse:= TRUE;
			
END_IF

q_anPLCResponse := anKoyo_PLC_CnBits;

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-f-converttickstounixtimestamp">
<h2>POU: F_ConvertTicksToUnixTimestamp<a class="headerlink" href="#pou-f-converttickstounixtimestamp" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Functions/F_ConvertTicksToUnixTimestamp.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="k">FUNCTION</span> <span class="n">F_ConvertTicksToUnixTimestamp</span> <span class="o">:</span> <span class="n">LREAL</span>
<span class="n">VAR_INPUT</span>
	<span class="n">nTimestamp</span> <span class="o">:</span> <span class="n">ULINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="k">CONSTANT</span>
	<span class="o">//</span> <span class="n">Timer</span> <span class="n">ticks</span> <span class="k">in</span> <span class="n">Windows</span> <span class="n">are</span> <span class="mi">100</span><span class="n">ns</span> <span class="p">(</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">7</span> <span class="n">sec</span><span class="p">)</span>
	<span class="n">nTicksToSeconds</span> <span class="o">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">10</span><span class="n">_000_000</span><span class="p">;</span>
	<span class="o">//</span> <span class="n">Epoch</span> <span class="n">offset</span> <span class="mi">1601</span> <span class="k">to</span> <span class="mi">1970</span>
	<span class="n">nEpochOffset</span>	<span class="o">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">11</span><span class="n">_644_473_600</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">F_ConvertTicksToUnixTimestamp</span> <span class="o">:=</span> <span class="n">ULINT_TO_LREAL</span><span class="p">(</span><span class="n">nTimestamp</span><span class="p">)</span> <span class="o">/</span> <span class="n">nTicksToSeconds</span> <span class="o">-</span> <span class="n">nEpochOffset</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</div>
<div class="section" id="pou-f-sendudpmessage">
<h2>POU: F_SendUDPMessage<a class="headerlink" href="#pou-f-sendudpmessage" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Logger/F_SendUDPMessage.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="k">FUNCTION</span> <span class="n">F_SendUDPMessage</span> <span class="o">:</span> <span class="n">HRESULT</span>
<span class="n">VAR_INPUT</span>
	<span class="n">sMessage</span>			<span class="o">:</span>	<span class="n">POINTER</span> <span class="k">TO</span> <span class="kt">STRING</span><span class="p">;</span>
	<span class="n">fbSocket</span>			<span class="o">:</span>	<span class="n">REFERENCE</span> <span class="k">TO</span> <span class="n">FB_ConnectionlessSocket</span><span class="p">;</span>
	<span class="n">sHost</span>				<span class="o">:</span>	<span class="kt">STRING</span><span class="p">;</span>
	<span class="n">iPort</span>				<span class="o">:</span>	<span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
	<span class="n">fbSend</span>				<span class="o">:</span>	<span class="n">FB_SocketUdpSendTo</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="k">IF</span> <span class="n">sMessage</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">AND</span> <span class="n">__ISVALIDREF</span><span class="p">(</span><span class="n">fbSocket</span><span class="p">)</span> <span class="k">THEN</span>
	<span class="n">fbSend</span><span class="p">.</span><span class="n">hSocket</span>		<span class="o">:=</span> <span class="n">fbSocket</span><span class="p">.</span><span class="n">hSocket</span><span class="p">;</span>
	<span class="n">fbSend</span><span class="p">.</span><span class="n">sRemoteHost</span>	<span class="o">:=</span> <span class="n">sHost</span><span class="p">;</span>
	<span class="n">fbSend</span><span class="p">.</span><span class="n">nRemotePort</span>	<span class="o">:=</span> <span class="n">iPort</span><span class="p">;</span>
	<span class="n">fbSend</span><span class="p">.</span><span class="n">pSrc</span> 		<span class="o">:=</span> <span class="n">sMessage</span><span class="p">;</span>
	<span class="n">fbSend</span><span class="p">.</span><span class="n">cbLen</span>		<span class="o">:=</span> <span class="n">LEN2</span><span class="p">(</span><span class="n">sMessage</span><span class="p">);</span>
	<span class="n">fbSend</span><span class="p">.</span><span class="n">bExecute</span>	 	<span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="n">fbSend</span><span class="p">();</span>
	
	<span class="n">fbSend</span><span class="p">.</span><span class="n">bExecute</span> 	<span class="n">R</span><span class="o">=</span> <span class="n">fbSend</span><span class="p">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</div>
<div class="section" id="pou-system-time-to-rfc3339">
<h2>POU: SYSTEM_TIME_TO_RFC3339<a class="headerlink" href="#pou-system-time-to-rfc3339" title="Permalink to this headline">¶</a></h2>
<p>File: LCLSGeneral/POUs/Logger/SYSTEM_TIME_TO_RFC3339.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>//Converts Beckhoff PLC SYSTEMTIME to RFC3339 time format as a string
{attribute &#39;naming&#39; := &#39;omit&#39;}
{attribute &#39;analysis&#39; := &#39;-23&#39;}
FUNCTION SYSTEM_TIME_TO_RFC3339 : STRING(255)
VAR_INPUT
	{attribute &#39;naming&#39; := &#39;omit&#39;}
	tCurrentTime	:	TIMESTRUCT; //TIMESTRUCT Time to convert to RFC3339
END_VAR
VAR
END_VAR
SYSTEM_TIME_TO_RFC3339 := CONCAT(REPLACE(SYSTEMTIME_TO_STRING(tCurrentTime), &#39;T&#39;, 1, 11), &#39;Z&#39;);

END_FUNCTION
</pre></div>
</div>
</div>
<div class="section" id="symbols">
<h2>Symbols<a class="headerlink" href="#symbols" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="boxes">
<h2>Boxes<a class="headerlink" href="#boxes" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="nc-axes">
<h2>NC axes<a class="headerlink" href="#nc-axes" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="links">
<h2>Links<a class="headerlink" href="#links" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="pragma-lint-results">
<h2>Pragma lint results<a class="headerlink" href="#pragma-lint-results" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INFO</span><span class="p">:</span><span class="n">pytmc</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">pragmalint</span><span class="p">:</span><span class="n">Total</span> <span class="n">pragmas</span> <span class="n">found</span><span class="p">:</span> <span class="mi">79</span> <span class="n">Total</span> <span class="n">linter</span> <span class="n">errors</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">PLC</span> <span class="n">Project</span> <span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="n">LCLSGeneral</span>
<span class="o">============================</span>


<span class="n">Data</span> <span class="n">types</span><span class="o">/</span><span class="n">Misc</span><span class="o">/</span><span class="n">ST_FbDiagnostics</span><span class="o">.</span><span class="n">TcDUT</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">----------------------------------------------------</span>

    <span class="o">-</span> <span class="n">ST_FbDiagnostics</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">2</span> <span class="n">pragmas</span>


<span class="n">Data</span> <span class="n">types</span><span class="o">/</span><span class="n">Misc</span><span class="o">/</span><span class="n">ST_System</span><span class="o">.</span><span class="n">TcDUT</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">---------------------------------------------</span>

    <span class="o">-</span> <span class="n">ST_System</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">pragmas</span>


<span class="n">POUs</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">FB_BasicStats</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">-------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_BasicStats</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">11</span> <span class="n">pragmas</span>


<span class="n">POUs</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">FB_LREALFromEPICS</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">-----------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_LREALFromEPICS</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">3</span> <span class="n">pragmas</span>


<span class="n">POUs</span><span class="o">/</span><span class="n">Diagnostics</span><span class="o">/</span><span class="n">FB_EcatDiagWrapper</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">-------------------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_EcatDiagWrapper</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">6</span> <span class="n">pragmas</span>


<span class="n">POUs</span><span class="o">/</span><span class="n">Functions</span><span class="o">/</span><span class="n">FB_EcatDiag</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">----------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_EcatDiag</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">3</span> <span class="n">pragmas</span>


<span class="n">POUs</span><span class="o">/</span><span class="n">Functions</span><span class="o">/</span><span class="n">FB_Index</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">-------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_Index</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">2</span> <span class="n">pragmas</span>


<span class="n">POUs</span><span class="o">/</span><span class="n">Functions</span><span class="o">/</span><span class="n">FB_XKoyoPLCModbus</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">----------------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_XKoyoPLCModbus</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">2</span> <span class="n">pragmas</span>


<span class="n">POUs</span><span class="o">/</span><span class="n">Hardware</span><span class="o">/</span><span class="n">FB_EL6_Com</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">--------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_EL6_Com</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">7</span> <span class="n">pragmas</span>


<span class="n">POUs</span><span class="o">/</span><span class="n">Hardware</span><span class="o">/</span><span class="n">FB_ThermoCouple</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">-------------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_ThermoCouple</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">3</span> <span class="n">pragmas</span>


<span class="n">POUs</span><span class="o">/</span><span class="n">Hardware</span><span class="o">/</span><span class="n">FB_TempSensor</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">-----------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_TempSensor</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">3</span> <span class="n">pragmas</span>


<span class="n">POUs</span><span class="o">/</span><span class="n">Logger</span><span class="o">/</span><span class="n">DUTs</span><span class="o">/</span><span class="n">E_LogEventType_WC</span><span class="o">.</span><span class="n">TcDUT</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">------------------------------------------------------</span>

    <span class="o">-</span> <span class="n">E_LogEventType_WC</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">2</span> <span class="n">pragmas</span>


<span class="n">POUs</span><span class="o">/</span><span class="n">Logger</span><span class="o">/</span><span class="n">DUTs</span><span class="o">/</span><span class="n">ST_LoggingEventInfo_WC</span><span class="o">.</span><span class="n">TcDUT</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">-----------------------------------------------------------</span>

    <span class="o">-</span> <span class="n">ST_LoggingEventInfo_WC</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">10</span> <span class="n">pragmas</span>


<span class="n">POUs</span><span class="o">/</span><span class="n">Logger</span><span class="o">/</span><span class="n">DUTs</span><span class="o">/</span><span class="n">ST_PendingEvent</span><span class="o">.</span><span class="n">TcDUT</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">----------------------------------------------------</span>

    <span class="o">-</span> <span class="n">ST_PendingEvent</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">pragmas</span>


<span class="n">POUs</span><span class="o">/</span><span class="n">Logger</span><span class="o">/</span><span class="n">FB_Listener</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">-------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_Listener</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">7</span> <span class="n">pragmas</span>


<span class="n">POUs</span><span class="o">/</span><span class="n">Logger</span><span class="o">/</span><span class="n">FB_LogHandler</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">---------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_LogHandler</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">7</span> <span class="n">pragmas</span>


<span class="n">POUs</span><span class="o">/</span><span class="n">Logger</span><span class="o">/</span><span class="n">FB_LogMessage</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">---------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_LogMessage</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">3</span> <span class="n">pragmas</span>


<span class="n">POUs</span><span class="o">/</span><span class="n">Logger</span><span class="o">/</span><span class="n">GVL_Logger</span><span class="o">.</span><span class="n">TcGVL</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">------------------------------------------</span>

    <span class="o">-</span> <span class="n">GVL_Logger</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">3</span> <span class="n">pragmas</span>


<span class="n">POUs</span><span class="o">/</span><span class="n">Logger</span><span class="o">/</span><span class="n">SYSTEM_TIME_TO_RFC3339</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">------------------------------------------------------</span>

    <span class="o">-</span> <span class="n">SYSTEM_TIME_TO_RFC3339</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">3</span> <span class="n">pragmas</span>
</pre></div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">pcdshub/lcls-twincat-general</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="LCLSGeneral.tmc.html">LCLSGeneral.tmc</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">PLC Project (1): LCLSGeneral</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#dut-e-eccommstate">DUT: E_EcCommState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-e-ecatdiagstate">DUT: E_EcatDiagState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-e-logeventtype-wc">DUT: E_LogEventType_WC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-e-subsystem">DUT: E_Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-st-ecdevice">DUT: ST_EcDevice</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-st-ecmasterdevstate">DUT: ST_EcMasterDevState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-st-fbdiagnostics">DUT: ST_FbDiagnostics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-st-loggingeventinfo-wc">DUT: ST_LoggingEventInfo_WC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-st-pendingevent">DUT: ST_PendingEvent</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-st-portaddr">DUT: ST_PortAddr</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-st-slavestate">DUT: ST_SlaveState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-st-slavestateinfo">DUT: ST_SlaveStateInfo</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-st-slavestateinfoscanned">DUT: ST_SlaveStateInfoScanned</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-st-system">DUT: ST_System</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-st-topologydata">DUT: ST_TopologyData</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-defaultglobals">GVL: DefaultGlobals</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-gvl-logger">GVL: GVL_Logger</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-global-variables-ethercat">GVL: Global_Variables_EtherCAT</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-analoginput">POU: FB_AnalogInput</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-analogoutput">POU: FB_AnalogOutput</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-basicstats">POU: FB_BasicStats</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-coe-fastread">POU: FB_CoE_FastRead</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-databuffer">POU: FB_DataBuffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-el6-com">POU: FB_EL6_Com</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-ecatdiag">POU: FB_EcatDiag</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-ecatdiagwrapper">POU: FB_EcatDiagWrapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-ethercatdiag">POU: FB_EtherCATDiag</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-ethercatframediag">POU: FB_EtherCATFrameDiag</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-index">POU: FB_Index</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-lrealbuffer">POU: FB_LREALBuffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-lrealfromepics">POU: FB_LREALFromEPICS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-listener">POU: FB_Listener</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-loghandler">POU: FB_LogHandler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-logmessage">POU: FB_LogMessage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-tempsensor">POU: FB_TempSensor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-thermocouple">POU: FB_ThermoCouple</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-timestampbuffer">POU: FB_TimeStampBuffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-timestampbufferglobal">POU: FB_TimeStampBufferGlobal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-unixtimestamp">POU: FB_UnixTimeStamp</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-unixtimestampglobal">POU: FB_UnixTimeStampGlobal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-xkoyoplcmodbus">POU: FB_XKoyoPLCModbus</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-f-converttickstounixtimestamp">POU: F_ConvertTicksToUnixTimestamp</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-f-sendudpmessage">POU: F_SendUDPMessage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-system-time-to-rfc3339">POU: SYSTEM_TIME_TO_RFC3339</a></li>
<li class="toctree-l2"><a class="reference internal" href="#symbols">Symbols</a></li>
<li class="toctree-l2"><a class="reference internal" href="#boxes">Boxes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#nc-axes">NC axes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#links">Links</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pragma-lint-results">Pragma lint results</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="LCLSGeneral.tmc.html" title="previous chapter">LCLSGeneral.tmc</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, SLAC National Accelerator Laboratory.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/LCLSGeneral.tsproj.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>